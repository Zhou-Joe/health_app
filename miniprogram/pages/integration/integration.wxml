<view class="integration-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="blob blob-1"></view>
    <view class="blob blob-2"></view>
  </view>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left">
      <text class="header-emoji">ğŸ”„</text>
      <view class="header-text">
        <text class="header-title">æ•°æ®æ•´åˆ</text>
        <text class="header-subtitle">AIæ™ºèƒ½ç»Ÿä¸€æŒ‡æ ‡</text>
      </view>
    </view>
  </view>

  <!-- ä»‹ç»å¡ç‰‡ -->
  <view class="intro-card">
    <text class="intro-emoji">âœ¨</text>
    <view class="intro-content">
      <text class="intro-title">æ™ºèƒ½æ•´åˆ</text>
      <text class="intro-text">é€‰æ‹©å¤šä»½æŠ¥å‘Šï¼ŒAIå°†è‡ªåŠ¨ç»Ÿä¸€æŒ‡æ ‡åç§°ã€å•ä½å’Œå‚è€ƒèŒƒå›´</text>
    </view>
  </view>

  <!-- é‡å¤æŠ¥å‘Šæ£€æµ‹ -->
  <view class="section-card">
    <view class="section-header">
      <text class="section-title">åˆå¹¶æŠ¥å‘Š</text>
      <view class="detect-btn" bindtap="detectDuplicates">
        <text class="detect-btn-text">æŸ¥æ‰¾ç›¸åŒ</text>
      </view>
    </view>

    <!-- é‡å¤åˆ—è¡¨ -->
    <view class="duplicate-list" wx:if="{{duplicateGroups.length > 0}}">
      <view class="duplicate-group" wx:for="{{duplicateGroups}}" wx:key="date">
        <view class="duplicate-header">
          <text class="duplicate-date">{{item.date}}</text>
          <text class="duplicate-count">{{item.count}}ä»½</text>
        </view>
        <text class="duplicate-hospital">{{item.hospital}}</text>

        <!-- æŠ¥å‘Šåˆ—è¡¨ -->
        <view class="checkup-list">
          <view class="checkup-item-mini"
                wx:for="{{item.checkups}}"
                wx:for-item="checkup"
                wx:key="id"
                bindtap="selectTargetCheckup"
                data-group-index="{{index}}"
                data-checkup-id="{{checkup.id}}">
            <view class="radio-dot {{item.targetCheckupId === checkup.id ? 'checked' : ''}}"></view>
            <view class="checkup-mini-info">
              <text class="mini-id">ID: {{checkup.id}}</text>
              <text class="mini-meta">{{checkup.indicators_count}}é¡¹ Â· {{checkup.created_at}}</text>
            </view>
          </view>
        </view>

        <view class="duplicate-footer">
          <text class="target-text">å·²é€‰ID {{item.targetCheckupId}}</text>
          <button class="merge-btn"
                  bindtap="mergeDuplicates"
                  data-group-index="{{index}}"
                  disabled="{{!item.targetCheckupId || item.merging}}"
                  loading="{{item.merging}}">
            {{item.merging ? 'åˆå¹¶ä¸­...' : 'åˆå¹¶'}}
          </button>
        </view>
      </view>
    </view>

    <view class="no-duplicates" wx:elif="{{hasChecked && duplicateGroups.length === 0}}">
      <text class="no-duplicate-icon">âœ“</text>
      <text class="no-duplicate-text">æœªå‘ç°ç›¸åŒæŠ¥å‘Š</text>
    </view>

    <view class="detect-hint" wx:else>
      <text class="hint-icon">ğŸ’¡</text>
      <text class="hint-text">ç‚¹å‡»æŸ¥æ‰¾ç›¸åŒæ—¥æœŸå’Œæœºæ„çš„æŠ¥å‘Š</text>
    </view>
  </view>

  <!-- æŠ¥å‘Šé€‰æ‹© -->
  <view class="section-card">
    <view class="section-header">
      <text class="section-title">é€‰æ‹©æŠ¥å‘Š (è‡³å°‘2ä»½)</text>
    </view>

    <view class="checkup-list-full">
      <view class="checkup-row"
            wx:for="{{checkups}}"
            wx:key="id"
            bindtap="toggleSelection"
            data-id="{{item.id}}">
        <view class="checkbox-box {{selectedIdSet[item.id] ? 'checked' : ''}}">
          <text class="check-icon" wx:if="{{selectedIdSet[item.id]}}">âœ“</text>
        </view>
        <view class="checkup-row-info">
          <text class="row-hospital">{{item.hospital}}</text>
          <text class="row-meta">{{item.checkup_date}} Â· {{item.indicators_count}}é¡¹</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è‡ªå®šä¹‰æç¤º -->
  <view class="section-card">
    <view class="section-header">
      <text class="section-title">è‡ªå®šä¹‰æç¤º (å¯é€‰)</text>
    </view>
    <textarea class="prompt-area"
              placeholder="ä¾‹å¦‚ï¼šè¯·ç‰¹åˆ«å…³æ³¨è¡€å‹ã€è¡€ç³–æŒ‡æ ‡..."
              value="{{userPrompt}}"
              bindinput="onPromptInput"
              maxlength="200" />
    <text class="prompt-hint">æ·»åŠ ä½ å¸Œæœ›AIç‰¹åˆ«å…³æ³¨çš„æ–¹é¢</text>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="action-bar">
    <text class="action-count">å·²é€‰æ‹© {{selectedIds.length}} ä»½</text>
    <button class="integrate-btn"
            bindtap="handleIntegrate"
            disabled="{{selectedIds.length < 2 || integrating}}"
            loading="{{integrating}}">
      {{integrating ? 'æ•´åˆä¸­...' : 'å¼€å§‹æ•´åˆ'}}
    </button>
  </view>
</view>
