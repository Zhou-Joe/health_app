<!--pages/conversation/conversation.wxml-->
<view class="chat-container" id="chat-container">
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <view class="chat-header">
    <view class="header-left">
      <text class="back-btn" bindtap="goBack">â€¹ è¿”å›</text>
    </view>
    <view class="header-center">
      <text class="header-title">AIå¥åº·åŠ©æ‰‹</text>
    </view>
    <view class="header-right">
      <button class="icon-btn" bindtap="toggleReportSelector" wx:if="{{conversationMode === 'new'}}">
        <text class="icon">ğŸ“‹</text>
      </button>
    </view>
  </view>

  <!-- æŠ¥å‘Šé€‰æ‹©å™¨ -->
  <view class="report-selector" wx:if="{{showReportSelector}}">
    <view class="selector-header">
      <view class="selector-title">
        <text class="title-text">é€‰æ‹©ä½“æ£€æŠ¥å‘Š</text>
        <text class="selected-count">å·²é€‰{{selectedReportIds.length}}ä»½</text>
      </view>
      <view class="selector-actions">
        <button class="text-btn" bindtap="toggleSelectAll">
          {{selectedReportIds.length === reports.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
        </button>
        <button class="text-btn" bindtap="toggleReportSelector">å®Œæˆ</button>
      </view>
    </view>
    <scroll-view class="report-list" scroll-y>
      <!-- ä¸ä½¿ç”¨ä»»ä½•æŠ¥å‘Šé€‰é¡¹ -->
      <view class="report-item no-reports-option {{selectedReportIds.length === 0 && reportsNoSelection ? 'selected' : ''}}"
            bindtap="selectNoReports">
        <view class="report-check">
          <text class="check-icon">{{selectedReportIds.length === 0 && reportsNoSelection ? 'âœ“' : ''}}</text>
        </view>
        <view class="report-info">
          <text class="report-hospital">ğŸ’¬ ä¸ä½¿ç”¨ä»»ä½•æŠ¥å‘Š</text>
          <text class="report-desc">ä»…åŸºäºé—®é¢˜æä¾›ä¸€èˆ¬æ€§å¥åº·å»ºè®®</text>
        </view>
      </view>

      <!-- æŠ¥å‘Šåˆ—è¡¨ -->
      <view class="report-item {{item.selected ? 'selected' : ''}}"
            wx:for="{{reports}}"
            wx:key="id"
            bindtap="toggleReport"
            data-id="{{item.id}}">
        <view class="report-check">
          <text class="check-icon">{{item.selected ? 'âœ“' : ''}}</text>
        </view>
        <view class="report-info">
          <text class="report-hospital">{{item.hospital}}</text>
          <text class="report-date">{{item.checkup_date}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="message-list" scroll-y scroll-into-view="msg-{{lastMessageId}}" scroll-with-animation="{{true}}" scroll-into-view-align="bottom">
    <block wx:for="{{messages}}" wx:key="id">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message-row user" wx:if="{{item.role === 'user'}}" id="msg-{{item.id}}">
        <view class="message-bubble user-bubble">
          <text class="message-text">{{item.content}}</text>
          <view class="message-meta">
            <text class="message-time">{{item.created_at}}</text>
            <text class="meta-action" bindtap="copyContent" data-content="{{item.content}}">å¤åˆ¶</text>
          </view>
        </view>
        <view class="avatar user-avatar">ğŸ‘¤</view>
      </view>

      <!-- AIæ¶ˆæ¯ -->
      <view class="message-row ai" wx:else id="msg-{{item.id}}">
        <view class="avatar ai-avatar">ğŸ’¬</view>
        <view class="message-bubble ai-bubble">
          <!-- å¦‚æœæ˜¯æ€è€ƒçŠ¶æ€ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”» -->
          <view class="ai-typing" wx:if="{{item.isThinking}}">
            <view class="typing-indicator">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
            <text class="typing-text">AIæ­£åœ¨æ€è€ƒä¸­...</text>
          </view>
          <!-- å¦åˆ™æ˜¾ç¤ºå†…å®¹ -->
          <block wx:else>
            <!-- æŠ˜å çŠ¶æ€ï¼šåªæ˜¾ç¤ºå‰100å­— -->
            <view wx:if="{{!item.expanded && item.previewText && item.previewText.length > 100}}">
              <text class="message-text ai-text">{{item.previewShort}}...</text>
              <text class="expand-btn" bindtap="toggleExpand" data-index="{{index}}">å±•å¼€å…¨æ–‡</text>
            </view>
            <!-- å±•å¼€çŠ¶æ€æˆ–çŸ­æ¶ˆæ¯ï¼šæ˜¾ç¤ºå…¨éƒ¨ -->
            <view wx:else>
              <rich-text wx:if="{{item.markdownData}}" nodes="{{item.markdownData}}" />
              <text class="message-text ai-text" wx:else>{{item.content}}</text>
              <text class="expand-btn" wx:if="{{item.previewText && item.previewText.length > 100}}" bindtap="toggleExpand" data-index="{{index}}">æ”¶èµ·</text>
            </view>
            <view class="message-meta" wx:if="{{item.created_at}}">
              <text class="message-time">{{item.created_at}}</text>
              <text class="meta-action" bindtap="copyContent" data-content="{{item.content}}">å¤åˆ¶</text>
              <text class="meta-action" bindtap="viewPrompt" data-index="{{index}}" wx:if="{{item.prompt_sent}}">æŸ¥çœ‹æç¤º</text>
            </view>
          </block>
        </view>
      </view>
    </block>

    <!-- åˆ—è¡¨åº•éƒ¨ç•™ç™½ -->
    <view class="list-footer"></view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <!-- å·²é€‰æŠ¥å‘Šæç¤º -->
    <view class="selected-reports-tip" wx:if="{{selectedReportIds.length > 0 && !showReportSelector}}">
      <scroll-view class="reports-scroll" scroll-x>
        <text class="tip-text">å·²é€‰æ‹© {{selectedReportIds.length}} ä»½æŠ¥å‘Š</text>
        <text class="tip-action" bindtap="toggleReportSelector">ä¿®æ”¹</text>
      </scroll-view>
    </view>

    <view class="input-wrapper">
      <textarea
        class="message-input"
        value="{{inputText}}"
        bindinput="onInputChange"
        placeholder="è¯·ç»§ç»­æé—®..."
        maxlength="1000"
        auto-height
        disable-default-padding
        adjust-position="{{true}}"
        show-confirm-bar="{{false}}"
        cursor-spacing="10" />
      <view class="action-buttons">
        <button
          class="send-btn {{inputText.trim() ? 'active' : ''}}"
          bindtap="handleSendTap">
          <text class="btn-text" wx:if="{{!sending}}">å‘é€</text>
          <text class="btn-text" wx:if="{{sending}}">...</text>
        </button>
      </view>
    </view>

    <!-- å¿«æ·é—®é¢˜å»ºè®® -->
    <scroll-view class="quick-questions" scroll-x wx:if="{{conversationMode === 'new' && messages.length <= 1}}">
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æœ€è¿‘ä½“æ£€å‘ç°è¡€å‹åé«˜ï¼Œéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ">
        <text class="quick-text">è¡€å‹åé«˜æ€ä¹ˆåŠï¼Ÿ</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æˆ‘çš„è¡€ç³–å€¼æ­£å¸¸å—ï¼Ÿå¦‚ä½•æ§åˆ¶è¡€ç³–ï¼Ÿ">
        <text class="quick-text">å¦‚ä½•æ§åˆ¶è¡€ç³–ï¼Ÿ</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æ ¹æ®æˆ‘çš„ä½“æ£€æŠ¥å‘Šï¼Œæœ‰ä»€ä¹ˆå¥åº·å»ºè®®ï¼Ÿ">
        <text class="quick-text">å¥åº·å»ºè®®</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æˆ‘çš„èƒ†å›ºé†‡åé«˜ï¼Œåº”è¯¥å¦‚ä½•è°ƒæ•´é¥®é£Ÿï¼Ÿ">
        <text class="quick-text">èƒ†å›ºé†‡åé«˜é¥®é£Ÿå»ºè®®</text>
      </view>
    </scroll-view>
  </view>
</view>
