<!--pages/conversation/conversation.wxml-->
<view class="chat-container" id="chat-container">
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <view class="chat-header">
    <view class="header-left">
      <text class="back-btn" bindtap="goBack">â€¹ è¿”å›</text>
    </view>
    <view class="header-center">
      <text class="header-title">AIå¥åº·åŠ©æ‰‹</text>
    </view>
    <view class="header-right">
    </view>
  </view>

  <!-- æŠ¥å‘Šé€‰æ‹©å™¨ -->
  <view class="report-selector" wx:if="{{showReportSelector}}">
    <view class="selector-mask" bindtap="toggleReportSelector"></view>
    <view class="selector-content">
      <view class="selector-header">
        <text class="selector-title">é€‰æ‹©ä½“æ£€æŠ¥å‘Š</text>
        <view class="selector-actions">
          <text class="selected-hint" wx:if="{{selectedReportIds.length > 0}}">å·²é€‰{{selectedReportIds.length}}ä»½</text>
          <text class="action-btn" bindtap="toggleSelectAll">{{selectedReportIds.length === reports.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}</text>
          <text class="action-btn primary" bindtap="toggleReportSelector">å®Œæˆ</text>
        </view>
      </view>
      <scroll-view class="report-list" scroll-y>
        <!-- ä¸ä½¿ç”¨ä»»ä½•æŠ¥å‘Šé€‰é¡¹ -->
        <view class="list-item special-option {{selectedReportIds.length === 0 && reportsNoSelection ? 'selected' : ''}}"
              bindtap="selectNoReports">
          <view class="item-check {{selectedReportIds.length === 0 && reportsNoSelection ? 'checked' : ''}}">
            <text wx:if="{{selectedReportIds.length === 0 && reportsNoSelection}}">âœ“</text>
          </view>
          <view class="item-content">
            <text class="item-title">ğŸ’¬ ä¸ä½¿ç”¨ä»»ä½•æŠ¥å‘Š</text>
            <text class="item-subtitle">ä»…åŸºäºé—®é¢˜æä¾›ä¸€èˆ¬æ€§å¥åº·å»ºè®®</text>
          </view>
        </view>

        <!-- æŠ¥å‘Šåˆ—è¡¨ -->
        <view class="list-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{reports}}"
              wx:key="id"
              bindtap="toggleReport"
              data-id="{{item.id}}">
          <view class="item-check {{item.selected ? 'checked' : ''}}">
            <text wx:if="{{item.selected}}">âœ“</text>
          </view>
          <view class="item-content">
            <text class="item-title">{{item.hospital}}</text>
            <view class="item-meta">
              <text class="meta-text">{{item.checkup_date}}</text>
              <text class="meta-dot">Â·</text>
              <text class="meta-text">{{item.indicators_count || 0}}é¡¹æŒ‡æ ‡</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è¯å•é€‰æ‹©å™¨ -->
  <view class="medication-selector" wx:if="{{showMedicationSelector}}">
    <view class="selector-mask" bindtap="toggleMedicationSelector"></view>
    <view class="selector-content">
      <view class="selector-header">
        <text class="selector-title">é€‰æ‹©è¯å•</text>
        <view class="selector-actions">
          <text class="selected-hint" wx:if="{{selectedMedicationIds.length > 0}}">å·²é€‰{{selectedMedicationIds.length}}ä»½</text>
          <text class="action-btn" bindtap="toggleSelectAllMedications">{{selectedMedicationIds.length === medications.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}</text>
          <text class="action-btn primary" bindtap="toggleMedicationSelector">å®Œæˆ</text>
        </view>
      </view>
      <scroll-view class="medication-list" scroll-y>
        <!-- ä¸ä½¿ç”¨ä»»ä½•è¯å•é€‰é¡¹ -->
        <view class="list-item special-option {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'selected' : ''}}"
              bindtap="selectNoMedications">
          <view class="item-check {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'checked' : ''}}">
            <text wx:if="{{selectedMedicationIds.length === 0 && medicationsNoSelection}}">âœ“</text>
          </view>
          <view class="item-content">
            <text class="item-title">ğŸ’¬ ä¸ä½¿ç”¨ä»»ä½•è¯å•</text>
            <text class="item-subtitle">ä¸åŒ…å«è¯å•ä¿¡æ¯è¿›è¡Œå’¨è¯¢</text>
          </view>
        </view>

        <!-- è¯å•åˆ—è¡¨ -->
        <view class="list-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{medications}}"
              wx:key="id"
              bindtap="toggleMedication"
              data-id="{{item.id}}">
          <view class="item-check {{item.selected ? 'checked' : ''}}">
            <text wx:if="{{item.selected}}">âœ“</text>
          </view>
          <view class="item-content">
            <text class="item-title">{{item.medicine_name}}</text>
            <view class="item-meta">
              <text class="meta-text">{{item.dosage}}</text>
            </view>
            <view class="item-meta">
              <text class="meta-text">{{item.start_date}} è‡³ {{item.end_date}}</text>
              <text class="meta-dot">Â·</text>
              <text class="meta-text">å·²æœè¯{{item.days_taken || 0}}/{{item.total_days || 0}}å¤©</text>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{medications.length === 0}}">
          <text class="empty-text">æš‚æ— è¯å•</text>
          <text class="empty-desc">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è¯å•</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="message-list" scroll-y scroll-into-view="msg-{{lastMessageId}}" scroll-with-animation="{{true}}" scroll-into-view-align="bottom">
    <block wx:for="{{messages}}" wx:key="id">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message-row user" wx:if="{{item.role === 'user'}}" id="msg-{{item.id}}">
        <view class="message-bubble user-bubble">
          <text class="message-text">{{item.content}}</text>
          <view class="message-meta">
            <text class="message-time">{{item.created_at}}</text>
            <text class="meta-action" bindtap="copyContent" data-content="{{item.content}}">å¤åˆ¶</text>
          </view>
        </view>
        <view class="avatar user-avatar">ğŸ‘¤</view>
      </view>

      <!-- AIæ¶ˆæ¯ -->
      <view class="message-row ai" wx:else id="msg-{{item.id}}">
        <view class="avatar ai-avatar">ğŸ’¬</view>
        <view class="message-bubble ai-bubble">
          <!-- å¦‚æœæ˜¯æ€è€ƒçŠ¶æ€ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”» -->
          <view class="ai-typing" wx:if="{{item.isThinking}}">
            <view class="typing-indicator">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
            <text class="typing-text">AIæ­£åœ¨æ€è€ƒä¸­...</text>
          </view>
          <!-- å¦åˆ™æ˜¾ç¤ºå†…å®¹ -->
          <block wx:else>
            <!-- æŠ˜å çŠ¶æ€ï¼šåªæ˜¾ç¤ºå‰100å­— -->
            <view wx:if="{{!item.expanded && item.previewText && item.previewText.length > 100}}">
              <text class="message-text ai-text">{{item.previewShort}}...</text>
              <text class="expand-btn" bindtap="toggleExpand" data-index="{{index}}">å±•å¼€å…¨æ–‡</text>
            </view>
            <!-- å±•å¼€çŠ¶æ€æˆ–çŸ­æ¶ˆæ¯ï¼šæ˜¾ç¤ºå…¨éƒ¨ -->
            <view wx:else>
              <rich-text wx:if="{{item.markdownData}}" nodes="{{item.markdownData}}" />
              <text class="message-text ai-text" wx:else>{{item.content}}</text>
              <text class="expand-btn" wx:if="{{item.previewText && item.previewText.length > 100}}" bindtap="toggleExpand" data-index="{{index}}">æ”¶èµ·</text>
            </view>
            <view class="message-meta" wx:if="{{item.created_at}}">
              <text class="message-time">{{item.created_at}}</text>
              <text class="meta-action" bindtap="copyContent" data-content="{{item.content}}">å¤åˆ¶</text>
              <text class="meta-action" bindtap="viewPrompt" data-index="{{index}}" wx:if="{{item.prompt_sent}}">æŸ¥çœ‹æç¤º</text>
            </view>
          </block>
        </view>
      </view>
    </block>

    <!-- åˆ—è¡¨åº•éƒ¨ç•™ç™½ -->
    <view class="list-footer"></view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <!-- å·²é€‰æŠ¥å‘Šæç¤º -->
    <view class="selected-reports-tip" wx:if="{{selectedReportIds.length > 0 && !showReportSelector}}">
      <scroll-view class="reports-scroll" scroll-x>
        <text class="tip-text">å·²é€‰æ‹© {{selectedReportIds.length}} ä»½æŠ¥å‘Š</text>
        <text class="tip-action" bindtap="toggleReportSelector">ä¿®æ”¹</text>
      </scroll-view>
    </view>

    <!-- å·²é€‰è¯å•æç¤º -->
    <view class="selected-medications-tip" wx:if="{{selectedMedicationIds.length > 0 && !showMedicationSelector}}">
      <scroll-view class="medications-scroll" scroll-x>
        <text class="tip-text">å·²é€‰æ‹© {{selectedMedicationIds.length}} ä»½è¯å•</text>
        <text class="tip-action" bindtap="toggleMedicationSelector">ä¿®æ”¹</text>
      </scroll-view>
    </view>

    <view class="input-wrapper">
      <!-- é€‰æ‹©æŒ‰é’®ç»„ -->
      <view class="select-buttons">
        <button class="select-btn report-btn" bindtap="toggleReportSelector">
          <text class="select-icon">ğŸ“‹</text>
          <text class="select-text">æŠ¥å‘Š{{selectedReportIds.length > 0 ? '(' + selectedReportIds.length + ')' : ''}}</text>
        </button>
        <button class="select-btn medication-btn" bindtap="toggleMedicationSelector">
          <text class="select-icon">ğŸ’Š</text>
          <text class="select-text">è¯å•{{selectedMedicationIds.length > 0 ? '(' + selectedMedicationIds.length + ')' : ''}}</text>
        </button>
      </view>

      <textarea
        class="message-input"
        value="{{inputText}}"
        bindinput="onInputChange"
        placeholder="è¯·ç»§ç»­æé—®..."
        maxlength="1000"
        auto-height
        disable-default-padding
        adjust-position="{{true}}"
        show-confirm-bar="{{false}}"
        cursor-spacing="10" />
      <view class="action-buttons">
        <button
          class="send-btn {{inputText.trim() ? 'active' : ''}}"
          bindtap="handleSendTap">
          <text class="btn-text" wx:if="{{!sending}}">å‘é€</text>
          <text class="btn-text" wx:if="{{sending}}">...</text>
        </button>
      </view>
    </view>

    <!-- å¿«æ·é—®é¢˜å»ºè®® -->
    <scroll-view class="quick-questions" scroll-x wx:if="{{conversationMode === 'new' && messages.length <= 1}}">
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æœ€è¿‘ä½“æ£€å‘ç°è¡€å‹åé«˜ï¼Œéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ">
        <text class="quick-text">è¡€å‹åé«˜æ€ä¹ˆåŠï¼Ÿ</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æˆ‘çš„è¡€ç³–å€¼æ­£å¸¸å—ï¼Ÿå¦‚ä½•æ§åˆ¶è¡€ç³–ï¼Ÿ">
        <text class="quick-text">å¦‚ä½•æ§åˆ¶è¡€ç³–ï¼Ÿ</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æ ¹æ®æˆ‘çš„ä½“æ£€æŠ¥å‘Šï¼Œæœ‰ä»€ä¹ˆå¥åº·å»ºè®®ï¼Ÿ">
        <text class="quick-text">å¥åº·å»ºè®®</text>
      </view>
      <view class="quick-question-item" bindtap="setQuickQuestion" data-question="æˆ‘çš„èƒ†å›ºé†‡åé«˜ï¼Œåº”è¯¥å¦‚ä½•è°ƒæ•´é¥®é£Ÿï¼Ÿ">
        <text class="quick-text">èƒ†å›ºé†‡åé«˜é¥®é£Ÿå»ºè®®</text>
      </view>
    </scroll-view>
  </view>
</view>
