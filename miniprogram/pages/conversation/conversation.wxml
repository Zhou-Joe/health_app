<!--pages/conversation/conversation.wxml-->
<view class="chat-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="organic-shape shape-1"></view>
    <view class="organic-shape shape-2"></view>
    <view class="organic-shape shape-3"></view>
  </view>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="chat-header">
    <view class="header-back" bindtap="goBack">
      <text class="back-icon">â†</text>
    </view>
    <view class="header-center">
      <view class="ai-avatar-wrapper">
        <view class="ai-avatar-pulse"></view>
        <text class="ai-avatar">ğŸ¤–</text>
      </view>
      <text class="header-title">AIå¥åº·åŠ©æ‰‹</text>
    </view>
    <view class="header-right">
      <view class="header-btn" bindtap="toggleReportSelector">
        <text class="btn-icon">ğŸ“‹</text>
      </view>
      <view class="header-btn" bindtap="toggleMedicationSelector">
        <text class="btn-icon">ğŸ’Š</text>
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view class="message-list" scroll-y scroll-into-view="{{scrollToView}}" scroll-with-animation>
    <view class="message-wrapper"
          wx:for="{{messages}}"
          wx:key="id">

      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message-bubble user-message" wx:if="{{item.role === 'user'}}">
        <view class="bubble-content {{item.expanded ? 'expanded' : ''}}" bindtap="toggleExpand" data-index="{{index}}">
          <text class="message-text">{{item.content}}</text>
          <view class="bubble-tail"></view>
        </view>
      </view>

      <!-- AIæ¶ˆæ¯ -->
      <view class="message-bubble ai-message" wx:else>
        <view class="ai-indicator"></view>
        <view class="bubble-content {{item.expanded ? 'expanded' : ''}}" bindtap="toggleExpand" data-index="{{index}}">
          <text class="message-text">{{item.content}}</text>
          <view class="bubble-tail"></view>
          <view class="expand-hint" wx:if="{{!item.expanded && item.content && item.content.length > 100}}">
            <text>ç‚¹å‡»å±•å¼€</text>
          </view>
        </view>
      </view>

      <view class="message-time">
        <text>{{item.created_at}}</text>
      </view>
    </view>

    <!-- AIæ€è€ƒä¸­ -->
    <view class="thinking-indicator" wx:if="{{isGenerating}}">
      <view class="thinking-dots">
        <view class="dot dot-1"></view>
        <view class="dot dot-2"></view>
        <view class="dot dot-3"></view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥åŒº -->
  <view class="input-area">
    <!-- é™„ä»¶æŒ‰é’® -->
    <view class="attach-btn" bindtap="showAttachmentMenu">
      <text class="attach-icon">+</text>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <textarea class="message-input"
                value="{{inputText}}"
                bindinput="onInputChange"
                bindfocus="onInputFocus"
                bindblur="onInputBlur"
                placeholder="æè¿°æ‚¨çš„å¥åº·é—®é¢˜..."
                maxlength="1000"
                auto-height
                adjust-position="{{true}}"
                show-confirm-bar="{{false}}"
                cursor-spacing="20" />
    </view>

    <!-- å‘é€æŒ‰é’® -->
    <view class="send-btn {{inputText.trim().length > 0 ? 'active' : ''}}" bindtap="sendMessage">
      <text class="send-icon">â¤</text>
    </view>
  </view>

  <!-- é™„ä»¶èœå• -->
  <view class="attachment-menu" wx:if="{{showAttachmentMenu}}" bindtap="hideAttachmentMenu">
    <view class="menu-mask" bindtap="hideAttachmentMenu"></view>
    <view class="menu-content" catchtap="stopPropagation">
      <view class="menu-item" bindtap="openReportSelector">
        <view class="menu-icon">ğŸ“‹</view>
        <text class="menu-text">ä½“æ£€æŠ¥å‘Š</text>
        <text class="menu-badge" wx:if="{{selectedReportIds.length > 0}}">{{selectedReportIds.length}}</text>
      </view>
      <view class="menu-item" bindtap="openMedicationSelector">
        <view class="menu-icon">ğŸ’Š</view>
        <text class="menu-text">è¯å•ä¿¡æ¯</text>
        <text class="menu-badge" wx:if="{{selectedMedicationIds.length > 0}}">{{selectedMedicationIds.length}}</text>
      </view>
    </view>
  </view>

  <!-- æŠ¥å‘Šé€‰æ‹©å™¨ -->
  <view class="bottom-sheet" wx:if="{{showReportSelector}}">
    <view class="sheet-mask" bindtap="toggleReportSelector"></view>
    <view class="sheet-content" catchtap="stopPropagation">
      <view class="sheet-handle"></view>
      <view class="sheet-header">
        <text class="sheet-title">é€‰æ‹©ä½“æ£€æŠ¥å‘Š</text>
        <view class="sheet-actions">
          <text class="sheet-btn" bindtap="toggleSelectAllReports">å…¨é€‰</text>
          <text class="sheet-btn primary" bindtap="toggleReportSelector">å®Œæˆ</text>
        </view>
      </view>

      <!-- æŠ¥å‘Šåˆ—è¡¨ -->
      <scroll-view class="sheet-list" scroll-y>
        <view class="sheet-item {{selectedReportIds.length === 0 && reportsNoSelection ? 'selected' : ''}}"
              bindtap="selectNoReports">
          <view class="item-icon">ğŸ’¬</view>
          <view class="item-content">
            <text class="item-title">ä¸ä½¿ç”¨æŠ¥å‘Š</text>
            <text class="item-desc">ä»…åŸºäºé—®é¢˜å’¨è¯¢</text>
          </view>
          <view class="item-check {{selectedReportIds.length === 0 && reportsNoSelection ? 'checked' : ''}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>

        <view class="sheet-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{reports}}"
              wx:key="id"
              wx:for-item="report"
              bindtap="toggleReport"
              data-id="{{report.id}}">
          <view class="item-icon">ğŸ“‹</view>
          <view class="item-content">
            <text class="item-title">{{report.hospital}}</text>
            <text class="item-desc">{{report.checkup_date}} Â· {{report.indicators_count}}é¡¹æŒ‡æ ‡</text>
          </view>
          <view class="item-check {{report.selected ? 'checked' : ''}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è¯å•é€‰æ‹©å™¨ -->
  <view class="bottom-sheet" wx:if="{{showMedicationSelector}}">
    <view class="sheet-mask" bindtap="toggleMedicationSelector"></view>
    <view class="sheet-content" catchtap="stopPropagation">
      <view class="sheet-handle"></view>
      <view class="sheet-header">
        <text class="sheet-title">é€‰æ‹©è¯å•</text>
        <view class="sheet-actions">
          <text class="sheet-btn" bindtap="toggleSelectAllMedications">å…¨é€‰</text>
          <text class="sheet-btn primary" bindtap="toggleMedicationSelector">å®Œæˆ</text>
        </view>
      </view>

      <!-- è¯å•åˆ—è¡¨ -->
      <scroll-view class="sheet-list" scroll-y>
        <view class="sheet-item {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'selected' : ''}}"
              bindtap="selectNoMedications">
          <view class="item-icon">ğŸ’¬</view>
          <view class="item-content">
            <text class="item-title">ä¸ä½¿ç”¨è¯å•</text>
            <text class="item-desc">ä»…å’¨è¯¢å¥åº·é—®é¢˜</text>
          </view>
          <view class="item-check {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'checked' : ''}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>

        <view class="sheet-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{medications}}"
              wx:key="id"
              wx:for-item="medication"
              bindtap="toggleMedication"
              data-id="{{medication.id}}">
          <view class="item-icon">ğŸ’Š</view>
          <view class="item-content">
            <text class="item-title">{{medication.medicine_name}}</text>
            <text class="item-desc">{{medication.dosage}}</text>
          </view>
          <view class="item-check {{medication.selected ? 'checked' : ''}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
