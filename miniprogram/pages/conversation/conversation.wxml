<!-- pages/conversation/conversation.wxml -->
<view class="conversation-page app-theme">
  <view class="ambient-layer ambient-a"></view>
  <view class="ambient-layer ambient-b"></view>

  <view class="top-shell">
    <view class="topbar">
      <view class="icon-btn" bindtap="goBack">
        <text class="icon-text">‹</text>
      </view>
      <view class="topbar-center">
        <view class="doctor-badge">
          <image class="doctor-avatar" src="/images/tabbar/ai-active.png" mode="aspectFill"></image>
          <text class="doctor-label">AI</text>
        </view>
        <view class="title-wrap">
          <text class="conv-title">AI 健康医生</text>
          <text class="conv-subtitle">连续对话 · 智能分析</text>
        </view>
      </view>
      <view class="icon-btn top-action-btn" bindtap="showAttachmentMenu">
        <text class="action-label">资料</text>
      </view>
      <view class="icon-btn top-action-btn summary-btn" bindtap="showSummary" wx:if="{{conversationId}}">
        <text class="action-label">总结</text>
      </view>
    </view>

    <view class="meta-strip">
      <view class="mode-pill {{conversationMode === 'continue' ? 'continue' : ''}}">
        <text>{{conversationMode === 'continue' ? '继续对话' : '新对话'}}</text>
      </view>
      <view class="binding-pill">
        <text>{{bindingSummary}}</text>
      </view>
    </view>
  </view>

  <scroll-view class="chat-scroll" scroll-y enable-flex="true" scroll-into-view="{{scrollToView}}" scroll-with-animation>
    <view class="chat-track">
      <view class="msg-row {{item.role === 'user' ? 'outgoing' : 'incoming'}}" wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}">
        <view class="msg-avatar ai" wx:if="{{item.role === 'ai'}}">
          <image class="msg-ai-avatar" src="/images/tabbar/ai-active.png" mode="aspectFill"></image>
        </view>

        <view class="msg-main">
          <view class="msg-card msg-user-card" wx:if="{{item.role === 'user'}}">
            <text class="msg-text user-text">{{item.content}}</text>
          </view>

          <view class="msg-card ai-card {{item.expanded ? 'expanded' : ''}}" wx:else bindtap="toggleExpand" data-index="{{index}}">
            <text class="msg-text ai-text" wx:if="{{!item.expanded}}">{{item.previewText}}</text>
            <rich-text class="msg-rich" wx:else nodes="{{item.markdownData}}"></rich-text>
            <view class="expand-tip" wx:if="{{!item.expanded && item.content && item.content.length > 100}}">
              <text>展开查看完整建议</text>
            </view>
          </view>
          <view class="msg-time">
            <text>{{item.created_at}}</text>
          </view>
        </view>

        <view class="msg-avatar self" wx:if="{{item.role === 'user'}}">
          <image
            wx:if="{{userAvatarUrl && !userAvatarLoadFailed}}"
            class="msg-user-avatar"
            src="{{userAvatarUrl}}"
            mode="aspectFit"
            binderror="onUserAvatarError"
          ></image>
          <text wx:else>{{userDisplayInitial}}</text>
        </view>
      </view>

      <view class="thinking-row" wx:if="{{isGenerating}}" id="msg-thinking">
        <view class="thinking-pulse">
          <view class="pulse-dot pulse-dot-1"></view>
          <view class="pulse-dot pulse-dot-2"></view>
          <view class="pulse-dot pulse-dot-3"></view>
        </view>
        <text class="thinking-label">AI 正在分析中...</text>
      </view>
    </view>
  </scroll-view>

  <view class="quick-select-bar">
    <view class="quick-select-item {{selectedReportIds.length > 0 ? 'selected' : ''}}" bindtap="openReportSelector">
      <text class="quick-select-icon">检</text>
      <text class="quick-select-label">体检报告</text>
      <text class="quick-select-count" wx:if="{{selectedReportIds.length > 0}}">{{selectedReportIds.length}}</text>
    </view>
    <view class="quick-select-item {{selectedMedicationIds.length > 0 ? 'selected' : ''}}" bindtap="openMedicationSelector">
      <text class="quick-select-icon">药</text>
      <text class="quick-select-label">药单</text>
      <text class="quick-select-count" wx:if="{{selectedMedicationIds.length > 0}}">{{selectedMedicationIds.length}}</text>
    </view>
    <view class="quick-select-item {{selectedEventId ? 'selected' : ''}}" bindtap="openEventSelector">
      <text class="quick-select-icon">事</text>
      <text class="quick-select-label">健康事件</text>
      <text class="quick-select-count" wx:if="{{selectedEventId}}">1</text>
    </view>
  </view>

  <view class="composer-shell">
    <view class="composer">
      <view class="attach-trigger" bindtap="showAttachmentMenu">
        <text class="attach-symbol">＋</text>
      </view>

      <view class="composer-input-wrap">
        <textarea
          class="composer-input"
          value="{{inputText}}"
          bindinput="onInputChange"
          placeholder="告诉我你现在的症状、疑问或目标..."
          maxlength="1000"
          auto-height
          adjust-position="{{true}}"
          show-confirm-bar="{{false}}"
          cursor-spacing="24"
        />
      </view>

      <view class="send-trigger {{inputText.trim().length > 0 && !sending ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-label">发送</text>
      </view>
    </view>
  </view>

  <view class="overlay-menu" wx:if="{{showAttachmentMenu}}" bindtap="hideAttachmentMenu">
    <view class="overlay-mask" bindtap="hideAttachmentMenu"></view>
    <view class="menu-panel" catchtap="stopPropagation">
      <view class="menu-head">
        <text class="menu-title">添加参考资料</text>
      </view>
      <view class="menu-grid">
        <view class="menu-option" bindtap="openReportSelector">
          <view class="option-icon">检</view>
          <text class="option-title">体检报告</text>
          <text class="option-count" wx:if="{{selectedReportIds.length > 0}}">{{selectedReportIds.length}}</text>
        </view>
        <view class="menu-option" bindtap="openMedicationSelector">
          <view class="option-icon">药</view>
          <text class="option-title">药单信息</text>
          <text class="option-count" wx:if="{{selectedMedicationIds.length > 0}}">{{selectedMedicationIds.length}}</text>
        </view>
        <view class="menu-option" bindtap="openEventSelector">
          <view class="option-icon">事</view>
          <text class="option-title">健康事件</text>
          <text class="option-count" wx:if="{{selectedEventId}}">1</text>
        </view>
      </view>
    </view>
  </view>

  <view class="selector-overlay" wx:if="{{activeSelector}}">
    <view class="selector-mask" bindtap="closeSelector"></view>
    <view class="selector-panel" catchtap="stopPropagation">
      <view class="selector-handle"></view>
      <view class="selector-head">
        <text class="selector-title">{{activeSelectorTitle}}</text>
        <view class="selector-actions">
          <text class="selector-btn" bindtap="toggleSelectAllCurrent">全选</text>
          <text class="selector-btn primary" bindtap="closeSelector">完成</text>
        </view>
      </view>

      <view class="selector-status" wx:if="{{activeSelectorLoading}}">
        <text>加载中...</text>
      </view>
      <view class="selector-status error" wx:elif="{{activeSelectorError}}">
        <text>{{activeSelectorError}}</text>
        <text class="retry-action" bindtap="retryActiveSelector">重试</text>
      </view>

      <scroll-view class="selector-list" wx:else scroll-y>
        <view class="selector-item {{activeSelectorNoSelection ? 'selected' : ''}}" bindtap="selectNoCurrent">
          <view class="selector-item-icon">无</view>
          <view class="selector-item-content">
            <text class="selector-item-title">{{activeSelectorNoSelectionTitle}}</text>
            <text class="selector-item-desc">{{activeSelectorNoSelectionDesc}}</text>
          </view>
          <view class="selector-check {{activeSelectorNoSelection ? 'checked' : ''}}">
            <text class="selector-check-text">✓</text>
          </view>
        </view>

        <view
          class="selector-item {{item.selected ? 'selected' : ''}}"
          wx:for="{{activeSelectorItems}}"
          wx:key="id"
          bindtap="toggleSelectorItem"
          data-id="{{item.id}}"
        >
          <view class="selector-item-icon">{{item.icon}}</view>
          <view class="selector-item-content">
            <text class="selector-item-title">{{item.title}}</text>
            <text class="selector-item-desc">{{item.desc}}</text>
          </view>
          <view class="selector-check {{item.selected ? 'checked' : ''}}">
            <text class="selector-check-text">✓</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- AI 总结弹窗 -->
  <view class="summary-modal" wx:if="{{showSummaryModal}}" bindtap="hideSummaryModal">
    <view class="summary-modal-content" catchtap="stopPropagation">
      <view class="summary-modal-header">
        <text class="summary-modal-title">AI 对话总结</text>
        <view class="summary-header-actions">
          <text class="regenerate-btn" wx:if="{{aiSummary && !aiSummaryLoading}}" bindtap="generateSummary">重新生成</text>
          <text class="summary-modal-close" bindtap="hideSummaryModal">✕</text>
        </view>
      </view>

      <view class="summary-modal-body">
        <view class="summary-loading" wx:if="{{aiSummaryLoading && !aiSummary}}">
          <text class="loading-text">正在生成AI总结...</text>
        </view>

        <view class="summary-content streaming" wx:elif="{{aiSummary}}">
          <text>{{aiSummary}}</text>
          <view class="streaming-indicator" wx:if="{{aiSummaryLoading}}">
            <text>生成中...</text>
          </view>
        </view>

        <view class="summary-error" wx:elif="{{aiSummaryError}}">
          <text class="error-text">{{aiSummaryError}}</text>
          <button class="retry-btn" bindtap="generateSummary">重新生成</button>
        </view>

        <view class="summary-empty" wx:else>
          <text class="empty-text">暂无AI总结</text>
          <button class="generate-btn" bindtap="generateSummary">生成总结</button>
        </view>
      </view>

      <view class="summary-modal-footer" wx:if="{{aiSummary && !aiSummaryLoading}}">
        <button class="export-btn pdf-btn" bindtap="exportSummaryPdf">导出 PDF</button>
        <button class="export-btn word-btn" bindtap="exportSummaryWord">导出 Word</button>
      </view>
    </view>
  </view>
</view>
