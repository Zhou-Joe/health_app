<!-- pages/conversation/conversation.wxml -->
<view class="chat-container app-theme">
  <view class="bg-decoration"></view>

  <view class="chat-header">
    <view class="header-back" bindtap="goBack">
      <text class="back-icon">‹</text>
    </view>

    <view class="header-center">
      <image class="ai-avatar" src="/images/doctor-avatar.svg" mode="aspectFit"></image>
      <text class="header-title">AI 健康医生</text>
      <text class="header-subtitle">连续对话 · 智能分析</text>
    </view>

    <view class="header-right">
      <view class="header-btn" bindtap="toggleReportSelector">
        <text class="btn-text">报告</text>
      </view>
      <view class="header-btn" bindtap="toggleMedicationSelector">
        <text class="btn-text">药单</text>
      </view>
    </view>
  </view>

  <view class="chat-meta">
    <view class="meta-chip mode {{conversationMode === 'continue' ? 'continue' : ''}}">
      <text>{{conversationMode === 'continue' ? '继续对话' : '新对话'}}</text>
    </view>
    <view class="meta-chip">
      <text>报告 {{selectedReportIds.length}}</text>
    </view>
    <view class="meta-chip">
      <text>药单 {{selectedMedicationIds.length}}</text>
    </view>
  </view>

  <scroll-view class="message-list" scroll-y scroll-into-view="{{scrollToView}}" scroll-with-animation>
    <view class="message-wrapper" wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}">
      <view class="message-bubble user-message" wx:if="{{item.role === 'user'}}">
        <view class="bubble-content" bindtap="toggleExpand" data-index="{{index}}">
          <text class="message-text">{{item.content}}</text>
          <view class="bubble-tail"></view>
        </view>
      </view>

      <view class="message-bubble ai-message" wx:else>
        <view class="ai-indicator"></view>
        <view class="bubble-content {{item.expanded ? 'expanded' : ''}}" bindtap="toggleExpand" data-index="{{index}}">
          <text class="message-text" wx:if="{{!item.expanded}}">{{item.previewText}}</text>
          <rich-text class="message-html" wx:else nodes="{{item.markdownData}}"></rich-text>
          <view class="bubble-tail"></view>
          <view class="expand-hint" wx:if="{{!item.expanded && item.content && item.content.length > 100}}">
            <text>点击展开</text>
          </view>
        </view>
      </view>

      <view class="message-time">
        <text>{{item.created_at}}</text>
      </view>
    </view>

    <view class="thinking-indicator" wx:if="{{isGenerating}}" id="msg-thinking">
      <view class="thinking-dots">
        <view class="dot dot-1"></view>
        <view class="dot dot-2"></view>
        <view class="dot dot-3"></view>
      </view>
      <text class="thinking-text">AI 正在思考...</text>
    </view>
  </scroll-view>

  <view class="input-area">
    <view class="attach-btn" bindtap="showAttachmentMenu">
      <text class="attach-icon">+</text>
    </view>

    <view class="input-wrapper">
      <textarea
        class="message-input"
        value="{{inputText}}"
        bindinput="onInputChange"
        bindfocus="onInputFocus"
        bindblur="onInputBlur"
        placeholder="输入你的健康问题..."
        maxlength="1000"
        auto-height
        adjust-position="{{true}}"
        show-confirm-bar="{{false}}"
        cursor-spacing="24"
      />
    </view>

    <view class="send-btn {{inputText.trim().length > 0 && !sending ? 'active' : ''}}" bindtap="sendMessage">
      <text class="send-icon">发送</text>
    </view>
  </view>

  <view class="attachment-menu" wx:if="{{showAttachmentMenu}}" bindtap="hideAttachmentMenu">
    <view class="menu-mask" bindtap="hideAttachmentMenu"></view>
    <view class="menu-content" catchtap="stopPropagation">
      <view class="menu-item" bindtap="openReportSelector">
        <view class="menu-icon">报</view>
        <text class="menu-text">体检报告</text>
        <text class="menu-badge" wx:if="{{selectedReportIds.length > 0}}">{{selectedReportIds.length}}</text>
      </view>

      <view class="menu-item" bindtap="openMedicationSelector">
        <view class="menu-icon">药</view>
        <text class="menu-text">药单信息</text>
        <text class="menu-badge" wx:if="{{selectedMedicationIds.length > 0}}">{{selectedMedicationIds.length}}</text>
      </view>
    </view>
  </view>

  <view class="bottom-sheet" wx:if="{{showReportSelector}}">
    <view class="sheet-mask" bindtap="toggleReportSelector"></view>
    <view class="sheet-content" catchtap="stopPropagation">
      <view class="sheet-handle"></view>
      <view class="sheet-header">
        <text class="sheet-title">选择体检报告</text>
        <view class="sheet-actions">
          <text class="sheet-btn" bindtap="toggleSelectAllReports">全选</text>
          <text class="sheet-btn primary" bindtap="toggleReportSelector">完成</text>
        </view>
      </view>

      <scroll-view class="sheet-list" scroll-y>
        <view class="sheet-item {{selectedReportIds.length === 0 && reportsNoSelection ? 'selected' : ''}}" bindtap="selectNoReports">
          <view class="item-icon">无</view>
          <view class="item-content">
            <text class="item-title">不使用报告</text>
            <text class="item-desc">仅基于问题咨询</text>
          </view>
          <view class="item-check {{selectedReportIds.length === 0 && reportsNoSelection ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>

        <view
          class="sheet-item {{report.selected ? 'selected' : ''}}"
          wx:for="{{reports}}"
          wx:key="id"
          wx:for-item="report"
          bindtap="toggleReport"
          data-id="{{report.id}}"
        >
          <view class="item-icon">检</view>
          <view class="item-content">
            <text class="item-title">{{report.hospital}}</text>
            <text class="item-desc">{{report.checkup_date}} · {{report.indicators_count}} 项指标</text>
          </view>
          <view class="item-check {{report.selected ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="bottom-sheet" wx:if="{{showMedicationSelector}}">
    <view class="sheet-mask" bindtap="toggleMedicationSelector"></view>
    <view class="sheet-content" catchtap="stopPropagation">
      <view class="sheet-handle"></view>
      <view class="sheet-header">
        <text class="sheet-title">选择药单</text>
        <view class="sheet-actions">
          <text class="sheet-btn" bindtap="toggleSelectAllMedications">全选</text>
          <text class="sheet-btn primary" bindtap="toggleMedicationSelector">完成</text>
        </view>
      </view>

      <scroll-view class="sheet-list" scroll-y>
        <view class="sheet-item {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'selected' : ''}}" bindtap="selectNoMedications">
          <view class="item-icon">无</view>
          <view class="item-content">
            <text class="item-title">不使用药单</text>
            <text class="item-desc">仅咨询健康问题</text>
          </view>
          <view class="item-check {{selectedMedicationIds.length === 0 && medicationsNoSelection ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>

        <view
          class="sheet-item {{medication.selected ? 'selected' : ''}}"
          wx:for="{{medications}}"
          wx:key="id"
          wx:for-item="medication"
          bindtap="toggleMedication"
          data-id="{{medication.id}}"
        >
          <view class="item-icon">药</view>
          <view class="item-content">
            <text class="item-title">{{medication.medicine_name}}</text>
            <text class="item-desc">{{medication.dosage}}</text>
          </view>
          <view class="item-check {{medication.selected ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
