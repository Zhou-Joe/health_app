<!--pages/medications/medications.wxml-->
<view class="container app-theme">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æˆ‘çš„è¯å•</text>
    <view class="header-actions">
      <button class="action-btn" bindtap="showClusterModal">
        <text class="icon">ğŸ“¦</text>
        <text>åˆ›å»ºè¯å•ç»„</text>
      </button>
      <button class="add-btn" bindtap="showAddModal">
        <view class="add-btn-content">
          <text class="icon">+</text>
          <text>æ·»åŠ è¯å•</text>
        </view>
      </button>
    </view>
  </view>

  <!-- è¯å•ç»„åˆ—è¡¨ -->
  <view class="section" wx:if="{{groups.length > 0}}">
    <view class="section-header">
      <text class="section-title">è¯å•ç»„</text>
      <button class="auto-cluster-btn" bindtap="autoCluster">è‡ªåŠ¨èšç±»</button>
    </view>
    <view class="group-list">
      <view class="group-card" wx:for="{{groups}}" wx:key="id">
        <!-- è¯å•ç»„å¤´éƒ¨ -->
        <view class="group-header" bindtap="toggleGroup" data-id="{{item.id}}">
          <view class="group-info">
            <text class="group-name">{{item.name}}</text>
            <text class="group-count">{{item.medication_count}} ä¸ªè¯ç‰©</text>
          </view>
          <view class="group-actions">
            <text class="expand-icon {{expandedGroups[item.id] ? 'expanded' : ''}}">â–¼</text>
          </view>
        </view>

        <!-- è¯å•ç»„å¤‡æ³¨ -->
        <view class="group-summary" wx:if="{{item.ai_summary}}">
          <text>{{item.ai_summary}}</text>
        </view>

        <!-- å±•å¼€çš„è¯ç‰©åˆ—è¡¨ -->
        <view class="group-medications" wx:if="{{expandedGroups[item.id]}}">
          <view class="medication-mini-card" wx:for="{{item.medications}}" wx:for-item="med" wx:key="id">
            <view class="med-info">
              <text class="med-name">{{med.medicine_name}}</text>
              <text class="med-dosage">{{med.dosage}}</text>
            </view>
            <view class="med-progress">
              <text>{{med.days_taken}}/{{med.total_days}}å¤©</text>
            </view>
          </view>

          <!-- è¯å•ç»„æ“ä½œæŒ‰é’® -->
          <view class="group-action-buttons">
            <button class="group-checkin-btn" bindtap="groupCheckin" data-id="{{item.id}}">
              <text class="icon">âœ“</text>
              <text>æ‰¹é‡ç­¾åˆ°</text>
            </button>
            <button class="group-edit-btn" bindtap="showEditGroupModal" data-group="{{item}}">
              <text class="icon">âœï¸</text>
              <text>ç¼–è¾‘</text>
            </button>
            <button class="group-delete-btn" bindtap="deleteGroup" data-id="{{item.id}}">
              <text class="icon">ğŸ—‘ï¸</text>
              <text>åˆ é™¤</text>
            </button>
          </view>
        </view>

        <!-- æœªå±•å¼€æ—¶çš„å¿«æ·æ“ä½œ -->
        <view class="group-quick-actions" wx:else>
          <button class="quick-checkin-btn" bindtap="groupCheckin" data-id="{{item.id}}">
            æ‰¹é‡ç­¾åˆ°
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç‹¬ç«‹è¯å•åˆ—è¡¨ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">ç‹¬ç«‹è¯å•</text>
      <text class="section-count">{{medications.length}} ä¸ª</text>
    </view>
    
    <view class="medication-list" wx:if="{{medications.length > 0}}">
      <view class="medication-card"
            wx:for="{{medications}}"
            wx:key="id">
        <!-- è¯å•å¤´éƒ¨ -->
        <view class="card-header">
          <view class="medicine-info">
            <text class="medicine-name">{{item.medicine_name}}</text>
            <text class="dosage">{{item.dosage}}</text>
          </view>
          <view class="actions">
            <text class="delete-btn" bindtap="deleteMedication" data-id="{{item.id}}">åˆ é™¤</text>
          </view>
        </view>

        <!-- è¿›åº¦ä¿¡æ¯ -->
        <view class="progress-section">
          <view class="progress-info">
            <text class="progress-text">æœè¯è¿›åº¦ï¼š{{item.days_taken}}/{{item.total_days}}å¤©</text>
            <text class="progress-percent">{{item.progress_percentage}}%</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.progress_percentage}}%"></view>
          </view>
        </view>

        <!-- æ—¥æœŸä¿¡æ¯ -->
        <view class="date-section">
          <view class="date-item">
            <text class="date-label">å¼€å§‹æ—¥æœŸ</text>
            <text class="date-value">{{item.start_date}}</text>
          </view>
          <view class="date-item">
            <text class="date-label">ç»“æŸæ—¥æœŸ</text>
            <text class="date-value">{{item.end_date}}</text>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="notes-section" wx:if="{{item.notes}}">
          <text class="notes-label">å¤‡æ³¨ï¼š</text>
          <text class="notes-text">{{item.notes}}</text>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="card-actions">
          <button class="checkin-btn primary-btn" bindtap="checkin" data-id="{{item.id}}">
            <text class="icon">âœ“</text>
            <text>ä»Šæ—¥ç­¾åˆ°</text>
          </button>
          <button class="records-btn secondary-btn" bindtap="viewRecords" data-id="{{item.id}}">
            <text class="icon">ğŸ“‹</text>
            <text>æœè¯è®°å½•</text>
          </button>
          <picker class="makeup-btn secondary-btn" mode="date" end="{{today}}" bindchange="onMakeupDateChange" data-id="{{item.id}}">
            <text class="icon">ğŸ“…</text>
            <text>è¡¥ç­¾</text>
          </picker>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <text class="empty-icon">ğŸ’Š</text>
      <text class="empty-text">è¿˜æ²¡æœ‰ç‹¬ç«‹è¯å•</text>
      <text class="empty-desc">ç‚¹å‡»"æ·»åŠ è¯å•"å¼€å§‹è®°å½•æ‚¨çš„æœè¯æƒ…å†µ</text>
    </view>
  </view>
</view>

<!-- æ·»åŠ è¯å•å¼¹çª— -->
<view class="modal" wx:if="{{showAddModal}}">
  <view class="modal-mask" bindtap="hideAddModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ è¯å•</text>
      <text class="modal-close" bindtap="hideAddModal">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">è¯å *</text>
        <input class="form-input"
               placeholder="è¯·è¾“å…¥è¯å"
               value="{{formData.medicine_name}}"
               bindinput="onMedicineNameInput" />
      </view>
      <view class="form-item">
        <text class="form-label">æœè¯æ–¹å¼ *</text>
        <input class="form-input"
               placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥1æ¬¡ï¼Œæ¯æ¬¡1ç‰‡ï¼Œé¥­åæœç”¨"
               value="{{formData.dosage}}"
               bindinput="onDosageInput" />
      </view>
      <view class="form-item">
        <text class="form-label">å¼€å§‹æ—¥æœŸ *</text>
        <picker mode="date"
                value="{{formData.start_date}}"
                bindchange="onStartDateChange">
          <view class="picker-input">
            {{formData.start_date || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">ç»“æŸæ—¥æœŸ *</text>
        <picker mode="date"
                value="{{formData.end_date}}"
                bindchange="onEndDateChange">
          <view class="picker-input">
            {{formData.end_date || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea"
                  placeholder="ä¾‹å¦‚ï¼šåŒ»ç”Ÿå»ºè®®ã€æ³¨æ„äº‹é¡¹ç­‰"
                  value="{{formData.notes}}"
                  bindinput="onNotesInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="hideAddModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm-btn" bindtap="saveMedication">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- åˆ›å»ºè¯å•ç»„å¼¹çª— -->
<view class="modal" wx:if="{{showClusterModal}}">
  <view class="modal-mask" bindtap="hideClusterModal"></view>
  <view class="modal-content cluster-modal">
    <view class="modal-header">
      <text class="modal-title">åˆ›å»ºè¯å•ç»„</text>
      <text class="modal-close" bindtap="hideClusterModal">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">è¯å•ç»„åç§°</text>
        <input class="form-input"
               placeholder="å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ—¥æœŸå‘½å"
               value="{{clusterFormData.name}}"
               bindinput="onClusterNameInput" />
      </view>
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea"
                  placeholder="å¯é€‰ï¼Œæ·»åŠ è¯å•ç»„è¯´æ˜"
                  value="{{clusterFormData.notes}}"
                  bindinput="onClusterNotesInput" />
      </view>
      <view class="form-item">
        <text class="form-label">é€‰æ‹©è¯ç‰© *</text>
        <view class="medication-select-list" wx:if="{{ungroupedMedications.length > 0}}">
          <view class="medication-select-item {{item.selected ? 'selected' : ''}}"
                wx:for="{{ungroupedMedications}}"
                wx:key="id"
                bindtap="toggleMedicationSelect"
                data-id="{{item.id}}">
            <view class="select-checkbox">
              <text wx:if="{{item.selected}}">âœ“</text>
            </view>
            <view class="select-info">
              <text class="select-name">{{item.medicine_name}}</text>
              <text class="select-dosage">{{item.dosage}}</text>
            </view>
          </view>
        </view>
        <view class="empty-select" wx:else>
          <text>æ²¡æœ‰å¯é€‰çš„ç‹¬ç«‹è¯å•</text>
        </view>
      </view>
      <view class="selected-count" wx:if="{{selectedCount > 0}}">
        å·²é€‰æ‹© {{selectedCount}} ä¸ªè¯ç‰©
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="hideClusterModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm-btn" bindtap="createCluster">åˆ›å»ºè¯å•ç»„</button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘è¯å•ç»„å¼¹çª— -->
<view class="modal" wx:if="{{showEditGroupModal}}">
  <view class="modal-mask" bindtap="hideEditGroupModal"></view>
  <view class="modal-content cluster-modal">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘è¯å•ç»„</text>
      <text class="modal-close" bindtap="hideEditGroupModal">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">è¯å•ç»„åç§°</text>
        <input class="form-input"
               value="{{editGroupData.name}}"
               bindinput="onEditGroupNameInput" />
      </view>
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea"
                  value="{{editGroupData.notes}}"
                  bindinput="onEditGroupNotesInput" />
      </view>
      
      <!-- å½“å‰è¯ç‰©åˆ—è¡¨ -->
      <view class="form-item">
        <text class="form-label">å½“å‰è¯ç‰© ({{editGroupData.medications.length}}ä¸ª)</text>
        <view class="current-medications-list">
          <view class="current-med-item" wx:for="{{editGroupData.medications}}" wx:key="id">
            <text class="med-name">{{item.medicine_name}}</text>
            <text class="remove-med-btn" bindtap="removeMedFromGroup" data-id="{{item.id}}">ç§»é™¤</text>
          </view>
        </view>
      </view>

      <!-- æ·»åŠ è¯ç‰© -->
      <view class="form-item" wx:if="{{availableMedications.length > 0}}">
        <text class="form-label">æ·»åŠ è¯ç‰©</text>
        <view class="medication-select-list">
          <view class="medication-select-item {{item.selected ? 'selected' : ''}}"
                wx:for="{{availableMedications}}"
                wx:key="id"
                bindtap="toggleAvailableMedSelect"
                data-id="{{item.id}}">
            <view class="select-checkbox">
              <text wx:if="{{item.selected}}">âœ“</text>
            </view>
            <view class="select-info">
              <text class="select-name">{{item.medicine_name}}</text>
              <text class="select-dosage">{{item.dosage}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="hideEditGroupModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm-btn" bindtap="updateGroup">ä¿å­˜ä¿®æ”¹</button>
    </view>
  </view>
</view>

<!-- æœè¯è®°å½•å¼¹çª— -->
<view class="modal" wx:if="{{showRecordsModal}}">
  <view class="modal-mask" bindtap="hideRecordsModal"></view>
  <view class="modal-content records-modal">
    <view class="modal-header">
      <text class="modal-title">æœè¯è®°å½•</text>
      <text class="modal-close" bindtap="hideRecordsModal">âœ•</text>
    </view>
    <view class="modal-body">
      <scroll-view class="records-list" scroll-y wx:if="{{records.length > 0}}">
        <view class="record-item" wx:for="{{records}}" wx:key="id">
          <view class="record-header">
            <text class="record-date">{{item.record_date}}</text>
            <text class="record-time">{{item.taken_at}}</text>
          </view>
          <view class="record-frequency">
            <text class="frequency-badge">{{item.frequency_display}}</text>
          </view>
          <text class="record-notes" wx:if="{{item.notes}}">{{item.notes}}</text>
        </view>
      </scroll-view>
      <view class="empty-records" wx:else>
        <text class="empty-text">æš‚æ— æœè¯è®°å½•</text>
      </view>
    </view>
  </view>
</view>
