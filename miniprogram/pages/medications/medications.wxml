<!--pages/medications/medications.wxml-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æˆ‘çš„è¯å•</text>
    <button class="add-btn" bindtap="showAddModal">
      <view class="add-btn-content">
        <text class="icon">+</text>
        <text>æ·»åŠ è¯å•</text>
      </view>
    </button>
  </view>

  <!-- è¯å•åˆ—è¡¨ -->
  <view class="medication-list" wx:if="{{medications.length > 0}}">
    <view class="medication-card"
          wx:for="{{medications}}"
          wx:key="id">
      <!-- è¯å•å¤´éƒ¨ -->
      <view class="card-header">
        <view class="medicine-info">
          <text class="medicine-name">{{item.medicine_name}}</text>
          <text class="dosage">{{item.dosage}}</text>
        </view>
        <view class="actions">
          <text class="delete-btn" bindtap="deleteMedication" data-id="{{item.id}}">åˆ é™¤</text>
        </view>
      </view>

      <!-- è¿›åº¦ä¿¡æ¯ -->
      <view class="progress-section">
        <view class="progress-info">
          <text class="progress-text">æœè¯è¿›åº¦ï¼š{{item.days_taken}}/{{item.total_days}}å¤©</text>
          <text class="progress-percent">{{item.progress_percentage}}%</text>
        </view>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{item.progress_percentage}}%"></view>
        </view>
      </view>

      <!-- æ—¥æœŸä¿¡æ¯ -->
      <view class="date-section">
        <view class="date-item">
          <text class="date-label">å¼€å§‹æ—¥æœŸ</text>
          <text class="date-value">{{item.start_date}}</text>
        </view>
        <view class="date-item">
          <text class="date-label">ç»“æŸæ—¥æœŸ</text>
          <text class="date-value">{{item.end_date}}</text>
        </view>
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="notes-section" wx:if="{{item.notes}}">
        <text class="notes-label">å¤‡æ³¨ï¼š</text>
        <text class="notes-text">{{item.notes}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="card-actions">
        <button class="checkin-btn primary-btn" bindtap="checkin" data-id="{{item.id}}">
          <text class="icon">âœ“</text>
          <text>ä»Šæ—¥ç­¾åˆ°</text>
        </button>
        <button class="records-btn secondary-btn" bindtap="viewRecords" data-id="{{item.id}}">
          <text class="icon">ğŸ“‹</text>
          <text>æœè¯è®°å½•</text>
        </button>
        <button class="makeup-btn secondary-btn" bindtap="showMakeupModal" data-id="{{item.id}}">
          <text class="icon">ğŸ“…</text>
          <text>è¡¥ç­¾</text>
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ’Š</text>
    <text class="empty-text">è¿˜æ²¡æœ‰è¯å•</text>
    <text class="empty-desc">ç‚¹å‡»"æ·»åŠ è¯å•"å¼€å§‹è®°å½•æ‚¨çš„æœè¯æƒ…å†µ</text>
    <button class="empty-add-btn" bindtap="showAddModal">
      <text>æ·»åŠ ç¬¬ä¸€ä¸ªè¯å•</text>
    </button>
  </view>
</view>

<!-- æ·»åŠ è¯å•å¼¹çª— -->
<view class="modal" wx:if="{{showAddModal}}">
  <view class="modal-mask" bindtap="hideAddModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ è¯å•</text>
      <text class="modal-close" bindtap="hideAddModal">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">è¯å *</text>
        <input class="form-input"
               placeholder="è¯·è¾“å…¥è¯å"
               value="{{formData.medicine_name}}"
               bindinput="onMedicineNameInput" />
      </view>
      <view class="form-item">
        <text class="form-label">æœè¯æ–¹å¼ *</text>
        <input class="form-input"
               placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥1æ¬¡ï¼Œæ¯æ¬¡1ç‰‡ï¼Œé¥­åæœç”¨"
               value="{{formData.dosage}}"
               bindinput="onDosageInput" />
      </view>
      <view class="form-item">
        <text class="form-label">å¼€å§‹æ—¥æœŸ *</text>
        <picker mode="date"
                value="{{formData.start_date}}"
                bindchange="onStartDateChange">
          <view class="picker-input">
            {{formData.start_date || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">ç»“æŸæ—¥æœŸ *</text>
        <picker mode="date"
                value="{{formData.end_date}}"
                bindchange="onEndDateChange">
          <view class="picker-input">
            {{formData.end_date || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea"
                  placeholder="ä¾‹å¦‚ï¼šåŒ»ç”Ÿå»ºè®®ã€æ³¨æ„äº‹é¡¹ç­‰"
                  value="{{formData.notes}}"
                  bindinput="onNotesInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="hideAddModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm-btn" bindtap="saveMedication">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æœè¯è®°å½•å¼¹çª— -->
<view class="modal" wx:if="{{showRecordsModal}}">
  <view class="modal-mask" bindtap="hideRecordsModal"></view>
  <view class="modal-content records-modal">
    <view class="modal-header">
      <text class="modal-title">æœè¯è®°å½•</text>
      <text class="modal-close" bindtap="hideRecordsModal">âœ•</text>
    </view>
    <view class="modal-body">
      <scroll-view class="records-list" scroll-y wx:if="{{records.length > 0}}">
        <view class="record-item" wx:for="{{records}}" wx:key="id">
          <view class="record-header">
            <text class="record-date">{{item.record_date}}</text>
            <text class="record-time">{{item.taken_at}}</text>
          </view>
          <view class="record-frequency">
            <text class="frequency-badge">{{item.frequency_display}}</text>
          </view>
          <text class="record-notes" wx:if="{{item.notes}}">{{item.notes}}</text>
        </view>
      </scroll-view>
      <view class="empty-records" wx:else>
        <text class="empty-text">æš‚æ— æœè¯è®°å½•</text>
      </view>
    </view>
  </view>
</view>

<!-- è¡¥ç­¾å¼¹çª— -->
<view class="modal" wx:if="{{showMakeupModal}}">
  <view class="modal-mask" bindtap="hideMakeupModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">è¡¥ç­¾</text>
      <text class="modal-close" bindtap="hideMakeupModal">âœ•</text>
    </view>
    <view class="modal-body">
      <picker mode="date" value="{{makeupDate}}" end="{{today}}" bindchange="onMakeupDateChange">
        <view class="date-picker-btn">
          <text class="date-picker-icon">ğŸ“…</text>
          <text class="date-picker-text">{{makeupDate || 'é€‰æ‹©è¡¥ç­¾æ—¥æœŸ'}}</text>
        </view>
      </picker>
    </view>
  </view>
</view>
