<!--pages/dashboard/dashboard.wxml-->
<view class="dashboard-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="blob blob-1"></view>
    <view class="blob blob-2"></view>
    <view class="blob blob-3"></view>
  </view>

  <!-- é¡¶éƒ¨ï¼šä¸å¯¹ç§°å¸ƒå±€ -->
  <view class="top-section">
    <view class="welcome-card">
      <view class="date-badge">
        <text class="day-text">{{currentDay}}</text>
        <text class="month-text">{{currentMonth}}</text>
      </view>
      <view class="welcome-text">
        <text class="greeting-main">Hi~</text>
        <text class="greeting-sub">{{userInfo.first_name || userInfo.username || 'ç”¨æˆ·'}}</text>
      </view>
    </view>

    <view class="avatar-section" bindtap="goToSettings">
      <view class="avatar-ring">
        <image wx:if="{{userInfo.avatar_url}}"
               class="avatar-image"
               src="{{userInfo.avatar_url}}"
               mode="aspectFill"></image>
        <text wx:else class="avatar-emoji">{{userInfo.avatar || 'âœ¨'}}</text>
      </view>
      <view class="settings-dot"></view>
    </view>
  </view>

  <!-- å¥åº·è¯„åˆ†å¤§å¡ç‰‡ - è§†è§‰ç„¦ç‚¹ -->
  <view class="health-score-card" bindtap="goToCheckups">
    <view class="score-header">
      <view class="score-title-group">
        <text class="score-emoji">ğŸ’“</text>
        <text class="score-title">å¥åº·æŒ‡æ•°</text>
      </view>
      <view class="score-trend">
        <text class="trend-icon">{{healthTrend === 'up' ? 'â†—' : 'â†’'}}</text>
      </view>
    </view>

    <view class="score-display">
      <view class="score-circle">
        <text class="score-value">{{healthScore}}</text>
        <text class="score-max">/100</text>
      </view>
    </view>

    <view class="score-details">
      <view class="detail-item">
        <text class="detail-dot"></text>
        <text class="detail-text">{{scoreComment}}</text>
      </view>
    </view>
  </view>

  <!-- æ•°æ®å¡ç‰‡ - æ¨ªå‘æ»šåŠ¨ï¼Œæ‰“ç ´ç½‘æ ¼ -->
  <view class="stats-scroll">
    <view class="stat-card stat-primary" bindtap="goToCheckups">
      <view class="stat-inner">
        <text class="stat-number">{{stats.checkupCount}}</text>
        <text class="stat-label">ä»½æŠ¥å‘Š</text>
        <view class="stat-icon-bg">ğŸ“‹</view>
      </view>
    </view>

    <view class="stat-card stat-secondary" bindtap="goToCheckups">
      <view class="stat-inner">
        <text class="stat-number">{{stats.indicatorCount}}</text>
        <text class="stat-label">é¡¹æŒ‡æ ‡</text>
        <view class="stat-icon-bg">ğŸ“Š</view>
      </view>
    </view>

    <view class="stat-card stat-accent" bindtap="goToConversations">
      <view class="stat-inner">
        <text class="stat-number">{{stats.conversationCount}}</text>
        <text class="stat-label">æ¬¡å’¨è¯¢</text>
        <view class="stat-icon-bg">ğŸ’¬</view>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œ - å¤§æŒ‰é’®ç½‘æ ¼ -->
  <view class="actions-grid">
    <view class="action-card action-upload" bindtap="goToUpload">
      <view class="action-bg-circle"></view>
      <text class="action-emoji">ğŸ“„</text>
      <text class="action-title">ä¸Šä¼ </text>
    </view>

    <view class="action-card action-ai" bindtap="goToAIAdvice">
      <view class="action-bg-circle"></view>
      <text class="action-emoji">ğŸ¤–</text>
      <text class="action-title">AIåŒ»ç”Ÿ</text>
    </view>

    <view class="action-card action-meds" bindtap="goToMedications">
      <view class="action-bg-circle"></view>
      <text class="action-emoji">ğŸ’Š</text>
      <text class="action-title">è¯å•</text>
    </view>

    <view class="action-card action-integration" bindtap="goToIntegration">
      <view class="action-bg-circle"></view>
      <text class="action-emoji">ğŸ”„</text>
      <text class="action-title">æ•´åˆ</text>
    </view>

    <view class="action-card action-trends" bindtap="goToTrends">
      <view class="action-bg-circle"></view>
      <text class="action-emoji">ğŸ“ˆ</text>
      <text class="action-title">è¶‹åŠ¿</text>
    </view>
  </view>

  <!-- å¥åº·äº‹ä»¶æ—¶é—´è½´ -->
  <view class="events-section">
    <view class="section-header">
      <text class="section-title">äº‹ä»¶æ—¶é—´è½´</text>
      <view class="section-line"></view>
      <text class="section-more"
            bindtap="autoAggregateEvents">
        {{autoAggregating ? 'æ•´åˆä¸­...' : 'ä¸€é”®è‡ªåŠ¨æ•´åˆ'}}
      </text>
    </view>

    <view class="aggregate-tip" wx:if="{{showAggregateTip}}">
      <view class="aggregate-tip-content">
        <text class="aggregate-tip-title">ä¸çŸ¥é“è¿™ä¸ªåŠŸèƒ½ï¼Ÿ</text>
        <text class="aggregate-tip-text">å¯æŒ‰æ—¶é—´è‡ªåŠ¨èšåˆä½“æ£€å’Œè¯å•ï¼Œç”Ÿæˆç»“æ„åŒ–äº‹ä»¶æ—¶é—´è½´ã€‚</text>
      </view>
      <view class="aggregate-tip-btn" bindtap="autoAggregateEvents">
        <text>{{autoAggregating ? 'å¤„ç†ä¸­...' : 'ç«‹å³å°è¯•'}}</text>
      </view>
    </view>

    <view class="event-timeline" wx:if="{{recentEvents.length > 0}}">
      <view class="event-item"
            wx:for="{{recentEvents}}"
            wx:key="id">
        <view class="event-dot {{item.event_type}}"></view>
        <view class="event-card" bindtap="goToEventDetail" data-id="{{item.id}}">
          <view class="event-row">
            <text class="event-name">{{item.name}}</text>
            <text class="event-type">{{item.event_type_label}}</text>
          </view>
          <view class="event-row-meta">
            <text class="event-date">{{item.date_range}}</text>
            <text class="event-count">{{item.item_count}} æ¡è®°å½•</text>
          </view>
          <text class="event-auto" wx:if="{{item.is_auto_generated}}">è‡ªåŠ¨èšåˆ</text>
          <text class="event-enter">æŸ¥çœ‹è¯¦æƒ… â†’</text>
        </view>
      </view>
    </view>

    <view class="empty-events" wx:else>
      <text class="empty-emoji">ğŸ§©</text>
      <text class="empty-text">æš‚æ— äº‹ä»¶æ—¶é—´è½´</text>
      <view class="empty-events-btn" bindtap="autoAggregateEvents">
        <text>{{autoAggregating ? 'æ•´åˆä¸­...' : 'ä¸€é”®ç”Ÿæˆäº‹ä»¶æ—¶é—´è½´'}}</text>
      </view>
    </view>
  </view>

</view>
