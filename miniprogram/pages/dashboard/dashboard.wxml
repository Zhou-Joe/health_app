<!--pages/dashboard/dashboard.wxml-->
<view class="dashboard-container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card card">
    <view class="user-info">
      <text class="user-name">{{userInfo.first_name || userInfo.username || 'ç”¨æˆ·'}}</text>
      <text class="user-greeting">æ¬¢è¿ä½¿ç”¨å¥åº·æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ</text>
    </view>
    <view class="user-actions" bindtap="goToSettings">
      <text class="settings-icon">âš™ï¸</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <view class="stats-grid">
    <view class="stat-item" bindtap="goToCheckups">
      <text class="stat-value">{{stats.checkupCount}}</text>
      <text class="stat-label">ä½“æ£€æŠ¥å‘Š</text>
    </view>
    <view class="stat-item" bindtap="goToCheckups">
      <text class="stat-value">{{stats.indicatorCount}}</text>
      <text class="stat-label">å¥åº·æŒ‡æ ‡</text>
    </view>
    <view class="stat-item abnormal-stat" bindtap="goToCheckups" wx:if="{{stats.abnormalCount > 0}}">
      <text class="stat-value stat-danger">{{stats.abnormalCount}}</text>
      <text class="stat-label">å¼‚å¸¸æŒ‡æ ‡</text>
    </view>
    <view class="stat-item" bindtap="goToConversations" wx:else>
      <text class="stat-value">{{stats.conversationCount}}</text>
      <text class="stat-label">AIå’¨è¯¢</text>
    </view>
  </view>

  <!-- å¼‚å¸¸æŒ‡æ ‡æé†’ -->
  <view class="abnormal-alert card" wx:if="{{abnormalIndicators.length > 0}}">
    <view class="alert-header">
      <text class="alert-icon">âš ï¸</text>
      <text class="alert-title">å¼‚å¸¸æŒ‡æ ‡æé†’</text>
    </view>
    <scroll-view class="abnormal-list" scroll-y="{{abnormalIndicators.length > 3}}">
      <view class="abnormal-item"
            wx:for="{{abnormalIndicators}}"
            wx:key="id"
            bindtap="goToAbnormalIndicator"
            data-id="{{item.id}}"
            data-checkup="{{item.checkup}}">
        <view class="abnormal-name">{{item.indicator_name}}</view>
        <view class="abnormal-info">
          <text class="abnormal-value">{{item.value_display || item.value}} {{item.unit}}</text>
          <text class="abnormal-range" wx:if="{{item.reference_range}}">å‚è€ƒ: {{item.reference_range}}</text>
        </view>
        <text class="abnormal-date">{{item.checkup_date}}</text>
      </view>
    </scroll-view>
    <view class="alert-footer">
      <text class="alert-action" bindtap="goToAIAdvice">å’¨è¯¢AIåŒ»ç”Ÿ ></text>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œ -->
  <view class="quick-actions card">
    <view class="card-title">å¿«æ·æ“ä½œ</view>
    <view class="action-grid action-grid-4">
      <view class="action-item" bindtap="goToUpload">
        <view class="action-icon upload-icon">ğŸ“„</view>
        <text class="action-text">ä¸Šä¼ æŠ¥å‘Š</text>
        <text class="action-desc">æ™ºèƒ½è§£æï¼Œè‡ªåŠ¨å½’æ¡£</text>
      </view>
      <view class="action-item" bindtap="goToIntegration">
        <view class="action-icon integrate-icon">ğŸ”„</view>
        <text class="action-text">æ•°æ®æ•´åˆ</text>
        <text class="action-desc">æ™ºèƒ½æ•´åˆï¼Œæ¨ªå‘å¯¹æ¯”</text>
      </view>
      <view class="action-item" bindtap="goToMedications">
        <view class="action-icon medication-icon">ğŸ’Š</view>
        <text class="action-text">æˆ‘çš„è¯å•</text>
        <text class="action-desc">æœè¯ç®¡ç†ï¼Œå¥åº·è·Ÿè¸ª</text>
      </view>
      <view class="action-item" bindtap="goToAIAdvice">
        <view class="action-icon ai-icon">ğŸ’¬</view>
        <text class="action-text">AIå’¨è¯¢</text>
        <text class="action-desc">å¥åº·å’¨è¯¢ï¼Œå°±åŒ»å…ˆå¯¼</text>
      </view>
    </view>
  </view>

  <!-- å¥åº·è¶‹åŠ¿ -->
  <view class="health-trends card" wx:if="{{trendTypes.length > 0}}">
    <view class="card-title">å¥åº·è¶‹åŠ¿</view>
    <scroll-view class="trend-types" scroll-x>
      <view class="trend-type-item {{currentTrendType === item.type ? 'active' : ''}}"
            wx:for="{{trendTypes}}"
            wx:key="type"
            bindtap="switchTrendType"
            data-type="{{item.type}}">
        <text class="trend-name">{{item.name}}</text>
        <text class="trend-count">({{item.count}})</text>
      </view>
    </scroll-view>

    <scroll-view class="trend-list" scroll-y wx:if="{{trendData.length > 0}}">
      <view class="trend-item"
            wx:for="{{trendData}}"
            wx:key="name"
            bindtap="viewTrendDetail"
            data-index="{{index}}">
        <view class="trend-header">
          <text class="trend-name">{{item.name}}</text>
          <text class="trend-unit">{{item.unit}}</text>
        </view>
        <scroll-view class="trend-values" scroll-x>
          <view class="trend-value-item {{value.status}}"
                wx:for="{{item.values}}"
                wx:for-item="value"
                wx:key="date">
            <text class="trend-value-date">{{value.date}}</text>
            <text class="trend-value-num">{{value.value_display}}</text>
          </view>
        </scroll-view>
      </view>
    </scroll-view>
    <view class="empty-container" wx:else>
      <text class="empty-text">æš‚æ— {{currentTrendTypeName}}æ•°æ®</text>
    </view>
  </view>

  <!-- æ— å¥åº·æ•°æ®æç¤º -->
  <view class="health-trends card" wx:else>
    <view class="card-title">å¥åº·è¶‹åŠ¿</view>
    <view class="empty-container">
      <text class="empty-text">æš‚æ— å¥åº·æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ ä½“æ£€æŠ¥å‘Š</text>
      <button class="btn-primary mt-20" bindtap="goToUpload">ä¸Šä¼ æŠ¥å‘Š</button>
    </view>
  </view>

  <!-- æœ€æ–°æŠ¥å‘Š -->
  <view class="recent-checkups card">
    <view class="card-title flex-between">
      <text>æœ€æ–°æŠ¥å‘Š</text>
      <text class="more-link" bindtap="goToCheckups">æ›´å¤š ></text>
    </view>
    <view class="checkup-list">
      <block wx:if="{{recentCheckups.length > 0}}">
        <view class="checkup-item"
              wx:for="{{recentCheckups}}"
              wx:key="id"
              bindtap="goToCheckupDetail"
              data-id="{{item.id}}">
          <view class="checkup-header">
            <text class="checkup-hospital">{{item.hospital || 'æœªçŸ¥åŒ»é™¢'}}</text>
            <text class="checkup-date">{{item.checkup_date}}</text>
          </view>
          <view class="checkup-info" wx:if="{{item.indicators_count}}">
            <text class="indicator-count">{{item.indicators_count}}é¡¹æŒ‡æ ‡</text>
            <view class="status-badge status-{{item.status || 'completed'}}">
              {{item.status === 'completed' ? 'å·²å®Œæˆ' : 'å¤„ç†ä¸­'}}
            </view>
          </view>
        </view>
      </block>
      <view class="empty-container" wx:else>
        <text class="empty-text">æš‚æ— ä½“æ£€æŠ¥å‘Š</text>
        <button class="btn-primary mt-20" bindtap="goToUpload">ä¸Šä¼ ç¬¬ä¸€ä»½æŠ¥å‘Š</button>
      </view>
    </view>
  </view>
</view>
