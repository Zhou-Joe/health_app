<!--pages/ai-advice/ai-advice.wxml-->
<view class="ai-advice-container">
  <!-- é¡¶éƒ¨æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-left">
      <text class="page-title">AIå¥åº·åŒ»ç”Ÿ</text>
      <text class="page-subtitle">æ™ºèƒ½åˆ†ææ‚¨çš„å¥åº·æ•°æ®</text>
    </view>
    <view class="header-right">
      <button class="history-btn" bindtap="goToHistory">ğŸ“‹ å†å²</button>
    </view>
  </view>

  <!-- å¯¹è¯æ¨¡å¼é€‰æ‹© -->
  <view class="section-card">
    <view class="section-title">
      <text class="title-icon">ğŸ’¬</text>
      <text class="title-text">å¯¹è¯æ¨¡å¼</text>
    </view>

    <view class="mode-selector">
      <view class="mode-option {{conversationMode === 'new' ? 'active' : ''}}"
            bindtap="selectConversationMode"
            data-mode="new">
        <text class="mode-icon">âœ¨</text>
        <text class="mode-title">åˆ›å»ºæ–°å¯¹è¯</text>
        <view class="mode-check" wx:if="{{conversationMode === 'new'}}">âœ“</view>
      </view>

      <view class="mode-option {{conversationMode === 'continue' ? 'active' : ''}}"
            bindtap="selectConversationMode"
            data-mode="continue">
        <text class="mode-icon">ğŸ”„</text>
        <text class="mode-title">ç»§ç»­å¯¹è¯</text>
        <view class="mode-check" wx:if="{{conversationMode === 'continue'}}">âœ“</view>
      </view>
    </view>

    <!-- é€‰æ‹©å¯¹è¯ -->
    <view class="conversation-select" wx:if="{{conversationMode === 'continue' && conversations.length > 0}}">
      <view class="select-label">é€‰æ‹©è¦ç»§ç»­çš„å¯¹è¯ï¼š</view>
      <view class="conversation-list">
        <view class="conv-item {{selectedConversationId === item.id ? 'active' : ''}}"
              wx:for="{{conversations}}"
              wx:key="id">
          <view class="conv-main" bindtap="selectConversation" data-id="{{item.id}}">
            <text class="conv-title">{{item.title}}</text>
            <text class="conv-count">{{item.message_count}}æ¡æ¶ˆæ¯</text>
          </view>
          <view class="conv-delete" catchtap="deleteConversation" data-id="{{item.id}}">åˆ é™¤</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ¥å‘Šé€‰æ‹© -->
  <view class="section-card">
    <view class="section-title">
      <text class="title-icon">ğŸ“‹</text>
      <text class="title-text">ä½“æ£€æŠ¥å‘Šé€‰æ‹©</text>
    </view>

    <view class="report-mode-selector">
      <view class="report-mode-option {{reportMode === 'none' ? 'active' : ''}}"
            bindtap="selectReportMode"
            data-mode="none">
        <text class="report-mode-icon">ğŸ’­</text>
        <text class="report-mode-title">ä¸ä½¿ç”¨æŠ¥å‘Š</text>
        <view class="report-mode-check" wx:if="{{reportMode === 'none'}}">âœ“</view>
      </view>

      <view class="report-mode-option {{reportMode === 'select' ? 'active' : ''}}"
            bindtap="selectReportMode"
            data-mode="select">
        <text class="report-mode-icon">ğŸ“Š</text>
        <text class="report-mode-title">é€‰æ‹©æŠ¥å‘Š</text>
        <view class="report-mode-check" wx:if="{{reportMode === 'select'}}">âœ“</view>
      </view>
    </view>

    <!-- æŠ¥å‘Šåˆ—è¡¨ -->
    <view class="report-list" wx:if="{{reportMode === 'select' && reports.length > 0}}">
      <view class="report-actions">
        <button class="action-btn" bindtap="selectAllReports">å…¨é€‰</button>
        <button class="action-btn" bindtap="selectRecentReports">æœ€è¿‘2ä»½</button>
        <button class="action-btn" bindtap="clearReports">æ¸…ç©º</button>
      </view>

      <view class="report-items">
        <view class="report-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{reports}}"
              wx:key="id"
              bindtap="toggleReport"
              data-id="{{item.id}}">
          <view class="report-check">{{item.selected ? 'âœ“' : ''}}</view>
          <view class="report-info">
            <text class="report-hospital">{{item.hospital}}</text>
            <text class="report-date">{{item.checkup_date}}</text>
            <text class="report-count">{{item.indicators_count || 0}}é¡¹æŒ‡æ ‡</text>
          </view>
        </view>
      </view>

      <view class="selected-tip" wx:if="{{selectedReportIds.length > 0}}">
        <text class="tip-text">å·²é€‰æ‹© {{selectedReportIds.length}} ä»½æŠ¥å‘Š</text>
      </view>
    </view>

    <view class="empty-reports" wx:if="{{reportMode === 'select' && reports.length === 0}}">
      <text class="empty-text">æš‚æ— ä½“æ£€æŠ¥å‘Š</text>
      <text class="empty-hint">è¯·å…ˆä¸Šä¼ æŠ¥å‘Šå†å’¨è¯¢</text>
    </view>
  </view>

  <!-- è¯å•é€‰æ‹© -->
  <view class="section-card">
    <view class="section-title">
      <text class="title-icon">ğŸ’Š</text>
      <text class="title-text">è¯å•é€‰æ‹©</text>
    </view>

    <view class="report-mode-selector">
      <view class="report-mode-option {{medicationMode === 'none' ? 'active' : ''}}"
            bindtap="selectMedicationMode"
            data-mode="none">
        <text class="report-mode-icon">ğŸ’­</text>
        <text class="report-mode-title">ä¸ä½¿ç”¨è¯å•</text>
        <view class="report-mode-check" wx:if="{{medicationMode === 'none'}}">âœ“</view>
      </view>

      <view class="report-mode-option {{medicationMode === 'select' ? 'active' : ''}}"
            bindtap="selectMedicationMode"
            data-mode="select">
        <text class="report-mode-icon">ğŸ’Š</text>
        <text class="report-mode-title">é€‰æ‹©è¯å•</text>
        <view class="report-mode-check" wx:if="{{medicationMode === 'select'}}">âœ“</view>
      </view>
    </view>

    <!-- è¯å•åˆ—è¡¨ -->
    <view class="report-list" wx:if="{{medicationMode === 'select' && medications.length > 0}}">
      <view class="report-actions">
        <button class="action-btn" bindtap="selectAllMedications">å…¨é€‰</button>
        <button class="action-btn" bindtap="clearMedications">æ¸…ç©º</button>
      </view>

      <view class="report-items">
        <view class="report-item {{item.selected ? 'selected' : ''}}"
              wx:for="{{medications}}"
              wx:key="id"
              bindtap="toggleMedication"
              data-id="{{item.id}}">
          <view class="report-check">{{item.selected ? 'âœ“' : ''}}</view>
          <view class="report-info">
            <text class="report-hospital">{{item.medicine_name}}</text>
            <text class="report-date">{{item.dosage}}</text>
            <text class="report-count">{{item.start_date}} è‡³ {{item.end_date}}</text>
          </view>
        </view>
      </view>

      <view class="selected-tip" wx:if="{{selectedMedicationIds.length > 0}}">
        <text class="tip-text">å·²é€‰æ‹© {{selectedMedicationIds.length}} ä»½è¯å•</text>
      </view>
    </view>

    <view class="empty-reports" wx:if="{{medicationMode === 'select' && medications.length === 0}}">
      <text class="empty-text">æš‚æ— è¯å•</text>
      <text class="empty-hint">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è¯å•</text>
    </view>
  </view>

  <!-- é—®é¢˜è¾“å…¥ -->
  <view class="section-card">
    <view class="section-title">
      <text class="title-icon">â“</text>
      <text class="title-text">æè¿°æ‚¨çš„é—®é¢˜</text>
    </view>

    <textarea class="question-input"
              value="{{question}}"
              bindinput="onQuestionInput"
              placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„å¥åº·é—®é¢˜ï¼ŒAIåŒ»ç”Ÿä¼šåŸºäºæ‚¨çš„æ•°æ®æä¾›ä¸“ä¸šå»ºè®®..."
              maxlength="1000"
              auto-height
              adjust-position="{{true}}"
              show-confirm-bar="{{false}}" />
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-section">
    <button class="submit-btn {{question.trim() ? 'active' : ''}}"
            bindtap="handleSubmit"
            disabled="{{submitting}}">
      <text wx:if="{{!submitting}}">ğŸ¤– è·å–AIå»ºè®®</text>
      <text wx:else>åˆ†æä¸­...</text>
    </button>
  </view>
</view>
