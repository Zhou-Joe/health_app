<!--pages/ai-advice/ai-advice.wxml-->
<view class="ai-advice-container app-theme">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="blob blob-1"></view>
    <view class="blob blob-2"></view>
  </view>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left">
      <text class="header-emoji">ğŸ’¬</text>
      <view class="header-text">
        <text class="header-title">AIå¥åº·åŒ»ç”Ÿ</text>
        <text class="header-subtitle">ä¸“ä¸šå¥åº·å’¨è¯¢</text>
      </view>
    </view>
    <view class="header-right" bindtap="goToHistory">
      <text class="history-btn">ğŸ“‹ å†å²</text>
    </view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒº -->
  <view class="main-content">
    <!-- AIå½¢è±¡å¡ç‰‡ -->
    <view class="ai-card">
      <view class="ai-avatar">ğŸ¤–</view>
      <text class="ai-greeting">æ‚¨å¥½ï¼æˆ‘æ˜¯AIå¥åº·åŠ©æ‰‹</text>
      <text class="ai-desc">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å’¨è¯¢</text>
    </view>

    <!-- é€‰é¡¹æŒ‰é’®ç½‘æ ¼ -->
    <view class="options-grid">
      <!-- å¯¹è¯æ¨¡å¼ -->
      <view class="option-card" bindtap="showModeModal">
        <view class="option-icon-wrap mode-theme">
          <text class="option-emoji">âœ¨</text>
        </view>
        <text class="option-title">å¯¹è¯æ¨¡å¼</text>
        <text class="option-value">{{conversationMode === 'new' ? 'æ–°å»ºå¯¹è¯' : 'ç»§ç»­å¯¹è¯'}}</text>
      </view>

      <!-- ä½“æ£€æŠ¥å‘Š -->
      <view class="option-card" bindtap="showReportModal">
        <view class="option-icon-wrap report-theme">
          <text class="option-emoji">ğŸ“‹</text>
        </view>
        <text class="option-title">ä½“æ£€æŠ¥å‘Š</text>
        <text class="option-value">{{reportMode === 'none' ? 'ä¸ä½¿ç”¨' : selectedReportIds.length + 'ä»½'}}</text>
      </view>

      <!-- è¯å•ä¿¡æ¯ -->
      <view class="option-card" bindtap="showMedicationModal">
        <view class="option-icon-wrap medication-theme">
          <text class="option-emoji">ğŸ’Š</text>
        </view>
        <text class="option-title">è¯å•ä¿¡æ¯</text>
        <text class="option-value">{{medicationMode === 'none' ? 'ä¸ä½¿ç”¨' : selectedMedicationIds.length + 'ä»½'}}</text>
      </view>

      <!-- å¥åº·äº‹ä»¶ -->
      <view class="option-card" bindtap="showEventModal">
        <view class="option-icon-wrap event-theme">
          <text class="option-emoji">ğŸ¥</text>
        </view>
        <text class="option-title">å¥åº·äº‹ä»¶</text>
        <text class="option-value">{{eventMode === 'none' ? 'ä¸ä½¿ç”¨' : 'å·²é€‰æ‹©'}}</text>
      </view>
    </view>

    <!-- é—®é¢˜è¾“å…¥åŒº -->
    <view class="input-section">
      <view class="input-card">
        <textarea class="question-input"
                  value="{{question}}"
                  bindinput="onQuestionInput"
                  placeholder="è¯·æè¿°æ‚¨çš„å¥åº·é—®é¢˜..."
                  maxlength="1000"
                  auto-height
                  adjust-position="{{true}}"
                  show-confirm-bar="{{false}}" />
        <view class="input-footer">
          <text class="char-count">{{question.length}}/1000</text>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-section">
      <button class="submit-btn"
              bindtap="handleSubmit"
              loading="{{submitting}}"
              disabled="{{submitting}}">
        <view wx:if="{{!submitting}}" class="btn-content">
          <text class="btn-icon">ğŸš€</text>
          <text>å¼€å§‹å’¨è¯¢</text>
        </view>
        <text wx:else>å¤„ç†ä¸­...</text>
      </button>
    </view>
  </view>
</view>

<!-- å¯¹è¯æ¨¡å¼å¼¹çª— -->
<view class="modal-mask" wx:if="{{showModeModal}}" bindtap="hideModals">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¯¹è¯æ¨¡å¼</text>
      <text class="modal-close" bindtap="hideModals">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="modal-option {{conversationMode === 'new' ? 'active' : ''}}"
            bindtap="selectConversationMode"
            data-mode="new">
        <text class="modal-option-icon">ğŸŒŸ</text>
        <view class="modal-option-content">
          <text class="modal-option-title">æ–°å»ºå¯¹è¯</text>
          <text class="modal-option-desc">å¼€å§‹å…¨æ–°çš„å¥åº·å’¨è¯¢</text>
        </view>
        <view class="modal-check" wx:if="{{conversationMode === 'new'}}">âœ“</view>
      </view>

      <view class="modal-option {{conversationMode === 'continue' ? 'active' : ''}}"
            bindtap="selectConversationMode"
            data-mode="continue">
        <text class="modal-option-icon">ğŸ”„</text>
        <view class="modal-option-content">
          <text class="modal-option-title">ç»§ç»­å¯¹è¯</text>
          <text class="modal-option-desc">å»¶ç»­ä¹‹å‰çš„å’¨è¯¢</text>
        </view>
        <view class="modal-check" wx:if="{{conversationMode === 'continue'}}">âœ“</view>
      </view>

      <!-- å†å²å¯¹è¯åˆ—è¡¨ -->
      <view class="history-list" wx:if="{{conversationMode === 'continue' && conversations.length > 0}}">
        <view class="history-title">é€‰æ‹©å¯¹è¯</view>
        <scroll-view class="history-scroll" scroll-y>
          <view class="history-item {{selectedConversationId === item.id ? 'active' : ''}}"
                wx:for="{{conversations}}"
                wx:key="id"
                bindtap="selectConversation"
                data-id="{{item.id}}">
            <text class="history-title-text">{{item.title}}</text>
            <text class="history-meta">{{item.message_count}}æ¡ Â· {{item.created_at}}</text>
          </view>
        </scroll-view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn" bindtap="hideModals">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- ä½“æ£€æŠ¥å‘Šå¼¹çª— -->
<view class="modal-mask" wx:if="{{showReportModal}}" bindtap="hideModals">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ä½“æ£€æŠ¥å‘Š</text>
      <text class="modal-close" bindtap="hideModals">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="modal-option {{reportMode === 'none' ? 'active' : ''}}"
            bindtap="selectReportMode"
            data-mode="none">
        <text class="modal-option-icon">ğŸ’­</text>
        <view class="modal-option-content">
          <text class="modal-option-title">ä¸ä½¿ç”¨æŠ¥å‘Š</text>
          <text class="modal-option-desc">ä»…åŸºäºé—®é¢˜å’¨è¯¢</text>
        </view>
        <view class="modal-check" wx:if="{{reportMode === 'none'}}">âœ“</view>
      </view>

      <view class="modal-option {{reportMode === 'select' ? 'active' : ''}}"
            bindtap="selectReportMode"
            data-mode="select">
        <text class="modal-option-icon">ğŸ“Š</text>
        <view class="modal-option-content">
          <text class="modal-option-title">é€‰æ‹©æŠ¥å‘Š</text>
          <text class="modal-option-desc">åŸºäºä½“æ£€æ•°æ®åˆ†æ</text>
        </view>
        <view class="modal-check" wx:if="{{reportMode === 'select'}}">âœ“</view>
      </view>

      <!-- æŠ¥å‘Šåˆ—è¡¨ -->
      <view class="report-list-section" wx:if="{{reportMode === 'select' && reports.length > 0}}">
        <view class="list-actions">
          <button class="action-tag" bindtap="selectAllReports">å…¨é€‰</button>
          <button class="action-tag" bindtap="selectRecentReports">æœ€è¿‘2ä»½</button>
          <button class="action-tag clear" bindtap="clearReports">æ¸…ç©º</button>
        </view>
        <scroll-view class="report-scroll" scroll-y>
          <view class="report-item {{item.selected ? 'selected' : ''}}"
                wx:for="{{reports}}"
                wx:key="id"
                bindtap="toggleReport"
                data-id="{{item.id}}">
            <view class="report-check">{{item.selected ? 'âœ“' : ''}}</view>
            <view class="report-content">
              <text class="report-name">ğŸ¥ {{item.hospital}}</text>
              <text class="report-meta">{{item.checkup_date}} Â· {{item.indicators_count}}é¡¹</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn" bindtap="hideModals">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- è¯å•å¼¹çª— -->
<view class="modal-mask" wx:if="{{showMedicationModal}}" bindtap="hideModals">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è¯å•ä¿¡æ¯</text>
      <text class="modal-close" bindtap="hideModals">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="modal-option {{medicationMode === 'none' ? 'active' : ''}}"
            bindtap="selectMedicationMode"
            data-mode="none">
        <text class="modal-option-icon">ğŸ’­</text>
        <view class="modal-option-content">
          <text class="modal-option-title">ä¸ä½¿ç”¨è¯å•</text>
          <text class="modal-option-desc">ä»…å’¨è¯¢å¥åº·é—®é¢˜</text>
        </view>
        <view class="modal-check" wx:if="{{medicationMode === 'none'}}">âœ“</view>
      </view>

      <view class="modal-option {{medicationMode === 'select' ? 'active' : ''}}"
            bindtap="selectMedicationMode"
            data-mode="select">
        <text class="modal-option-icon">ğŸ’Š</text>
        <view class="modal-option-content">
          <text class="modal-option-title">é€‰æ‹©è¯å•</text>
          <text class="modal-option-desc">ç»“åˆç”¨è¯æƒ…å†µåˆ†æ</text>
        </view>
        <view class="modal-check" wx:if="{{medicationMode === 'select'}}">âœ“</view>
      </view>

      <!-- è¯å•åˆ—è¡¨ -->
      <view class="medication-list-section" wx:if="{{medicationMode === 'select' && medications.length > 0}}">
        <view class="list-actions">
          <button class="action-tag" bindtap="selectAllMedications">å…¨é€‰</button>
          <button class="action-tag clear" bindtap="clearMedications">æ¸…ç©º</button>
        </view>
        <scroll-view class="medication-scroll" scroll-y>
          <view class="medication-item {{item.selected ? 'selected' : ''}}"
                wx:for="{{medications}}"
                wx:key="id"
                bindtap="toggleMedication"
                data-id="{{item.id}}">
            <view class="medication-check">{{item.selected ? 'âœ“' : ''}}</view>
            <view class="medication-content">
              <text class="medication-name">ğŸ’Š {{item.medicine_name}}</text>
              <text class="medication-meta">{{item.dosage}}</text>
              <text class="medication-date">{{item.start_date}} è‡³ {{item.end_date}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn" bindtap="hideModals">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- å¥åº·äº‹ä»¶å¼¹çª— -->
<view class="modal-mask" wx:if="{{showEventModal}}" bindtap="hideModals">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¥åº·äº‹ä»¶</text>
      <text class="modal-close" bindtap="hideModals">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="modal-option {{eventMode === 'none' ? 'active' : ''}}"
            bindtap="selectEventMode"
            data-mode="none">
        <text class="modal-option-icon">ğŸ’­</text>
        <view class="modal-option-content">
          <text class="modal-option-title">ä¸ä½¿ç”¨äº‹ä»¶</text>
          <text class="modal-option-desc">å•ç‹¬é€‰æ‹©æŠ¥å‘Šå’Œè¯å•</text>
        </view>
        <view class="modal-check" wx:if="{{eventMode === 'none'}}">âœ“</view>
      </view>

      <view class="modal-option {{eventMode === 'select' ? 'active' : ''}}"
            bindtap="selectEventMode"
            data-mode="select">
        <text class="modal-option-icon">ğŸ¥</text>
        <view class="modal-option-content">
          <text class="modal-option-title">é€‰æ‹©å¥åº·äº‹ä»¶</text>
          <text class="modal-option-desc">è‡ªåŠ¨åŒ…å«å…³è”çš„æŠ¥å‘Šå’Œè¯å•</text>
        </view>
        <view class="modal-check" wx:if="{{eventMode === 'select'}}">âœ“</view>
      </view>

      <!-- äº‹ä»¶åˆ—è¡¨ -->
      <view class="event-list-section" wx:if="{{eventMode === 'select'}}">
        <view class="list-actions">
          <text class="list-hint">é€‰æ‹©å¥åº·äº‹ä»¶å¯è‡ªåŠ¨åŒ…å«å…³è”çš„æŠ¥å‘Šå’Œè¯å•</text>
        </view>
        <scroll-view class="event-scroll" scroll-y wx:if="{{events.length > 0}}">
          <view class="event-item {{selectedEventId === item.id ? 'selected' : ''}}"
                wx:for="{{events}}"
                wx:key="id"
                bindtap="toggleEvent"
                data-id="{{item.id}}">
            <view class="event-check">{{selectedEventId === item.id ? 'âœ“' : ''}}</view>
            <view class="event-content">
              <text class="event-name">ğŸ¥ {{item.name}}</text>
              <text class="event-type">{{item.event_type_label}}</text>
              <text class="event-meta">{{item.date_range}} Â· {{item.item_count}}é¡¹</text>
            </view>
          </view>
        </scroll-view>
        <view class="empty-list" wx:else>
          <text class="empty-text">æš‚æ— å¥åº·äº‹ä»¶</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn" bindtap="hideModals">ç¡®å®š</button>
    </view>
  </view>
</view>
