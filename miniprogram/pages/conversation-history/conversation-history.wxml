<!--pages/conversation-history/conversation-history.wxml-->
<view class="history-page app-theme">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="gradient-blob blob-1"></view>
    <view class="gradient-blob blob-2"></view>
    <view class="gradient-blob blob-3"></view>
  </view>

  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="page-header">
    <view class="header-nav">
      <view class="nav-btn back-btn" bindtap="goBack">
        <text class="nav-icon">â†</text>
      </view>
      <view class="header-content">
        <text class="page-title">å’¨è¯¢è®°å½•</text>
        <text class="page-count">{{conversations.length}} æ¡å¯¹è¯</text>
      </view>
      <view class="nav-btn search-btn" bindtap="toggleSearch">
        <text class="nav-icon">ğŸ”</text>
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class="search-container {{showSearch ? 'show' : ''}}">
      <view class="search-box">
        <text class="search-icon">ğŸ”</text>
        <input class="search-input"
               value="{{searchKeyword}}"
               bindinput="onSearchInput"
               placeholder="æœç´¢å¯¹è¯å†…å®¹..." />
        <view class="search-clear {{searchKeyword ? 'visible' : ''}}" bindtap="clearSearch">
          <text>âœ•</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content-scroll" scroll-y bindscrolltolower="loadMore">

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{conversations.length === 0 && !loading}}">
      <view class="empty-visual">
        <view class="empty-circle circle-1"></view>
        <view class="empty-circle circle-2"></view>
        <view class="empty-circle circle-3"></view>
        <text class="empty-icon">ğŸ’­</text>
      </view>
      <text class="empty-title">æš‚æ— å’¨è¯¢è®°å½•</text>
      <text class="empty-text">å¼€å§‹ä¸AIå¥åº·åŠ©æ‰‹å¯¹è¯å§</text>
      <view class="empty-btn" bindtap="goToAIAdvice">
        <text>å¼€å§‹å¯¹è¯</text>
      </view>
    </view>

    <!-- å¯¹è¯åˆ—è¡¨ -->
    <view class="conversation-timeline" wx:else>
      <view class="timeline-line"></view>

      <view class="conversation-item"
            wx:for="{{conversations}}"
            wx:key="id"
            style="animation-delay: {{index * 0.08}}s">
        <view class="timeline-dot"></view>

        <view class="conversation-card" bindtap="goToConversation" data-id="{{item.id}}">
          <!-- å¡ç‰‡ä¸»ä½“ -->
          <view class="card-main">
            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <view class="card-status {{item.status || 'completed'}}">
              <view class="status-dot"></view>
            </view>

            <!-- å¡ç‰‡å†…å®¹ -->
            <view class="card-content">
              <view class="card-header">
                <text class="card-title">{{item.title}}</text>
                <view class="card-badge" wx:if="{{item.status === 'generating'}}">
                  <text>ç”Ÿæˆä¸­</text>
                </view>
              </view>

              <text class="card-preview">{{item.preview || 'æš‚æ— é¢„è§ˆ'}}</text>

              <view class="card-footer">
                <view class="card-meta">
                  <text class="meta-icon">ğŸ•</text>
                  <text class="meta-text">{{item.created_at}}</text>
                </view>
                <view class="card-meta">
                  <text class="meta-icon">ğŸ’¬</text>
                  <text class="meta-text">{{item.message_count || 0}} æ¡æ¶ˆæ¯</text>
                </view>
              </view>
            </view>
          </view>

          <!-- å¡ç‰‡æ“ä½œ -->
          <view class="card-actions" catchtap="stopPropagation">
            <view class="action-item" bindtap="exportConversation" data-id="{{item.id}}">
              <view class="action-icon">ğŸ“„</view>
              <text class="action-label">å¯¼å‡º</text>
            </view>
            <view class="action-item delete" bindtap="deleteConversation" data-id="{{item.id}}">
              <view class="action-icon">ğŸ—‘</view>
              <text class="action-label">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading && conversations.length > 0}}">
      <view class="loading-dots">
        <view class="dot dot-1"></view>
        <view class="dot dot-2"></view>
        <view class="dot dot-3"></view>
      </view>
    </view>

  </scroll-view>
</view>
