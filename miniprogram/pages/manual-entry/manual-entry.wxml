<view class="manual-entry-container app-theme">
  <view class="mode-toggle">
    <view class="toggle-item {{mode === 'new' ? 'active' : ''}}" bindtap="onModeChange" data-value="new">
      <text class="toggle-icon">â•</text>
      <text class="toggle-text">æ–°å»ºä½“æ£€æŠ¥å‘Š</text>
    </view>
    <view class="toggle-item {{mode === 'existing' ? 'active' : ''}}" bindtap="onModeChange" data-value="existing">
      <text class="toggle-icon">ğŸ“</text>
      <text class="toggle-text">æ·»åŠ åˆ°å·²æœ‰æŠ¥å‘Š</text>
    </view>
  </view>

  <view class="form-section" wx:if="{{mode === 'new'}}">
    <view class="form-item">
      <text class="form-label">ä½“æ£€æ—¥æœŸ</text>
      <picker mode="date" value="{{checkupDate}}" end="{{today}}" bindchange="onDateChange">
        <view class="picker-value">
          <text class="picker-icon">ğŸ“…</text>
          <text>{{checkupDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
        </view>
      </picker>
    </view>

    <view class="form-item">
      <text class="form-label">ä½“æ£€æœºæ„ï¼ˆé€‰å¡«ï¼‰</text>
      <input class="form-input"
             placeholder="è¯·è¾“å…¥ä½“æ£€åŒ»é™¢æˆ–æœºæ„åç§°"
             placeholder-class="input-placeholder"
             value="{{hospital}}"
             bindinput="onHospitalInput" />
    </view>
  </view>

  <view class="form-section" wx:if="{{mode === 'existing'}}">
    <view class="form-item">
      <text class="form-label">é€‰æ‹©å·²æœ‰ä½“æ£€æŠ¥å‘Š</text>
      <picker mode="selector" range="{{checkups}}" range-key="checkup_date" bindchange="onCheckupChange">
        <view class="picker-value">
          <text class="picker-icon">ğŸ“‹</text>
          <text>{{selectedCheckupId ? 'å·²é€‰æ‹©æŠ¥å‘Š' : 'è¯·é€‰æ‹©ä½“æ£€æŠ¥å‘Š'}}</text>
        </view>
      </picker>
    </view>
  </view>

  <view class="indicators-section">
    <view class="section-header">
      <text class="section-title">å¥åº·æŒ‡æ ‡</text>
      <text class="indicator-count">å…± {{indicators.length}} é¡¹</text>
    </view>

    <view class="indicator-list" wx:if="{{indicators.length > 0}}">
      <view class="indicator-item" wx:for="{{indicators}}" wx:key="index">
        <view class="indicator-info">
          <text class="indicator-name">{{item.indicator_name}}</text>
          <view class="indicator-value-row">
            <text class="indicator-value">{{item.value}}</text>
            <text class="indicator-unit" wx:if="{{item.unit}}">{{item.unit}}</text>
          </view>
          <text class="indicator-status status-{{item.status}}">
            {{item.status === 'normal' ? 'æ­£å¸¸' : item.status === 'attention' ? 'å…³æ³¨' : 'å¼‚å¸¸'}}
          </text>
        </view>
        <view class="indicator-actions">
          <text class="action-btn delete" bindtap="removeIndicator" data-index="{{index}}">åˆ é™¤</text>
        </view>
      </view>
    </view>

    <view class="empty-indicators" wx:else>
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">æš‚æ— æŒ‡æ ‡ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </text>
    </view>

    <button class="add-indicator-btn" bindtap="showAddIndicator">
      <text class="btn-icon">â•</text>
      <text>æ·»åŠ æŒ‡æ ‡</text>
    </button>
  </view>

  <button class="submit-btn"
          bindtap="submitData"
          loading="{{submitting}}"
          disabled="{{submitting || indicators.length === 0}}">
    {{submitting ? 'æäº¤ä¸­...' : 'æäº¤æ•°æ®'}}
  </button>

  <view class="modal-mask" wx:if="{{showAddModal}}" bindtap="hideAddModal">
    <view class="modal-container" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ æŒ‡æ ‡</text>
        <text class="modal-close" bindtap="hideAddModal">âœ•</text>
      </view>
      <view class="modal-content">
        <view class="modal-form-item">
          <text class="modal-label">æŒ‡æ ‡åç§°</text>
          <input class="modal-input"
                 placeholder="å¦‚ï¼šè¡€çº¢è›‹ç™½"
                 placeholder-class="input-placeholder"
                 value="{{newIndicator.indicator_name}}"
                 bindinput="onIndicatorNameInput" />
        </view>

        <view class="modal-form-item">
          <text class="modal-label">æŒ‡æ ‡åˆ†ç±»</text>
          <picker mode="selector" range="{{indicatorTypes}}" range-key="name" bindchange="onIndicatorTypeChange">
            <view class="picker-value">
              <text>{{newIndicator.indicator_type || 'è¯·é€‰æ‹©åˆ†ç±»'}}</text>
            </view>
          </picker>
        </view>

        <view class="modal-form-item">
          <text class="modal-label">æ•°å€¼</text>
          <input class="modal-input"
                 placeholder="å¦‚ï¼š120"
                 placeholder-class="input-placeholder"
                 value="{{newIndicator.value}}"
                 bindinput="onIndicatorValueInput" />
        </view>

        <view class="modal-form-item">
          <text class="modal-label">å•ä½ï¼ˆé€‰å¡«ï¼‰</text>
          <input class="modal-input"
                 placeholder="å¦‚ï¼šg/L"
                 placeholder-class="input-placeholder"
                 value="{{newIndicator.unit}}"
                 bindinput="onIndicatorUnitInput" />
        </view>

        <view class="modal-form-item">
          <text class="modal-label">å‚è€ƒèŒƒå›´ï¼ˆé€‰å¡«ï¼‰</text>
          <input class="modal-input"
                 placeholder="å¦‚ï¼š110-160"
                 placeholder-class="input-placeholder"
                 value="{{newIndicator.reference_range}}"
                 bindinput="onIndicatorReferenceInput" />
        </view>

        <view class="modal-form-item">
          <text class="modal-label">çŠ¶æ€</text>
          <picker mode="selector" range="{{statusOptions}}" range-key="label" bindchange="onIndicatorStatusChange">
            <view class="picker-value">
              <text>{{newIndicator.status === 'normal' ? 'æ­£å¸¸' : newIndicator.status === 'attention' ? 'å…³æ³¨' : 'å¼‚å¸¸'}}</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="modal-actions">
        <button class="modal-btn cancel-btn" bindtap="hideAddModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm-btn" bindtap="addIndicator">æ·»åŠ </button>
      </view>
    </view>
  </view>
</view>
