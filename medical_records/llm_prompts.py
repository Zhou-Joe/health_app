"""
LLMæç¤ºè¯ç»Ÿä¸€é…ç½®æ¨¡å—
æ•´åˆäº†éæµå¼å’Œæµå¼å“åº”çš„æ‰€æœ‰æç¤ºè¯
"""

from .models import HealthIndicator

# ============================================================================
# 1. OCRæå–æ¨¡å—æç¤ºè¯
# ============================================================================

OCR_EXTRACT_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»ç–—æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œè¯·ä»ä½“æ£€æŠ¥å‘ŠOCRæ–‡æœ¬ä¸­æå–å¥åº·æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„JSONæ ¼å¼è¿”å›ã€‚"""

OCR_EXTRACT_USER_PROMPT_TEMPLATE = """ä»ä½“æ£€æŠ¥å‘ŠOCRæ–‡æœ¬ä¸­æå–æ‰€æœ‰å¥åº·æŒ‡æ ‡ï¼Œè¿”å›JSONæ ¼å¼ã€‚

æ–‡æœ¬å†…å®¹ï¼š
{ocr_text}

**ä¼˜å…ˆä½¿ç”¨æ ‡å‡†æŒ‡æ ‡åç§°ï¼š**
{existing_indicators}

**æå–èŒƒå›´ï¼š**
- **æ•°å€¼æŒ‡æ ‡
- **è¯Šæ–­ç»“è®º
- **ç—‡çŠ¶æè¿°
- **æ£€æŸ¥å‘ç°
- **ä½“å¾æ•°æ®

**ç‰¹åˆ«æ³¨æ„ï¼š**
- ä¸ä»…è¦æå–è¡¨æ ¼æ•°æ®ï¼Œè¿˜è¦è¯†åˆ«æ®µè½ä¸­çš„å¥åº·ä¿¡æ¯
- å¯¹äºæè¿°æ€§æ£€æŸ¥ï¼Œæ¨æ–­å¹¶æå–ç»“æ„åŒ–æŒ‡æ ‡
- ç¡®ä¿ä¸é—æ¼ä»»ä½•æ•°å€¼åŒ–æˆ–è€…æœ‰æ˜ç¡®ç—…ç—‡æè¿°çš„åŒ»å­¦æ£€æŸ¥ç»“æœ
- ä¸¥ç¦æå–ä¸ªäººä¿¡æ¯ - æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™: ç»å¯¹ç¦æ­¢æå–ä»¥ä¸‹å­—æ®µï¼Œé‡åˆ°åå¿…é¡»å®Œå…¨å¿½ç•¥å¦‚å§“åã€æ€§åˆ«ã€å¹´é¾„ã€å‡ºç”Ÿæ—¥æœŸã€èº«ä»½è¯å·ã€åœ°å€ã€è”ç³»æ–¹å¼ç­‰ä»»ä½•ä¸ªäººè¯†åˆ«ä¿¡æ¯

**é‡è¦çº¦æŸï¼š**
1. **ä¸è¦æ— ä¸­ç”Ÿæœ‰ï¼š** åªæå–OCRæ–‡æœ¬ä¸­æ˜ç¡®å­˜åœ¨çš„æŒ‡æ ‡æ•°æ®ä»¥åŠç—…ç—‡æè¿°
2. **å‚è€ƒå€¼å¤„ç†ï¼š** å¦‚æœæŠ¥å‘Šä¸­æ²¡æœ‰æä¾›å‚è€ƒèŒƒå›´ï¼ˆnormal_rangeï¼‰ï¼Œè¯·ç•™ç©ºæˆ–å¡«nullï¼Œä¸è¦ç¼–é€ 
3. **å¼‚å¸¸åˆ¤æ–­ï¼š** åªæœ‰å½“æŠ¥å‘Šä¸­æ˜ç¡®æ ‡æ³¨äº†å¼‚å¸¸ï¼ˆå¦‚â†‘â†“ç®­å¤´ã€å¼‚å¸¸å­—æ ·ã€è¶…å‡ºå‚è€ƒèŒƒå›´ï¼‰æ—¶æ‰æ ‡è®°"æ˜¯"ï¼Œå¦åˆ™ç•™ç©ºæˆ–å¡«null
4. **æ•°æ®çœŸå®æ€§ï¼š** å®å¯åœ¨fieldç•™ç©ºï¼Œä¹Ÿä¸è¦ç¼–é€ æŠ¥å‘Šä¸­ä¸å­˜åœ¨çš„å†…å®¹

**JSONæ ¼å¼ï¼š**
{{
    "indicators": [
        {{
            "indicator": "æ ‡å‡†åŒ»å­¦æœ¯è¯­",
            "measured_value": "æ£€æµ‹å€¼æˆ–æè¿°",
            "normal_range": "æ­£å¸¸å‚è€ƒèŒƒå›´ï¼ˆå¦‚æœæŠ¥å‘Šä¸­æ²¡æœ‰åˆ™å¡«nullï¼‰",
            "abnormal": "æ˜¯/å¦/nullï¼ˆå¦‚æœæŠ¥å‘Šä¸­æ²¡æœ‰æ˜ç¡®å¼‚å¸¸æ ‡æ³¨åˆ™å¡«nullï¼‰"
        }}
    ]
}}

**ç¤ºä¾‹ï¼š**
- "è¡€å‹ï¼š120/80mmHgï¼ˆæ­£å¸¸90-139/60-89ï¼‰" â†’ {{"indicator": "è¡€å‹", "measured_value": "120/80", "normal_range": "90-139/60-89", "abnormal": "å¦"}}
- "è¯Šæ–­ï¼š2çº§é«˜è¡€å‹" â†’ {{"indicator": "é«˜è¡€å‹", "measured_value": "2çº§", "normal_range": null, "abnormal": "æ˜¯"}}
- "è„¾è„åšåº¦4.5cm" â†’ {{"indicator": "è„¾è„åšåº¦", "measured_value": "4.5cm", "normal_range": null, "abnormal": null}}
- "çº¢ç»†èƒè®¡æ•° 4.5" â†’ {{"indicator": "çº¢ç»†èƒè®¡æ•°", "measured_value": "4.5", "normal_range": null, "abnormal": null}}

è¯·ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šã€‚åˆ‡è®°ä¸è¦ç¼–é€ æŠ¥å‘Šä¸­ä¸å­˜åœ¨çš„å‚è€ƒèŒƒå›´å’Œå¼‚å¸¸çŠ¶æ€ã€‚"""


# ============================================================================
# 2. è§†è§‰æ¨¡å‹æ¨¡å—æç¤ºè¯
# ============================================================================

VISION_MODEL_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»ç–—æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œä¸“é—¨ä»ä½“æ£€æŠ¥å‘Šå›¾ç‰‡ä¸­æå–å¥åº·æŒ‡æ ‡æ•°æ®ã€‚"""

VISION_MODEL_USER_PROMPT_TEMPLATE = """åˆ†æç¬¬{page_num}/{total_pages}é¡µåŒ»ç–—å›¾ç‰‡ï¼Œæå–æ‰€æœ‰å¥åº·ç›¸å…³ä¿¡æ¯ã€‚

**ä»»åŠ¡è¦æ±‚ï¼š**
1. **ä½“æ£€æŠ¥å‘Šï¼š** è¯†åˆ«å¹¶æå–æ‰€æœ‰åŒ»å­¦æ£€æŸ¥ç»“æœã€æŒ‡æ ‡æ•°æ®ã€è¯Šæ–­ç»“è®º
2. **ç—‡çŠ¶ç…§ç‰‡ï¼š** è¯¦ç»†æè¿°å¯è§çš„ç—‡çŠ¶è¡¨ç°ã€ä½“å¾ç‰¹å¾
3. ä¸¥ç¦æå–ä¸ªäººä¿¡æ¯ - æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™: ç»å¯¹ç¦æ­¢æå–ä»¥ä¸‹å­—æ®µï¼Œé‡åˆ°åå¿…é¡»å®Œå…¨å¿½ç•¥å¦‚å§“åã€æ€§åˆ«ã€å¹´é¾„ã€å‡ºç”Ÿæ—¥æœŸã€èº«ä»½è¯å·ã€åœ°å€ã€è”ç³»æ–¹å¼ç­‰ä»»ä½•ä¸ªäººè¯†åˆ«ä¿¡æ¯

**æå–é‡ç‚¹ï¼š**
- **æ•°å€¼æŒ‡æ ‡
- **è¯Šæ–­ç»“è®º
- **ç—‡çŠ¶æè¿°
- **æ£€æŸ¥å‘ç°
- **ä½“å¾æ•°æ®

**é‡è¦çº¦æŸï¼š**
1. **ä¸è¦æ— ä¸­ç”Ÿæœ‰ï¼š** åªæå–å›¾ç‰‡ä¸­æ˜ç¡®å¯è§æˆ–æ˜ç¡®å†™æ˜çš„æŒ‡æ ‡æ•°æ®æˆ–è€…ç—‡çŠ¶æè¿°
2. **å‚è€ƒå€¼å¤„ç†ï¼š** å¦‚æœå›¾ç‰‡ä¸­æ²¡æœ‰æä¾›å‚è€ƒèŒƒå›´ï¼ˆnormal_rangeï¼‰ï¼Œè¯·ç•™ç©ºæˆ–å¡«nullï¼Œä¸è¦ç¼–é€ 
3. **å¼‚å¸¸åˆ¤æ–­ï¼š** åªæœ‰å½“å›¾ç‰‡ä¸­æ˜ç¡®æ ‡æ³¨äº†å¼‚å¸¸ï¼ˆå¦‚â†‘â†“ç®­å¤´ã€å¼‚å¸¸å­—æ ·ã€è¶…å‡ºå‚è€ƒèŒƒå›´ã€é˜³æ€§ï¼‰æ—¶æ‰æ ‡è®°"æ˜¯"ï¼Œå¦åˆ™ç•™ç©ºæˆ–å¡«null
4. **æ•°æ®çœŸå®æ€§ï¼š** å®å¯å°‘æå–ï¼Œä¹Ÿä¸è¦ç¼–é€ å›¾ç‰‡ä¸­ä¸å­˜åœ¨çš„å†…å®¹
5. **æ¸…æ™°åº¦è¦æ±‚ï¼š** å¦‚æœæ–‡å­—æ¨¡ç³Šä¸æ¸…æ— æ³•å‡†ç¡®è¯†åˆ«ï¼Œå»ºè®®åœ¨æŒ‡æ ‡åç§°åæ·»åŠ "ï¼ˆæ¨¡ç³Šï¼‰"
6. **çº¯å›¾ç‰‡ç—‡çŠ¶ç…§ç‰‡ï¼š** å¦‚æœç—‡çŠ¶æè¿°ä»…åŒ…å«å›¾ç‰‡ä¸­çš„ç—‡çŠ¶ç‰¹å¾ï¼Œä¸åŒ…å«æ–‡å­—æè¿°ï¼Œå»ºè®®åœ¨æŒ‡æ ‡åç§°åæ·»åŠ "ï¼ˆå›¾ç‰‡ï¼‰"




**JSONæ ¼å¼è¦æ±‚ï¼š**
{{
    "indicators": [
        {{
            "indicator": "æ ‡å‡†åŒ»å­¦æœ¯è¯­åç§°",
            "measured_value": "æ£€æµ‹å€¼æˆ–ç—‡çŠ¶æè¿°",
            "normal_range": "æ­£å¸¸å‚è€ƒèŒƒå›´ï¼ˆå¦‚æœå›¾ç‰‡ä¸­æ²¡æœ‰åˆ™å¡«nullï¼‰",
            "abnormal": "æ˜¯/å¦/nullï¼ˆå¦‚æœå›¾ç‰‡ä¸­æ²¡æœ‰æ˜ç¡®å¼‚å¸¸æ ‡æ³¨åˆ™å¡«nullï¼‰"
        }}
    ]
}}

**ç¤ºä¾‹ï¼š**
- è¡€å‹"120/80" â†’ {{"indicator": "è¡€å‹", "measured_value": "120/80", "normal_range": "90-140/60-90", "abnormal": "å¦"}}
- çº¢ç»†èƒè®¡æ•°"4.5" â†’ {{"indicator": "çº¢ç»†èƒè®¡æ•°", "measured_value": "4.5", "normal_range": null, "abnormal": null}}

è¯·ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚åˆ‡è®°ä¸è¦ç¼–é€ å›¾ç‰‡ä¸­ä¸å­˜åœ¨çš„å‚è€ƒèŒƒå›´å’Œå¼‚å¸¸çŠ¶æ€ã€‚"""


# ============================================================================
# 3. å¥åº·å»ºè®®æ¨¡å—æç¤ºè¯
# ============================================================================

HEALTH_ADVICE_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·é¡¾é—®åŒ»ç”Ÿï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„ä½“æ£€æŒ‡æ ‡æ•°æ®æä¾›å¥åº·å»ºè®®ã€‚"""

HEALTH_ADVICE_USER_PROMPT_TEMPLATE = """è¯·æ ¹æ®ä»¥ä¸‹ä½“æ£€æŒ‡æ ‡æ•°æ®ï¼Œä¸ºç”¨æˆ·æä¾›ä¸“ä¸šçš„å¥åº·å»ºè®®å’Œç”Ÿæ´»æ–¹å¼æŒ‡å¯¼ã€‚

ä½“æ£€æŒ‡æ ‡æ•°æ®:
{indicators_text}

{focus_text}

è¯·æä¾›ä»¥ä¸‹æ–¹é¢çš„å»ºè®®ï¼š
1. **æŒ‡æ ‡è§£è¯»**: ç®€è¦è§£é‡Šå„é¡¹æŒ‡æ ‡çš„å«ä¹‰
2. **å¼‚å¸¸åˆ†æ**: é’ˆå¯¹å¼‚å¸¸æŒ‡æ ‡æä¾›å¯èƒ½çš„åŸå› å’Œå»ºè®®
3. **é¥®é£Ÿå»ºè®®**: åŸºäºä½“æ£€ç»“æœæä¾›é¥®é£Ÿè°ƒæ•´å»ºè®®
4. **è¿åŠ¨å»ºè®®**: æ¨èé€‚åˆçš„è¿åŠ¨æ–¹å¼å’Œé¢‘ç‡
5. **ç”Ÿæ´»ä¹ æƒ¯**: æä¾›ä½œæ¯ã€æˆ’çƒŸé™é…’ç­‰ç”Ÿæ´»æ–¹å¼å»ºè®®
6. **å®šæœŸå¤æŸ¥**: å»ºè®®éœ€è¦é‡ç‚¹å…³æ³¨å’Œå®šæœŸå¤æŸ¥çš„æŒ‡æ ‡

è¯·ç”¨é€šä¿—æ˜“æ‡‚ã€ä¸“ä¸šè€Œä¸ç”Ÿç¡¬çš„è¯­è¨€ï¼Œé¿å…è¿‡åº¦åŒ»å­¦æœ¯è¯­ï¼Œç»™å‡ºå®ç”¨çš„å»ºè®®ã€‚å»ºè®®è¦å…·ä½“å¯è¡Œï¼Œé¿å…è¿‡äºç¬¼ç»Ÿã€‚

æ³¨æ„ï¼š
- å¦‚æœæ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ï¼Œé‡ç‚¹ç»™å‡ºé¢„é˜²ä¿å¥å»ºè®®
- å¦‚æœæœ‰å¼‚å¸¸æŒ‡æ ‡ï¼Œé‡ç‚¹å…³æ³¨ç›¸å…³é£é™©å› ç´ 
- å»ºè®®ç”¨æˆ·å®šæœŸä½“æ£€ï¼ŒéµåŒ»å˜±è¿›è¡Œå¤æŸ¥
- å¼ºè°ƒæœ¬å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯Šç–—è¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ"""


# ============================================================================
# 4. æ•°æ®æ•´åˆæ¨¡å—æç¤ºè¯
# ============================================================================

DATA_INTEGRATION_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ»ç–—æ•°æ®æ ‡å‡†åŒ–ä¸“å®¶ã€‚ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ç»“æœï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„æ–‡å­—è¯´æ˜ã€‚"""

DATA_INTEGRATION_USER_PROMPT_TEMPLATE = """åˆ†æ{indicator_count}ç»„å¥åº·æŒ‡æ ‡ï¼Œåˆ¤æ–­å“ªäº›æŒ‡æ ‡éœ€è¦æ›´æ­£ï¼š

ã€é¦–è¦ä»»åŠ¡ï¼šå¯¹é½æŒ‡æ ‡åçš„å‘½åã€‘
å‘½åç»Ÿä¸€æ˜¯æœ€é‡è¦çš„ä»»åŠ¡ï¼å¿…é¡»ä»”ç»†æ£€æŸ¥ç›¸åŒæŒ‡æ ‡æ˜¯å¦æœ‰ä¸åŒåç§°ï¼Œå°†æ‰€æœ‰å˜ä½“åç§°å¯¹é½åˆ°å…¶ä¸­ä¸€ä¸ªå·²æœ‰åç§°ï¼Œä¸è¦åˆ›é€ æ–°åç§°ã€‚
ç¤ºä¾‹ï¼š
- "è¡€çº¢è›‹ç™½"å’Œ"HGB"åŒæ—¶å­˜åœ¨ â†’ ç»Ÿä¸€ä¸º"è¡€çº¢è›‹ç™½"ï¼ˆé€‰å…¶ä¸­ä¸€ä¸ªå·²æœ‰çš„ï¼‰
- "ç©ºè…¹è¡€ç³–"å’Œ"è¡€ç³–"åŒæ—¶å­˜åœ¨ â†’ ç»Ÿä¸€ä¸ºå…¶ä¸­ä»»æ„ä¸€ä¸ª

ã€å…¶ä»–éœ€è¦æ›´æ­£çš„æƒ…å†µã€‘
1.å•ä½ç¼ºå¤±æˆ–ä¸ç»Ÿä¸€ï¼ˆå¦‚"kg"å’Œ"å…¬æ–¤"ï¼‰â†’ç»Ÿä¸€æ ‡å‡†å•ä½
2.çŠ¶æ€é”™è¯¯ï¼šåªæ›´æ–°valueä»¥åŠå‚è€ƒèŒƒå›´æœ‰æ˜æ˜¾å·®åˆ«çš„æŒ‡æ ‡
   - å¦‚æœvalueæ˜¯æè¿°æ€§æ–‡å­—ï¼ˆå¦‚"æœªè§å¼‚å¸¸"ã€"æ­£å¸¸"ã€"é˜³æ€§"ç­‰ï¼‰â†’ statusåº”è®¾ä¸ºå¯¹åº”çŠ¶æ€
   - å¦‚æœvalueæ˜æ˜¾è¶…å‡ºå‚è€ƒèŒƒå›´ â†’ statusåº”ä¸º"abnormal"
   - å¦‚æœvalueåœ¨å‚è€ƒèŒƒå›´å†… â†’ statusåº”ä¸º"normal"
   - å¦‚æœæœ‰å‚è€ƒèŒƒå›´ä½†statusæ ‡è®°é”™è¯¯ â†’ å¿…é¡»æ›´æ­£
3.åˆ†ç±»é”™è¯¯æˆ–ä¸ç»Ÿä¸€ï¼šç»Ÿä¸€ä¸ºæœ€å‡†ç¡®çš„åˆ†ç±»

ã€å¯é€‰çš„æŒ‡æ ‡åˆ†ç±»ï¼ˆindicator_typeï¼‰ã€‘
å¿…é¡»ä»ä»¥ä¸‹åˆ†ç±»ä¸­é€‰æ‹©ï¼Œä¼˜å…ˆé€‰æ‹©æœ€å…·ä½“çš„åˆ†ç±»ï¼Œæœ€åæ‰ä½¿ç”¨otherï¼š
1. ä¸€èˆ¬æ£€æŸ¥
   - general_exam: ä¸€èˆ¬æ£€æŸ¥ï¼ˆèº«é«˜ã€ä½“é‡ã€BMIã€è¡€å‹ã€å¿ƒç‡ã€ä½“æ¸©ç­‰ï¼‰

2. è¡€æ¶²æ£€éªŒ
   - blood_routine: è¡€å¸¸è§„ï¼ˆç™½ç»†èƒã€çº¢ç»†èƒã€è¡€çº¢è›‹ç™½ã€è¡€å°æ¿ç­‰ï¼‰
   - biochemistry: ç”ŸåŒ–æ£€éªŒï¼ˆè¡€ç³–ã€è¡€è„‚ã€ç”µè§£è´¨ç­‰ï¼‰
   - liver_function: è‚åŠŸèƒ½ï¼ˆALTã€ASTã€èƒ†çº¢ç´ ã€ç™½è›‹ç™½ç­‰ï¼‰
   - kidney_function: è‚¾åŠŸèƒ½ï¼ˆè‚Œé…ã€å°¿ç´ æ°®ã€å°¿é…¸ç­‰ï¼‰
   - thyroid: ç”²çŠ¶è…ºï¼ˆT3ã€T4ã€TSHç­‰ï¼‰
   - cardiac: å¿ƒè„æ ‡å¿—ç‰©ï¼ˆè‚Œé’™è›‹ç™½ã€BNPã€CK-MBç­‰ï¼‰
   - tumor_markers: è‚¿ç˜¤æ ‡å¿—ç‰©ï¼ˆCEAã€AFPã€CA125ã€CA199ã€PSAç­‰ï¼‰
   - infection: æ„ŸæŸ“ç‚ç—‡ï¼ˆCååº”è›‹ç™½CRPã€è¡€æ²‰ESRç­‰ï¼‰
   - blood_rheology: è¡€æ¶²æµå˜ï¼ˆå…¨è¡€ç²˜åº¦ã€è¡€æµ†ç²˜åº¦ï¼‰
   - coagulation: å‡è¡€åŠŸèƒ½ï¼ˆPTã€APTTã€çº¤ç»´è›‹ç™½åŸç­‰ï¼‰

3. ä½“æ¶²æ£€éªŒ
   - urine: å°¿æ¶²æ£€æŸ¥ï¼ˆå°¿å¸¸è§„ã€å°¿è›‹ç™½ã€å°¿ç³–ç­‰ï¼‰
   - stool: ç²ªä¾¿æ£€æŸ¥ï¼ˆå¤§ä¾¿å¸¸è§„ã€éšè¡€ç­‰ï¼‰
   - pathology: ç—…ç†æ£€æŸ¥ï¼ˆæ´»æ£€ç—…ç†ã€ç»†èƒå­¦æ£€æŸ¥ã€å…ç–«ç»„åŒ–ï¼‰

4. å½±åƒå­¦æ£€æŸ¥
   - ultrasound: è¶…å£°æ£€æŸ¥ï¼ˆBè¶…ã€å½©è¶…æ£€æŸ¥å‘ç°çš„èƒ†å›Šæ¯è‚‰ã€è‚å›Šè‚¿ç­‰ï¼‰
   - X_ray: Xçº¿æ£€æŸ¥ï¼ˆèƒ¸ç‰‡ã€éª¨éª¼Xå…‰ç­‰ï¼‰
   - CT_MRI: CTå’ŒMRIæ£€æŸ¥
   - endoscopy: å†…é•œæ£€æŸ¥ï¼ˆèƒƒé•œã€è‚ é•œã€æ”¯æ°”ç®¡é•œç­‰ï¼‰

5. ä¸“ç§‘æ£€æŸ¥
   - special_organs: ä¸“ç§‘æ£€æŸ¥ï¼ˆçœ¼ç§‘è§†åŠ›/çœ¼å‹ã€è€³é¼»å–‰å¬åŠ›æ£€æŸ¥ã€å£è…”ç‰™é½¿ç­‰ï¼‰

6. å…œåº•åˆ†ç±»
   - other: å…¶ä»–æ£€æŸ¥ï¼ˆä»…å½“æ— æ³•å½’å…¥ä»¥ä¸Šä»»ä½•ç±»åˆ«æ—¶ä½¿ç”¨ï¼‰

ã€åˆ†ç±»åˆ¤æ–­ä¼˜å…ˆçº§ã€‘
1. å¦‚æœæ˜¯ç—…ç†æ´»æ£€/ç»†èƒå­¦æ£€æŸ¥ â†’ pathology
2. å¦‚æœæ˜¯è¶…å£°/Bè¶…/å½©è¶… â†’ ultrasound
3. å¦‚æœæ˜¯Xçº¿æ£€æŸ¥ â†’ X_ray
4. å¦‚æœæ˜¯CTæˆ–MRI â†’ CT_MRI
5. å¦‚æœæ˜¯å†…é•œï¼ˆèƒƒé•œè‚ é•œï¼‰ â†’ endoscopy
6. å¦‚æœæ˜¯ä¸“ç§‘æ£€æŸ¥ï¼ˆçœ¼è€³é¼»å–‰å£è…”ç­‰ï¼‰ â†’ special_organs
7. å¦‚æœæ˜¯è¡€æ¶²æ£€éªŒï¼ŒæŒ‰å…·ä½“é¡¹ç›®é€‰æ‹©æœ€ç»†åˆ†çš„ç±»åˆ«ï¼ˆä¼˜å…ˆçº§ï¼šcardiac/tumor_markers/infection/coagulation > liver/kidney/thyroid > blood_routine > biochemistryï¼‰
8. å¦‚æœæ˜¯ä½“æ¶²æ£€éªŒï¼ŒæŒ‰æ ·æœ¬ç±»å‹ï¼ˆurine/stoolï¼‰
9. å¦‚æœå®åœ¨æ— æ³•åˆ¤æ–­ â†’ otherï¼ˆä½†è¿™æ˜¯æœ€åçš„é€‰æ‹©ï¼‰

ã€ä¸éœ€è¦æ›´æ­£çš„æƒ…å†µã€‘
- åç§°å·²ç»ä¸€è‡´ï¼ˆæ²¡æœ‰ä¸åŒå˜ä½“ï¼‰
- å•ä½å·²ç»æ˜¯æ ‡å‡†å•ä½
- çŠ¶æ€åˆ¤æ–­æ­£ç¡®
- åˆ†ç±»å·²ç»å‡†ç¡®

ã€ç¦æ­¢ä¿®æ”¹çš„å­—æ®µã€‘
- å‚è€ƒèŒƒå›´ï¼ˆreference_rangeï¼‰ï¼šä¸è¦è¿”å›æ­¤å­—æ®µï¼Œä¿æŒåŸå€¼ä¸å˜

ã€é‡è¦ï¼šæ·»åŠ ä¿®æ”¹ç†ç”±ã€‘
æ¯ä¸ªå˜æ›´éƒ½å¿…é¡»åŒ…å«"reason"å­—æ®µï¼Œç”¨ç®€æ´çš„ä¸­æ–‡è¯´æ˜ä¿®æ”¹çš„ç†ç”±ï¼ˆ10ä¸ªå­—ä»¥å†…ï¼‰ã€‚

æ•°æ®ï¼š
{indicators_data}

è¿”å›æ ¼å¼ï¼ˆåªåŒ…å«éœ€è¦æ›´æ­£çš„æŒ‡æ ‡å’Œå­—æ®µï¼‰ï¼š
{{
    "changes": [
        {{
            "indicator_id": 123,
            "indicator_name": "ç»Ÿä¸€åçš„åç§°",
            "reason": "å°†'èº«é•¿'ç»Ÿä¸€ä¸º'èº«é«˜'ï¼Œä¿æŒå‘½åä¸€è‡´æ€§"
        }},
        {{
            "indicator_id": 456,
            "value": "ä¿®æ­£åçš„å€¼",
            "unit": "æ ‡å‡†å•ä½",
            "reason": "å•ä½ä»éæ ‡å‡†çš„'å…¬æ–¤'ç»Ÿä¸€ä¸º'kg'"
        }},
        {{
            "indicator_id": 101,
            "indicator_type": "blood_routine",
            "reason": "ç™½ç»†èƒè®¡æ•°å±äºè¡€æ¶²å¸¸è§„æ£€æŸ¥ï¼Œåˆ†ç±»åº”æ›´æ­£ä¸ºblood_routine"
        }}
    ]
}}

ã€å…³é”®è¦æ±‚ã€‘
1.åªè¿”å›çœŸæ­£éœ€è¦æ›´æ­£çš„æŒ‡æ ‡
2.å·²ç»æ­£ç¡®çš„æŒ‡æ ‡ä¸è¦å‡ºç°åœ¨changesä¸­
3.æ¯ä¸ªå¯¹è±¡å¿…é¡»åŒ…å«indicator_idã€éœ€è¦ä¿®æ”¹çš„å­—æ®µï¼ˆåªé™indicator_nameã€valueã€unitã€statusã€indicator_typeï¼‰å’Œreason
4.reasonå­—æ®µå¿…é¡»ç”¨ç®€æ´çš„ä¸­æ–‡è¯´æ˜ä¿®æ”¹ç†ç”±ï¼ˆ10ä¸ªå­—ä»¥å†…ï¼‰
5.ç»å¯¹ä¸è¦è¿”å›reference_rangeå­—æ®µ
6.çº¯JSONæ ¼å¼ï¼Œæ— markdown{user_prompt_section}
7.å¦‚æŸä¸ªindicator_idåŒ…å«å¤šä¸ªä¿®æ”¹é¡¹ï¼Œåˆ™éœ€è¦åŒ…å«åœ¨åŒä¸€ä¸ªitemé‡Œ"""


# ============================================================================
# 5. AIåŒ»ç”Ÿæ¨¡å—æç¤ºè¯
# ============================================================================

AI_DOCTOR_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…¨ç§‘åŒ»ç”Ÿï¼Œè¯·åŸºäºç”¨æˆ·çš„å¥åº·æ•°æ®å’Œé—®é¢˜æä¾›ä¸“ä¸šå»ºè®®ã€‚"""

AI_DOCTOR_USER_PROMPT_TEMPLATE_WITH_DATA = """å½“å‰é—®é¢˜ï¼š{question}

ä¸ªäººä¿¡æ¯ï¼š
{personal_info}

å¯¹è¯å†å²ï¼š
{conversation_history}

ç”¨æˆ·å¥åº·æ•°æ®ï¼š
{health_data}

ã€é‡è¦åŸåˆ™ã€‘
1. **ä¸“æ³¨ç”¨æˆ·é—®é¢˜**ï¼šå›ç­”çš„æ ¸å¿ƒå¿…é¡»ç´§æ‰£ç”¨æˆ·å½“å‰çš„é—®é¢˜ï¼Œä¸è¦æ³›æ³›è€Œè°ˆ
2. **ç²¾å‡†å¼•ç”¨æŒ‡æ ‡**ï¼šåªåˆ†æä¸é—®é¢˜ç›¸å…³çš„æŒ‡æ ‡ï¼Œä¸è¦ç½—åˆ—æ‰€æœ‰æ•°æ®
   - âš ï¸ ç»å¯¹ä¸è¦é€ä¸€åˆ†ææˆ–åˆ—ä¸¾ç”¨æˆ·æä¾›çš„æ‰€æœ‰æŒ‡æ ‡
   - ä½“æ£€æ•°æ®ä»…ä½œä¸ºå‚è€ƒç´ æï¼ŒåªæåŠç›¸å…³æŒ‡æ ‡
   - æ­£å¸¸æŒ‡æ ‡ä¸æåŠï¼Œé™¤éä¸é—®é¢˜ç›´æ¥ç›¸å…³
3. **ç®€æ´ä¸“ä¸š**ï¼šå›ç­”è¦ç›´å‡»è¦ç‚¹ï¼Œé¿å…å†—é•¿

è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼š
1. **ç²¾å‡†å®šä½é—®é¢˜**ï¼šç»“åˆå¯¹è¯å†å²ï¼Œç†è§£ç”¨æˆ·çœŸæ­£å…³å¿ƒçš„æ ¸å¿ƒé—®é¢˜
2. **ç›¸å…³æ•°æ®åˆ†æ**ï¼šåªåˆ†æä¸é—®é¢˜ç›¸å…³çš„å¥åº·æŒ‡æ ‡åŠå…¶è¶‹åŠ¿å˜åŒ–
3. **é’ˆå¯¹æ€§å»ºè®®**ï¼šç»™å‡ºå…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆå’ŒåŒ»ç–—å»ºè®®
4. **å¿…è¦æ—¶å°±åŒ»**ï¼šå¦‚æœ‰éœ€è¦ï¼Œæ˜ç¡®å»ºè®®ä½•æ—¶å°±åŒ»æˆ–åšå“ªäº›æ£€æŸ¥

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¯­æ°”ä¸“ä¸šä½†å¹³æ˜“è¿‘äººã€‚è¿™ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£é¢è¯Šã€‚"""

AI_DOCTOR_USER_PROMPT_TEMPLATE_WITHOUT_DATA = """å½“å‰é—®é¢˜ï¼š{question}

ä¸ªäººä¿¡æ¯ï¼š
{personal_info}

å¯¹è¯å†å²ï¼š
{conversation_history}

æ³¨æ„ï¼šç”¨æˆ·é€‰æ‹©ä¸æä¾›ä»»ä½•ä½“æ£€æŠ¥å‘Šæ•°æ®ï¼Œè¯·ä»…åŸºäºé—®é¢˜æä¾›ä¸€èˆ¬æ€§å¥åº·å»ºè®®ã€‚

ã€é‡è¦åŸåˆ™ã€‘
1. **ä¸“æ³¨ç”¨æˆ·é—®é¢˜**ï¼šå›ç­”çš„æ ¸å¿ƒå¿…é¡»ç´§æ‰£ç”¨æˆ·å½“å‰çš„é—®é¢˜ï¼Œä¸è¦æ³›æ³›è€Œè°ˆ
2. **ç®€æ´ç²¾å‡†**ï¼šé¿å…å†—é•¿çš„å¥åº·çŸ¥è¯†ç§‘æ™®ï¼Œç›´æ¥å›åº”ç”¨æˆ·çš„ç–‘é—®
3. **å®ç”¨å¯è¡Œ**ï¼šç»™å‡ºçš„å»ºè®®è¦å…·ä½“ã€å¯æ“ä½œï¼Œé¿å…ç©ºæ³›çš„ç†è®º

è¯·åŸºäºä»¥ä¸Šé—®é¢˜ï¼š
1. **ç²¾å‡†å®šä½é—®é¢˜**ï¼šç»“åˆå¯¹è¯å†å²ï¼Œç†è§£ç”¨æˆ·çœŸæ­£å…³å¿ƒçš„æ ¸å¿ƒé—®é¢˜
2. **é’ˆå¯¹æ€§è§£ç­”**ï¼šç›´æ¥å›ç­”ç”¨æˆ·ç–‘é—®ï¼Œæä¾›ç›¸å…³çŸ¥è¯†èƒŒæ™¯
3. **å®ç”¨å»ºè®®**ï¼šç»™å‡ºå…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆæˆ–é¢„é˜²æªæ–½
4. **å°±åŒ»æŒ‡å¼•**ï¼šæ˜ç¡®å»ºè®®ä½•æ—¶éœ€è¦å°±åŒ»æˆ–åšå“ªäº›æ£€æŸ¥

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¯­æ°”ä¸“ä¸šä½†å¹³æ˜“è¿‘äººã€‚è®°ä½ï¼šä¸“æ³¨äºç”¨æˆ·é—®é¢˜ï¼Œç»™å‡ºç²¾å‡†å®ç”¨çš„å»ºè®®ã€‚è¿™ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£é¢è¯Šã€‚"""


# ============================================================================
# 6. ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯æ‰©å±•
# ============================================================================

def add_user_custom_prompt(base_prompt: str, user_prompt: str) -> str:
    """
    æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯åˆ°åŸºç¡€æç¤ºè¯ä¸­
    
    Args:
        base_prompt: åŸºç¡€æç¤ºè¯
        user_prompt: ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
    
    Returns:
        ç»„åˆåçš„æç¤ºè¯
    """
    if not user_prompt or not user_prompt.strip():
        return base_prompt
    
    return f"""{base_prompt}

ã€ç”¨æˆ·ç‰¹åˆ«è¦æ±‚ã€‘
{user_prompt}

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç”¨æˆ·è¦æ±‚è¿›è¡Œæ•°æ®å¤„ç†ã€‚"""


# ============================================================================
# 7. æç¤ºè¯æ„å»ºè¾…åŠ©å‡½æ•°
# ============================================================================

def build_ocr_extract_prompt(ocr_text: str, existing_indicators: list) -> tuple:
    """
    æ„å»ºOCRæå–æç¤ºè¯
    
    Args:
        ocr_text: OCRè¯†åˆ«çš„æ–‡æœ¬
        existing_indicators: ç°æœ‰æ ‡å‡†æŒ‡æ ‡åç§°åˆ—è¡¨
    
    Returns:
        (system_prompt, user_prompt)
    """
    existing_list = '\n'.join([f'  - {name}' for name in existing_indicators])
    user_prompt = OCR_EXTRACT_USER_PROMPT_TEMPLATE.format(
        ocr_text=ocr_text,
        existing_indicators=existing_list
    )
    return OCR_EXTRACT_SYSTEM_PROMPT, user_prompt


def build_vision_model_prompt(page_num: int, total_pages: int) -> str:
    """
    æ„å»ºè§†è§‰æ¨¡å‹æç¤ºè¯
    
    Args:
        page_num: å½“å‰é¡µç 
        total_pages: æ€»é¡µæ•°
    
    Returns:
        user_prompt
    """
    return VISION_MODEL_USER_PROMPT_TEMPLATE.format(
        page_num=page_num,
        total_pages=total_pages
    )


def build_health_advice_prompt(indicators_text: str, focus_text: str) -> tuple:
    """
    æ„å»ºå¥åº·å»ºè®®æç¤ºè¯
    
    Args:
        indicators_text: æŒ‡æ ‡æ•°æ®æ–‡æœ¬
        focus_text: å…³æ³¨é‡ç‚¹æ–‡æœ¬
    
    Returns:
        (system_prompt, user_prompt)
    """
    user_prompt = HEALTH_ADVICE_USER_PROMPT_TEMPLATE.format(
        indicators_text=indicators_text,
        focus_text=focus_text
    )
    return HEALTH_ADVICE_SYSTEM_PROMPT, user_prompt


def build_data_integration_prompt(indicators_data: str, user_prompt: str = None) -> tuple:
    """
    æ„å»ºæ•°æ®æ•´åˆæç¤ºè¯
    
    Args:
        indicators_data: æŒ‡æ ‡æ•°æ®JSONå­—ç¬¦ä¸²
        user_prompt: ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
    
    Returns:
        (system_prompt, user_prompt)
    """
    user_prompt_section = ""
    if user_prompt and user_prompt.strip():
        user_prompt_section = f"""

ã€ç”¨æˆ·ç‰¹åˆ«è¦æ±‚ã€‘
{user_prompt}

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç”¨æˆ·è¦æ±‚è¿›è¡Œæ•°æ®æ•´åˆã€‚"""
    
    # è®¡ç®—æŒ‡æ ‡æ•°é‡
    import json
    indicators_json = json.loads(indicators_data)
    indicator_count = len(indicators_json) if isinstance(indicators_json, list) else len(indicators_json.get('indicators', []))
    
    user_prompt = DATA_INTEGRATION_USER_PROMPT_TEMPLATE.format(
        indicator_count=indicator_count,
        indicators_data=indicators_data,
        user_prompt_section=user_prompt_section
    )
    return DATA_INTEGRATION_SYSTEM_PROMPT, user_prompt


def build_ai_doctor_prompt(question: str, personal_info: str, conversation_history: str,
                           health_data: str = None, has_health_data: bool = True) -> str:
    """
    æ„å»ºAIåŒ»ç”Ÿæç¤ºè¯
    
    Args:
        question: ç”¨æˆ·é—®é¢˜
        personal_info: ä¸ªäººä¿¡æ¯
        conversation_history: å¯¹è¯å†å²
        health_data: å¥åº·æ•°æ®ï¼ˆå¯é€‰ï¼‰
        has_health_data: æ˜¯å¦æœ‰å¥åº·æ•°æ®
    
    Returns:
        user_prompt (LangChainæµå¼ä½¿ç”¨ï¼ŒåŒ…å«è§’è‰²å®šä¹‰)
    """
    if has_health_data and health_data:
        template = AI_DOCTOR_USER_PROMPT_TEMPLATE_WITH_DATA
        user_prompt = template.format(
            question=question,
            personal_info=personal_info,
            conversation_history=conversation_history,
            health_data=health_data
        )
    else:
        template = AI_DOCTOR_USER_PROMPT_TEMPLATE_WITHOUT_DATA
        user_prompt = template.format(
            question=question,
            personal_info=personal_info,
            conversation_history=conversation_history
        )
    
    # å¯¹äºLangChainæµå¼å“åº”ï¼Œå°†system promptä¹ŸåŒ…å«åœ¨user messageä¸­
    return f"""{AI_DOCTOR_SYSTEM_PROMPT}

{user_prompt}"""


# ============================================================================
# 8. AIå¯¹è¯æ€»ç»“æ¨¡å—æç¤ºè¯
# ============================================================================

AI_SUMMARY_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŒ»ç–—å¥åº·é¡¾é—®ï¼Œæ“…é•¿æ€»ç»“å’Œåˆ†æåŒ»æ‚£å¯¹è¯å†…å®¹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¯¹ç”¨æˆ·ä¸AIåŒ»ç”Ÿçš„å¯¹è¯è¿›è¡Œç»“æ„åŒ–æ€»ç»“ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£å¯¹è¯çš„æ ¸å¿ƒå†…å®¹ã€‚"""

AI_SUMMARY_USER_PROMPT_TEMPLATE = """è¯·å¯¹ä»¥ä¸‹ç”¨æˆ·ä¸AIåŒ»ç”Ÿçš„å¯¹è¯è¿›è¡Œç»“æ„åŒ–æ€»ç»“ã€‚

ã€å¯¹è¯å†…å®¹ã€‘
{conversation_content}

ã€æ€»ç»“è¦æ±‚ã€‘
è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡ºæ€»ç»“å†…å®¹ï¼š

## ğŸ“‹ æ ¸å¿ƒå…³æ³¨
- åˆ—å‡ºç”¨æˆ·åœ¨å¯¹è¯ä¸­ä¸»è¦å…³å¿ƒçš„å¥åº·é—®é¢˜ï¼ˆ2-4æ¡ï¼‰
- ç”¨ç®€æ´çš„è¯­è¨€æ¦‚æ‹¬ç”¨æˆ·çš„æ ¸å¿ƒè¯‰æ±‚

## ğŸ”¬ åŒ»å­¦è§£é‡Š
- æ€»ç»“AIåŒ»ç”Ÿå¯¹ç”¨æˆ·é—®é¢˜çš„ä¸»è¦åŒ»å­¦è§£é‡Š
- æåŠæ¶‰åŠçš„å…³é”®å¥åº·æŒ‡æ ‡æˆ–ç—‡çŠ¶
- è¯´æ˜å¼‚å¸¸æƒ…å†µçš„åŒ»å­¦å«ä¹‰ï¼ˆå¦‚æœ‰ï¼‰

## ğŸ’¡ å¥åº·å»ºè®®
- åˆ—å‡ºAIåŒ»ç”Ÿç»™å‡ºçš„ä¸»è¦å¥åº·å»ºè®®ï¼ˆ3-5æ¡ï¼‰
- åŒ…æ‹¬ç”Ÿæ´»æ–¹å¼ã€é¥®é£Ÿã€è¿åŠ¨ç­‰æ–¹é¢çš„å…·ä½“å»ºè®®
- å¦‚æœ‰å°±åŒ»å»ºè®®ï¼Œè¯·ç‰¹åˆ«æ ‡æ³¨

## âš ï¸ æ³¨æ„äº‹é¡¹
- åˆ—å‡ºéœ€è¦ç‰¹åˆ«å…³æ³¨çš„å¥åº·é£é™©æˆ–é¢„è­¦ä¿¡å·
- è¯´æ˜éœ€è¦å®šæœŸå¤æŸ¥æˆ–ç›‘æµ‹çš„æŒ‡æ ‡

## ğŸ“… åç»­è¡ŒåŠ¨
- å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆå¦‚å¤è¯Šã€æ£€æŸ¥ç­‰ï¼‰
- æ¨èçš„æ—¶é—´å®‰æ’

ã€è¾“å‡ºè¦æ±‚ã€‘
1. ä½¿ç”¨Markdownæ ¼å¼è¾“å‡º
2. è¯­è¨€ç®€æ´ä¸“ä¸šï¼Œé¿å…è¿‡äºåŒ»å­¦æœ¯è¯­åŒ–
3. çªå‡ºé‡ç‚¹ï¼Œä¾¿äºç”¨æˆ·å¿«é€Ÿé˜…è¯»
4. å¦‚æœå¯¹è¯å†…å®¹è¾ƒå°‘ï¼Œå¯é€‚å½“ç²¾ç®€æ€»ç»“ç»“æ„
5. ç¡®ä¿æ€»ç»“å†…å®¹å¿ å®äºåŸå§‹å¯¹è¯ï¼Œä¸æ·»åŠ å¯¹è¯ä¸­æœªæåŠçš„ä¿¡æ¯"""


def build_ai_summary_prompt(conversation_content: str) -> str:
    """
    æ„å»ºAIå¯¹è¯æ€»ç»“æç¤ºè¯
    
    Args:
        conversation_content: å¯¹è¯å†…å®¹æ–‡æœ¬
    
    Returns:
        user_prompt (LangChainæµå¼ä½¿ç”¨ï¼ŒåŒ…å«è§’è‰²å®šä¹‰)
    """
    user_prompt = AI_SUMMARY_USER_PROMPT_TEMPLATE.format(
        conversation_content=conversation_content
    )
    
    return f"""{AI_SUMMARY_SYSTEM_PROMPT}

{user_prompt}"""


EVENT_AI_SUMMARY_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŒ»ç–—å¥åº·é¡¾é—®ï¼Œæ“…é•¿åˆ†ææ‚£è€…çš„å¥åº·äº‹ä»¶å¹¶æä¾›ç»“æ„åŒ–çš„å¥åº·æ€»ç»“ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·çš„å¥åº·äº‹ä»¶åŠç›¸å…³å¥åº·è®°å½•ï¼Œç”Ÿæˆä¸€ä»½å…¨é¢çš„å¥åº·åˆ†ææŠ¥å‘Šã€‚

ã€é‡è¦è¾“å‡ºè¦æ±‚ã€‘
1. ç›´æ¥è¾“å‡ºç»“æ„åŒ–åˆ†æå†…å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å¼€åœºç™½ã€é—®å€™è¯­æˆ–å®¢å¥—è¯
2. ç›´æ¥ä»¥Markdownæ ¼å¼è¾“å‡ºæŠ¥å‘Šå†…å®¹
3. è¯­è¨€ç®€æ´ä¸“ä¸šï¼Œé¿å…è¿‡äºåŒ»å­¦æœ¯è¯­åŒ–
4. å¦‚æœæŸé¡¹å†…å®¹ä¸ºç©ºï¼Œåœ¨æŠ¥å‘Šä¸­è¯´æ˜"æ— ç›¸å…³è®°å½•"
5. ç¡®ä¿åˆ†æå†…å®¹å¿ å®äºåŸå§‹è®°å½•æ•°æ®"""

EVENT_AI_SUMMARY_USER_PROMPT_TEMPLATE = """è¯·åˆ†æä»¥ä¸‹å¥åº·äº‹ä»¶åŠå…¶å…³è”çš„å¥åº·è®°å½•ï¼Œç”Ÿæˆç»“æ„åŒ–çš„å¥åº·åˆ†ææŠ¥å‘Šã€‚

ã€äº‹ä»¶ä¿¡æ¯ã€‘
- äº‹ä»¶åç§°ï¼š{event_name}
- äº‹ä»¶ç±»å‹ï¼š{event_type}
- äº‹ä»¶æè¿°ï¼š{event_description}
- å¼€å§‹æ—¥æœŸï¼š{start_date}
- ç»“æŸæ—¥æœŸï¼š{end_date}
- å½“å‰çŠ¶æ€ï¼š{status}

ã€å…³è”çš„ä½“æ£€æŠ¥å‘Šã€‘
{checkups_content}

ã€å…³è”çš„è¯å•ã€‘
{medications_content}

ã€å…³è”çš„å¥åº·æŒ‡æ ‡ã€‘
{indicators_content}

ã€å…³è”çš„ç—‡çŠ¶è®°å½•ã€‘
{symptoms_content}

ã€å…³è”çš„æœè¯è®°å½•ã€‘
{medication_records_content}

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„ç›´æ¥è¾“å‡ºåˆ†ææŠ¥å‘Šï¼Œä¸è¦æœ‰ä»»ä½•å¼€åœºç™½ã€‚åªå…³æ³¨å¼‚å¸¸å’Œæœ‰é—®é¢˜çš„é¡¹ç›®ï¼Œæ­£å¸¸çš„é¡¹ç›®ä¸è¦æåŠï¼š

## ğŸ” å¼‚å¸¸é¡¹ï¼ˆåªåˆ—å‡ºæœ‰é—®é¢˜çš„æŒ‡æ ‡ï¼‰
## ğŸ¤’ ç—‡çŠ¶åˆ†æ
## ğŸ’Š ç”¨è¯æƒ…å†µ
## ğŸ“Š å¥åº·äº‹ä»¶æ€»ç»“
## ğŸ’¡ å¥åº·å»ºè®®
## âš ï¸ æ³¨æ„äº‹é¡¹"""


def build_event_ai_summary_prompt(event) -> str:
    """æ„å»ºå¥åº·äº‹ä»¶AIæ€»ç»“æç¤ºè¯"""
    from django.utils import timezone
    from django.contrib.contenttypes.models import ContentType
    
    event_type_display = dict(event.EVENT_TYPE_CHOICES).get(event.event_type, event.event_type)
    status_display = dict(event.EVENT_STATUS_CHOICES).get(event.status, event.status)
    
    checkups_content = []
    medications_content = []
    indicators_content = []
    symptoms_content = []
    medication_records_content = []
    
    for item in event.get_all_items():
        content_type = item.content_type
        obj = item.content_object
        
        if not obj:
            continue
        
        try:
            if content_type.model == 'healthcheckup':
                checkups_content.append(f"\nã€ä½“æ£€æŠ¥å‘Š - {obj.hospital}ã€‘")
                checkups_content.append(f"ä½“æ£€æ—¥æœŸ: {obj.checkup_date}")
                checkups_content.append(f"å¤‡æ³¨: {obj.notes or 'æ— '}")
                try:
                    for indicator in obj.indicators.all():
                        indicators_content.append(f"- {indicator.indicator_name}: {indicator.value} {indicator.unit or ''} (å‚è€ƒ: {indicator.reference_range or 'æ— '})")
                except Exception:
                    pass
                    
            elif content_type.model == 'medication':
                medications_content.append(f"\nã€è¯å• - {obj.medicine_name}ã€‘")
                medications_content.append(f"ç”¨è¯æ—¶é—´: {obj.start_date} è‡³ {obj.end_date or 'è¿›è¡Œä¸­'}")
                medications_content.append(f"å‰‚é‡: {obj.dosage or 'æœªæŒ‡å®š'}")
                medications_content.append(f"é¢‘æ¬¡: {obj.frequency or 'æœªæŒ‡å®š'}")
                medications_content.append(f"ç”¨é€”: {obj.purpose or 'æœªæŒ‡å®š'}")
                medications_content.append(f"å¤‡æ³¨: {obj.notes or 'æ— '}")
                
            elif content_type.model == 'healthindicator':
                indicators_content.append(f"- {obj.indicator_name}: {obj.value} {obj.unit or ''} (å‚è€ƒ: {obj.reference_range or 'æ— '}, ç±»å‹: {dict(HealthIndicator.INDICATOR_TYPES).get(obj.indicator_type, obj.indicator_type)})")
                
            elif content_type.model == 'symptomentry':
                symptoms_content.append(f"\nã€ç—‡çŠ¶è®°å½• - {obj.entry_date}ã€‘")
                symptoms_content.append(f"ç—‡çŠ¶: {obj.symptom}")
                symptoms_content.append(f"ä¸¥é‡ç¨‹åº¦: {obj.severity or 'æœªè®°å½•'}")
                symptoms_content.append(f"æŒç»­æ—¶é—´: {obj.duration or 'æœªè®°å½•'}")
                symptoms_content.append(f"å¤‡æ³¨: {obj.notes or 'æ— '}")
                
            elif content_type.model == 'medicationrecord':
                med_name = obj.medication.medicine_name if obj.medication else 'æœªçŸ¥'
                medication_records_content.append(f"- {obj.record_date}: {med_name} - {obj.status or 'æœªè®°å½•'}")
        except Exception as e:
            print(f"Error processing event item: {e}")
    
    checkups_content_str = "\n".join(checkups_content) if checkups_content else "æ— å…³è”ä½“æ£€æŠ¥å‘Š"
    medications_content_str = "\n".join(medications_content) if medications_content else "æ— å…³è”è¯å•"
    indicators_content_str = "\n".join(indicators_content) if indicators_content else "æ— å…³è”å¥åº·æŒ‡æ ‡"
    symptoms_content_str = "\n".join(symptoms_content) if symptoms_content else "æ— å…³è”ç—‡çŠ¶è®°å½•"
    medication_records_content_str = "\n".join(medication_records_content) if medication_records_content else "æ— å…³è”æœè¯è®°å½•"
    
    user_prompt = EVENT_AI_SUMMARY_USER_PROMPT_TEMPLATE.format(
        event_name=event.name,
        event_type=event_type_display,
        event_description=event.description or "æ— æè¿°",
        start_date=event.start_date.strftime('%Yå¹´%mæœˆ%dæ—¥'),
        end_date=event.end_date.strftime('%Yå¹´%mæœˆ%dæ—¥') if event.end_date else "è¿›è¡Œä¸­",
        status=status_display,
        checkups_content=checkups_content_str,
        medications_content=medications_content_str,
        indicators_content=indicators_content_str,
        symptoms_content=symptoms_content_str,
        medication_records_content=medication_records_content_str
    )
    
    return f"""{EVENT_AI_SUMMARY_SYSTEM_PROMPT}

{user_prompt}"""
