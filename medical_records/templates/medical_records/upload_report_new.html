{% extends 'base.html' %}

{% block title %}æ™ºèƒ½ä¸Šä¼ ä½“æ£€æŠ¥å‘Š - ä¸ªäººå¥åº·ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="mb-3">
            <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> æ™ºèƒ½ä¸Šä¼ ä½“æ£€æŠ¥å‘Š
                </h4>
                <p class="mb-0 mt-2">æ”¯æŒPDFæ ¼å¼ï¼Œè‡ªåŠ¨OCRè¯†åˆ«å’ŒAIæ•°æ®åˆ†æ</p>
            </div>
            <div class="card-body">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div id="uploadSection">
                    <form id="uploadForm" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="checkup_date" class="form-label">
                                    <i class="bi bi-calendar"></i> ä½“æ£€æ—¥æœŸ <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="checkup_date" name="checkup_date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="hospital" class="form-label">
                                    <i class="bi bi-hospital"></i> ä½“æ£€æœºæ„
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="hospital" name="hospital"
                                           placeholder="è¯·è¾“å…¥ä½“æ£€åŒ»é™¢æˆ–æœºæ„åç§°" autocomplete="off">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-building"></i> å†å²è®°å½•
                                    </button>
                                    <ul class="dropdown-menu" id="hospitalDropdown">
                                        <li><a class="dropdown-item text-muted" href="#"><i class="bi bi-arrow-repeat spin"></i> åŠ è½½ä¸­...</a></li>
                                    </ul>
                                </div>
                                <div class="form-text">å¯é€‰ï¼Œç•™ç©ºå°†æ˜¾ç¤º"æœªçŸ¥æœºæ„"</div>
                            </div>
                        </div>

                        <!-- æŠ¥å‘Šæè¿° -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="report_description" class="form-label">
                                    <i class="bi bi-card-text"></i> æŠ¥å‘Šæè¿°
                                </label>
                                <input type="text" class="form-control" id="report_description" name="report_description"
                                       placeholder="ä¾‹å¦‚ï¼šå¹´åº¦ä½“æ£€æŠ¥å‘Šã€å…¥èŒä½“æ£€ç­‰ï¼ˆé»˜è®¤ä¸ºæ–‡ä»¶åï¼‰" maxlength="200">
                                <div class="form-text">å¯é€‰ï¼Œç•™ç©ºå°†ä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶åä½œä¸ºæè¿°</div>
                            </div>
                        </div>

                        <!-- å·¥ä½œæµæ¨¡å¼é€‰æ‹© -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="workflow_type" class="form-label">
                                    <i class="bi bi-gear"></i> å¤„ç†æ¨¡å¼ <span class="text-danger">*</span>
                                </label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card workflow-option" data-workflow="ocr_llm">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="workflow_type"
                                                           id="workflow_ocr_llm" value="ocr_llm" checked>
                                                    <label class="form-check-label" for="workflow_ocr_llm">
                                                        <strong>OCR + LLM æ¨¡å¼</strong>
                                                    </label>
                                                </div>
                                                <div class="small text-muted mt-2">
                                                    <i class="bi bi-check-circle"></i> æˆç†Ÿç¨³å®šçš„ä¼ ç»Ÿå·¥ä½œæµ<br>
                                                    <i class="bi bi-check-circle"></i> é€‚åˆå¤„ç†PDFæ–‡ä»¶<br>
                                                    <i class="bi bi-check-circle"></i> æ”¯æŒå¤æ‚æ ¼å¼è¡¨æ ¼<br>
                                                    <i class="bi bi-check-circle"></i> OCRè¯†åˆ«å‡†ç¡®åº¦é«˜
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card workflow-option" data-workflow="vlm_transformers">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="workflow_type"
                                                           id="workflow_vlm_transformers" value="vlm_transformers">
                                                    <label class="form-check-label" for="workflow_vlm_transformers">
                                                        <strong>VLM Transformers æ¨¡å¼</strong>
                                                    </label>
                                                </div>
                                                <div class="small text-muted mt-2">
                                                    <i class="bi bi-check-circle"></i> å¢å¼ºç‰ˆOCRå·¥ä½œæµ<br>
                                                    <i class="bi bi-check-circle"></i> VLMè§†è§‰ç†è§£èƒ½åŠ›<br>
                                                    <i class="bi bi-check-circle"></i> æ‰‹å†™æ–‡å­—è¯†åˆ«æ›´å¼º<br>
                                                    <i class="bi bi-check-circle"></i> é€‚åˆå¤æ‚å¸ƒå±€æ–‡æ¡£
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card workflow-option" data-workflow="vl_model">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="workflow_type"
                                                           id="workflow_vl_model" value="vl_model">
                                                    <label class="form-check-label" for="workflow_vl_model">
                                                        <strong>å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼</strong>
                                                    </label>
                                                </div>
                                                <div class="small text-muted mt-2">
                                                    <i class="bi bi-check-circle"></i> ç›´æ¥ç†è§£æ–‡æ¡£å†…å®¹<br>
                                                    <i class="bi bi-check-circle"></i> å›¾ç‰‡æ–‡ä»¶å¤„ç†æœ€å¿«<br>
                                                    <i class="bi bi-check-circle"></i> æ”¯æŒç—‡çŠ¶ç…§ç‰‡åˆ†æ<br>
                                                    <i class="bi bi-check-circle"></i> æ— éœ€ä¸­é—´è½¬æ¢æ­¥éª¤
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>å»ºè®®ï¼š</strong>PDFæ–‡ä»¶æ¨èä½¿ç”¨OCR + LLMæ¨¡å¼ï¼Œå›¾ç‰‡æ–‡ä»¶æ¨èä½¿ç”¨å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼
                                </div>
                            </div>
                        </div>

                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label">
                                    <i class="bi bi-file-earmark-image"></i> é€‰æ‹©ä½“æ£€æŠ¥å‘Šæ–‡ä»¶ <span class="text-danger">*</span>
                                </label>
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-content text-center p-4">
                                        <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                                        <h5>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h5>
                                        <p class="text-muted">æ”¯æŒPDFã€JPGã€PNGã€JPEGã€TIFFã€BMPæ ¼å¼ï¼Œæœ€å¤§æ–‡ä»¶å¤§å°10MB</p>
                                        <input type="file" id="fileInput" name="file"
                                               class="form-control" accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" required style="display: none;">
                                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                            <i class="bi bi-folder-open"></i> é€‰æ‹©æ–‡ä»¶
                                        </button>
                                    </div>
                                    <div class="file-info p-3" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <i id="fileIcon" class="bi bi-file-earmark text-primary me-3" style="font-size: 2rem;"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1" id="fileName"></h6>
                                                <small class="text-muted" id="fileSize"></small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                                <i class="bi bi-trash"></i> æ¸…é™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="bi bi-activity"></i> AIæœåŠ¡çŠ¶æ€</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="checkServiceStatus()">
                                        <i class="bi bi-arrow-clockwise"></i> æ£€æŸ¥çŠ¶æ€
                                    </button>
                                </div>
                                <small class="text-muted">ç‚¹å‡»æŒ‰é’®æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆé¿å…æ¶ˆè€—APIé…é¢ï¼‰</small>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-body py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-cpu me-3 text-muted" id="ocrStatusIcon" style="font-size: 1.2rem;"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">OCRæœåŠ¡çŠ¶æ€</small>
                                                <div id="ocrStatusText" class="fw-bold text-muted">æœªæ£€æŸ¥</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-body py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-robot me-3 text-muted" id="llmStatusIcon" style="font-size: 1.2rem;"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">AIåˆ†ææœåŠ¡çŠ¶æ€</small>
                                                <div id="llmStatusText" class="fw-bold text-muted">æœªæ£€æŸ¥</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-body py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-eye me-3 text-muted" id="vlmStatusIcon" style="font-size: 1.2rem;"></i>
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">å¤šæ¨¡æ€æœåŠ¡çŠ¶æ€</small>
                                                <div id="vlmStatusText" class="fw-bold text-muted">æœªæ£€æŸ¥</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å½“å‰æ¨¡å¼è¯´æ˜ -->
                        <div class="alert alert-info mb-4" id="workflowInfoAlert">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <strong id="workflowTitle">OCR + LLM æ¨¡å¼ (ä¼ ç»Ÿå·¥ä½œæµ)</strong>
                                    <div class="small mt-1" id="workflowDescription">ä½¿ç”¨ä¼ ç»ŸOCRè¿›è¡Œæ–‡å­—è¯†åˆ«ï¼Œç„¶åä½¿ç”¨LLMæå–ç»“æ„åŒ–æ•°æ®ã€‚è¿™æ˜¯æˆç†Ÿç¨³å®šçš„ä¼ ç»Ÿå·¥ä½œæµã€‚</div>
                                </div>
                                <div class="ms-auto">
                                    <span id="workflowStatusBadge" class="badge bg-success">ç¨³å®š</span>
                                </div>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-upload"></i> å¼€å§‹æ™ºèƒ½åˆ†æ
                            </button>
                        </div>
                    </form>
                </div>

                <!-- å¤„ç†è¿›åº¦åŒºåŸŸ -->
                <div id="progressSection" style="display: none;">
                    <div class="text-center mb-4">
                        <h5>
                            <i class="bi bi-gear-fill spin"></i> æ­£åœ¨å¤„ç†ä½“æ£€æŠ¥å‘Š
                        </h5>
                        <p class="text-muted">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨è‡ªåŠ¨åˆ†ææ‚¨çš„å¥åº·æ•°æ®...</p>
                    </div>

                    <!-- è¿›åº¦æ¡ -->
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             id="progressBar" role="progressbar" style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>

                    <!-- å®æ—¶å¤„ç†æ—¥å¿— -->
                    <div class="card bg-dark text-light mb-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0 small">
                                    <i class="bi bi-terminal-fill text-success"></i> å®æ—¶å¤„ç†æ—¥å¿—
                                </h6>
                                <span class="badge bg-success small" id="uploadLogStatus">è¿è¡Œä¸­</span>
                            </div>
                            <div id="uploadProgressLog"
                                 style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.4; background: #1e1e1e; padding: 10px; border-radius: 4px;">
                                <div class="text-secondary">ç­‰å¾…å¼€å§‹...</div>
                            </div>
                        </div>
                    </div>

                    <!-- LLMè¾“å‡ºåŒºåŸŸ -->
                    <div class="card bg-light mb-3" id="uploadLLMOutputCard" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-robot text-primary"></i> AIæ­£åœ¨åˆ†æä½“æ£€æŠ¥å‘Š
                            </h6>
                            <div id="uploadLLMOutput"
                                 style="max-height: 200px; overflow-y: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9em; line-height: 1.6; padding: 15px; background: white; border: 1px solid #dee2e6; border-radius: 5px; color: #333;">
                            </div>
                        </div>
                    </div>

                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">å¤„ç†çŠ¶æ€</h6>
                                    <div id="statusDetails" class="small">
                                        ç­‰å¾…å¼€å§‹å¤„ç†...
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">æ–‡ä»¶ä¿¡æ¯</h6>
                                    <div id="fileDetails" class="small">
                                        <!-- æ–‡ä»¶ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OCRç»“æœ -->
                    <div id="ocrResults" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h6 class="mb-0"><i class="bi bi-file-text"></i> OCRè¯†åˆ«ç»“æœ</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">è¯†åˆ«å­—ç¬¦æ•°: <span id="ocrLength">0</span></small>
                                </div>
                                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 0.85em;">
                                    <pre id="ocrContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">ç­‰å¾…OCRè¯†åˆ«...</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LLMç»“æœ -->
                    <div id="llmResults" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-success">
                                <h6 class="mb-0"><i class="bi bi-robot"></i> AIåˆ†æç»“æœ</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">è¯†åˆ«æŒ‡æ ‡æ•°: <span id="llmCount">0</span></small>
                                </div>
                                <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 0.85em;">
                                    <pre id="llmContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">ç­‰å¾…AIåˆ†æ...</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€ç»ˆæŒ‡æ ‡ -->
                    <div id="finalResults" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-primary">
                                <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> æå–çš„å¥åº·æŒ‡æ ‡</h6>
                            </div>
                            <div class="card-body">
                                <div id="indicatorsList">
                                    <!-- æŒ‡æ ‡åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é”™è¯¯ä¿¡æ¯ -->
                    <div class="alert alert-danger mt-3" id="errorAlert" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> å¤„ç†å¤±è´¥</h6>
                        <p id="errorMessage" class="mb-0"></p>
                        <hr>
                        <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> é‡æ–°ä¸Šä¼ 
                        </button>
                    </div>

                    <!-- æˆåŠŸä¿¡æ¯ -->
                    <div class="alert alert-success mt-3" id="successAlert" style="display: none;">
                        <h6><i class="bi bi-check-circle"></i> å¤„ç†å®Œæˆ</h6>
                        <p id="successMessage" class="mb-0"></p>
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="window.location.href='{% url "medical_records:dashboard" %}'">
                                <i class="bi bi-house"></i> è¿”å›é¦–é¡µæŸ¥çœ‹ç»“æœ
                            </button>
                            <button class="btn btn-outline-success ms-2" id="viewDetailsBtn">
                                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> ä½¿ç”¨è¯´æ˜</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">ä¸Šä¼ è¦æ±‚</h6>
                        <ul class="small">
                            <li>æ”¯æŒPDFã€JPGã€PNGã€JPEGã€TIFFã€BMPæ ¼å¼çš„ä½“æ£€æŠ¥å‘Š</li>
                            <li>æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB</li>
                            <li>æŠ¥å‘Šå†…å®¹æ¸…æ™°ï¼Œæ–‡å­—è¯†åˆ«æ•ˆæœå¥½</li>
                            <li>å»ºè®®ä½¿ç”¨æ­£å¼åŒ»é™¢çš„ä½“æ£€æŠ¥å‘Š</li>
                            <li>å›¾ç‰‡æ ¼å¼å»ºè®®ä¸ºé«˜æ¸…æ‰«æä»¶æˆ–ç…§ç‰‡ï¼Œç¡®ä¿æ–‡å­—æ¸…æ™°å¯è¾¨</li>
                            <li><strong>ä¸Šä¼ è¿‡ç¨‹ä¸­è¯·ä¿æŒè¯¥é¡µé¢ç­‰å¾…å®Œæˆ</strong></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">å¤„ç†æµç¨‹</h6>
                        <ul class="small">
                            <li><strong>ç¬¬1æ­¥ï¼š</strong>ä¸Šä¼ ä½“æ£€æŠ¥å‘Šæ–‡ä»¶ï¼ˆPDFæˆ–å›¾ç‰‡æ ¼å¼ï¼‰</li>
                            <li><strong>ç¬¬2æ­¥ï¼š</strong>OCRæ–‡å­—è¯†åˆ«æå–æ–‡æœ¬å†…å®¹</li>
                            <li><strong>ç¬¬3æ­¥ï¼š</strong>AIæ™ºèƒ½åˆ†æå¥åº·æŒ‡æ ‡æ•°æ®</li>
                            <li><strong>ç¬¬4æ­¥ï¼š</strong>è‡ªåŠ¨åˆ†ç±»å¹¶ä¿å­˜åˆ°æ•°æ®åº“</li>
                            <li><strong>ç¬¬5æ­¥ï¼š</strong>åœ¨é¦–é¡µæŸ¥çœ‹åˆ†æç»“æœå’Œè¶‹åŠ¿</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #4facfe;
    background-color: #f0f8ff;
}

.upload-area.dragover {
    border-color: #4facfe;
    background-color: #e3f2fd;
}

.spin {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-online {
    color: #28a745;
}

.status-offline {
    color: #dc3545;
}

.status-checking {
    color: #ffc107;
}

/* å·¥ä½œæµé€‰é¡¹æ ·å¼ */
.workflow-option {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.workflow-option:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0,123,255,0.1);
    transform: translateY(-2px);
}

.workflow-option.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
    box-shadow: 0 4px 8px rgba(0,123,255,0.15);
}

.workflow-option .form-check-input:checked + .form-check-label {
    color: #007bff;
    font-weight: bold;
}

.workflow-option .card-body {
    padding: 1rem;
}
</style>

<script>
let currentProcessingId = null;
let progressInterval = null;

// é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setupUploadArea();
    setupFormSubmit();
    loadHospitalDropdown();
    setupWorkflowSelection();
});

// æ£€æŸ¥æœåŠ¡çŠ¶æ€
async function checkServiceStatus() {
    // é€šè¿‡åç«¯APIæ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼Œé¿å…è·¨åŸŸé—®é¢˜
    updateStatusIcon('ocr', 'checking', 'æ£€æŸ¥ä¸­...');
    updateStatusIcon('llm', 'checking', 'æ£€æŸ¥ä¸­...');
    updateStatusIcon('vlm', 'checking', 'æ£€æŸ¥ä¸­...');

    try {
        const response = await fetch('{% url "medical_records:api_check_services" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const result = await response.json();

            // æ›´æ–°OCRæœåŠ¡çŠ¶æ€
            if (result.ocr_status === 'online') {
                updateStatusIcon('ocr', 'online', 'OCRæœåŠ¡æ­£å¸¸');
            } else {
                updateStatusIcon('ocr', 'offline', 'OCRæœåŠ¡ä¸å¯ç”¨');
            }

            // æ›´æ–°LLMæœåŠ¡çŠ¶æ€
            if (result.llm_status === 'online') {
                updateStatusIcon('llm', 'online', 'LLMæœåŠ¡æ­£å¸¸');
            } else {
                updateStatusIcon('llm', 'offline', 'LLMæœåŠ¡ä¸å¯ç”¨');
            }

            // æ›´æ–°å¤šæ¨¡æ€æ¨¡å‹æœåŠ¡çŠ¶æ€
            if (result.vl_model_status === 'online') {
                updateStatusIcon('vlm', 'online', 'å¤šæ¨¡æ€æœåŠ¡æ­£å¸¸');
            } else {
                updateStatusIcon('vlm', 'offline', 'å¤šæ¨¡æ€æœåŠ¡ä¸å¯ç”¨');
            }

            // æ˜¾ç¤ºå½“å‰å·¥ä½œæµæ¨¡å¼
            if (result.default_workflow) {
                updateCurrentWorkflow(result.default_workflow);
            }
        } else {
            updateStatusIcon('ocr', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
            updateStatusIcon('llm', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
            updateStatusIcon('vlm', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
        }
    } catch (error) {
        console.error('æœåŠ¡çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
        updateStatusIcon('ocr', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
        updateStatusIcon('llm', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
        updateStatusIcon('vlm', 'offline', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥');
    }
}

// æ›´æ–°çŠ¶æ€å›¾æ ‡
function updateStatusIcon(service, status, text) {
    const icon = document.getElementById(`${service}StatusIcon`);
    const textElement = document.getElementById(`${service}StatusText`);

    icon.className = 'bi me-2';
    textElement.className = 'small fw-bold';

    switch (status) {
        case 'online':
            icon.classList.add('bi-check-circle-fill', 'status-online');
            textElement.classList.add('status-online');
            break;
        case 'offline':
            icon.classList.add('bi-x-circle-fill', 'status-offline');
            textElement.classList.add('status-offline');
            break;
        case 'checking':
            icon.classList.add('bi-arrow-repeat', 'spin', 'status-checking');
            textElement.classList.add('status-checking');
            break;
    }

    textElement.textContent = text;
}

// æ›´æ–°å½“å‰å·¥ä½œæµæ˜¾ç¤º
function updateCurrentWorkflow(workflowType) {
    const workflowInfoAlert = document.getElementById('workflowInfoAlert');
    const workflowTitle = document.getElementById('workflowTitle');
    const workflowDescription = document.getElementById('workflowDescription');
    const workflowStatusBadge = document.getElementById('workflowStatusBadge');

    if (workflowType === 'vl_model') {
        workflowTitle.textContent = 'å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼ (ç›´æ¥è¯†åˆ«)';
        workflowDescription.textContent = 'ç›´æ¥ä½¿ç”¨å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼ˆå¦‚GPT-4Vï¼‰ç†è§£æ–‡æ¡£å†…å®¹å¹¶æå–æ•°æ®ã€‚åœ¨å¤„ç†å¤æ‚å¸ƒå±€ã€è¡¨æ ¼å’Œæ‰‹å†™æ–‡å­—æ–¹é¢å¯èƒ½è¡¨ç°æ›´å¥½ã€‚';
        workflowStatusBadge.textContent = 'å®éªŒæ€§';
        workflowStatusBadge.className = 'badge bg-warning';
    } else if (workflowType === 'vlm_transformers') {
        workflowTitle.textContent = 'VLM Transformers æ¨¡å¼ (OCR + LLM)';
        workflowDescription.textContent = 'ä½¿ç”¨VLM Transformersè¿›è¡ŒOCRæ–‡å­—è¯†åˆ«ï¼Œç„¶åä½¿ç”¨LLMæå–ç»“æ„åŒ–æ•°æ®ã€‚è¿™æ˜¯å¢å¼ºç‰ˆçš„OCRå·¥ä½œæµã€‚';
        workflowStatusBadge.textContent = 'å¢å¼º';
        workflowStatusBadge.className = 'badge bg-info';
    } else {
        workflowTitle.textContent = 'OCR + LLM æ¨¡å¼ (ä¼ ç»Ÿå·¥ä½œæµ)';
        workflowDescription.textContent = 'ä½¿ç”¨ä¼ ç»ŸOCRè¿›è¡Œæ–‡å­—è¯†åˆ«ï¼Œç„¶åä½¿ç”¨LLMæå–ç»“æ„åŒ–æ•°æ®ã€‚è¿™æ˜¯æˆç†Ÿç¨³å®šçš„ä¼ ç»Ÿå·¥ä½œæµã€‚';
        workflowStatusBadge.textContent = 'ç¨³å®š';
        workflowStatusBadge.className = 'badge bg-success';
    }

    // æ˜¾ç¤ºå·¥ä½œæµä¿¡æ¯æç¤ºæ¡†
    workflowInfoAlert.style.display = 'block';
}

// è®¾ç½®ä¸Šä¼ åŒºåŸŸ
function setupUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    // æ‹–æ‹½åŠŸèƒ½
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(file) {
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    const allowedTypes = ['.pdf', '.jpg', '.jpeg', '.png', '.tiff', '.bmp'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    if (!allowedTypes.includes(fileExtension)) {
        alert('åªæ”¯æŒPDFã€JPGã€PNGã€JPEGã€TIFFã€BMPæ ¼å¼çš„æ–‡ä»¶');
        return;
    }

    // æ£€æŸ¥æ–‡ä»¶å¤§å°
    if (file.size > 10 * 1024 * 1024) {
        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        return;
    }

    // è®¾ç½®æ–‡ä»¶å›¾æ ‡
    const fileIcon = document.getElementById('fileIcon');
    if (fileExtension === '.pdf') {
        fileIcon.className = 'bi bi-file-pdf text-danger me-3';
    } else if (['.jpg', '.jpeg', '.png', '.tiff', '.bmp'].includes(fileExtension)) {
        fileIcon.className = 'bi bi-file-image text-success me-3';
    }

    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    document.querySelector('.upload-content').style.display = 'none';
    document.querySelector('.file-info').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);

    // è‡ªåŠ¨å¡«å……æŠ¥å‘Šæè¿°ï¼ˆå¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰å¡«å†™ï¼‰
    const reportDescription = document.getElementById('report_description');
    if (!reportDescription.value || reportDescription.value.trim() === '') {
        // å»æ‰æ–‡ä»¶æ‰©å±•åä½œä¸ºé»˜è®¤æè¿°
        const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
        reportDescription.value = fileNameWithoutExt;
    }

    // å¯ç”¨æäº¤æŒ‰é’®
    document.getElementById('submitBtn').disabled = false;
}

// æ¸…é™¤æ–‡ä»¶é€‰æ‹©
function clearFile() {
    document.getElementById('fileInput').value = '';
    document.querySelector('.upload-content').style.display = 'block';
    document.querySelector('.file-info').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// è®¾ç½®è¡¨å•æäº¤
function setupFormSubmit() {
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile();
    });
}

// åŠ è½½åŒ»é™¢ä¸‹æ‹‰åˆ—è¡¨
async function loadHospitalDropdown() {
    const hospitalDropdown = document.getElementById('hospitalDropdown');

    try {
        const response = await fetch('{% url "medical_records:api_common_hospitals" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success && result.hospitals.length > 0) {
                // æ¸…ç©ºåŠ è½½æç¤º
                hospitalDropdown.innerHTML = '';

                // æ·»åŠ ç”¨æˆ·å†å²è®°å½•çš„åŒ»é™¢é€‰é¡¹
                result.hospitals.forEach(hospital => {
                    const li = document.createElement('li');

                    // åˆ›å»ºä½¿ç”¨æ¬¡æ•°å¾½ç« 
                    let usageBadge = '';
                    if (hospital.usage_count > 1) {
                        usageBadge = `<span class="badge bg-primary ms-2">${hospital.usage_count}æ¬¡</span>`;
                    }

                    li.innerHTML = `
                        <a class="dropdown-item hospital-preset" href="#" data-hospital="${hospital.name}">
                            <div>
                                <strong>${hospital.name}</strong>
                                ${usageBadge}
                                <div class="small text-muted mt-1">æœ€åä½¿ç”¨: ${hospital.last_used}</div>
                            </div>
                        </a>
                    `;

                    hospitalDropdown.appendChild(li);
                });

                // é‡æ–°è®¾ç½®ç‚¹å‡»äº‹ä»¶
                setupHospitalClickEvents();
            } else {
                // ç”¨æˆ·æ²¡æœ‰å†å²è®°å½•
                hospitalDropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">æš‚æ— å†å²è®°å½•</a></li>';
            }
        } else {
            hospitalDropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">åŠ è½½å¤±è´¥</a></li>';
        }
    } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
        hospitalDropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">ç½‘ç»œé”™è¯¯</a></li>';
    }
}

// è®¾ç½®åŒ»é™¢ç‚¹å‡»äº‹ä»¶
function setupHospitalClickEvents() {
    const hospitalPresets = document.querySelectorAll('.hospital-preset');
    hospitalPresets.forEach(preset => {
        preset.addEventListener('click', function(e) {
            e.preventDefault();
            const hospitalName = this.getAttribute('data-hospital');
            document.getElementById('hospital').value = hospitalName;
        });
    });
}

// è®¾ç½®å·¥ä½œæµé€‰æ‹©
function setupWorkflowSelection() {
    const workflowOptions = document.querySelectorAll('.workflow-option');
    const workflowRadios = document.querySelectorAll('input[name="workflow_type"]');

    // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
    updateWorkflowSelection();

    // ä¸ºæ¯ä¸ªå·¥ä½œæµé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
    workflowOptions.forEach(option => {
        option.addEventListener('click', function() {
            const workflow = this.getAttribute('data-workflow');
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                updateWorkflowSelection();
                updateWorkflowInfo(workflow);
            }
        });
    });

    // ä¸ºå•é€‰æŒ‰é’®æ·»åŠ å˜åŒ–äº‹ä»¶
    workflowRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateWorkflowSelection();
            updateWorkflowInfo(this.value);
        });
    });
}

// æ›´æ–°å·¥ä½œæµé€‰æ‹©çŠ¶æ€
function updateWorkflowSelection() {
    const selectedRadio = document.querySelector('input[name="workflow_type"]:checked');
    const workflowOptions = document.querySelectorAll('.workflow-option');

    workflowOptions.forEach(option => {
        const workflow = option.getAttribute('data-workflow');
        if (selectedRadio && selectedRadio.value === workflow) {
            option.classList.add('selected');
        } else {
            option.classList.remove('selected');
        }
    });
}

// æ›´æ–°å·¥ä½œæµä¿¡æ¯æ˜¾ç¤º
function updateWorkflowInfo(workflowType) {
    console.log('Selected workflow:', workflowType);
    
    // æ›´æ–°æ¨¡å¼è¯´æ˜åŒºåŸŸ
    const workflowTitle = document.getElementById('workflowTitle');
    const workflowDescription = document.getElementById('workflowDescription');
    const workflowStatusBadge = document.getElementById('workflowStatusBadge');

    if (workflowType === 'vl_model') {
        workflowTitle.textContent = 'å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼ (ç›´æ¥è¯†åˆ«)';
        workflowDescription.textContent = 'ç›´æ¥ä½¿ç”¨å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼ˆå¦‚GPT-4Vï¼‰ç†è§£æ–‡æ¡£å†…å®¹å¹¶æå–æ•°æ®ã€‚åœ¨å¤„ç†å¤æ‚å¸ƒå±€ã€è¡¨æ ¼å’Œæ‰‹å†™æ–‡å­—æ–¹é¢å¯èƒ½è¡¨ç°æ›´å¥½ã€‚';
        workflowStatusBadge.textContent = 'å®éªŒæ€§';
        workflowStatusBadge.className = 'badge bg-warning';
    } else if (workflowType === 'vlm_transformers') {
        workflowTitle.textContent = 'VLM Transformers æ¨¡å¼ (OCR + LLM)';
        workflowDescription.textContent = 'ä½¿ç”¨VLM Transformersè¿›è¡ŒOCRæ–‡å­—è¯†åˆ«ï¼Œç„¶åä½¿ç”¨LLMæå–ç»“æ„åŒ–æ•°æ®ã€‚è¿™æ˜¯å¢å¼ºç‰ˆçš„OCRå·¥ä½œæµã€‚';
        workflowStatusBadge.textContent = 'å¢å¼º';
        workflowStatusBadge.className = 'badge bg-info';
    } else {
        workflowTitle.textContent = 'OCR + LLM æ¨¡å¼ (ä¼ ç»Ÿå·¥ä½œæµ)';
        workflowDescription.textContent = 'ä½¿ç”¨ä¼ ç»ŸOCRè¿›è¡Œæ–‡å­—è¯†åˆ«ï¼Œç„¶åä½¿ç”¨LLMæå–ç»“æ„åŒ–æ•°æ®ã€‚è¿™æ˜¯æˆç†Ÿç¨³å®šçš„ä¼ ç»Ÿå·¥ä½œæµã€‚';
        workflowStatusBadge.textContent = 'ç¨³å®š';
        workflowStatusBadge.className = 'badge bg-success';
    }
    
    // æ›´æ–°åº•éƒ¨çš„å»ºè®®æç¤º
    const formText = document.querySelector('.form-text');
    if (workflowType === 'vl_model') {
        formText.innerHTML = '<i class="bi bi-info-circle"></i> <strong>å»ºè®®ï¼š</strong>å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼æœ€é€‚åˆå›¾ç‰‡æ–‡ä»¶ï¼Œå¯ç›´æ¥ç†è§£å›¾ç‰‡å†…å®¹ï¼Œæ— éœ€OCRè½¬æ¢æ­¥éª¤';
    } else if (workflowType === 'vlm_transformers') {
        formText.innerHTML = '<i class="bi bi-info-circle"></i> <strong>å»ºè®®ï¼š</strong>VLM Transformersæ¨¡å¼é€‚åˆå¤æ‚å¸ƒå±€æ–‡æ¡£ï¼ŒVLMè§†è§‰ç†è§£èƒ½åŠ›æ›´å¼º';
    } else {
        formText.innerHTML = '<i class="bi bi-info-circle"></i> <strong>å»ºè®®ï¼š</strong>PDFæ–‡ä»¶æ¨èä½¿ç”¨OCR + LLMæ¨¡å¼ï¼Œå›¾ç‰‡æ–‡ä»¶æ¨èä½¿ç”¨å¤šæ¨¡æ€å¤§æ¨¡å‹æ¨¡å¼';
    }
}

// ä¸Šä¼ æ–‡ä»¶
async function uploadFile() {
    const formData = new FormData();
    const fileInput = document.getElementById('fileInput');

    formData.append('file', fileInput.files[0]);
    formData.append('checkup_date', document.getElementById('checkup_date').value);

    // æ·»åŠ æŠ¥å‘Šæè¿°å­—æ®µ
    const reportDescription = document.getElementById('report_description').value.trim();
    if (reportDescription) {
        formData.append('report_description', reportDescription);
    }

    // æ·»åŠ åŒ»é™¢å­—æ®µ
    const hospital = document.getElementById('hospital').value;
    if (hospital) {
        formData.append('hospital', hospital);
    }

    // æ·»åŠ å·¥ä½œæµç±»å‹å­—æ®µ
    const workflowType = document.querySelector('input[name="workflow_type"]:checked').value;
    formData.append('workflow_type', workflowType);

    // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';

    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    document.getElementById('fileDetails').innerHTML = `
        <div><strong>æ–‡ä»¶åï¼š</strong>${fileInput.files[0].name}</div>
        <div><strong>å¤§å°ï¼š</strong>${formatFileSize(fileInput.files[0].size)}</div>
        <div><strong>ä½“æ£€æ—¥æœŸï¼š</strong>${document.getElementById('checkup_date').value}</div>
    `;

    // æ¸…ç©ºæ—¥å¿—
    const uploadProgressLog = document.getElementById('uploadProgressLog');
    if (uploadProgressLog) {
        uploadProgressLog.innerHTML = '<div class="text-secondary">å‡†å¤‡å¼€å§‹...</div>';
    }

    // éšè—OCRç»“æœåŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const ocrResults = document.getElementById('ocrResults');
    if (ocrResults) {
        ocrResults.style.display = 'none';
    }

    // Wake Lock API - ä¿æŒå±å¹•å¸¸äº®
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock activated');
            }
        } catch (err) {
            console.log(`Wake Lock error: ${err.name}, ${err.message}`);
        }
    }

    // è¯·æ±‚Wake Lock
    await requestWakeLock();

    // Page Visibility API - æ£€æµ‹é¡µé¢å¯è§æ€§
    let uploadCancelled = false;
    const handleVisibilityChange = () => {
        if (document.hidden) {
            addUploadLogEntry('âš ï¸ è­¦å‘Šï¼šè¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œåˆ‡æ¢åå°å¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥', 'warning');
        } else {
            addUploadLogEntry('âœ… é¡µé¢å·²æ¢å¤ï¼Œç»§ç»­ä¸Šä¼ ...', 'info');
            // é‡æ–°è¯·æ±‚Wake Lockï¼ˆå› ä¸ºåˆ‡æ¢åå°ä¼šé‡Šæ”¾ï¼‰
            requestWakeLock();
        }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    // è·å–ç”¨æˆ·çš„å¤„ç†æ¨¡å¼
    let processingMode = 'background'; // é»˜è®¤åå°æ¨¡å¼
    try {
        const modeResponse = await fetch('{% url "medical_records:api_processing_mode" %}');
        if (modeResponse.ok) {
            const modeData = await modeResponse.json();
            processingMode = modeData.mode;
            console.log('å½“å‰å¤„ç†æ¨¡å¼:', processingMode);
        }
    } catch (error) {
        console.error('è·å–å¤„ç†æ¨¡å¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å¼:', error);
    }

    // åå°æ¨¡å¼å¤„ç†
    if (processingMode === 'background') {
        try {
            addUploadLogEntry('ğŸ“¤ æ­£åœ¨åˆ›å»ºåå°ä»»åŠ¡...', 'info');

            const bgResponse = await fetch('{% url "medical_records:api_create_upload_task" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (!bgResponse.ok) {
                throw new Error(`åˆ›å»ºä»»åŠ¡å¤±è´¥: HTTP ${bgResponse.status}`);
            }

            const data = await bgResponse.json();
            const taskId = data.task_id;

            if (!taskId) {
                throw new Error('æœªè¿”å›ä»»åŠ¡ID');
            }

            addUploadLogEntry(`âœ… åå°ä»»åŠ¡å·²åˆ›å»º (ID: ${taskId.substring(0, 8)}...)`, 'success');
            addUploadLogEntry('ğŸ“‹ ä»»åŠ¡æ­£åœ¨åå°å¤„ç†ï¼Œæ‚¨å¯ä»¥ç¦»å¼€æ­¤é¡µé¢', 'info');
            addUploadLogEntry('ğŸ”„ å¤„ç†å®Œæˆåï¼Œç»“æœå°†ä¿å­˜åˆ°ç³»ç»Ÿä¸­', 'info');

            // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
            await pollTaskStatus(taskId);

        } catch (bgError) {
            throw bgError;
        }
    } else {
        // å®æ—¶æµå¼æ¨¡å¼å¤„ç†
        try {
        // ä½¿ç”¨æµå¼APIï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶

        const response = await fetch('{% url "medical_records:api_stream_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
        if (uploadCancelled) {
            throw new Error('ä¸Šä¼ å·²å–æ¶ˆ');
        }

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // è¯»å–æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let finalResult = null;
        let buffer = '';
        let uploadLLMOutputBuffer = '';

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è¿½åŠ LLM tokenåˆ°è¾“å‡ºåŒºåŸŸ
        function appendUploadLLMToken(token) {
            const llmOutput = document.getElementById('uploadLLMOutput');
            if (!llmOutput) return;

            uploadLLMOutputBuffer += token;

            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦å¹¶æ˜¾ç¤º
            llmOutput.innerHTML = escapeHtml(uploadLLMOutputBuffer)
                .replace(/\n/g, '<br>')
                .replace(/\{/g, '<span style="color: #66d9ef;">{</span>')
                .replace(/\}/g, '<span style="color: #66d9ef;">}</span>')
                .replace(/"([^"]+)":/g, '<span style="color: #a6e22e;">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span style="color: #fd971f;">"$1"</span>');

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            llmOutput.scrollTop = llmOutput.scrollHeight;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addUploadLogEntry(message, type = 'info') {
            const progressLog = document.getElementById('uploadProgressLog');
            if (!progressLog) return;

            const timestamp = new Date().toLocaleTimeString();

            const colors = {
                'info': '#61dafb',
                'success': '#4ade80',
                'warning': '#fbbf24',
                'error': '#f87171'
            };

            const color = colors[type] || colors['info'];

            const entry = document.createElement('div');
            entry.style.cssText = `
                margin-bottom: 8px;
                padding: 8px;
                background: rgba(255, 255, 255, 0.05);
                border-left: 3px solid ${color};
                border-radius: 3px;
                color: ${color};
                font-family: 'Courier New', monospace;
            `;
            entry.innerHTML = `
                <span style="opacity: 0.6; font-size: 0.85em;">${timestamp}</span>
                <span style="margin-left: 10px; font-weight: bold;">[${type.toUpperCase()}]</span>
                <span style="margin-left: 8px;">${message}</span>
            `;

            progressLog.appendChild(entry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateUploadProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);
            }

            if (progressText) {
                progressText.textContent = percent + '%';
            }
        }

        // å¤„ç†SSEæ¶ˆæ¯çš„å‡½æ•°
        function processUploadSSELine(line) {
            if (!line.trim()) return;

            if (line.startsWith('data: ')) {
                try {
                    const jsonStr = line.slice(6).trim();
                    if (!jsonStr) return;

                    const data = JSON.parse(jsonStr);

                    if (data.error) {
                        addUploadLogEntry('âŒ é”™è¯¯: ' + data.error, 'error');
                        showError('ä¸Šä¼ å¤±è´¥ï¼š' + data.error);
                        return;
                    } else if (data.status === 'validating') {
                        addUploadLogEntry('âœ“ ' + data.message, 'info');
                        updateUploadProgress(10);
                    } else if (data.status === 'creating_records') {
                        addUploadLogEntry('ğŸ“ ' + data.message, 'info');
                        updateUploadProgress(20);
                    } else if (data.status === 'file_saved') {
                        addUploadLogEntry('ğŸ’¾ ' + data.message, 'info');
                        updateUploadProgress(30);
                    } else if (data.status === 'vlm_start') {
                        addUploadLogEntry(data.message, 'warning');
                        updateUploadProgress(40);
                    } else if (data.status === 'ocr_start') {
                        addUploadLogEntry(data.message, 'warning');
                        updateUploadProgress(40);
                    } else if (data.status === 'ocr_complete') {
                        addUploadLogEntry('âœ“ ' + data.message, 'success');
                        updateUploadProgress(60);
                    } else if (data.status === 'ai_start') {
                        addUploadLogEntry(data.message, 'warning');
                        // æ˜¾ç¤ºLLMè¾“å‡ºåŒºåŸŸ
                        const llmCard = document.getElementById('uploadLLMOutputCard');
                        if (llmCard) llmCard.style.display = 'block';
                        updateUploadProgress(70);
                    } else if (data.status === 'llm_token') {
                        // å®æ—¶æ˜¾ç¤ºLLMè¾“å‡ºçš„token
                        appendUploadLLMToken(data.token);
                    } else if (data.status === 'ai_complete') {
                        addUploadLogEntry('âœ“ ' + data.message, 'success');
                        updateUploadProgress(85);
                    } else if (data.status === 'saving_start') {
                        addUploadLogEntry(data.message, 'info');
                        updateUploadProgress(90);
                    } else if (data.status === 'complete') {
                        finalResult = data;
                        addUploadLogEntry('âœ… ' + data.message, 'success');
                        updateUploadProgress(100);
                    }
                } catch (parseError) {
                    console.warn('è·³è¿‡æ— æ³•è§£æçš„SSEæ¶ˆæ¯:', parseError.message);
                }
            }
        }

        while (true) {
            const { done, value } = await reader.read();

            if (done) {
                if (buffer.trim()) {
                    processUploadSSELine(buffer);
                    buffer = '';
                }
                break;
            }

            const chunk = decoder.decode(value, { stream: true });
            buffer += chunk;

            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
                processUploadSSELine(line);
            }
        }

        if (finalResult) {
            showSuccess({
                health_checkup_id: finalResult.checkup_id,
                indicators_count: finalResult.indicators_count
            });
        }

        } catch (streamError) {
            throw streamError;
        }
    } // end of else (stream mode)

    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);

        // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
        if (error.name === 'AbortError') {
            showError('ä¸Šä¼ è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
        } else if (error.message === 'ä¸Šä¼ å·²å–æ¶ˆ') {
            showError('ä¸Šä¼ å·²å–æ¶ˆ');
        } else {
            showError('ä¸Šä¼ å¤±è´¥: ' + error.message);
        }
    } finally {
        // æ¸…ç†èµ„æº
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        // é‡Šæ”¾Wake Lock
        if (wakeLock !== null) {
            wakeLock.release()
                .then(() => {
                    wakeLock = null;
                    console.log('Wake Lock released');
                })
                .catch((err) => {
                    console.error(`Wake Lock release error: ${err.name}, ${err.message}`);
                });
        }
    }
}

// å¼€å§‹è¿›åº¦ç›‘æ§
function startProgressMonitoring() {
    progressInterval = setInterval(async function() {
        try {
            const response = await fetch(`{% url "medical_records:api_status" 0 %}`.replace('0', currentProcessingId));
            const result = await response.json();

            console.log('DEBUG: API response for processing ID', currentProcessingId, ':', result);
            updateProgress(result);

            // å¦‚æœå¤„ç†å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢ç›‘æ§
            if (result.status === 'completed' || result.status === 'failed') {
                clearInterval(progressInterval);

                if (result.status === 'completed') {
                    showSuccess(result);
                } else {
                    showError(result.error_message);
                }
            }
        } catch (error) {
            console.error('è·å–è¿›åº¦å¤±è´¥:', error);
        }
    }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}

// æ›´æ–°è¿›åº¦
function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusDetails = document.getElementById('statusDetails');

    progressBar.style.width = data.progress + '%';
    progressText.textContent = data.progress + '%';

    // æ›´æ–°çŠ¶æ€è¯¦æƒ…
    let statusMessage = data.status_message || getStatusMessage(data.status);

    // åªåœ¨çœŸæ­£æœ‰é”™è¯¯ä¸”çŠ¶æ€ä¸æ˜¯å®Œæˆæ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (data.error_message && data.error_message.trim() && data.status === 'failed') {
        statusMessage += '<br><span class="text-danger">é”™è¯¯: ' + data.error_message + '</span>';
    }

    if (data.indicators_count > 0) {
        statusMessage += '<br><span class="text-success">å·²è¯†åˆ« ' + data.indicators_count + ' é¡¹å¥åº·æŒ‡æ ‡</span>';
    }
    statusDetails.innerHTML = statusMessage;

    // æ˜¾ç¤ºOCRç»“æœ
    if (data.ocr_result) {
        document.getElementById('ocrResults').style.display = 'block';
        document.getElementById('ocrLength').textContent = data.ocr_result_length;
        document.getElementById('ocrContent').textContent = data.ocr_result;
    }

    // æ˜¾ç¤ºLLMç»“æœ
    if (data.ai_result) {
        document.getElementById('llmResults').style.display = 'block';
        document.getElementById('llmCount').textContent = data.ai_indicators_count;
        document.getElementById('llmContent').textContent = JSON.stringify(data.ai_result, null, 2);
    }

    // æ˜¾ç¤ºå¤šæ¨¡æ€æ¨¡å‹ç»“æœ
    if (data.vl_model_result) {
        console.log('DEBUG: Found VL model result:', data.vl_model_result);
        console.log('DEBUG: VL indicators count:', data.vl_model_result.indicators ? data.vl_model_result.indicators.length : 0);

        // åˆ›å»ºæˆ–æ˜¾ç¤ºVLæ¨¡å‹ç»“æœåŒºåŸŸ
        let vlResultsDiv = document.getElementById('vlResults');
        if (!vlResultsDiv) {
            const llmResults = document.getElementById('llmResults');
            if (!llmResults) {
                console.log('DEBUG: llmResults element not found!');
                return;
            }
            vlResultsDiv = llmResults.cloneNode(true);
            vlResultsDiv.id = 'vlResults';
            vlResultsDiv.querySelector('.card-header').innerHTML = '<h6 class="mb-0"><i class="bi bi-eye"></i> å¤šæ¨¡æ€æ¨¡å‹åˆ†æç»“æœ</h6>';

            // ä¿®æ”¹span IDä»¥é¿å…å†²çª
            const llmCountSpan = vlResultsDiv.querySelector('#llmCount');
            if (llmCountSpan) {
                llmCountSpan.id = 'vlCount';
            }
            const llmContent = vlResultsDiv.querySelector('#llmContent');
            if (llmContent) {
                llmContent.id = 'vlContent';
            }

            llmResults.parentNode.insertBefore(vlResultsDiv, llmResults.nextSibling);
        }

        vlResultsDiv.style.display = 'block';

        // è®¡ç®—VLæ¨¡å‹æŒ‡æ ‡æ•°é‡
        let vlCount = 0;
        if (data.vl_model_result.indicators && Array.isArray(data.vl_model_result.indicators)) {
            vlCount = data.vl_model_result.indicators.length;
        } else if (data.vl_indicators && Array.isArray(data.vl_indicators)) {
            vlCount = data.vl_indicators.length;
        }

        console.log('DEBUG: Final VL count:', vlCount);
        const vlCountSpan = vlResultsDiv.querySelector('#vlCount');
        if (vlCountSpan) {
            vlCountSpan.textContent = vlCount;
            console.log('DEBUG: Successfully updated VL count span');
        } else {
            console.log('DEBUG: #vlCount element not found!');
        }

        // å¦‚æœæœ‰VLæŒ‡æ ‡ï¼Œæ˜¾ç¤ºå…·ä½“å†…å®¹è€Œä¸æ˜¯ç­‰å¾…ä¿¡æ¯
        if (vlCount > 0) {
            const indicators = data.vl_model_result.indicators || data.vl_indicators || [];
            let content = 'å¤šæ¨¡æ€æ¨¡å‹æˆåŠŸæå–äº†ä»¥ä¸‹å¥åº·æŒ‡æ ‡ï¼š\n\n';
            indicators.forEach((indicator, index) => {
                const name = indicator.indicator || indicator.indicator_name || 'æœªçŸ¥æŒ‡æ ‡';
                const value = indicator.measured_value || indicator.value || 'N/A';
                const status = indicator.abnormal === 'æ˜¯' || indicator.abnormal === true ? 'å¼‚å¸¸' : 'æ­£å¸¸';
                content += `${index + 1}. ${name}: ${value} (${status})\n`;
            });
            vlResultsDiv.querySelector('pre').textContent = content;
        } else {
            vlResultsDiv.querySelector('pre').textContent = 'ç­‰å¾…AIåˆ†æ...';
        }
    }

    // æ˜¾ç¤ºæœ€ç»ˆæŒ‡æ ‡ï¼ˆä¼˜å…ˆä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹ç»“æœï¼Œå¦åˆ™ä½¿ç”¨ä¼ ç»ŸAIç»“æœï¼‰
    let indicators = [];
    if (data.vl_model_result && data.vl_model_result.indicators) {
        indicators = data.vl_model_result.indicators;
    } else if (data.ai_indicators) {
        indicators = data.ai_indicators;
    }

    // å¦‚æœæœ‰æŒ‡æ ‡æ•°æ®ï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
    if (indicators.length > 0) {
        document.getElementById('finalResults').style.display = 'block';
        displayIndicators(indicators);

        // å¦‚æœæ˜¯å¤šæ¨¡æ€æ¨¡å‹æˆåŠŸä¸”æœ‰æŒ‡æ ‡ï¼Œéšè—ä¼ ç»ŸLLMç»“æœåŒºåŸŸï¼ˆé¿å…é‡å¤æ˜¾ç¤ºï¼‰
        if (data.vl_model_result && data.vl_model_result.indicators && data.vl_model_result.indicators.length > 0) {
            const llmResults = document.getElementById('llmResults');
            if (llmResults) {
                llmResults.style.display = 'none';
            }
        } else {
            // ç¡®ä¿ä¼ ç»ŸLLMç»“æœåŒºåŸŸæ˜¾ç¤º
            const llmResults = document.getElementById('llmResults');
            if (llmResults) {
                llmResults.style.display = 'block';
            }
        }
    }
    // å¦‚æœæ²¡æœ‰ä»»ä½•æŒ‡æ ‡ï¼Œæ˜¾ç¤º"æ— æ•°æ®"
    else {
        document.getElementById('finalResults').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'block';
    }
}

// æ˜¾ç¤ºæŒ‡æ ‡åˆ—è¡¨
function displayIndicators(indicators) {
    const indicatorsList = document.getElementById('indicatorsList');
    let html = '<div class="row">';

    indicators.forEach((indicator, index) => {
        const statusClass = indicator.abnormal === 'æ˜¯' ? 'danger' :
                          indicator.abnormal === 'å¦' ? 'success' : 'warning';
        const statusText = indicator.abnormal === 'æ˜¯' ? 'å¼‚å¸¸' :
                        indicator.abnormal === 'å¦' ? 'æ­£å¸¸' : 'å¾…ç¡®è®¤';

        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border-${statusClass}">
                    <div class="card-body">
                        <h6 class="card-title">
                            <span class="badge bg-${statusClass} me-2">${statusText}</span>
                            ${indicator.indicator}
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">æ£€æµ‹å€¼:</small><br>
                                <strong>${indicator.measured_value}</strong>
                            </div>
                            <div class="col-6 text-end">
                                <small class="text-muted">æ­£å¸¸èŒƒå›´:</small><br>
                                <span>${indicator.normal_range || 'æœªæä¾›'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    indicatorsList.innerHTML = html;
}

// è·å–çŠ¶æ€æ¶ˆæ¯
function getStatusMessage(status) {
    const statusMessages = {
        'pending': 'ç­‰å¾…å¼€å§‹å¤„ç†...',
        'uploading': 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...',
        'ocr_processing': 'æ­£åœ¨è¿›è¡ŒOCRæ–‡å­—è¯†åˆ«...',
        'ai_processing': 'æ­£åœ¨è¿›è¡ŒAIæ™ºèƒ½åˆ†æ...',
        'saving_data': 'æ­£åœ¨ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“...',
        'completed': 'å¤„ç†å®Œæˆï¼',
        'failed': 'å¤„ç†å¤±è´¥'
    };
    return statusMessages[status] || 'å¤„ç†ä¸­...';
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    clearInterval(progressInterval);
    document.getElementById('errorAlert').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('progressBar').classList.remove('progress-bar-animated');
    document.getElementById('progressBar').classList.add('bg-danger');
}

// æ˜¾ç¤ºæˆåŠŸ
function showSuccess(data) {
    clearInterval(progressInterval);
    document.getElementById('successAlert').style.display = 'block';

    let successMessage = 'ä½“æ£€æŠ¥å‘Šå¤„ç†å®Œæˆï¼';
    if (data.indicators_count) {
        successMessage += `æˆåŠŸè¯†åˆ« ${data.indicators_count} é¡¹å¥åº·æŒ‡æ ‡ã€‚`;
    }
    if (data.processing_time) {
        successMessage += `å¤„ç†è€—æ—¶: ${data.processing_time}`;
    }

    document.getElementById('successMessage').textContent = successMessage;
    document.getElementById('progressBar').classList.remove('progress-bar-animated');
    document.getElementById('progressBar').classList.add('bg-success');

    // è®¾ç½®æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
    if (data.health_checkup_id) {
        const detailUrl = `{% url "medical_records:checkup_detail" 0 %}`.replace('0', data.health_checkup_id);
        document.getElementById('viewDetailsBtn').onclick = function() {
            window.location.href = detailUrl;
        };
        document.getElementById('viewDetailsBtn').disabled = false;
    } else {
        document.getElementById('viewDetailsBtn').onclick = function() {
            alert('æ— æ³•è·å–è¯¦æƒ…é¡µé¢é“¾æ¥');
        };
        document.getElementById('viewDetailsBtn').disabled = true;
    }
}

/**
 * è½®è¯¢ä»»åŠ¡çŠ¶æ€
 */
async function pollTaskStatus(taskId) {
    const maxAttempts = 600; // æœ€å¤šè½®è¯¢600æ¬¡ï¼ˆ30åˆ†é’Ÿï¼Œæ¯3ç§’ä¸€æ¬¡ï¼‰
    let attempts = 0;

    const poll = async () => {
        attempts++;

        try {
            const response = await fetch(`{% url "medical_records:api_task_status" task_id="TASK_ID" %}`.replace('TASK_ID', taskId));

            if (!response.ok) {
                throw new Error(`æŸ¥è¯¢çŠ¶æ€å¤±è´¥: HTTP ${response.status}`);
            }

            const task = await response.json();

            // æ›´æ–°è¿›åº¦
            if (task.message) {
                addUploadLogEntry(`ğŸ“Š ${task.message}`, 'info');
            }

            if (task.status === 'completed') {
                // ä»»åŠ¡å®Œæˆ
                addUploadLogEntry('âœ… å¤„ç†å®Œæˆï¼', 'success');

                if (task.result) {
                    const result = task.result;
                    if (result.success) {
                        addUploadLogEntry(`ğŸ“ˆ æå–äº† ${result.indicators_count} ä¸ªå¥åº·æŒ‡æ ‡`, 'success');

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showSuccess({
                            health_checkup_id: result.checkup_id,
                            indicators_count: result.indicators_count
                        });

                        // è·³è½¬åˆ°è¯¦æƒ…é¡µ
                        setTimeout(() => {
                            window.location.href = `/health/checkup/${result.checkup_id}/`;
                        }, 3000);
                    } else {
                        addUploadLogEntry(`âŒ å¤„ç†å¤±è´¥: ${result.error}`, 'error');
                        showError(result.error || 'å¤„ç†å¤±è´¥');
                    }
                }

                // æ¢å¤ä¸Šä¼ æŒ‰é’®
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-upload"></i> å¼€å§‹ä¸Šä¼ ';
                }

                return;
            }

            if (task.status === 'failed') {
                // ä»»åŠ¡å¤±è´¥
                throw new Error(task.error || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
            }

            // ç»§ç»­è½®è¯¢
            if (attempts < maxAttempts) {
                setTimeout(() => poll(), 3000); // 3ç§’åå†æ¬¡æŸ¥è¯¢
            } else {
                throw new Error('ä»»åŠ¡è¶…æ—¶');
            }

        } catch (error) {
            addUploadLogEntry(`âŒ æŸ¥è¯¢çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            showError(error.message);
            throw error;
        }
    };

    // å¼€å§‹è½®è¯¢
    await poll();
}
</script>
{% endblock %}
