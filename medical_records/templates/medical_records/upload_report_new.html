{% extends 'base.html' %}

{% block title %}智能上传体检报告 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
/* 智能上传页面样式 - 专业医疗+有机自然风格 */

.card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    background: var(--bg-card);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    background: var(--primary-soft);
    color: var(--primary-dark);
    border-bottom: 1px solid var(--border-color);
    padding: 1.25rem 1.5rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.card-header h4, .card-header h6 {
    font-weight: 600;
    margin: 0;
}

.card-header i {
    margin-right: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.btn {
    border-radius: var(--radius-md);
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.btn:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}

.btn-primary:hover {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text-secondary);
    border-color: var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-soft);
    border-color: var(--secondary-light);
    color: var(--text-primary);
}

.btn-outline-primary {
    background: var(--bg-card);
    border-color: var(--primary);
    color: var(--primary);
}

.btn-outline-primary:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}

.btn-outline-secondary {
    background: var(--bg-card);
    border-color: var(--border-color);
    color: var(--text-secondary);
}

.btn-outline-secondary:hover {
    background: var(--bg-soft);
    border-color: var(--secondary-light);
    color: var(--text-primary);
}

.btn-outline-danger {
    background: var(--bg-card);
    border-color: var(--danger);
    color: var(--danger);
}

.btn-outline-danger:hover {
    background: var(--danger);
    border-color: var(--danger);
    color: #fff;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.form-control, .form-select {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    outline: none;
}

.form-label {
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.form-label i {
    margin-right: 0.375rem;
    color: var(--primary);
}

.form-text {
    font-size: 0.8125rem;
    color: var(--text-muted);
}

.input-group .form-control {
    border-right: none;
}

.input-group-text, .btn-outline-secondary.dropdown-toggle {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.workflow-option {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    cursor: pointer;
    background: var(--bg-card);
}

.workflow-option:hover {
    border-color: var(--primary-light);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.workflow-option.selected {
    border-color: var(--primary);
    background: var(--primary-soft);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    padding: 3rem;
    background: var(--bg-soft);
    text-align: center;
    transition: var(--transition);
    cursor: pointer;
}

.upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-soft);
}

.upload-area.dragover {
    border-color: var(--primary);
    background: var(--primary-soft);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.upload-content i {
    font-size: 4rem;
    color: var(--primary);
}

.progress {
    height: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-soft);
}

.progress-bar {
    background: var(--primary);
    border-radius: var(--radius-sm);
}

.alert {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-weight: 500;
}

.alert-info {
    background: var(--info-soft);
    color: var(--info-dark);
    border-color: var(--info-light);
}

.alert-success {
    background: var(--success-soft);
    color: var(--success-dark);
    border-color: var(--success-light);
}

.alert-danger {
    background: var(--danger-soft);
    color: var(--danger-dark);
    border-color: var(--danger-light);
}

.alert-warning {
    background: var(--warning-soft);
    color: var(--warning-dark);
    border-color: var(--warning-light);
}

.badge {
    padding: 0.375rem 0.625rem;
    border-radius: var(--radius-sm);
    font-weight: 500;
    font-size: 0.75rem;
}

.badge.bg-success {
    background: var(--success) !important;
}

.badge.bg-primary {
    background: var(--primary) !important;
}

.text-primary {
    color: var(--primary) !important;
}

.text-danger {
    color: var(--danger) !important;
}

.text-muted {
    color: var(--text-muted) !important;
}

/* 动画 */
.spin {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 状态样式 */
.status-online {
    color: var(--success);
}

.status-offline {
    color: var(--danger);
}

.status-checking {
    color: var(--warning);
}

.nav-pills .nav-link {
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    margin: 0 0.25rem;
    border-radius: var(--radius-md);
}

.nav-pills .nav-link.active {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}

.nav-pills .nav-link.completed {
    background: var(--success);
    border-color: var(--success);
    color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 返回按钮 -->
            <div class="mb-3">
                <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> 返回首页
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-cloud-upload"></i> 智能上传体检报告
                    </h4>
                    <p class="mb-0 mt-2 opacity-75">支持PDF格式，自动OCR识别和AI数据分析</p>
                </div>
                <div class="card-body">
                    <!-- 步骤指示器 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <ul class="nav nav-pills nav-fill">
                                <li class="nav-item">
                                    <a class="nav-link active" id="upload-step1-tab" href="#">
                                        <i class="bi bi-1-circle"></i> 上传报告
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="upload-step2-tab" href="#">
                                        <i class="bi bi-2-circle"></i> AI处理中
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="upload-step3-tab" href="#">
                                        <i class="bi bi-3-circle"></i> 处理完成
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- 上传区域 -->
                    <div id="uploadSection">
                        <form id="uploadForm" enctype="multipart/form-data">
                            {% csrf_token %}

                            <!-- 基本信息 -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="checkup_date" class="form-label">
                                        <i class="bi bi-calendar"></i> 体检日期 <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="checkup_date" name="checkup_date" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="hospital" class="form-label">
                                        <i class="bi bi-hospital"></i> 体检机构
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="hospital" name="hospital"
                                               placeholder="请输入体检医院或机构名称" autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-building"></i> 历史记录
                                        </button>
                                        <ul class="dropdown-menu" id="hospitalDropdown">
                                            <li><a class="dropdown-item text-muted" href="#"><i class="bi bi-arrow-repeat spin"></i> 加载中...</a></li>
                                        </ul>
                                    </div>
                                    <div class="form-text">可选，留空将显示"未知机构"</div>
                                </div>
                            </div>

                            <!-- 报告描述 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <label for="report_description" class="form-label">
                                        <i class="bi bi-card-text"></i> 报告描述
                                    </label>
                                    <input type="text" class="form-control" id="report_description" name="report_description"
                                           placeholder="例如：年度体检报告、入职体检等（默认为文件名）" maxlength="200">
                                    <div class="form-text">可选，留空将使用上传的文件名作为描述</div>
                                </div>
                            </div>

                            <!-- 工作流模式选择 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <label for="workflow_type" class="form-label">
                                        <i class="bi bi-gear"></i> 处理模式 <span class="text-danger">*</span>
                                    </label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card workflow-option" data-workflow="ocr_llm">
                                                <div class="card-body">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="workflow_type"
                                                               id="workflow_ocr_llm" value="ocr_llm" checked>
                                                        <label class="form-check-label" for="workflow_ocr_llm">
                                                            <strong>OCR + LLM 模式</strong>
                                                        </label>
                                                    </div>
                                                    <div class="small text-muted mt-2">
                                                        <i class="bi bi-check-circle text-success"></i> 成熟稳定的传统工作流<br>
                                                        <i class="bi bi-check-circle text-success"></i> 适合处理PDF文件<br>
                                                        <i class="bi bi-check-circle text-success"></i> 支持复杂格式表格<br>
                                                        <i class="bi bi-check-circle text-success"></i> OCR识别准确度高
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card workflow-option" data-workflow="vlm_transformers">
                                                <div class="card-body">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="workflow_type"
                                                               id="workflow_vlm_transformers" value="vlm_transformers">
                                                        <label class="form-check-label" for="workflow_vlm_transformers">
                                                            <strong>VLM Transformers 模式</strong>
                                                        </label>
                                                    </div>
                                                    <div class="small text-muted mt-2">
                                                        <i class="bi bi-check-circle text-success"></i> 增强版OCR工作流<br>
                                                        <i class="bi bi-check-circle text-success"></i> VLM视觉理解能力<br>
                                                        <i class="bi bi-check-circle text-success"></i> 手写文字识别更强<br>
                                                        <i class="bi bi-check-circle text-success"></i> 适合复杂布局文档
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card workflow-option" data-workflow="vl_model">
                                                <div class="card-body">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="workflow_type"
                                                               id="workflow_vl_model" value="vl_model">
                                                        <label class="form-check-label" for="workflow_vl_model">
                                                            <strong>多模态大模型模式</strong>
                                                        </label>
                                                    </div>
                                                    <div class="small text-muted mt-2">
                                                        <i class="bi bi-check-circle text-success"></i> 直接理解文档内容<br>
                                                        <i class="bi bi-check-circle text-success"></i> 图片文件处理最快<br>
                                                        <i class="bi bi-check-circle text-success"></i> 支持症状照片分析<br>
                                                        <i class="bi bi-check-circle text-success"></i> 无需中间转换步骤
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle text-info"></i> 
                                        <strong>建议：</strong>PDF文件推荐使用OCR + LLM模式，图片文件推荐使用多模态大模型模式
                                    </div>
                                </div>
                            </div>

                            <!-- 文件上传区域 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <label class="form-label">
                                        <i class="bi bi-file-earmark-image"></i> 选择体检报告文件 <span class="text-danger">*</span>
                                    </label>
                                    <div class="upload-area" id="uploadArea">
                                        <div class="upload-content text-center p-4">
                                            <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                                            <h5>拖拽文件到此处或点击选择</h5>
                                            <p class="text-muted">支持PDF、JPG、PNG、JPEG、TIFF、BMP格式，最大文件大小10MB</p>
                                            <input type="file" id="fileInput" name="file"
                                                   class="form-control" accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" required style="display: none;">
                                            <button type="button" class="btn btn-outline-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
                                                <i class="bi bi-folder-open"></i> 选择文件
                                            </button>
                                        </div>
                                        <div class="file-info p-3" style="display: none;">
                                            <div class="d-flex align-items-center">
                                                <i id="fileIcon" class="bi bi-file-earmark text-primary me-3" style="font-size: 2rem;"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1" id="fileName"></h6>
                                                    <small class="text-muted" id="fileSize"></small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                                    <i class="bi bi-trash"></i> 清除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 服务状态检查 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0"><i class="bi bi-activity text-primary"></i> AI服务状态</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="checkServiceStatus()">
                                            <i class="bi bi-arrow-clockwise"></i> 检查状态
                                        </button>
                                    </div>
                                    <small class="text-muted">点击按钮手动检查服务状态（避免消耗API配额）</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body py-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-cpu me-3 text-muted" id="ocrStatusIcon" style="font-size: 1.2rem;"></i>
                                                <div class="flex-grow-1">
                                                    <small class="text-muted d-block">OCR服务状态</small>
                                                    <div id="ocrStatusText" class="fw-bold text-muted">未检查</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body py-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-robot me-3 text-muted" id="llmStatusIcon" style="font-size: 1.2rem;"></i>
                                                <div class="flex-grow-1">
                                                    <small class="text-muted d-block">AI分析服务状态</small>
                                                    <div id="llmStatusText" class="fw-bold text-muted">未检查</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body py-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-eye me-3 text-muted" id="vlmStatusIcon" style="font-size: 1.2rem;"></i>
                                                <div class="flex-grow-1">
                                                    <small class="text-muted d-block">多模态服务状态</small>
                                                    <div id="vlmStatusText" class="fw-bold text-muted">未检查</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 当前模式说明 -->
                            <div class="alert alert-info mb-4" id="workflowInfoAlert">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-info-circle me-2 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <strong id="workflowTitle">OCR + LLM 模式 (传统工作流)</strong>
                                        <div class="small mt-1" id="workflowDescription">使用传统OCR进行文字识别，然后使用LLM提取结构化数据。这是成熟稳定的传统工作流。</div>
                                    </div>
                                    <div class="ms-auto">
                                        <span id="workflowStatusBadge" class="badge bg-success">稳定</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 提交按钮 -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="bi bi-upload"></i> 开始智能分析
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- 处理进度区域 -->
                    <div id="progressSection" style="display: none;">
                        <div class="text-center mb-4">
                            <h5>
                                <i class="bi bi-gear-fill spin text-primary"></i> 正在处理体检报告
                            </h5>
                            <p class="text-muted">请稍候，系统正在自动分析您的健康数据...</p>
                        </div>

                        <!-- 进度条 -->
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="progressBar" role="progressbar" style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>

                        <!-- 实时处理日志 -->
                        <div class="card mb-3" style="background: #1e1e1e; color: #d4d4d4;">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title mb-0 small">
                                        <i class="bi bi-terminal-fill text-success"></i> 实时处理日志
                                    </h6>
                                    <span class="badge bg-success small" id="uploadLogStatus">运行中</span>
                                </div>
                                <div id="uploadProgressLog"
                                     style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.4; background: #2d2d2d; padding: 10px; border-radius: 4px;">
                                    <div class="text-secondary">等待开始...</div>
                                </div>
                            </div>
                        </div>

                        <!-- LLM输出区域 -->
                        <div class="card mb-3" id="uploadLLMOutputCard" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-robot text-primary"></i> AI正在分析体检报告
                                </h6>
                                <div id="uploadLLMOutput"
                                     style="max-height: 200px; overflow-y: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9em; line-height: 1.6; padding: 15px; background: white; border: 1px solid var(--border-color); border-radius: 5px; color: #333;">
                                </div>
                            </div>
                        </div>

                        <!-- 状态信息 -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">处理状态</h6>
                                        <div id="statusDetails" class="small">
                                            等待开始处理...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">文件信息</h6>
                                        <div id="fileDetails" class="small">
                                            <!-- 文件信息将在这里显示 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OCR结果 -->
                        <div id="ocrResults" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header" style="background: var(--warning-soft);">
                                    <h6 class="mb-0"><i class="bi bi-file-text text-warning"></i> OCR识别结果</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">识别字符数: <span id="ocrLength">0</span></small>
                                    </div>
                                    <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: var(--bg-soft); font-family: monospace; font-size: 0.85em;">
                                        <pre id="ocrContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">等待OCR识别...</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LLM结果 -->
                        <div id="llmResults" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header" style="background: var(--success-soft);">
                                    <h6 class="mb-0"><i class="bi bi-robot text-success"></i> AI分析结果</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">识别指标数: <span id="llmCount">0</span></small>
                                    </div>
                                    <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: var(--bg-soft); font-family: monospace; font-size: 0.85em;">
                                        <pre id="llmContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">等待AI分析...</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 最终指标 -->
                        <div id="finalResults" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header" style="background: var(--primary-soft);">
                                    <h6 class="mb-0"><i class="bi bi-clipboard-check text-primary"></i> 提取的健康指标</h6>
                                </div>
                                <div class="card-body">
                                    <div id="indicatorsList">
                                        <!-- 指标列表将在这里显示 -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 错误信息 -->
                        <div class="alert alert-danger mt-3" id="errorAlert" style="display: none;">
                            <h6><i class="bi bi-exclamation-triangle"></i> 处理失败</h6>
                            <p id="errorMessage" class="mb-0"></p>
                            <hr>
                            <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> 重新上传
                            </button>
                        </div>

                        <!-- 成功信息 -->
                        <div class="alert alert-success mt-3" id="successAlert" style="display: none;">
                            <h6><i class="bi bi-check-circle"></i> 处理完成</h6>
                            <p id="successMessage" class="mb-0"></p>
                            <div class="mt-3">
                                <button class="btn btn-success" onclick="window.location.href='{% url "medical_records:dashboard" %}'">
                                    <i class="bi bi-house"></i> 返回首页查看结果
                                </button>
                                <button class="btn btn-outline-success ms-2" id="viewDetailsBtn">
                                    <i class="bi bi-eye"></i> 查看详细信息
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 使用说明 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="bi bi-info-circle"></i> 使用说明</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">上传要求</h6>
                            <ul class="small text-muted">
                                <li>支持PDF、JPG、PNG、JPEG、TIFF、BMP格式的体检报告</li>
                                <li>文件大小不能超过10MB</li>
                                <li>报告内容清晰，文字识别效果好</li>
                                <li>建议使用正式医院的体检报告</li>
                                <li>图片格式建议为高清扫描件或照片，确保文字清晰可辨</li>
                                <li><strong>上传过程中请保持该页面等待完成</strong></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">处理流程</h6>
                            <ul class="small text-muted">
                                <li><strong>第1步：</strong>上传体检报告文件（PDF或图片格式）</li>
                                <li><strong>第2步：</strong>OCR文字识别提取文本内容</li>
                                <li><strong>第3步：</strong>AI智能分析健康指标数据</li>
                                <li><strong>第4步：</strong>自动分类并保存到数据库</li>
                                <li><strong>第5步：</strong>在首页查看分析结果和趋势</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentProcessingId = null;
let progressInterval = null;

// 页面加载时的初始化
document.addEventListener('DOMContentLoaded', function() {
    loadHospitalDropdown();
    setupWorkflowSelection();
    // 自动检查服务状态
    checkServiceStatus();
});

// 检查服务状态
async function checkServiceStatus() {
    updateStatusIcon('ocr', 'checking', '检查中...');
    updateStatusIcon('llm', 'checking', '检查中...');
    updateStatusIcon('vlm', 'checking', '检查中...');

    try {
        const response = await fetch('{% url "medical_records:api_check_services" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const result = await response.json();

            if (result.ocr_status === 'online') {
                updateStatusIcon('ocr', 'online', 'OCR服务正常');
            } else {
                updateStatusIcon('ocr', 'offline', 'OCR服务不可用');
            }

            if (result.llm_status === 'online') {
                updateStatusIcon('llm', 'online', 'AI分析服务正常');
            } else {
                updateStatusIcon('llm', 'offline', 'AI分析服务不可用');
            }

            if (result.vlm_status === 'online') {
                updateStatusIcon('vlm', 'online', '多模态服务正常');
            } else {
                updateStatusIcon('vlm', 'offline', '多模态服务不可用');
            }
        } else {
            updateStatusIcon('ocr', 'offline', '检查失败');
            updateStatusIcon('llm', 'offline', '检查失败');
            updateStatusIcon('vlm', 'offline', '检查失败');
        }
    } catch (error) {
        console.error('检查服务状态失败:', error);
        updateStatusIcon('ocr', 'offline', '检查失败');
        updateStatusIcon('llm', 'offline', '检查失败');
        updateStatusIcon('vlm', 'offline', '检查失败');
    }
}

function updateStatusIcon(service, status, text) {
    const icon = document.getElementById(service + 'StatusIcon');
    const textEl = document.getElementById(service + 'StatusText');
    
    if (icon && textEl) {
        textEl.textContent = text;
        icon.className = 'bi me-3';
        
        if (status === 'online') {
            icon.classList.add('bi-check-circle-fill', 'status-online');
            textEl.className = 'fw-bold text-success';
        } else if (status === 'offline') {
            icon.classList.add('bi-x-circle-fill', 'status-offline');
            textEl.className = 'fw-bold text-danger';
        } else {
            icon.classList.add('bi-arrow-repeat', 'spin', 'status-checking');
            textEl.className = 'fw-bold text-warning';
        }
    }
}

// 设置上传区域
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', function(e) {
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });
    }
});

function handleFileSelect(file) {
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileIcon = document.getElementById('fileIcon');
    const uploadContent = document.querySelector('.upload-content');
    const fileInfo = document.querySelector('.file-info');
    const submitBtn = document.getElementById('submitBtn');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = formatFileSize(file.size);
    
    if (fileIcon) {
        if (file.name.toLowerCase().endsWith('.pdf')) {
            fileIcon.className = 'bi bi-file-earmark-pdf text-danger me-3';
        } else {
            fileIcon.className = 'bi bi-file-earmark-image text-primary me-3';
        }
    }
    
    if (uploadContent) uploadContent.style.display = 'none';
    if (fileInfo) fileInfo.style.display = 'block';
    if (submitBtn) submitBtn.disabled = false;
}

function clearFile() {
    const fileInput = document.getElementById('fileInput');
    const uploadContent = document.querySelector('.upload-content');
    const fileInfo = document.querySelector('.file-info');
    const submitBtn = document.getElementById('submitBtn');
    
    if (fileInput) fileInput.value = '';
    if (uploadContent) uploadContent.style.display = 'block';
    if (fileInfo) fileInfo.style.display = 'none';
    if (submitBtn) submitBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 设置工作流选择
function setupWorkflowSelection() {
    const workflowOptions = document.querySelectorAll('.workflow-option');
    
    workflowOptions.forEach(option => {
        option.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                updateWorkflowSelection();
            }
        });
    });
    
    updateWorkflowSelection();
}

function updateWorkflowSelection() {
    const options = document.querySelectorAll('.workflow-option');
    const selectedRadio = document.querySelector('input[name="workflow_type"]:checked');
    
    options.forEach(option => {
        option.classList.remove('selected');
    });
    
    if (selectedRadio) {
        const selectedOption = selectedRadio.closest('.workflow-option');
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
        // 更新工作流信息
        const workflowInfo = {
            'ocr_llm': {
                title: 'OCR + LLM 模式 (传统工作流)',
                description: '使用传统OCR进行文字识别，然后使用LLM提取结构化数据。这是成熟稳定的传统工作流。',
                badge: '稳定'
            },
            'vlm_transformers': {
                title: 'VLM Transformers 模式 (增强OCR)',
                description: '使用VLM Transformers进行OCR文字识别，增强版OCR工作流，适合复杂布局文档。',
                badge: '增强'
            },
            'vl_model': {
                title: '多模态大模型模式 (直接理解)',
                description: '直接使用多模态大模型理解文档内容并提取数据，处理图片文件最快。',
                badge: '快速'
            }
        };
        
        const info = workflowInfo[selectedRadio.value];
        if (info) {
            const titleEl = document.getElementById('workflowTitle');
            const descEl = document.getElementById('workflowDescription');
            const badgeEl = document.getElementById('workflowStatusBadge');
            
            if (titleEl) titleEl.textContent = info.title;
            if (descEl) descEl.textContent = info.description;
            if (badgeEl) badgeEl.textContent = info.badge;
        }
    }
}

// 加载医院下拉菜单
async function loadHospitalDropdown() {
    const dropdown = document.getElementById('hospitalDropdown');
    if (!dropdown) return;
    
    try {
        const response = await fetch('{% url "medical_records:api_common_hospitals" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.hospitals && result.hospitals.length > 0) {
                dropdown.innerHTML = '';
                result.hospitals.forEach(hospital => {
                    const li = document.createElement('li');
                    const hospitalName = hospital.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    li.innerHTML = `<a class="dropdown-item" href="#" onclick="selectHospital('${hospitalName}'); return false;">${hospital.name} <small class="text-muted">(${hospital.usage_count}次)</small></a>`;
                    dropdown.appendChild(li);
                });
            } else {
                dropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">暂无历史记录</a></li>';
            }
        } else {
            dropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">加载失败</a></li>';
        }
    } catch (error) {
        console.error('加载医院历史记录失败:', error);
        dropdown.innerHTML = '<li><a class="dropdown-item text-muted" href="#">加载失败</a></li>';
    }
}

function selectHospital(hospitalName) {
    const hospitalInput = document.getElementById('hospital');
    if (hospitalInput) {
        hospitalInput.value = hospitalName;
    }
}

// 设置表单提交
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleUpload();
        });
    }
});

async function handleUpload() {
    const form = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const uploadSection = document.getElementById('uploadSection');
    const progressSection = document.getElementById('progressSection');

    if (submitBtn) submitBtn.disabled = true;

    const formData = new FormData(form);

    try {
        const response = await fetch('{% url "medical_records:api_stream_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!response.ok) {
            alert('上传失败，请重试');
            if (submitBtn) submitBtn.disabled = false;
            return;
        }

        // 处理流式响应 (Server-Sent Events)
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        // 先显示进度区域
        if (uploadSection) uploadSection.style.display = 'none';
        if (progressSection) progressSection.style.display = 'block';
        updateUploadStepIndicator(2);

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });

            // 处理所有完整的数据行
            const lines = buffer.split('\n\n');
            buffer = lines.pop(); // 保留不完整的部分

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        handleStreamData(data);
                    } catch (e) {
                        console.error('解析流数据失败:', e, line);
                    }
                }
            }
        }

    } catch (error) {
        console.error('上传失败:', error);
        showError(error.message || '上传失败');
        if (submitBtn) submitBtn.disabled = false;
    }
}

function handleStreamData(data) {
    const statusDetails = document.getElementById('statusDetails');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    if (data.error) {
        showError(data.error);
        return;
    }

    if (data.status === 'complete') {
        // 设置进度到100%
        if (progressBar) progressBar.style.width = '100%';
        if (progressText) progressText.textContent = '100%';

        updateUploadStepIndicator(3);
        showSuccess({
            indicator_count: data.indicators_count,
            checkup_id: data.checkup_id
        });
        return;
    }

    // 更新进度消息
    if (data.message && statusDetails) {
        statusDetails.textContent = data.message;
    }

    // 根据状态更新进度条
    let progress = 0;
    if (data.status === 'vlm_start') progress = 30;
    else if (data.status === 'saving_start') progress = 80;
    else if (data.status === 'ocr_start') progress = 20;
    else if (data.status === 'ocr_complete') progress = 50;
    else if (data.status === 'ai_start') progress = 60;

    if (progressBar) progressBar.style.width = progress + '%';
    if (progressText) progressText.textContent = progress + '%';
}

function startProgressTracking() {
    if (!currentProcessingId) return;
    
    progressInterval = setInterval(async function() {
        try {
            const response = await fetch(`/api/status/${currentProcessingId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                updateProgress(result);
                
                if (result.status === 'completed' || result.status === 'failed') {
                    clearInterval(progressInterval);
                    if (result.status === 'completed') {
                        showSuccess(result);
                    } else {
                        showError(result.error || '处理失败');
                    }
                }
            }
        } catch (error) {
            console.error('获取进度失败:', error);
        }
    }, 2000);
}

function updateProgress(result) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusDetails = document.getElementById('statusDetails');
    
    if (progressBar && result.progress) {
        progressBar.style.width = result.progress + '%';
    }
    if (progressText && result.progress) {
        progressText.textContent = result.progress + '%';
    }
    if (statusDetails && result.message) {
        statusDetails.textContent = result.message;
    }
}

function showSuccess(result) {
    updateUploadStepIndicator(3);
    const successAlert = document.getElementById('successAlert');
    const successMessage = document.getElementById('successMessage');
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');

    if (successAlert) successAlert.style.display = 'block';
    if (successMessage) {
        successMessage.textContent = `成功处理体检报告，识别出 ${result.indicator_count || 0} 项健康指标`;
    }

    // 绑定查看详细信息按钮
    if (viewDetailsBtn && result.checkup_id) {
        viewDetailsBtn.onclick = function() {
            window.location.href = `/checkup/${result.checkup_id}/`;
        };
        viewDetailsBtn.style.display = 'inline-block';
    } else if (viewDetailsBtn) {
        // 如果没有checkup_id，隐藏这个按钮
        viewDetailsBtn.style.display = 'none';
    }
}

function updateUploadStepIndicator(step) {
    const tabs = ['upload-step1-tab', 'upload-step2-tab', 'upload-step3-tab'];
    tabs.forEach((tabId, index) => {
        const tab = document.getElementById(tabId);
        if (tab) {
            if (index + 1 === step) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
            if (index + 1 < step) {
                tab.classList.add('completed');
                tab.innerHTML = `<i class="bi bi-check-circle"></i> ${tab.textContent.trim()}`;
            }
        }
    });
}

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    
    if (errorAlert) errorAlert.style.display = 'block';
    if (errorMessage) errorMessage.textContent = message;
}
</script>
{% endblock %}
