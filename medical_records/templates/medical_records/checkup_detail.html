{% extends 'base.html' %}

{% block title %}体检报告详情 - {{ checkup.hospital }} ({{ checkup.checkup_date|date:"Y-m-d" }}){% endblock %}

{% block extra_css %}
<style>
/* 体检报告详情页面样式 - 专业医疗+有机自然风格 */

.card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    background: var(--bg-card);
    margin-bottom: 1.5rem;
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    background: var(--primary-soft);
    color: var(--primary-dark);
    border-bottom: 1px solid var(--border-color);
    padding: 1.25rem 1.5rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.card-header h4, .card-header h5 {
    font-weight: 600;
    margin: 0;
}

.card-header i {
    margin-right: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.card.text-center h2 {
    font-size: 2rem;
    font-weight: 600;
    margin: 0;
}

.card.text-center.border-success {
    border-top: 4px solid var(--success) !important;
}

.card.text-center.border-danger {
    border-top: 4px solid var(--danger) !important;
}

.card.text-center.border-warning {
    border-top: 4px solid var(--warning) !important;
}

.btn {
    border-radius: var(--radius-md);
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.btn:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--bg-card);
    border-color: var(--border-color);
    color: var(--text-secondary);
}

.btn-secondary:hover {
    background: var(--bg-soft);
    border-color: var(--secondary-light);
    color: var(--text-primary);
}

.btn-outline-primary {
    background: var(--bg-card);
    border-color: var(--primary);
    color: var(--primary);
}

.btn-outline-primary:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
}

.btn-outline-secondary {
    background: var(--bg-card);
    border-color: var(--border-color);
    color: var(--text-secondary);
}

.btn-outline-secondary:hover {
    background: var(--bg-soft);
    border-color: var(--secondary-light);
    color: var(--text-primary);
}

.btn-success {
    background: var(--success);
    border-color: var(--success);
    color: #fff;
}

.btn-success:hover {
    background: var(--success-dark);
    border-color: var(--success-dark);
}

.btn-danger {
    background: var(--danger);
    border-color: var(--danger);
    color: #fff;
}

.btn-danger:hover {
    background: var(--danger-dark);
    border-color: var(--danger-dark);
}

.btn-info {
    background: var(--info);
    border-color: var(--info);
    color: #fff;
}

.btn-info:hover {
    background: var(--info-dark);
    border-color: var(--info-dark);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.badge {
    padding: 0.375rem 0.625rem;
    border-radius: var(--radius-sm);
    font-weight: 500;
    font-size: 0.75rem;
}

.badge.bg-success {
    background: var(--success) !important;
}

.badge.bg-primary {
    background: var(--primary) !important;
}

.badge.bg-info {
    background: var(--info) !important;
}

.badge.bg-danger {
    background: var(--danger) !important;
}

.badge.bg-light {
    background: var(--bg-soft) !important;
    color: var(--text-primary) !important;
}

strong {
    color: var(--text-primary);
    font-weight: 600;
}

.text-primary {
    color: var(--primary) !important;
}

.text-success {
    color: var(--success) !important;
}

.text-danger {
    color: var(--danger) !important;
}

.text-warning {
    color: var(--warning) !important;
}

.text-muted {
    color: var(--text-muted) !important;
}

/* 指标表格 */
.table {
    margin-bottom: 0;
}

.table thead th {
    background: var(--bg-soft);
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.875rem;
    border-bottom: 2px solid var(--border-color);
    padding: 0.875rem;
}

.table tbody td {
    padding: 0.875rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.table tbody tr:nth-child(even) {
    background: var(--bg-soft);
}

.table tbody tr:hover {
    background: var(--primary-soft);
}

/* 分组标题 */
.list-group-item {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-card);
    font-weight: 500;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

/* Modal */
.modal-content {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
}

.modal-header {
    background: var(--bg-soft);
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.modal-footer {
    border-top: 1px solid var(--border-color);
}

.form-control, .form-select {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    outline: none;
}

.form-label {
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 返回按钮 -->
        <div class="mb-3">
            <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> 返回首页
            </a>
        </div>

        {% if indicators %}
        <!-- 指标状态统计 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
                            <h6 class="card-title mb-0">正常指标</h6>
                        </div>
                        <h2 class="text-success mb-0">{{ normal_count }}</h2>
                        <small class="text-muted">项指标正常</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-exclamation-triangle-fill text-danger me-2" style="font-size: 1.5rem;"></i>
                            <h6 class="card-title mb-0">异常指标</h6>
                        </div>
                        <h2 class="text-danger mb-0">{{ abnormal_count }}</h2>
                        <small class="text-muted">项指标异常</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-exclamation-circle-fill text-warning me-2" style="font-size: 1.5rem;"></i>
                            <h6 class="card-title mb-0">关注指标</h6>
                        </div>
                        <h2 class="text-warning mb-0">{{ attention_count }}</h2>
                        <small class="text-muted">项指标需关注</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 体检报告基本信息 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="bi bi-file-text"></i> 体检报告详情
                    </h4>
                    {% if checkup.notes %}
                    <div class="mt-2" id="notesContainer">
                        <span class="badge bg-info text-dark" id="currentNotes">
                            <i class="bi bi-card-text"></i> {{ checkup.notes }}
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="showEditNotesModal()" title="编辑描述">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    {% else %}
                    <div class="mt-2" id="notesContainer">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showEditNotesModal()">
                            <i class="bi bi-plus"></i> 添加报告描述
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="text-end">
                    {% if checkup.report_file %}
                    <a href="{{ checkup.report_file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="bi bi-download"></i> 下载报告
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong><i class="bi bi-calendar text-primary"></i> 体检日期：</strong> {{ checkup.checkup_date|date:"Y年m月d日" }}</p>
                        <p class="mb-1"><strong><i class="bi bi-building text-primary"></i> 体检机构：</strong> {{ checkup.hospital }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong><i class="bi bi-clock text-primary"></i> 创建时间：</strong> {{ checkup.created_at|date:"Y-m-d H:i" }}</p>
                        <p class="mb-1"><strong><i class="bi bi-bar-chart text-primary"></i> 指标总数：</strong> <span class="badge bg-primary">{{ indicators|length }} 项</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 健康指标详情 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-activity"></i> 健康指标
                </h5>
                <span class="badge bg-primary">{{ indicators|length }} 项指标</span>
            </div>
            <div class="card-body">
                {% if indicators %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>指标名称</th>
                                    <th>检测值</th>
                                    <th>单位</th>
                                    <th>参考范围</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for indicator in indicators %}
                                <tr>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ indicator.get_indicator_type_display }}</span>
                                        {{ indicator.indicator_name }}
                                    </td>
                                    <td><strong>{{ indicator.value }}</strong></td>
                                    <td>{{ indicator.unit|default:"-" }}</td>
                                    <td>{{ indicator.reference_range|default:"-" }}</td>
                                    <td>
                                        {% if indicator.status == 'normal' %}
                                            <span class="badge bg-success">正常</span>
                                        {% elif indicator.status == 'abnormal' %}
                                            <span class="badge bg-danger">异常</span>
                                        {% else %}
                                            <span class="badge bg-warning">关注</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-indicator-btn" 
                                                data-indicator-id="{{ indicator.id }}"
                                                data-indicator-name="{{ indicator.indicator_name }}"
                                                data-indicator-value="{{ indicator.value }}"
                                                data-indicator-unit="{{ indicator.unit|default:'' }}"
                                                data-indicator-range="{{ indicator.reference_range|default:'' }}"
                                                data-indicator-status="{{ indicator.status }}"
                                                data-indicator-type="{{ indicator.indicator_type }}">
                                            <i class="bi bi-pencil"></i> 编辑
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clipboard-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <p class="mt-3 text-muted">暂无详细指标数据</p>
                        <p class="text-muted">您可以查看上传的原始报告文件获取详细信息</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="mt-4 d-flex justify-content-between">
            <div>
                {% if checkup.report_file %}
                <a href="{{ checkup.report_file.url }}" class="btn btn-outline-primary" target="_blank">
                    <i class="bi bi-eye"></i> 查看原始报告
                </a>
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-info me-2" onclick="showCheckupAiSummary({{ checkup.id }})">
                    <i class="bi bi-stars"></i> AI快速解读
                </button>
                <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> 删除报告
                </button>
                <a href="{% url 'medical_records:upload_report' %}" class="btn btn-success me-2">
                    <i class="bi bi-plus-circle"></i> 上传新报告
                </a>
                <a href="{% url 'medical_records:ai_health_advice' %}" class="btn btn-info">
                    <i class="bi bi-robot"></i> 获取AI建议
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 编辑指标模态框 -->
<div class="modal fade" id="editIndicatorModal" tabindex="-1" aria-labelledby="editIndicatorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editIndicatorModalLabel">
                    <i class="bi bi-pencil-square"></i> 编辑指标
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editIndicatorForm">
                    <input type="hidden" id="editIndicatorId" name="indicator_id">

                    <div class="mb-3">
                        <label for="editIndicatorType" class="form-label">指标分类</label>
                        <select class="form-select" id="editIndicatorType" name="indicator_type">
                            <option value="physical_exam">体格检查</option>
                            <option value="blood_routine">血液常规</option>
                            <option value="biochemistry">生化检验</option>
                            <option value="liver_function">肝功能</option>
                            <option value="kidney_function">肾功能</option>
                            <option value="thyroid_function">甲状腺功能</option>
                            <option value="tumor_markers">肿瘤标志物</option>
                            <option value="urine_exam">尿液检查</option>
                            <option value="blood_rheology">血液流变学</option>
                            <option value="eye_exam">眼科检查</option>
                            <option value="ultrasound_exam">超声检查</option>
                            <option value="imaging_exam">影像学检查</option>
                            <option value="diagnosis">病症诊断</option>
                            <option value="symptoms">症状描述</option>
                            <option value="other_exam">其他检查</option>
                        </select>
                        <small class="form-text text-muted">选择指标所属的医学分类</small>
                    </div>

                    <div class="mb-3">
                        <label for="editIndicatorName" class="form-label">指标名称</label>
                        <input type="text" class="form-control" id="editIndicatorName" name="indicator_name" required>
                    </div>

                    <div class="mb-3">
                        <label for="editIndicatorValue" class="form-label">检测值</label>
                        <input type="text" class="form-control" id="editIndicatorValue" name="value" required>
                    </div>

                    <div class="mb-3">
                        <label for="editIndicatorUnit" class="form-label">单位</label>
                        <input type="text" class="form-control" id="editIndicatorUnit" name="unit">
                    </div>

                    <div class="mb-3">
                        <label for="editIndicatorRange" class="form-label">参考范围</label>
                        <input type="text" class="form-control" id="editIndicatorRange" name="reference_range">
                    </div>

                    <div class="mb-3">
                        <label for="editIndicatorStatus" class="form-label">状态</label>
                        <select class="form-select" id="editIndicatorStatus" name="status">
                            <option value="normal">正常</option>
                            <option value="abnormal">异常</option>
                            <option value="attention">关注</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" id="saveIndicatorBtn">
                    <i class="bi bi-check-circle"></i> 保存更改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除这份体检报告吗？此操作不可恢复。</p>
                <p class="text-danger">
                    <strong>警告：</strong>删除后，所有相关的健康指标数据也将被删除。
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash"></i> 确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑报告描述模态框 -->
<div class="modal fade" id="editNotesModal" tabindex="-1" aria-labelledby="editNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editNotesModalLabel">
                    <i class="bi bi-pencil-square"></i> 编辑报告描述
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editNotesForm">
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">报告描述</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="4" placeholder="请输入报告描述..."></textarea>
                        <small class="form-text text-muted">添加对这份体检报告的备注或总结</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" id="saveNotesBtn">
                    <i class="bi bi-check-circle"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 体检报告AI分析模态框 -->
<div class="modal fade" id="checkupAiSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3">
                        <i class="bi bi-stars text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0">体检报告智能解读</h5>
                        <small class="text-muted">基于体检指标数据生成全面解读报告</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="checkupAiSummaryContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">AI正在分析...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="exportCheckupSummaryBtns" style="display: none;">
                </div>
                <button type="button" class="btn btn-outline-primary me-auto" id="regenerateCheckupSummaryBtn" onclick="regenerateCheckupAiSummary()" style="display: none;">
                    <i class="bi bi-arrow-clockwise"></i> 重新解读
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let currentCheckupAiSummaryId = null;

async function showCheckupAiSummary(checkupId) {
    currentCheckupAiSummaryId = checkupId;
    const modal = new bootstrap.Modal(document.getElementById('checkupAiSummaryModal'));
    const summaryContent = document.getElementById('checkupAiSummaryContent');
    const regenerateBtn = document.getElementById('regenerateCheckupSummaryBtn');
    
    summaryContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">AI正在分析体检报告...</span>
            </div>
            <p class="text-muted">AI正在分析体检报告，请稍候...</p>
        </div>
    `;
    regenerateBtn.style.display = 'none';
    
    modal.show();
    
    try {
        const response = await fetch(`/api/checkups/${checkupId}/summary/`);
        const data = await response.json();
        
        if (data.success && data.has_summary) {
            summaryContent.innerHTML = `
                <div class="mb-3 text-muted small">
                    <i class="bi bi-clock"></i> 分析时间：${data.ai_summary_created_at}
                </div>
                <div class="ai-content-modal">${marked.parse(data.ai_summary)}</div>
            `;
            regenerateBtn.style.display = 'inline-block';
        } else {
            await generateCheckupAiSummary(checkupId);
        }
    } catch (error) {
        console.error('获取AI分析失败:', error);
        summaryContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 获取分析失败：${error.message}
            </div>
        `;
    }
}

async function generateCheckupAiSummary(checkupId) {
    const summaryContent = document.getElementById('checkupAiSummaryContent');
    const regenerateBtn = document.getElementById('regenerateCheckupSummaryBtn');
    
    summaryContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">AI正在生成分析...</span>
            </div>
            <p class="text-muted">AI正在分析体检报告，请稍候...</p>
        </div>
    `;
    regenerateBtn.style.display = 'none';
    
    try {
        const response = await fetch('/api/stream-checkup-ai-summary/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ checkup_id: checkupId })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || '请求失败');
        }
        
        if (!response.body) {
            throw new Error('响应体为空');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            let buffer = '';
            
            for (const char of chunk) {
                buffer += char;
                if (char === '\n') {
                    const line = buffer.trim();
                    buffer = '';
                    
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.content) {
                                fullContent += data.content;
                                summaryContent.innerHTML = `
                                    <div class="ai-content-modal">${marked.parse(fullContent)}</div>
                                `;
                            } else if (data.done) {
                                regenerateBtn.style.display = 'inline-block';
                            } else if (data.error) {
                                throw new Error(data.error);
                            } else if (data.save_error) {
                                console.warn('保存失败:', data.save_error);
                                if (data.trace) console.warn('详细 trace:', data.trace);
                            }
                        } catch (e) {
                            console.warn('解析响应行失败，跳过:', e.message);
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.error('生成AI分析失败:', error);
        let errorMsg = error.message || '未知错误';
        if (error.name === 'TypeError' && error.message === 'Load failed') {
            errorMsg = '网络请求失败，请检查网络连接或刷新页面重试';
        }
        summaryContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 生成分析失败：${errorMsg}
            </div>
        `;
    }
}

async function regenerateCheckupAiSummary() {
    if (!currentCheckupAiSummaryId) return;
    
    const summaryContent = document.getElementById('checkupAiSummaryContent');
    summaryContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">AI正在重新分析...</span>
            </div>
            <p class="text-muted">AI正在重新分析体检报告，请稍候...</p>
        </div>
    `;
    
    await generateCheckupAiSummary(currentCheckupAiSummaryId);
}

function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // 为表格行添加点击高亮效果
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // ========== 编辑指标功能 ==========
    const editIndicatorModal = new bootstrap.Modal(document.getElementById('editIndicatorModal'));
    const editIndicatorBtns = document.querySelectorAll('.edit-indicator-btn');
    const saveIndicatorBtn = document.getElementById('saveIndicatorBtn');
    
    // 点击编辑按钮打开模态框并填充数据
    editIndicatorBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const indicatorId = this.getAttribute('data-indicator-id');
            const indicatorType = this.getAttribute('data-indicator-type');
            const indicatorName = this.getAttribute('data-indicator-name');
            const indicatorValue = this.getAttribute('data-indicator-value');
            const indicatorUnit = this.getAttribute('data-indicator-unit');
            const indicatorRange = this.getAttribute('data-indicator-range');
            const indicatorStatus = this.getAttribute('data-indicator-status');

            document.getElementById('editIndicatorId').value = indicatorId;
            document.getElementById('editIndicatorType').value = indicatorType;
            document.getElementById('editIndicatorName').value = indicatorName;
            document.getElementById('editIndicatorValue').value = indicatorValue;
            document.getElementById('editIndicatorUnit').value = indicatorUnit;
            document.getElementById('editIndicatorRange').value = indicatorRange;
            document.getElementById('editIndicatorStatus').value = indicatorStatus;

            editIndicatorModal.show();
        });
    });
    
    // 保存指标修改
    if (saveIndicatorBtn) {
        saveIndicatorBtn.addEventListener('click', function() {
            const indicatorId = document.getElementById('editIndicatorId').value;
            const indicatorType = document.getElementById('editIndicatorType').value;
            const indicatorName = document.getElementById('editIndicatorName').value;
            const indicatorValue = document.getElementById('editIndicatorValue').value;
            const indicatorUnit = document.getElementById('editIndicatorUnit').value;
            const indicatorRange = document.getElementById('editIndicatorRange').value;
            const indicatorStatus = document.getElementById('editIndicatorStatus').value;

            // 验证必填字段
            if (!indicatorName || !indicatorValue) {
                alert('请填写指标名称和检测值');
                return;
            }

            // 禁用按钮防止重复点击
            saveIndicatorBtn.disabled = true;
            saveIndicatorBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';

            // 发送更新请求
            fetch(`/checkup/indicator/${indicatorId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    indicator_type: indicatorType,
                    indicator_name: indicatorName,
                    value: indicatorValue,
                    unit: indicatorUnit,
                    reference_range: indicatorRange,
                    status: indicatorStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新成功，关闭模态框并刷新页面
                    editIndicatorModal.hide();
                    window.location.reload();
                } else {
                    // 更新失败，显示错误信息
                    alert('保存失败: ' + (data.message || '未知错误'));
                    saveIndicatorBtn.disabled = false;
                    saveIndicatorBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存更改';
                }
            })
            .catch(error => {
                console.error('保存请求失败:', error);
                alert('保存请求失败，请稍后重试');
                saveIndicatorBtn.disabled = false;
                saveIndicatorBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存更改';
            });
        });
    }
    
    // ========== 删除功能 ==========
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            // 获取当前体检报告ID
            const pathParts = window.location.pathname.split('/');
            const checkupId = pathParts[pathParts.length - 2];
            
            // 禁用按钮防止重复点击
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 删除中...';
            
            // 发送删除请求
            fetch(`/checkup/${checkupId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 删除成功，跳转到首页
                    window.location.href = "{% url 'medical_records:dashboard' %}";
                } else {
                    // 删除失败，显示错误信息
                    alert('删除失败: ' + (data.message || '未知错误'));
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> 确认删除';
                }
            })
            .catch(error => {
                console.error('删除请求失败:', error);
                alert('删除请求失败，请稍后重试');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> 确认删除';
            });
        });
    }
    
    // ========== 编辑报告描述功能 ==========
    const editNotesModal = new bootstrap.Modal(document.getElementById('editNotesModal'));
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    
    // 显示编辑报告描述模态框
    window.showEditNotesModal = function() {
        // 获取当前报告描述
        const currentNotesElement = document.getElementById('currentNotes');
        const currentNotes = currentNotesElement ? currentNotesElement.textContent.trim() : '';
        
        // 填充到编辑框
        document.getElementById('editNotes').value = currentNotes;
        
        // 显示模态框
        editNotesModal.show();
    };
    
    // 保存报告描述
    if (saveNotesBtn) {
        saveNotesBtn.addEventListener('click', function() {
            const notes = document.getElementById('editNotes').value.trim();
            
            // 获取当前体检报告ID
            const pathParts = window.location.pathname.split('/');
            const checkupId = pathParts[pathParts.length - 2];
            
            // 禁用按钮防止重复点击
            saveNotesBtn.disabled = true;
            saveNotesBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
            
            // 发送更新请求
            fetch(`/api/checkup/${checkupId}/update-notes/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新成功，关闭模态框并刷新页面
                    editNotesModal.hide();
                    window.location.reload();
                } else {
                    // 更新失败，显示错误信息
                    alert('保存失败: ' + (data.message || '未知错误'));
                    saveNotesBtn.disabled = false;
                    saveNotesBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存';
                }
            })
            .catch(error => {
                console.error('保存请求失败:', error);
                alert('保存请求失败，请稍后重试');
                saveNotesBtn.disabled = false;
                saveNotesBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存';
            });
        });
    }
    
    // 获取CSRF Token的辅助函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}