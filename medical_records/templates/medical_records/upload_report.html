{% extends 'base.html' %}

{% block title %}上传体检报告 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
/* 上传报告页面样式 */

.page-header {
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.page-header p {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

.upload-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.upload-card .card-header {
    background: var(--bg-soft);
    border-bottom: 1px solid var(--border-color);
    padding: 1.25rem 1.5rem;
}

.upload-card .card-header h4 {
    font-weight: 600;
    font-size: 1.125rem;
    color: var(--text-primary);
    margin: 0;
}

.upload-card .card-body {
    padding: 1.5rem;
}

.section-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    color: var(--primary);
}

.form-label {
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: var(--transition);
    background: var(--bg-card);
    color: var(--text-primary);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    outline: none;
}

.form-control::placeholder {
    color: var(--text-muted);
}

.form-text {
    font-size: 0.8125rem;
    color: var(--text-muted);
}

.metric-card {
    background: var(--bg-soft);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.metric-card .form-label {
    font-size: 0.8125rem;
}

.metric-card .form-label i {
    color: var(--primary);
    margin-right: 0.25rem;
}

.btn-primary {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.btn-primary:hover {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
    transform: translateY(-1px);
}

.btn-outline-secondary {
    background: transparent;
    border-color: var(--border-color);
    color: var(--text-secondary);
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.btn-outline-secondary:hover {
    background: var(--bg-soft);
    border-color: var(--secondary);
    color: var(--text-primary);
}

.info-card {
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 1.5rem;
    color: #fff;
}

.info-card h6 {
    font-weight: 600;
    font-size: 0.9375rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-card ul {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 0.875rem;
    opacity: 0.95;
}

.info-card li {
    margin-bottom: 0.375rem;
}

.text-danger {
    color: #ef4444 !important;
    font-size: 0.8125rem;
}

/* 文件上传区域 */
.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 2rem;
    text-align: center;
    background: var(--bg-soft);
    transition: var(--transition);
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-soft);
}

.file-upload-area i {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 0.75rem;
}

.file-upload-area h6 {
    color: var(--text-primary);
    margin-bottom: 0.375rem;
}

.file-upload-area p {
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <!-- 页面标题 -->
    <div class="page-header">
        <h1>上传体检报告</h1>
        <p>智能识别体检报告，自动提取健康指标</p>
    </div>

    <!-- 上传表单 -->
    <div class="upload-card">
        <div class="card-header">
            <h4>
                <i class="bi bi-file-earmark-medical me-2"></i>报告信息
            </h4>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="section-title">
                    <i class="bi bi-info-circle"></i>基本信息
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.checkup_date.id_for_label }}" class="form-label">
                            {{ form.checkup_date.label }}
                        </label>
                        {{ form.checkup_date }}
                        {% if form.checkup_date.errors %}
                            <div class="text-danger mt-1">
                                {{ form.checkup_date.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.hospital.id_for_label }}" class="form-label">
                            {{ form.hospital.label }}
                        </label>
                        {{ form.hospital }}
                        {% if form.hospital.errors %}
                            <div class="text-danger mt-1">
                                {{ form.hospital.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-4">
                    <label for="{{ form.report_file.id_for_label }}" class="form-label">
                        <i class="bi bi-cloud-upload me-1"></i>{{ form.report_file.label }}
                    </label>
                    <div class="file-upload-area" onclick="document.getElementById('{{ form.report_file.id_for_label }}').click()">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <h6>点击或拖拽文件到此处</h6>
                        <p>支持 PDF、JPG、PNG 格式，文件大小不超过 10MB</p>
                    </div>
                    {{ form.report_file }}
                    {% if form.report_file.errors %}
                        <div class="text-danger mt-1">
                            {{ form.report_file.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                        {{ form.notes.label }}
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div class="text-danger mt-1">
                            {{ form.notes.errors }}
                        </div>
                    {% endif %}
                </div>

                <div class="section-title" style="margin-top: 2rem;">
                    <i class="bi bi-activity"></i>主要健康指标（可选）
                </div>

                <div class="metric-card">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-heart-pulse"></i>血压
                            </label>
                            <input type="text" class="form-control" placeholder="如: 120/80" name="blood_pressure">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-activity"></i>心率
                            </label>
                            <input type="text" class="form-control" placeholder="如: 72" name="heart_rate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-person"></i>体重
                            </label>
                            <input type="text" class="form-control" placeholder="如: 65.5" name="weight">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-ruler"></i>身高
                            </label>
                            <input type="text" class="form-control" placeholder="如: 170" name="height">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-droplet"></i>血糖
                            </label>
                            <input type="text" class="form-control" placeholder="如: 5.1" name="blood_sugar">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="bi bi-clipboard-data"></i>胆固醇
                            </label>
                            <input type="text" class="form-control" placeholder="如: 4.8" name="cholesterol">
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'medical_records:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>返回首页
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-1"></i>上传报告
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 上传说明 -->
    <div class="info-card">
        <h6>
            <i class="bi bi-lightbulb"></i>上传说明
        </h6>
        <ul>
            <li>请选择准确的体检日期，这将用于健康趋势分析</li>
            <li>支持上传体检报告的扫描件或照片</li>
            <li>填写主要健康指标有助于系统自动生成趋势图表</li>
            <li>所有数据将被安全存储，仅您本人可以查看</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 文件上传验证
    const fileInput = document.getElementById('{{ form.report_file.id_for_label }}');
    const uploadArea = document.querySelector('.file-upload-area');

    // 隐藏原始文件输入框
    fileInput.style.display = 'none';

    // 拖拽上传
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--primary)';
        this.style.background = 'var(--primary-soft)';
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--border-color)';
        this.style.background = 'var(--bg-soft)';
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--border-color)';
        this.style.background = 'var(--bg-soft)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            validateFile(files[0]);
        }
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            validateFile(this.files[0]);
        }
    });

    function validateFile(file) {
        // 检查文件大小 (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('文件大小不能超过 10MB');
            fileInput.value = '';
            return;
        }

        // 检查文件类型
        const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
        if (!allowedTypes.includes(file.type)) {
            alert('只支持 JPG、PNG、PDF 格式的文件');
            fileInput.value = '';
            return;
        }

        // 更新上传区域显示
        const uploadArea = document.querySelector('.file-upload-area');
        uploadArea.innerHTML = `
            <i class="bi bi-file-earmark-check" style="color: var(--success);"></i>
            <h6>${file.name}</h6>
            <p>点击更换文件</p>
        `;
    }
});
</script>
{% endblock %}
