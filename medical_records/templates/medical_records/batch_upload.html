{% extends 'base.html' %}

{% block title %}批量智能上传 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
/* 批量上传页面样式 */

.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    padding: 3rem;
    background: var(--bg-soft);
    text-align: center;
    transition: var(--transition);
    cursor: pointer;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-soft);
}

.upload-area.dragover {
    border-color: var(--primary);
    background: var(--primary-soft);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.upload-area.has-files {
    border-style: solid;
    border-color: var(--success);
    background: var(--success-soft);
}

.file-list {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    margin-bottom: 0.5rem;
    background: var(--bg-card);
    transition: var(--transition);
}

.file-item:hover {
    box-shadow: var(--shadow-sm);
}

.file-item.processing {
    border-color: var(--primary);
    background: var(--primary-soft);
}

.file-item.completed {
    border-color: var(--success);
    background: var(--success-soft);
}

.file-item.failed {
    border-color: var(--danger);
    background: var(--danger-soft);
}

.file-icon {
    font-size: 1.5rem;
    margin-right: 0.75rem;
    color: var(--primary);
}

.file-icon.pdf {
    color: #dc3545;
}

.file-icon.image {
    color: #0d9488;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.file-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-actions {
    display: flex;
    gap: 0.25rem;
}

.progress-thin {
    height: 4px;
    border-radius: 2px;
}

.workflow-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    border-radius: var(--radius-sm);
}

.workflow-badge.ocr {
    background: #e3f2fd;
    color: #1976d2;
}

.workflow-badge.vlm {
    background: #f3e5f5;
    color: #7b1fa2;
}

.batch-status-card {
    position: sticky;
    top: 1rem;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-dot.pending {
    background: var(--text-muted);
    animation: none;
}

.status-dot.processing {
    background: var(--primary);
}

.status-dot.completed {
    background: var(--success);
    animation: none;
}

.status-dot.failed {
    background: var(--danger);
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: var(--bg-soft);
    border-radius: var(--radius-md);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* 动画 */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

/* 旋转动画 */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.bi-arrow-repeat {
    animation: spin 2s linear infinite;
    display: inline-block;
}

/* 文件项状态样式增强 */
.file-item .btn-sm {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
}

.file-item .status-text {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    flex-wrap: wrap;
}

.file-item.processing .status-text {
    color: var(--primary);
}

.file-item.completed .status-text {
    color: var(--success);
}

.file-item.failed .status-text {
    color: var(--danger);
}

/* 进度条动画 */
.progress-bar {
    transition: width 0.5s ease-in-out;
}

/* 状态面板增强 */
.batch-status-card .card-body {
    position: sticky;
    top: 1rem;
}

/* 实时更新指示器 */
.live-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--primary);
}

.live-indicator::before {
    content: '';
    width: 6px;
    height: 6px;
    background: var(--primary);
    border-radius: 50%;
    animation: pulse 1s infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- 返回按钮 -->
            <div class="mb-3">
                <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> 返回首页
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 左侧：上传区域 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-cloud-upload-fill"></i> 批量智能上传
                    </h4>
                    <p class="mb-0 mt-2 opacity-75">支持同时上传多个PDF和图片文件，系统自动识别并提取健康指标</p>
                </div>
                <div class="card-body">
                    <!-- 上传表单 -->
                    <form id="batchUploadForm">
                        {% csrf_token %}

                        <!-- 基本信息 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="checkup_date" class="form-label">
                                    <i class="bi bi-calendar"></i> 体检日期 <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="checkup_date" name="checkup_date" 
                                       value="{{ today }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="hospital" class="form-label">
                                    <i class="bi bi-hospital"></i> 体检机构
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="hospital" name="hospital"
                                           placeholder="请输入体检医院或机构名称" autocomplete="off">
                                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-building"></i> 历史
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="hospitalDropdown">
                                        {% if hospitals %}
                                            {% for hospital in hospitals %}
                                            <li><a class="dropdown-item" href="#" data-value="{{ hospital.name }}">
                                                {{ hospital.name }} 
                                                <small class="text-muted">({{ hospital.usage_count }}次)</small>
                                            </a></li>
                                            {% endfor %}
                                        {% else %}
                                            <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 批次名称 -->
                        <div class="mb-4">
                            <label for="batch_name" class="form-label">
                                <i class="bi bi-tag"></i> 批次名称
                            </label>
                            <input type="text" class="form-control" id="batch_name" name="batch_name"
                                   placeholder="例如：2024年度体检（可选）">
                        </div>

                        <!-- 文件上传区域 -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-files"></i> 选择文件 <span class="text-danger">*</span>
                                <small class="text-muted">(最多 {{ max_files }} 个文件，每个最大10MB)</small>
                            </label>
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-placeholder" id="uploadPlaceholder">
                                    <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                                    <h5>拖拽文件到此处或点击选择</h5>
                                    <p class="text-muted mb-0">支持 PDF、JPG、PNG、JPEG、TIFF、BMP 格式</p>
                                    <p class="text-muted small">PDF文件将使用 OCR+LLM 处理，图片将使用 VLM 处理</p>
                                    <input type="file" id="fileInput" name="files" multiple 
                                           accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary mt-3" 
                                            onclick="document.getElementById('fileInput').click()">
                                        <i class="bi bi-folder-open"></i> 选择文件
                                    </button>
                                </div>
                                <div class="file-list w-100" id="fileList" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="bi bi-info-circle"></i> 
                                已选择 <span id="fileCount">0</span> 个文件
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" id="clearBtn" style="display: none;">
                                    <i class="bi bi-trash"></i> 清空
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="bi bi-upload"></i> 开始批量处理
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- 处理进度区域 -->
                    <div id="progressSection" style="display: none;" class="mt-4">
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-gear-fill spin text-primary"></i> 处理进度
                            </h5>
                            <span class="badge bg-primary" id="progressBadge">0%</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="processingFileList" class="file-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：状态面板 -->
        <div class="col-lg-4">
            <div class="card batch-status-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-activity"></i> 处理状态
                    </h5>
                </div>
                <div class="card-body">
                    <div id="statusPanel">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>等待上传文件...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工作流说明 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-magic"></i> 智能工作流
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="workflow-badge ocr me-2">OCR + LLM</span>
                        <small class="text-muted">用于 PDF 文件，先OCR识别文字，再用LLM提取结构化数据</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="workflow-badge vlm me-2">VLM</span>
                        <small class="text-muted">用于图片文件，视觉语言模型直接识别图片内容</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 结果模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill text-success"></i> 批量处理完成
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'medical_records:dashboard' %}" class="btn btn-primary">
                    <i class="bi bi-house"></i> 返回首页
                </a>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">继续上传</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let selectedFiles = [];
let batchId = null;
let statusCheckInterval = null;

// DOM 元素
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const uploadPlaceholder = document.getElementById('uploadPlaceholder');
const fileCount = document.getElementById('fileCount');
const submitBtn = document.getElementById('submitBtn');
const clearBtn = document.getElementById('clearBtn');
const batchUploadForm = document.getElementById('batchUploadForm');
const progressSection = document.getElementById('progressSection');
const progressBar = document.getElementById('progressBar');
const progressBadge = document.getElementById('progressBadge');
const processingFileList = document.getElementById('processingFileList');
const statusPanel = document.getElementById('statusPanel');

// 文件类型图标
function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (ext === 'pdf') return { icon: 'bi-file-earmark-pdf', class: 'pdf' };
    return { icon: 'bi-file-earmark-image', class: 'image' };
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 获取工作流显示名称
function getWorkflowName(workflowType) {
    const names = {
        'ocr_llm': 'OCR + LLM',
        'vlm_transformers': 'OCR + LLM',
        'vl_model': 'VLM'
    };
    return names[workflowType] || workflowType;
}

// 获取工作流徽章样式
function getWorkflowBadgeClass(workflowType) {
    return workflowType === 'vl_model' ? 'vlm' : 'ocr';
}

// 更新文件列表显示
function updateFileList() {
    if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        uploadPlaceholder.style.display = 'block';
        uploadArea.classList.remove('has-files');
        clearBtn.style.display = 'none';
        submitBtn.disabled = true;
    } else {
        fileList.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        uploadArea.classList.add('has-files');
        clearBtn.style.display = 'inline-block';
        submitBtn.disabled = false;
        
        fileList.innerHTML = selectedFiles.map((file, index) => {
            const iconInfo = getFileIcon(file.name);
            const workflowType = file.name.toLowerCase().endsWith('.pdf') ? 'ocr_llm' : 'vl_model';
            return `
                <div class="file-item slide-in" data-index="${index}">
                    <i class="bi ${iconInfo.icon} file-icon ${iconInfo.class}"></i>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">
                            ${formatFileSize(file.size)} · 
                            <span class="workflow-badge ${getWorkflowBadgeClass(workflowType)}">
                                ${getWorkflowName(workflowType)}
                            </span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    fileCount.textContent = selectedFiles.length;
}

// 添加文件
function addFiles(files) {
    const maxFiles = parseInt('{{ max_files }}');
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['.pdf', '.jpg', '.jpeg', '.png', '.tiff', '.bmp'];
    
    for (const file of files) {
        if (selectedFiles.length >= maxFiles) {
            alert(`最多只能上传 ${maxFiles} 个文件`);
            break;
        }
        
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(ext)) {
            alert(`不支持的文件格式: ${file.name}`);
            continue;
        }
        
        if (file.size > maxSize) {
            alert(`文件过大: ${file.name} (最大10MB)`);
            continue;
        }
        
        selectedFiles.push(file);
    }
    
    updateFileList();
}

// 移除文件
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

// 清空文件
function clearFiles() {
    selectedFiles = [];
    updateFileList();
}

// 拖拽事件
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    addFiles(Array.from(e.dataTransfer.files));
});

// 文件选择
fileInput.addEventListener('change', (e) => {
    addFiles(Array.from(e.target.files));
    fileInput.value = ''; // 清空input以便可以重复选择相同文件
});

// 清空按钮
clearBtn.addEventListener('click', clearFiles);

// 医院选择下拉菜单
document.getElementById('hospitalDropdown').addEventListener('click', (e) => {
    if (e.target.classList.contains('dropdown-item') && e.target.dataset.value) {
        document.getElementById('hospital').value = e.target.dataset.value;
    }
});

// 表单提交
batchUploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (selectedFiles.length === 0) {
        alert('请选择要上传的文件');
        return;
    }
    
    const formData = new FormData(batchUploadForm);
    selectedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';
    
    try {
        const response = await fetch('{% url "medical_records:api_batch_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            batchId = data.batch_id;
            showProgressSection(data.files);
            startStatusCheck();
        } else {
            alert(data.error || '上传失败');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> 开始批量处理';
        }
    } catch (error) {
        console.error('上传错误:', error);
        alert('上传失败，请检查网络连接');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-upload"></i> 开始批量处理';
    }
});

// 显示进度区域
function showProgressSection(files) {
    progressSection.style.display = 'block';
    processingFileList.innerHTML = files.map(file => `
        <div class="file-item" id="file-item-${file.item_id}" data-item-id="${file.item_id}">
            <i class="bi ${getFileIcon(file.file_name).icon} file-icon ${getFileIcon(file.file_name).class}"></i>
            <div class="file-info">
                <div class="file-name">${file.file_name}</div>
                <div class="file-meta">
                    <span class="workflow-badge ${getWorkflowBadgeClass(file.workflow_type)}">
                        ${getWorkflowName(file.workflow_type)}
                    </span>
                    <span class="status-text ms-2">等待处理...</span>
                </div>
                <div class="progress progress-thin mt-1" style="display: none;">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="file-status">
                <span class="status-dot pending"></span>
            </div>
        </div>
    `).join('');
}

// 开始状态检查
function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    checkStatus(); // 立即检查一次
    statusCheckInterval = setInterval(checkStatus, 2000); // 每2秒检查一次
}

// 检查状态
async function checkStatus() {
    if (!batchId) return;
    
    try {
        const response = await fetch(`{% url "medical_records:api_batch_status" batch_id=0 %}`.replace('0', batchId));
        const data = await response.json();
        
        if (data.success) {
            updateProgress(data.batch, data.items);
            
            if (data.batch.is_completed) {
                clearInterval(statusCheckInterval);
                showResult(data.batch, data.items);
            }
        }
    } catch (error) {
        console.error('状态检查错误:', error);
    }
}

// 更新进度
function updateProgress(batch, items) {
    // 更新总进度条
    progressBar.style.width = batch.progress_percentage + '%';
    progressBadge.textContent = batch.progress_percentage + '%';
    
    // 计算总处理时间
    let processingTime = '';
    if (batch.created_at) {
        const startTime = new Date(batch.created_at);
        const endTime = batch.completed_at ? new Date(batch.completed_at) : new Date();
        const elapsed = Math.floor((endTime - startTime) / 1000);
        if (elapsed > 0) {
            processingTime = elapsed < 60 ? `${elapsed}秒` : 
                elapsed < 3600 ? `${Math.floor(elapsed/60)}分${elapsed%60}秒` : 
                `${Math.floor(elapsed/3600)}时${Math.floor((elapsed%3600)/60)}分`;
        }
    }
    
    // 计算总指标数
    const totalIndicators = items.reduce((sum, item) => sum + (item.indicators_count || 0), 0);
    
    // 更新状态面板
    const statusHtml = `
        <div class="stats-grid mb-3">
            <div class="stat-item">
                <div class="stat-value">${batch.total_files}</div>
                <div class="stat-label">总文件</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-success">${batch.completed_files}</div>
                <div class="stat-label">已完成</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-danger">${batch.failed_files}</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-info">${totalIndicators}</div>
                <div class="stat-label">总指标</div>
            </div>
        </div>
        <div class="text-center mb-2">
            <span class="status-indicator">
                <span class="status-dot ${batch.status}"></span>
                <span class="fw-bold">${getStatusText(batch.status)}</span>
            </span>
            ${!batch.is_completed ? '<span class="live-indicator ms-2"><span></span>实时更新中</span>' : ''}
        </div>
        ${processingTime ? `
        <div class="text-center text-muted small">
            <i class="bi bi-clock"></i> 已用时间: ${processingTime}
        </div>
        ` : ''}
    `;
    statusPanel.innerHTML = statusHtml;
    
    // 更新每个文件的状态
    items.forEach(item => {
        const fileItem = document.getElementById(`file-item-${item.id}`);
        if (fileItem) {
            updateFileItemStatus(fileItem, item);
        }
    });
}

// 获取状态文本
function getStatusText(status) {
    const statusMap = {
        'pending': '等待处理',
        'processing': '处理中',
        'completed': '处理完成',
        'failed': '处理失败',
        'partial_failed': '部分失败'
    };
    return statusMap[status] || status;
}

// 更新文件项状态
function updateFileItemStatus(fileItem, item) {
    const statusDot = fileItem.querySelector('.status-dot');
    const statusText = fileItem.querySelector('.status-text');
    const progressBar = fileItem.querySelector('.progress');
    const progressBarInner = fileItem.querySelector('.progress-bar');
    const fileMeta = fileItem.querySelector('.file-meta');
    
    // 更新状态样式
    fileItem.classList.remove('processing', 'completed', 'failed');
    statusDot.classList.remove('pending', 'processing', 'completed', 'failed');
    
    if (item.status === 'completed') {
        fileItem.classList.add('completed');
        statusDot.classList.add('completed');
        const indicatorsCount = item.indicators_count || 0;
        statusText.innerHTML = `<i class="bi bi-check-circle"></i> 完成 · <span class="text-success fw-bold">${indicatorsCount}</span> 个指标`;
        progressBar.style.display = 'none';
        
        // 添加查看详情链接
        if (item.health_checkup_id) {
            const viewLink = document.createElement('a');
            viewLink.href = `/medical_records/checkup/${item.health_checkup_id}/`;
            viewLink.className = 'btn btn-sm btn-outline-success ms-2';
            viewLink.innerHTML = '<i class="bi bi-eye"></i> 查看';
            viewLink.target = '_blank';
            if (!fileItem.querySelector('.btn-outline-success')) {
                fileMeta.appendChild(viewLink);
            }
        }
    } else if (item.status === 'failed') {
        fileItem.classList.add('failed');
        statusDot.classList.add('failed');
        const errorMsg = item.error_message ? item.error_message.substring(0, 80) : '未知错误';
        statusText.innerHTML = `<i class="bi bi-x-circle"></i> 失败 · <span class="text-danger" title="${item.error_message || ''}">${errorMsg}</span>`;
        progressBar.style.display = 'none';
        
        // 添加重试按钮
        if (!fileItem.querySelector('.btn-retry')) {
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-sm btn-outline-warning ms-2 btn-retry';
            retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 重试';
            retryBtn.onclick = () => retryItem(item.id);
            fileMeta.appendChild(retryBtn);
        }
    } else if (['uploading', 'ocr_processing', 'ai_processing', 'saving_data'].includes(item.status)) {
        fileItem.classList.add('processing');
        statusDot.classList.add('processing');
        const statusInfo = getProcessingStatusText(item.status);
        const progressInfo = item.progress ? ` (${item.progress}%)` : '';
        statusText.innerHTML = `<i class="bi bi-arrow-repeat"></i> ${statusInfo}${progressInfo}`;
        progressBar.style.display = 'block';
        progressBarInner.style.width = (item.progress || 0) + '%';
        
        // 显示处理时间（如果有）
        if (item.updated_at && item.created_at) {
            const startTime = new Date(item.created_at);
            const currentTime = new Date();
            const elapsed = Math.floor((currentTime - startTime) / 1000);
            if (elapsed > 0) {
                const timeText = elapsed < 60 ? `${elapsed}秒` : `${Math.floor(elapsed/60)}分${elapsed%60}秒`;
                statusText.innerHTML += ` · <small class="text-muted">已用${timeText}</small>`;
            }
        }
    } else {
        statusDot.classList.add('pending');
        statusText.innerHTML = '<i class="bi bi-hourglass"></i> 等待处理...';
        progressBar.style.display = 'none';
    }
}

// 重试单个文件
async function retryItem(itemId) {
    try {
        const response = await fetch(`{% url "medical_records:api_batch_item_retry" item_id=0 %}`.replace('0', itemId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        const data = await response.json();
        if (data.success) {
            // 重新启动状态检查
            startStatusCheck();
        } else {
            alert('重试失败: ' + (data.error || '未知错误'));
        }
    } catch (error) {
        console.error('重试错误:', error);
        alert('重试失败，请检查网络连接');
    }
}

// 获取处理状态文本
function getProcessingStatusText(status) {
    const statusMap = {
        'uploading': '上传中...',
        'ocr_processing': 'OCR识别中...',
        'ai_processing': 'AI分析中...',
        'saving_data': '保存数据中...'
    };
    return statusMap[status] || '处理中...';
}

// 显示结果
function showResult(batch, items) {
    const completedItems = items.filter(item => item.status === 'completed');
    const failedItems = items.filter(item => item.status === 'failed');
    const totalIndicators = completedItems.reduce((sum, item) => sum + (item.indicators_count || 0), 0);
    
    const resultHtml = `
        <div class="text-center mb-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            <h4 class="mt-3">批量处理完成</h4>
            <p class="text-muted">共处理 ${batch.total_files} 个文件，成功 ${batch.completed_files} 个</p>
        </div>
        <div class="row text-center mb-4">
            <div class="col-4">
                <div class="h3 text-success">${batch.completed_files}</div>
                <small class="text-muted">成功</small>
            </div>
            <div class="col-4">
                <div class="h3 text-danger">${batch.failed_files}</div>
                <small class="text-muted">失败</small>
            </div>
            <div class="col-4">
                <div class="h3 text-primary">${totalIndicators}</div>
                <small class="text-muted">提取指标</small>
            </div>
        </div>
        ${failedItems.length > 0 ? `
        <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> 以下文件处理失败：</h6>
            <ul class="mb-0">
                ${failedItems.map(item => `<li>${item.file_name}: ${item.error_message || '未知错误'}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
    `;
    
    document.getElementById('resultContent').innerHTML = resultHtml;
    
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    resultModal.show();
    
    // 重置表单
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-upload"></i> 开始批量处理';
}

// 页面卸载时清理定时器
window.addEventListener('beforeunload', () => {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
});
</script>
{% endblock %}
