{% extends 'base.html' %}

{% block title %}AI健康建议 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
/* ═══════════════════════════════════════════════════════════
   NEO-BRUTALIST MEDICAL - 新野兽派AI建议页面
   ═══════════════════════════════════════════════════════════ */

:root {
    --brutal-yellow: #FFD60A;
    --brutal-cyan: #14b8a6;
    --brutal-pink: #FF5C8D;
    --brutal-blue: #4C8BF5;
    --brutal-green: #06FFA5;
    --brutal-red: #FF4757;
    --border-thick: 3px solid #000;
    --shadow-hard: 6px 6px 0px #000;
    --shadow-hard-sm: 4px 4px 0px #000;
}

body {
    background: #FAFAFA;
    font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
    color: #000;
    overflow-x: hidden;
}

/* 棋盘格背景 */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    pointer-events: none;
    z-index: 0;
}

.row, .col-md-4, .col-md-8 {
    position: relative;
    z-index: 1;
}

.card {
    border: var(--border-thick);
    border-radius: 0;
    box-shadow: var(--shadow-hard);
    background: #FFF;
    margin-bottom: 1.5rem;
}

.card-header {
    background: var(--brutal-cyan);
    color: #000;
    border-bottom: var(--border-thick);
    padding: 1.25rem 1.5rem;
}

.card-header h4, .card-header h6 {
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
}

.card-header i {
    display: none;
}

.card-body {
    padding: 1.5rem;
}

.btn {
    border: var(--border-thick);
    border-radius: 0;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: var(--shadow-hard-sm);
    transition: all 0.1s ease;
}

.btn:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

.btn-primary {
    background: var(--brutal-cyan);
    border-color: #000;
    color: #000;
}

.btn-primary:hover {
    background: var(--brutal-green);
}

.btn-outline-primary, .btn-outline-danger {
    background: #FFF;
    border-color: #000;
    color: #000;
}

.btn-outline-primary:hover {
    background: var(--brutal-cyan);
}

.btn-outline-danger:hover {
    background: var(--brutal-red);
    color: #FFF;
}

.btn-link {
    color: var(--brutal-blue);
    font-weight: 700;
    text-decoration: underline;
    border: none;
    box-shadow: none;
}

.btn-link:hover {
    color: var(--brutal-pink);
    transform: none;
    box-shadow: none;
}

.form-control, .form-select {
    background: #FFF;
    border: var(--border-thick);
    border-radius: 0;
    padding: 0.875rem 1rem;
    font-size: 0.9375rem;
    transition: all 0.1s ease;
    box-shadow: var(--shadow-hard-sm);
}

.form-control:focus, .form-select:focus {
    border-color: #000;
    box-shadow: 6px 6px 0px var(--brutal-yellow);
    background: #FFF;
    outline: none;
}

.form-label {
    font-weight: 800;
    font-size: 0.875rem;
    color: #000;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-label i {
    display: none;
}

.badge {
    padding: 0.375rem 0.625rem;
    border: 2px solid #000;
    border-radius: 0;
    font-weight: 800;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 2px 2px 0px #000;
}

.badge.bg-success {
    background: var(--brutal-green);
    color: #000;
}

.border-bottom {
    border-bottom: 2px solid #000 !important;
}

.text-primary {
    color: var(--brutal-cyan) !important;
}

.text-muted {
    color: #666 !important;
    font-weight: 600;
}

.fw-bold {
    color: #000;
    font-weight: 800 !important;
}

small {
    font-weight: 600;
}

/* 对话消息样式 */
.chat-message {
    border: var(--border-thick);
    border-radius: 0;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #FFF;
    box-shadow: var(--shadow-hard-sm);
}

.chat-message.user {
    background: var(--brutal-blue);
    color: #FFF;
}

.chat-message.assistant {
    background: #FFF;
}

.chat-message strong {
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* 加载动画 */
.loading-spinner {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    border: 3px solid #000;
    border-top-color: transparent;
    border-radius: 0;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 右侧咨询历史 -->
    <div class="col-md-4 order-md-2">
        <!-- 咨询历史 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> 咨询历史
                </h6>
            </div>
            <div class="card-body">
                {% if user_advices %}
                    <div class="advice-history">
                        {% for advice in user_advices %}
                        <div class="border-bottom pb-2 mb-2" id="advice-{{ advice.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if advice.is_conversation %}
                                            <span class="badge bg-success me-2">
                                                <i class="bi bi-chat-dots"></i> {{ advice.message_count }}条对话
                                            </span>
                                        {% endif %}
                                        <div class="small text-muted">{{ advice.updated_at|date:"m-d H:i" }}</div>
                                    </div>
                                    <div class="small fw-bold">{{ advice.title }}</div>
                                    <div class="small text-truncate text-muted" style="max-width: 200px;">
                                        <strong class="text-primary">最新：</strong>{{ advice.latest_question|default:advice.question|truncatechars:60 }}
                                    </div>
                                </div>
                                <div class="ms-2">
                                    {% if advice.is_conversation %}
                                        <button class="btn btn-link btn-sm p-0" data-show-conversation="{{ advice.conversation_id }}">
                                            查看对话
                                        </button>
                                    {% else %}
                                        <button class="btn btn-link btn-sm p-0" data-show-advice="{{ advice.id }}">
                                            查看完整回答
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="ms-2">
                                    {% if advice.is_conversation %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'medical_records:export_conversation_pdf' advice.conversation_id %}"
                                               class="btn btn-outline-danger" title="导出为PDF">
                                                <i class="bi bi-file-earmark-pdf"></i>
                                            </a>
                                            <a href="{% url 'medical_records:export_conversation_word' advice.conversation_id %}"
                                               class="btn btn-outline-primary" title="导出为Word">
                                                <i class="bi bi-file-earmark-word"></i>
                                            </a>
                                            <button class="btn btn-outline-danger" onclick="deleteConversation({{ advice.conversation_id }})" title="删除整个对话">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAdvice({{ advice.id }})" title="删除此条记录">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">暂无咨询记录</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 左侧主要内容 -->
    <div class="col-md-8 order-md-1">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-robot"></i> AI健康医生
                </h4>
            </div>
            <div class="card-body">
                <form id="adviceForm" method="post">
                    {% csrf_token %}

                    <!-- 简洁提示 -->
                    <div class="text-muted small mb-3">
                        <i class="bi bi-info-circle"></i> AI分析过程中请保持该页面等待完成
                    </div>

                    <!-- 对话模式选择 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-chat-dots"></i> 对话模式
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" name="conversation_mode" value="new_conversation" class="btn-check" id="newConversationMode" checked onchange="handleConversationModeChange()">
                            <label class="btn btn-outline-primary" for="newConversationMode">
                                <i class="bi bi-plus-circle"></i> 创建新对话
                            </label>

                            <input type="radio" name="conversation_mode" value="continue_conversation" class="btn-check" id="continueConversationMode" onchange="handleConversationModeChange()">
                            <label class="btn btn-outline-success" for="continueConversationMode">
                                <i class="bi bi-arrow-right-circle"></i> 继续对话
                            </label>
                        </div>

                        <!-- 选中的对话信息 -->
                        <div id="selectedConversationDisplay" class="mt-2" style="display: none;">
                            <div class="alert alert-info py-2 mb-0 d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">已选择：</small>
                                    <strong id="selectedConversationTitle"></strong>
                                    <small class="text-muted ms-2">(<span id="selectedConversationCount"></span> 条消息)</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openConversationModal()">
                                    <i class="bi bi-pencil"></i> 更改
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 问题描述 -->
                    <div class="mb-3">
                        <label for="{{ form.question.id_for_label }}" class="form-label">
                            <i class="bi bi-chat-dots"></i> 请描述您的健康问题
                        </label>
                        {{ form.question }}
                        {% if form.question.errors %}
                            <div class="text-danger">
                                {{ form.question.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 报告选择 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-clipboard-check"></i> 体检报告
                        </label>
                        <button type="button" class="btn btn-outline-primary w-100" onclick="openReportModal()">
                            <i class="bi bi-clipboard-data"></i> <span id="reportButtonText">选择体检报告</span>
                        </button>
                        <!-- 报告状态显示 -->
                        <div id="selectedReportsDisplay" class="mt-2">
                            <small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供报告</small>
                        </div>
                    </div>

                    <!-- 药单选择 -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-capsule"></i> 药单（可选）
                        </label>
                        <button type="button" class="btn btn-outline-warning w-100" onclick="openMedicationModal()">
                            <i class="bi bi-capsule"></i> <span id="medicationButtonText">选择药单</span>
                        </button>
                        <!-- 药单状态显示 -->
                        <div id="selectedMedicationsDisplay" class="mt-2">
                            <small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供药单</small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 返回首页
                        </a>
                        <button type="submit" id="submitBtn" class="btn btn-primary">
                            <i class="bi bi-send"></i> 获取建议
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="card mt-4" id="loadingCard" style="display: none;">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <h5><i class="bi bi-cpu"></i> AI医生正在分析您的健康数据...</h5>
                <p class="text-muted">请稍等片刻，这可能需要几十秒到几分钟时间</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- AI建议结果 -->
        <div class="card mt-4" id="resultCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-robot"></i> AI医生建议
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong><i class="bi bi-question-circle"></i> 您的问题：</strong>
                    <p id="userQuestion" class="mt-2"></p>
                </div>
                <hr>
                <div id="conversationHistory" style="display: none;">
                    <div class="mb-3">
                        <strong><i class="bi bi-clock-history"></i> 对话历史：</strong>
                        <div id="historyContent" class="mt-2 p-3 bg-light rounded" style="font-size: 0.9em;"></div>
                    </div>
                    <hr>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-chat-dots"></i> AI医生建议：</strong>
                    <div id="aiAnswer" class="mt-2 p-3 bg-light rounded ai-content"></div>
                </div>
                <hr>
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm" onclick="togglePrompt()">
                        <i class="bi bi-code"></i> 查看发送给AI的内容
                    </button>
                </div>
                <div id="promptSection" style="display: none;">
                    <strong><i class="bi bi-terminal"></i> 发送给AI医生的完整内容：</strong>
                    <pre id="promptContent" class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 300px; overflow-y: auto;"></pre>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-clock"></i> 回复时间：<span id="responseTime"></span>
                </div>

                <!-- 继续咨询按钮 -->
                <div class="mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-success w-100" onclick="continueConsultation()">
                        <i class="bi bi-chat-plus"></i> 继续咨询
                    </button>
                    <small class="text-muted d-block mt-2 text-center">
                        <i class="bi bi-info-circle"></i> 使用相同的报告设置继续提问
                    </small>
                </div>
            </div>
        </div>

      </div>
</div>

<!-- 报告选择弹窗 -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-check"></i> 选择体检报告
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if reports_with_info %}
                    <!-- 不使用报告选项 -->
                    <div class="form-check mb-3 p-3 border rounded bg-light">
                        <input type="checkbox" class="form-check-input" id="noReportsCheckbox" onchange="handleNoReportsChange()" checked>
                        <label class="form-check-label w-100" for="noReportsCheckbox">
                            <strong class="text-secondary">
                                <i class="bi bi-chat-text"></i> 不使用报告
                            </strong>
                            <div class="text-muted small">
                                仅基于问题提供一般性健康建议
                            </div>
                        </label>
                    </div>

                    <!-- 快捷选择按钮 -->
                    <div class="mb-3 d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllReports()">
                            <i class="bi bi-check-all"></i> 全选
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="selectRecentReports()">
                            <i class="bi bi-clock-history"></i> 最近2份
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="selectAbnormalReports()">
                            <i class="bi bi-clipboard-check"></i> 有异常的
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllReports()">
                            <i class="bi bi-x"></i> 清空
                        </button>
                    </div>

                    <!-- 报告列表 -->
                    <div class="report-selection-list" style="max-height: 400px; overflow-y: auto;">
                    {% for report_info in reports_with_info %}
                        {% with report=report_info.report %}
                        <div class="form-check mb-2 p-3 border rounded" style="background-color: white;">
                            <input type="checkbox" name="selected_reports" value="{{ report.id }}"
                                   class="form-check-input report-checkbox" id="report_{{ report.id }}" onchange="handleReportCheckboxChange()">
                            <label class="form-check-label w-100" for="report_{{ report.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ report.hospital|default:"未知医院" }}</strong>
                                        {% if report.notes %}
                                            <span class="badge bg-light text-dark border ms-2">
                                                <i class="bi bi-card-text"></i> {{ report.notes }}
                                            </span>
                                        {% endif %}
                                        <div class="text-muted small">
                                            <i class="bi bi-calendar"></i> {{ report.checkup_date|date:"Y年m月d日" }}
                                            {% if report.indicator_set.all %}
                                                <span class="badge bg-info ms-2">{{ report.indicator_set.all|length }}项指标</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endwith %}
                    {% endfor %}
                    </div>

                    <!-- 选中的统计 -->
                    <div class="mt-3 text-center">
                        <span class="badge bg-primary" id="reportSelectionCount">已选择 0 份报告</span>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-clipboard-x" style="font-size: 2rem;"></i>
                        <p class="mt-2">暂无体检报告</p>
                        <small class="text-muted">
                            请先<a href="{% url 'medical_records:upload_report' %}" class="text-decoration-none">上传体检报告</a>，再选择相关报告进行咨询
                        </small>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmReportSelection()">
                    <i class="bi bi-check-circle"></i> 确认选择
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 药单选择弹窗 -->
<div class="modal fade" id="medicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-capsule"></i> 选择药单
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if medications %}
                    <!-- 不使用药单选项 -->
                    <div class="form-check mb-3 p-3 border rounded bg-light">
                        <input type="checkbox" class="form-check-input" id="noMedicationsCheckbox" onchange="handleNoMedicationsChange()" checked>
                        <label class="form-check-label w-100" for="noMedicationsCheckbox">
                            <strong class="text-secondary">
                                <i class="bi bi-chat-text"></i> 不使用药单
                            </strong>
                            <div class="text-muted small">
                                不包含药单信息进行咨询
                            </div>
                        </label>
                    </div>

                    <!-- 快捷选择按钮 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllMedications()">全选</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllMedications()">清空</button>
                    </div>

                    <!-- 药单列表 -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div class="list-group">
                        {% for med in medications %}
                            <div class="list-group-item">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input medication-checkbox"
                                           name="selected_medications" value="{{ med.id }}"
                                           id="med_{{ med.id }}" onchange="handleMedicationCheckboxChange()">
                                    <label class="form-check-label w-100" for="med_{{ med.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong class="text-primary">{{ med.medicine_name }}</strong>
                                                <div class="text-muted small">
                                                    {{ med.dosage }}
                                                </div>
                                                <div class="text-muted small">
                                                    {{ med.start_date }} 至 {{ med.end_date }}
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    </div>

                    <!-- 选中的统计 -->
                    <div class="mt-3 text-center">
                        <span class="badge bg-warning" id="medicationSelectionCount">已选择 0 份药单</span>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-capsule" style="font-size: 2rem;"></i>
                        <p class="mt-2">暂无药单</p>
                        <small class="text-muted">
                            您还没有添加任何药单
                        </small>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="confirmMedicationSelection()">
                    <i class="bi bi-check-circle"></i> 确认选择
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 对话选择弹窗 -->
<div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-chat-history"></i> 选择要继续的对话
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="conversationListModal" class="conversation-list">
                    {% if user_advices %}
                        {% for advice in user_advices %}
                            <div class="conversation-item p-3 border rounded mb-2 {% if forloop.first %}border-primary bg-light{% else %}border-secondary{% endif %}"
                                 data-conversation-id="{{ advice.conversation_id }}"
                                 style="cursor: pointer; transition: all 0.2s ease;"
                                 onclick="selectConversationInModal({{ advice.conversation_id }}, '{{ advice.title|escapejs }}', {{ advice.message_count }})">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">{{ advice.title }}</div>
                                        <div class="small text-muted mt-1">
                                            {{ advice.message_count }} 条对话
                                        </div>
                                        <div class="small text-truncate mt-1" style="max-width: 300px;">
                                            最新: {{ advice.latest_question|default:advice.question }}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small text-muted">{{ advice.updated_at }}</div>
                                        {% if forloop.first %}<span class="badge bg-primary">选中</span>{% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                            <p class="mt-2">暂无对话记录</p>
                            <small class="text-muted">开始一个新对话</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="confirmConversationSelection()">
                    <i class="bi bi-check-circle"></i> 确认选择
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 完整建议模态框 -->
<div class="modal fade" id="adviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI健康建议详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

// 保存上一次的咨询设置
let lastConsultationSettings = {
    reportMode: null,
    selectedReports: [],
    medicationMode: null,
    selectedMedications: [],
    conversationMode: null,
    selectedConversationId: null,
    selectedConversationTitle: null
};

// 当前选中的对话
let selectedConversation = {
    id: null,
    title: null,
    messageCount: null
};

// 获取CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== 对话选择相关 ====================

function handleConversationModeChange() {
    const newConversationMode = document.getElementById('newConversationMode');
    const continueConversationMode = document.getElementById('continueConversationMode');
    const selectedConversationDisplay = document.getElementById('selectedConversationDisplay');

    if (continueConversationMode && continueConversationMode.checked) {
        // 打开对话选择弹窗
        openConversationModal();
    } else {
        // 隐藏选中的对话信息
        if (selectedConversationDisplay) {
            selectedConversationDisplay.style.display = 'none';
        }
        selectedConversation = { id: null, title: null, messageCount: null };
    }
}

function openConversationModal() {
    const modal = new bootstrap.Modal(document.getElementById('conversationModal'));
    modal.show();
}

function selectConversationInModal(conversationId, title, messageCount) {
    // 移除所有选中状态
    document.querySelectorAll('#conversationListModal .conversation-item').forEach(item => {
        item.classList.remove('border-primary', 'bg-light');
        item.classList.add('border-secondary');
        const badge = item.querySelector('.badge');
        if (badge) badge.remove();
    });

    // 添加选中状态
    const selectedItem = document.querySelector(`#conversationListModal [data-conversation-id="${conversationId}"]`);
    selectedItem.classList.remove('border-secondary');
    selectedItem.classList.add('border-primary', 'bg-light');

    const textEnd = selectedItem.querySelector('.text-end');
    if (!textEnd.querySelector('.badge')) {
        textEnd.innerHTML += ' <span class="badge bg-primary">选中</span>';
    }

    // 保存选中的对话
    selectedConversation = {
        id: conversationId,
        title: title,
        messageCount: messageCount
    };
}

function confirmConversationSelection() {
    const modalEl = document.getElementById('conversationModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

    if (selectedConversation.id) {
        // 显示选中的对话信息
        const selectedConversationDisplay = document.getElementById('selectedConversationDisplay');
        document.getElementById('selectedConversationTitle').textContent = selectedConversation.title;
        document.getElementById('selectedConversationCount').textContent = selectedConversation.messageCount;
        selectedConversationDisplay.style.display = 'block';

        // 加载对话关联的报告和药单
        loadConversationResources(selectedConversation.id);
    }
}

// 加载对话关联的资源（报告和药单）
function loadConversationResources(conversationId) {
    const url = "{% url 'medical_records:api_conversation_resources' 999 %}".replace('999', conversationId);
    console.log('加载对话资源:', url);

    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('响应状态:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('对话资源数据:', data);
        if (data.success) {
            // 更新报告选择状态
            if (data.reports && data.reports.length > 0) {
                reportSelectionState.noReports = false;
                reportSelectionState.selectedIds = data.reports.map(r => r.id);
                reportSelectionState.reportsInfo = data.reports.map(r => ({
                    hospital: r.hospital,
                    date: r.checkup_date
                }));
                updateSelectedReportsDisplay();
            } else {
                // 没有关联报告，重置为不使用
                reportSelectionState.noReports = true;
                reportSelectionState.selectedIds = [];
                reportSelectionState.reportsInfo = [];
                updateSelectedReportsDisplay();
            }

            // 更新药单选择状态
            if (data.medications && data.medications.length > 0) {
                medicationSelectionState.noMedications = false;
                medicationSelectionState.selectedIds = data.medications.map(m => m.id);
                medicationSelectionState.medicationsInfo = data.medications.map(m => ({
                    name: m.medicine_name,
                    startDate: m.start_date,
                    endDate: m.end_date,
                    totalDays: m.total_days,
                    daysTaken: m.days_taken,
                    progress: m.progress_percentage
                }));
                updateSelectedMedicationsDisplay();
            } else {
                // 没有关联药单，重置为不使用
                medicationSelectionState.noMedications = true;
                medicationSelectionState.selectedIds = [];
                medicationSelectionState.medicationsInfo = [];
                updateSelectedMedicationsDisplay();
            }
        } else {
            console.error('加载对话资源失败:', data.error);
        }
    })
    .catch(error => {
        console.error('加载对话资源失败:', error);
    });
}

// ==================== 报告选择相关 ====================

// 保存报告选择状态
let reportSelectionState = {
    noReports: true,
    selectedIds: [],
    reportsInfo: []  // 保存报告详细信息
};

function openReportModal() {
    // 恢复之前的选择状态
    document.getElementById('noReportsCheckbox').checked = reportSelectionState.noReports;
    document.querySelectorAll('.report-checkbox').forEach(cb => {
        cb.checked = reportSelectionState.selectedIds.includes(cb.value);
    });
    updateSelectedReportsInModal();

    const modal = new bootstrap.Modal(document.getElementById('reportModal'));
    modal.show();
}

function handleNoReportsChange() {
    const noReportsCheckbox = document.getElementById('noReportsCheckbox');

    if (noReportsCheckbox.checked) {
        // 不使用报告：清空所有报告选择
        document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
    }
    updateSelectedReportsInModal();
}

function handleReportCheckboxChange() {
    // 当勾选任何报告时，自动取消"不使用报告"
    const checkedReports = document.querySelectorAll('.report-checkbox:checked');
    if (checkedReports.length > 0) {
        document.getElementById('noReportsCheckbox').checked = false;
    }
    updateSelectedReportsInModal();
}

function updateSelectedReportsInModal() {
    const noReportsCheckbox = document.getElementById('noReportsCheckbox');

    if (noReportsCheckbox.checked) {
        document.getElementById('reportSelectionCount').textContent = '当前不选择提供报告';
        return;
    }

    const checkboxes = document.querySelectorAll('.report-checkbox:checked');
    const count = checkboxes.length;

    if (count === 0) {
        document.getElementById('reportSelectionCount').textContent = '请选择至少一份报告';
    } else {
        document.getElementById('reportSelectionCount').textContent = `已选择 ${count} 份报告`;
    }
}

function selectAllReports() {
    document.getElementById('noReportsCheckbox').checked = false;
    document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = true);
    updateSelectedReportsInModal();
}

function selectRecentReports() {
    document.getElementById('noReportsCheckbox').checked = false;
    const checkboxes = document.querySelectorAll('.report-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    for (let i = 0; i < Math.min(2, checkboxes.length); i++) {
        checkboxes[i].checked = true;
    }
    updateSelectedReportsInModal();
}

function selectAbnormalReports() {
    document.getElementById('noReportsCheckbox').checked = false;
    const checkboxes = document.querySelectorAll('.report-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    checkboxes.forEach(cb => {
        const reportDiv = cb.closest('.form-check');
        if (reportDiv.querySelector('.badge')) {
            cb.checked = true;
        }
    });
    updateSelectedReportsInModal();
}

function clearAllReports() {
    document.getElementById('noReportsCheckbox').checked = true;
    document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
    updateSelectedReportsInModal();
}

function confirmReportSelection() {
    // 保存选择状态
    const noReportsCheckbox = document.getElementById('noReportsCheckbox');
    const checkedReports = document.querySelectorAll('.report-checkbox:checked');

    console.log('确认报告选择:');
    console.log('- 不使用报告:', noReportsCheckbox.checked);
    console.log('- 选中的报告数量:', checkedReports.length);

    reportSelectionState.noReports = noReportsCheckbox.checked;
    reportSelectionState.selectedIds = [];
    reportSelectionState.reportsInfo = [];  // 清空并重新收集报告信息

    checkedReports.forEach(cb => {
        reportSelectionState.selectedIds.push(cb.value);

        // 保存报告详细信息 - label是checkbox的兄弟元素
        const label = cb.nextElementSibling;
        if (label) {
            const hospital = label.querySelector('strong').textContent;
            const dateText = label.querySelector('.text-muted');
            if (dateText) {
                const date = dateText.textContent.trim();
                reportSelectionState.reportsInfo.push({ hospital, date });
            }
        }
    });

    console.log('- 保存的selectedIds:', reportSelectionState.selectedIds);
    console.log('- 保存的reportsInfo:', reportSelectionState.reportsInfo);

    const modalEl = document.getElementById('reportModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) {
        modal.hide();
    }

    // 立即更新显示，不延迟
    updateSelectedReportsDisplay();
}

function updateSelectedReportsDisplay() {
    const selectedReportsDisplay = document.getElementById('selectedReportsDisplay');

    console.log('更新报告显示:');
    console.log('- noReports:', reportSelectionState.noReports);
    console.log('- selectedIds:', reportSelectionState.selectedIds);
    console.log('- reportsInfo:', reportSelectionState.reportsInfo);
    console.log('- 找到显示元素:', selectedReportsDisplay);

    if (!selectedReportsDisplay) {
        console.error('找不到 selectedReportsDisplay 元素!');
        return;
    }

    if (reportSelectionState.noReports) {
        selectedReportsDisplay.innerHTML = '<small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供报告</small>';
        return;
    }

    const count = reportSelectionState.selectedIds.length;

    if (count === 0) {
        selectedReportsDisplay.innerHTML = '<small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供报告</small>';
    } else {
        // 使用保存的报告信息
        const preview = reportSelectionState.reportsInfo.slice(0, 2)
            .map(r => `${r.hospital} (${r.date})`)
            .join('、');
        const more = count > 2 ? ` 等${count}份` : '';

        console.log('- 显示内容:', preview + more);

        selectedReportsDisplay.innerHTML = `
            <div>
                <strong class="text-primary"><i class="bi bi-check-circle"></i> 已选择 ${count} 份报告</strong>
                <div class="small text-muted mt-1">${preview}${more}</div>
            </div>
        `;
    }
}

// ==================== 药单选择相关 ====================

// 保存药单选择状态
let medicationSelectionState = {
    noMedications: true,
    selectedIds: [],
    medicationsInfo: []  // 保存药单详细信息
};

function openMedicationModal() {
    // 恢复之前的选择状态
    document.getElementById('noMedicationsCheckbox').checked = medicationSelectionState.noMedications;
    document.querySelectorAll('.medication-checkbox').forEach(cb => {
        cb.checked = medicationSelectionState.selectedIds.includes(cb.value);
    });
    updateSelectedMedicationsInModal();

    const modal = new bootstrap.Modal(document.getElementById('medicationModal'));
    modal.show();
}

function handleNoMedicationsChange() {
    const noMedicationsCheckbox = document.getElementById('noMedicationsCheckbox');

    if (noMedicationsCheckbox.checked) {
        document.querySelectorAll('.medication-checkbox').forEach(cb => cb.checked = false);
    }
    updateSelectedMedicationsInModal();
}

function handleMedicationCheckboxChange() {
    // 当勾选任何药单时，自动取消"不使用药单"
    const checkedMedications = document.querySelectorAll('.medication-checkbox:checked');
    if (checkedMedications.length > 0) {
        document.getElementById('noMedicationsCheckbox').checked = false;
    }
    updateSelectedMedicationsInModal();
}

function updateSelectedMedicationsInModal() {
    const noMedicationsCheckbox = document.getElementById('noMedicationsCheckbox');

    if (noMedicationsCheckbox.checked) {
        document.getElementById('medicationSelectionCount').textContent = '当前不选择提供药单';
        return;
    }

    const checkboxes = document.querySelectorAll('.medication-checkbox:checked');
    const count = checkboxes.length;

    if (count === 0) {
        document.getElementById('medicationSelectionCount').textContent = '请选择药单';
    } else {
        document.getElementById('medicationSelectionCount').textContent = `已选择 ${count} 份药单`;
    }
}

function selectAllMedications() {
    document.getElementById('noMedicationsCheckbox').checked = false;
    document.querySelectorAll('.medication-checkbox').forEach(cb => cb.checked = true);
    updateSelectedMedicationsInModal();
}

function clearAllMedications() {
    document.getElementById('noMedicationsCheckbox').checked = true;
    document.querySelectorAll('.medication-checkbox').forEach(cb => cb.checked = false);
    updateSelectedMedicationsInModal();
}

function confirmMedicationSelection() {
    // 保存选择状态
    const noMedicationsCheckbox = document.getElementById('noMedicationsCheckbox');
    const checkedMedications = document.querySelectorAll('.medication-checkbox:checked');

    medicationSelectionState.noMedications = noMedicationsCheckbox.checked;
    medicationSelectionState.selectedIds = [];
    medicationSelectionState.medicationsInfo = [];  // 清空并重新收集药单信息

    checkedMedications.forEach(cb => {
        medicationSelectionState.selectedIds.push(cb.value);

        // 保存药单详细信息 - label是checkbox的兄弟元素
        const label = cb.nextElementSibling;
        if (label) {
            const name = label.querySelector('strong').textContent;
            medicationSelectionState.medicationsInfo.push({ name });
        }
    });

    const modalEl = document.getElementById('medicationModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) {
        modal.hide();
    }

    updateSelectedMedicationsDisplay();
}

function updateSelectedMedicationsDisplay() {
    const selectedMedicationsDisplay = document.getElementById('selectedMedicationsDisplay');

    console.log('更新药单显示:');
    console.log('- noMedications:', medicationSelectionState.noMedications);
    console.log('- selectedIds:', medicationSelectionState.selectedIds);

    if (!selectedMedicationsDisplay) {
        console.error('找不到 selectedMedicationsDisplay 元素!');
        return;
    }

    if (medicationSelectionState.noMedications) {
        selectedMedicationsDisplay.innerHTML = '<small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供药单</small>';
        return;
    }

    const count = medicationSelectionState.selectedIds.length;

    if (count === 0) {
        selectedMedicationsDisplay.innerHTML = '<small class="text-muted"><i class="bi bi-info-circle"></i> 当前不选择提供药单</small>';
    } else {
        // 使用保存的药单信息
        const preview = medicationSelectionState.medicationsInfo.slice(0, 2)
            .map(m => m.name)
            .join('、');
        const more = count > 2 ? ` 等${count}份` : '';

        console.log('- 显示内容:', preview + more);

        selectedMedicationsDisplay.innerHTML = `
            <div>
                <strong class="text-warning"><i class="bi bi-check-circle"></i> 已选择 ${count} 份药单</strong>
                <div class="small text-muted mt-1">${preview}${more}</div>
            </div>
        `;
    }
}

// ==================== 其他原有功能 ====================

// 显示对话消息
function showConversationMessages(conversationId) {
    fetch(`{% url 'medical_records:api_conversation_messages' 0 %}`.replace('0', conversationId), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessagesInModal(data.messages);
        } else {
            alert('加载对话消息失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('加载对话消息失败:', error);
        alert('加载对话消息失败：网络错误');
    });
}

// 在模态框中显示消息
function displayMessagesInModal(messages) {
    const modal = new bootstrap.Modal(document.getElementById('adviceModal'));
    const modalContent = document.getElementById('modalContent');

    let messagesHtml = '';
    messages.forEach((msg) => {
        messagesHtml += `
            <div class="mb-3 p-3 rounded bg-light border">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="bi bi-person"></i> 您的问题</strong>
                    <span class="small text-muted">${msg.created_at}</span>
                </div>
                <div class="user-question">${msg.question}</div>
            </div>
            <hr class="my-2">
            <div class="mb-3 p-3 rounded bg-info bg-opacity-10 border border-info">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="bi bi-robot"></i> AI医生建议</strong>
                    <span class="small text-muted">${msg.created_at}</span>
                </div>
                <div class="ai-content-modal">${marked.parse(msg.answer)}</div>
            </div>
        `;
    });

    const hasAnyPrompt = messages.some(msg => msg.prompt_sent && msg.prompt_sent.trim() !== '');

    let promptButtonHtml = '';
    if (hasAnyPrompt) {
        promptButtonHtml = `
            <button class="btn btn-outline-info btn-sm mb-3" onclick="toggleAllPrompts()">
                <i class="bi bi-code"></i> 查看发送给AI的内容
            </button>
            <div id="allPromptsSection" style="display: none;">
                ${messages.map((msg, index) => `
                    <div class="mb-3">
                        <strong><i class="bi bi-chat-dots"></i> 第 ${index + 1} 条消息发送给AI的内容：</strong>
                        <pre class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 200px; overflow-y: auto;">${msg.prompt_sent || '无'}</pre>
                    </div>
                `).join('')}
            </div>
        `;
    }

    const conversationId = messages.length > 0 && messages[0].conversation_id ? messages[0].conversation_id : null;

    let exportButtonsHtml = '';
    if (conversationId) {
        exportButtonsHtml = `
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <a href="/conversations/${conversationId}/export/pdf/"
                       class="btn btn-outline-danger">
                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                    </a>
                    <a href="/conversations/${conversationId}/export/word/"
                       class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-word"></i> 导出Word
                    </a>
                </div>
            </div>
        `;
    }

    modalContent.innerHTML = `
        <div class="mb-3">
            <h5><i class="bi bi-chat-dots"></i> 对话历史</h5>
            <small class="text-muted">共 ${messages.length} 条消息</small>
        </div>
        ${exportButtonsHtml}
        ${promptButtonHtml}
        <div class="mb-3">
            ${messagesHtml}
        </div>
    `;

    modal.show();
}

// 切换显示所有Prompt
function toggleAllPrompts() {
    const promptSection = document.getElementById('allPromptsSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 删除对话
function deleteConversation(conversationId) {
    if (!confirm('确定要删除这个对话吗？')) return;

    fetch(`{% url 'medical_records:api_delete_conversation' 0 %}`.replace('0', conversationId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除对话失败:', error);
        alert('删除失败：网络错误');
    });
}

// 切换Prompt显示
function togglePrompt() {
    const promptSection = document.getElementById('promptSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 显示完整建议（历史记录）
function showFullAdvice(adviceId) {
    fetch(`{% url 'medical_records:api_advice_detail' 0 %}`.replace('0', adviceId), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = new bootstrap.Modal(document.getElementById('adviceModal'));
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <div class="mb-3">
                    <strong><i class="bi bi-question-circle"></i> 问题：</strong>
                    <p class="mt-2">${data.question}</p>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-chat-dots"></i> AI医生建议：</strong>
                    <div class="mt-2 p-3 bg-light rounded ai-content-modal">${marked.parse(data.answer)}</div>
                </div>
                ${data.prompt ? `
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm" onclick="toggleModalPrompt()">
                        <i class="bi bi-code"></i> 查看发送给AI的内容
                    </button>
                    <div id="modalPromptSection" style="display: none;">
                        <strong><i class="bi bi-terminal"></i> 发送给AI医生的完整内容：</strong>
                        <pre class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
                    </div>
                </div>
                ` : ''}
                <div class="text-muted small">
                    <i class="bi bi-clock"></i> 咨询时间：${data.created_at}
                </div>
            `;

            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('获取建议详情失败');
    });
}

// 切换模态框中的Prompt显示
function toggleModalPrompt() {
    const promptSection = document.getElementById('modalPromptSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 删除咨询记录
function deleteAdvice(adviceId) {
    if (!confirm('确定要删除这条记录吗？')) return;

    fetch(`/api/advice/${adviceId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除失败:', error);
        alert('删除失败：网络错误');
    });
}

// 保存当前咨询设置
function saveConsultationSettings() {
    const conversationMode = document.querySelector('input[name="conversation_mode"]:checked');

    lastConsultationSettings = {
        reportSelectionState: {...reportSelectionState},
        medicationSelectionState: {...medicationSelectionState},
        conversationMode: conversationMode ? conversationMode.value : 'new_conversation',
        selectedConversationId: selectedConversation.id,
        selectedConversationTitle: selectedConversation.title
    };

    console.log('保存咨询设置:', lastConsultationSettings);
}

// 继续咨询
function continueConsultation() {
    console.log('继续咨询，恢复设置:', lastConsultationSettings);

    document.getElementById('resultCard').style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // 恢复对话模式
    if (lastConsultationSettings.conversationMode === 'continue_conversation' && lastConsultationSettings.selectedConversationId) {
        document.getElementById('continueConversationMode').checked = true;
        selectedConversation = {
            id: lastConsultationSettings.selectedConversationId,
            title: lastConsultationSettings.selectedConversationTitle,
            messageCount: 0
        };
        document.getElementById('selectedConversationTitle').textContent = lastConsultationSettings.selectedConversationTitle;
        document.getElementById('selectedConversationCount').textContent = '继续';
        document.getElementById('selectedConversationDisplay').style.display = 'block';
    } else {
        document.getElementById('newConversationMode').checked = true;
        document.getElementById('selectedConversationDisplay').style.display = 'none';
    }

    // 恢复报告选择
    if (lastConsultationSettings.reportSelectionState) {
        reportSelectionState = {...lastConsultationSettings.reportSelectionState};
    }
    updateSelectedReportsDisplay();

    // 恢复药单选择
    if (lastConsultationSettings.medicationSelectionState) {
        medicationSelectionState = {...lastConsultationSettings.medicationSelectionState};
    }
    updateSelectedMedicationsDisplay();

    const textarea = document.querySelector('textarea[name="question"]');
    textarea.focus();
    textarea.style.height = 'auto';
}

// 事件监听
document.addEventListener('DOMContentLoaded', function() {
    handleConversationModeChange();
    updateSelectedReportsInModal();
    updateSelectedMedicationsInModal();

    // 历史记录按钮事件
    document.addEventListener('click', function(e) {
        const convBtn = e.target.closest('[data-show-conversation]');
        if (convBtn) {
            e.preventDefault();
            const conversationId = parseInt(convBtn.dataset.showConversation);
            showConversationMessages(conversationId);
            return;
        }

        const adviceBtn = e.target.closest('[data-show-advice]');
        if (adviceBtn) {
            e.preventDefault();
            const adviceId = parseInt(adviceBtn.dataset.showAdvice);
            showFullAdvice(adviceId);
            return;
        }
    });
});

// 表单提交处理 - 使用流式响应
document.getElementById('adviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const textarea = document.querySelector('textarea[name="question"]');
    const question = textarea.value.trim();

    if (!question) {
        alert('请输入您的健康问题');
        textarea.focus();
        return;
    }

    if (question.length < 5) {
        alert('请详细描述您的问题，至少5个字符');
        textarea.focus();
        return;
    }

    // 验证：如果选择继续对话，必须选择对话
    const continueConversationMode = document.getElementById('continueConversationMode');
    if (continueConversationMode && continueConversationMode.checked && !selectedConversation.id) {
        alert('请选择要继续的对话');
        return;
    }

    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>处理中...';

    saveConsultationSettings();

    const conversationMode = document.querySelector('input[name="conversation_mode"]:checked');

    const requestData = {
        question: question,
        conversation_mode: conversationMode ? conversationMode.value : 'new_conversation',
        report_mode: reportSelectionState.noReports ? 'no_reports' : 'select_reports',
        selected_report_ids: reportSelectionState.selectedIds,
        medication_mode: medicationSelectionState.noMedications ? 'no_medications' : 'select_medications',
        selected_medication_ids: medicationSelectionState.selectedIds
    };

    if (conversationMode && conversationMode.value === 'continue_conversation' && selectedConversation.id) {
        requestData.conversation_id = selectedConversation.id;
    }

    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock activated');
            }
        } catch (err) {
            console.log(`Wake Lock error: ${err.name}, ${err.message}`);
        }
    }

    await requestWakeLock();

    const handleVisibilityChange = () => {
        if (document.hidden) {
            console.log('⚠️ 警告：请保持页面打开，切换后台可能导致AI分析失败');
        } else {
            console.log('✅ 页面已恢复，继续AI分析...');
            requestWakeLock();
        }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    try {
        const streamUrl = '{% url "medical_records:api_stream_ai_advice" %}';

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000);

        const response = await fetch(streamUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('userQuestion').textContent = question;
        document.getElementById('aiAnswer').innerHTML = '<div class="text-muted"><i class="bi bi-three-dots"></i> AI医生正在思考...</div>';
        document.getElementById('responseTime').textContent = new Date().toLocaleString();
        document.getElementById('conversationHistory').style.display = 'none';

        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullAnswer = '';
        let savedPrompt = null;  // 保存prompt内容

        while (true) {
            const { done, value } = await reader.read();

            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.error) {
                            document.getElementById('aiAnswer').innerHTML = `
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> AI医生服务暂时不可用</h5>
                                    <p><strong>错误信息：</strong>${data.error}</p>
                                </div>
                            `;
                        } else if (data.prompt) {
                            // 保存prompt内容
                            savedPrompt = data.prompt;
                        } else if (data.content) {
                            fullAnswer += data.content;
                            document.getElementById('aiAnswer').textContent = fullAnswer;
                            const aiAnswerDiv = document.getElementById('aiAnswer');
                            aiAnswerDiv.scrollTop = aiAnswerDiv.scrollHeight;
                        } else if (data.done) {
                            const aiAnswerHtml = marked.parse(fullAnswer);
                            document.getElementById('aiAnswer').innerHTML = aiAnswerHtml;

                            // 如果有保存的prompt，设置到promptContent元素
                            if (savedPrompt) {
                                const promptContent = document.getElementById('promptContent');
                                if (promptContent) {
                                    promptContent.textContent = savedPrompt;
                                    console.log('Prompt内容已设置');
                                }
                            }
                        } else if (data.saved) {
                            console.log('已保存到数据库，advice_id:', data.advice_id, 'conversation_id:', data.conversation_id);
                            const aiAnswerDiv = document.getElementById('aiAnswer');
                            const refreshButton = document.createElement('div');
                            refreshButton.className = 'mt-3 text-center';
                            refreshButton.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> AI建议已保存
                                </div>
                                <button class="btn btn-primary" onclick="window.location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新页面查看历史记录
                                </button>
                            `;
                            aiAnswerDiv.appendChild(refreshButton);
                        } else if (data.save_error) {
                            console.error('保存失败:', data.save_error);
                        }
                    } catch (parseError) {
                        console.error('解析SSE数据失败:', parseError, line);
                    }
                }
            }
        }

        textarea.value = '';

    } catch (error) {
        console.error('Error:', error);

        document.getElementById('userQuestion').textContent = question;

        if (error.name === 'AbortError') {
            document.getElementById('aiAnswer').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> 请求超时</h5>
                    <p><strong>错误信息：</strong>AI分析超时，请检查网络连接后重试</p>
                </div>
            `;
        } else {
            document.getElementById('aiAnswer').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> 网络或服务器错误</h5>
                    <p><strong>错误信息：</strong>${error.message}</p>
                    <p>请检查网络连接或稍后重试</p>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新页面
                        </button>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('loadingCard').style.display='none'; document.getElementById('resultCard').style.display='none';">
                            <i class="bi bi-x"></i> 关闭
                        </button>
                    </div>
                </div>
            `;
        }
        document.getElementById('responseTime').textContent = new Date().toLocaleString();
        document.getElementById('conversationHistory').style.display = 'none';

        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
    } finally {
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        if (wakeLock !== null) {
            wakeLock.release()
                .then(() => {
                    wakeLock = null;
                    console.log('Wake Lock released');
                })
                .catch((err) => {
                    console.error(`Wake Lock release error: ${err.name}, ${err.message}`);
                });
        }

        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-send"></i> 获取建议';
    }
});

// 自动调整文本框高度
const textarea = document.querySelector('textarea[name="question"]');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});
</script>

<style>
.ai-content h1,
.ai-content h2,
.ai-content h3,
.ai-content h4,
.ai-content h5,
.ai-content h6 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.ai-content h1 {
    font-size: 1.75rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
}

.ai-content h2 {
    font-size: 1.5rem;
    color: #34495e;
    border-bottom: 1px solid #bdc3c7;
    padding-bottom: 0.3rem;
}

.ai-content h3 {
    font-size: 1.25rem;
    color: #2c3e50;
}

.ai-content h4 {
    font-size: 1.1rem;
    color: #34495e;
}

.ai-content p {
    margin-bottom: 1rem;
    line-height: 1.6;
}

.ai-content strong {
    color: #e74c3c;
    font-weight: 600;
}

.ai-content em {
    color: #8e44ad;
    font-style: italic;
}

.ai-content ul,
.ai-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.ai-content li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.ai-content blockquote {
    border-left: 4px solid #3498db;
    padding-left: 1rem;
    margin: 1rem 0;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    font-style: italic;
    color: #6c757d;
}

.ai-content code {
    background-color: #f1f2f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #e83e8c;
}

.ai-content pre {
    background-color: #2d3748;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.ai-content pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
}

.ai-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.ai-content th,
.ai-content td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

.ai-content th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.ai-content hr {
    border: 0;
    height: 1px;
    background-color: #dee2e6;
    margin: 2rem 0;
}

.ai-content-modal h1,
.ai-content-modal h2,
.ai-content-modal h3,
.ai-content-modal h4,
.ai-content-modal h5,
.ai-content-modal h6 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.ai-content-modal h1 {
    font-size: 1.5rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
}

.ai-content-modal h2 {
    font-size: 1.3rem;
    color: #34495e;
    border-bottom: 1px solid #bdc3c7;
    padding-bottom: 0.3rem;
}

.ai-content-modal strong {
    color: #e74c3c;
    font-weight: 600;
}

.ai-content-modal em {
    color: #8e44ad;
    font-style: italic;
}

.ai-content-modal code {
    background-color: #f1f2f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #e83e8c;
}

.ai-content-modal blockquote {
    border-left: 4px solid #3498db;
    padding-left: 1rem;
    margin: 1rem 0;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    font-style: italic;
    color: #6c757d;
}

.report-selection-list .form-check {
    transition: background-color 0.2s ease;
}

.report-selection-list .form-check:hover {
    background-color: #f0f8ff !important;
}

.report-selection-list .form-check-input:checked ~ .form-check-label {
    font-weight: 500;
    color: #0d6efd;
}

.report-selection-list .form-check-input:checked + .form-check-label {
    background-color: #e7f3ff;
    border-radius: 0.25rem;
}

.conversation-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.conversation-item:hover {
    background-color: #f0f8ff !important;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.alert {
    animation: fadeIn 0.3s ease;
}
</style>

{% endblock %}
