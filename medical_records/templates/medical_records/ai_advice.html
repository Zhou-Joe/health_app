{% extends 'base.html' %}

{% block title %}AI健康建议 - 个人健康管理系统{% endblock %}

{% block content %}
<div class="row">
    <!-- 右侧咨询历史 -->
    <div class="col-md-4 order-md-2">
        <!-- 咨询历史 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> 咨询历史
                </h6>
            </div>
            <div class="card-body">
                {% if user_advices %}
                    <div class="advice-history">
                        {% for advice in user_advices %}
                        <div class="border-bottom pb-2 mb-2" id="advice-{{ advice.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if advice.is_conversation %}
                                            <span class="badge bg-success me-2">
                                                <i class="bi bi-chat-dots"></i> {{ advice.message_count }}条对话
                                            </span>
                                        {% endif %}
                                        <div class="small text-muted">{{ advice.updated_at|date:"m-d H:i" }}</div>
                                    </div>
                                    <div class="small fw-bold">{{ advice.title }}</div>
                                    <div class="small text-truncate text-muted" style="max-width: 200px;">
                                        <strong class="text-primary">最新：</strong>{{ advice.latest_question|default:advice.question|truncatechars:60 }}
                                    </div>
                                </div>
                                <div class="ms-2">
                                    {% if advice.is_conversation %}
                                        <button class="btn btn-link btn-sm p-0" onclick="showConversationMessages({{ advice.conversation_id }})">
                                            查看对话
                                        </button>
                                    {% else %}
                                        <button class="btn btn-link btn-sm p-0" onclick="showFullAdvice({{ advice.id }})">
                                            查看完整回答
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="ms-2">
                                    {% if advice.is_conversation %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'medical_records:export_conversation_pdf' advice.conversation_id %}"
                                               class="btn btn-outline-danger" title="导出为PDF">
                                                <i class="bi bi-file-earmark-pdf"></i>
                                            </a>
                                            <a href="{% url 'medical_records:export_conversation_word' advice.conversation_id %}"
                                               class="btn btn-outline-primary" title="导出为Word">
                                                <i class="bi bi-file-earmark-word"></i>
                                            </a>
                                            <button class="btn btn-outline-danger" onclick="deleteConversation({{ advice.conversation_id }})" title="删除整个对话">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAdvice({{ advice.id }})" title="删除此条记录">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">暂无咨询记录</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 左侧主要内容 -->
    <div class="col-md-8 order-md-1">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-robot"></i> AI健康医生
                </h4>
            </div>
            <div class="card-body">
                <form id="adviceForm" method="post">
                    {% csrf_token %}

                    <!-- 简洁提示 -->
                    <div class="text-muted small mb-3">
                        <i class="bi bi-info-circle"></i> AI分析过程中请保持该页面等待完成
                    </div>

                    <!-- 对话选择区域 -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-chat-dots"></i> 对话模式
                        </label>
                        <small class="text-muted d-block mb-2">选择创建新对话或继续之前的对话</small>

                        <div class="card">
                            <div class="card-body p-0">
                                <!-- 新对话选项 -->
                                <div class="form-check m-0 p-3 border-bottom">
                                    <input type="radio" name="conversation_mode" value="new_conversation" class="form-check-input" id="newConversationMode" checked onchange="handleConversationModeChange()">
                                    <label class="form-check-label w-100" for="newConversationMode">
                                        <div>
                                            <strong class="text-primary">
                                                <i class="bi bi-plus-circle"></i> 创建新对话
                                            </strong>
                                            <div class="text-muted small">
                                                开始一个全新的健康咨询对话
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- 继续对话选项 -->
                                <div class="form-check m-0 p-3">
                                    <input type="radio" name="conversation_mode" value="continue_conversation" class="form-check-input" id="continueConversationMode" onchange="handleConversationModeChange()">
                                    <label class="form-check-label w-100" for="continueConversationMode">
                                        <div>
                                            <strong class="text-success">
                                                <i class="bi bi-arrow-right-circle"></i> 继续之前的对话
                                            </strong>
                                            <div class="text-muted small">
                                                选择一个已有的对话继续咨询
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 对话列表选择区域 -->
                        <div id="conversationListContainer" class="mt-3" style="display: none;">
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <strong><i class="bi bi-chat-history"></i> 选择对话</strong>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshConversations()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新
                                    </button>
                                </div>

                                <div id="conversationList" class="conversation-list">
                                    {% if user_advices %}
                                        {% for advice in user_advices %}
                                            <div class="conversation-item p-3 border rounded mb-2 {% if forloop.first %}border-primary bg-light{% else %}border-secondary{% endif %}"
                                                 data-conversation-id="{{ advice.conversation_id }}"
                                                 style="cursor: pointer; transition: all 0.2s ease;"
                                                 onclick="selectConversation({{ advice.conversation_id }}, '{{ advice.title|escapejs }}', {{ advice.message_count }})">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold">{{ advice.title }}</div>
                                                        <div class="small text-muted mt-1">
                                                            {{ advice.message_count }} 条对话
                                                        </div>
                                                        <div class="small text-truncate mt-1" style="max-width: 200px;">
                                                            最新: {{ advice.latest_question|default:advice.question }}
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="small text-muted">{{ advice.updated_at }}</div>
                                                        {% if forloop.first %}<span class="badge bg-primary">选中</span>{% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                                            <p class="mt-2">暂无对话记录</p>
                                            <small class="text-muted">开始一个新对话</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.question.id_for_label }}" class="form-label">
                            <i class="bi bi-chat-dots"></i> 请描述您的健康问题
                        </label>
                        {{ form.question }}
                        {% if form.question.errors %}
                            <div class="text-danger">
                                {{ form.question.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 报告选择区域 -->
                    <div class="mb-4">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-clipboard-check"></i>
                                选择相关体检报告
                            </label>
                            <small class="text-muted d-block mb-2">请选择与您问题相关的体检报告，或选择不使用任何报告</small>
                        </div>

                        <div id="reportSelectionArea" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 300px; overflow-y: auto;">
                            {% if reports_with_info %}
                                <!-- 选项：不使用任何报告 -->
                                <div class="form-check mb-3 p-3 border rounded" style="background-color: #e8f5e8; border: 1px solid #28a745 !important;">
                                    <input type="radio" name="report_mode" value="no_reports" class="form-check-input" id="noReportsMode" onchange="handleReportModeChange()">
                                    <label class="form-check-label w-100" for="noReportsMode">
                                        <div>
                                            <strong class="text-success">
                                                <i class="bi bi-chat-text"></i> 不使用任何报告
                                            </strong>
                                            <div class="text-muted small">
                                                仅基于我的问题提供一般性健康建议
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- 选项：选择特定报告 -->
                                <div class="form-check mb-3 p-3 border rounded" style="background-color: #f8f9fa; border: 1px solid #6c757d !important;">
                                    <input type="radio" name="report_mode" value="select_reports" class="form-check-input" id="selectReportsMode" checked onchange="handleReportModeChange()">
                                    <label class="form-check-label w-100" for="selectReportsMode">
                                        <div>
                                            <strong class="text-dark">
                                                <i class="bi bi-clipboard-data"></i> 选择特定报告
                                            </strong>
                                            <div class="text-muted small">
                                                AI医生将基于我选择的报告提供针对性建议
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- 报告列表 -->
                                <div id="reportListContainer">
                                    <div class="mb-3">
                                        <small class="text-muted">{{ form.selected_reports.help_text }}</small>
                                    </div>

                                    <div class="report-selection-list">
                                    {% for report_info in reports_with_info %}
                                        {% with report=report_info.report %}
                                        <div class="form-check mb-2 p-2 border-bottom" style="background-color: white;">
                                            <input type="checkbox" name="selected_reports" value="{{ report.id }}"
                                                   class="form-check-input" id="report_{{ report.id }}">
                                            <label class="form-check-label w-100" for="report_{{ report.id }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <strong>{{ report.hospital|default:"未知医院" }}</strong>
                                                        {% if report.notes %}
                                                            <span class="badge bg-light text-dark border ms-2">
                                                                <i class="bi bi-card-text"></i> {{ report.notes }}
                                                            </span>
                                                        {% endif %}
                                                        <div class="text-muted small">
                                                            <i class="bi bi-calendar"></i> {{ report.checkup_date|date:"Y年m月d日" }}
                                                            {% if report.indicator_set.all %}
                                                                <span class="badge bg-info ms-2">{{ report.indicator_set.all|length }}项指标</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% endwith %}
                                    {% endfor %}
                                </div>

                                      <!-- 快捷选择按钮 -->
                                    <div class="mt-3 d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllReports()">
                                            <i class="bi bi-check-all"></i> 全选
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="selectRecentReports()">
                                            <i class="bi bi-clock-history"></i> 选择最近2份
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="selectAbnormalReports()">
                                            <i class="bi bi-clipboard-check"></i> 选择报告
                                        </button>
                                    </div>
                                </div> <!-- 关闭 report-selection-list -->
                                </div> <!-- 关闭 reportListContainer -->
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-clipboard-x" style="font-size: 2rem;"></i>
                                    <p class="mt-2">暂无体检报告</p>
                                    <small class="text-muted">
                                        请先<a href="{% url 'medical_records:upload_report' %}" class="text-decoration-none">上传体检报告</a>，再选择相关报告进行咨询
                                    </small>
                                </div>
                            {% endif %}
                        </div>

                        <!-- 选中的报告提示 -->
                        <div id="selectedReportsInfo" class="mt-2" style="display: none;">
                            <small class="text-info">
                                <i class="bi bi-check-circle"></i>
                                已选择 <span id="selectedCount">0</span> 份报告
                            </small>
                        </div>
                    </div>

                    <!-- 药单选择区域 -->
                    <div class="mb-4">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-capsule"></i>
                                选择相关药单（可选）
                            </label>
                            <small class="text-muted d-block mb-2">如果您正在服用药物，可以选择相关药单，AI医生会结合您的服药情况提供建议</small>
                        </div>

                        <div id="medicationSelectionArea" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 300px; overflow-y: auto;">
                            {% if medications %}
                                <!-- 选项：不使用任何药单 -->
                                <div class="form-check mb-3 p-3 border rounded" style="background-color: #e8f5e8; border: 1px solid #28a745 !important;">
                                    <input type="radio" name="medication_mode" value="no_medications" class="form-check-input" id="noMedicationsMode" checked onchange="handleMedicationModeChange()">
                                    <label class="form-check-label w-100" for="noMedicationsMode">
                                        <div>
                                            <strong class="text-success">
                                                <i class="bi bi-chat-text"></i> 不使用药单
                                            </strong>
                                            <div class="text-muted small">
                                                不包含药单信息进行咨询
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- 选项：选择特定药单 -->
                                <div class="form-check mb-3 p-3 border rounded" style="background-color: #f8f9fa; border: 1px solid #6c757d !important;">
                                    <input type="radio" name="medication_mode" value="select_medications" class="form-check-input" id="selectMedicationsMode" onchange="handleMedicationModeChange()">
                                    <label class="form-check-label w-100" for="selectMedicationsMode">
                                        <div>
                                            <strong class="text-dark">
                                                <i class="bi bi-capsule"></i> 选择药单
                                            </strong>
                                            <div class="text-muted small">
                                                AI医生将结合我的药单提供建议
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- 药单列表 -->
                                <div id="medicationListContainer" style="display: none;">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllMedications()">全选</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearMedications()">清空</button>
                                    </div>

                                    <div class="list-group">
                                        {% for med in medications %}
                                        <div class="list-group-item">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input medication-checkbox"
                                                       name="selected_medications" value="{{ med.id }}"
                                                       id="med_{{ med.id }}" onchange="updateSelectedMedicationsCount()">
                                                <label class="form-check-label w-100" for="med_{{ med.id }}">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong class="text-primary">{{ med.medicine_name }}</strong>
                                                            <div class="text-muted small">
                                                                {{ med.dosage }}
                                                            </div>
                                                            <div class="text-muted small">
                                                                {{ med.start_date }} 至 {{ med.end_date }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-capsule" style="font-size: 2rem;"></i>
                                    <p class="mt-2">暂无药单</p>
                                    <small class="text-muted">
                                        您还没有添加任何药单
                                    </small>
                                </div>
                            {% endif %}
                        </div>

                        <!-- 选中的药单提示 -->
                        <div id="selectedMedicationsInfo" class="mt-2" style="display: none;">
                            <small class="text-warning">
                                <i class="bi bi-check-circle"></i>
                                已选择 <span id="selectedMedicationsCount">0</span> 份药单
                            </small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'medical_records:dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 返回首页
                        </a>
                        <button type="submit" id="submitBtn" class="btn btn-primary">
                            <i class="bi bi-send"></i> 获取建议
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="card mt-4" id="loadingCard" style="display: none;">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <h5><i class="bi bi-cpu"></i> AI医生正在分析您的健康数据...</h5>
                <p class="text-muted">请稍等片刻，这可能需要几十秒到几分钟时间</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- AI建议结果 -->
        <div class="card mt-4" id="resultCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-robot"></i> AI医生建议
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong><i class="bi bi-question-circle"></i> 您的问题：</strong>
                    <p id="userQuestion" class="mt-2"></p>
                </div>
                <hr>
                <div id="conversationHistory" style="display: none;">
                    <div class="mb-3">
                        <strong><i class="bi bi-clock-history"></i> 对话历史：</strong>
                        <div id="historyContent" class="mt-2 p-3 bg-light rounded" style="font-size: 0.9em;"></div>
                    </div>
                    <hr>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-chat-dots"></i> AI医生建议：</strong>
                    <div id="aiAnswer" class="mt-2 p-3 bg-light rounded ai-content"></div>
                </div>
                <hr>
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm" onclick="togglePrompt()">
                        <i class="bi bi-code"></i> 查看发送给AI的内容
                    </button>
                </div>
                <div id="promptSection" style="display: none;">
                    <strong><i class="bi bi-terminal"></i> 发送给AI医生的完整内容：</strong>
                    <pre id="promptContent" class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 300px; overflow-y: auto;"></pre>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-clock"></i> 回复时间：<span id="responseTime"></span>
                </div>

                <!-- 继续咨询按钮 -->
                <div class="mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-success w-100" onclick="continueConsultation()">
                        <i class="bi bi-chat-plus"></i> 继续咨询
                    </button>
                    <small class="text-muted d-block mt-2 text-center">
                        <i class="bi bi-info-circle"></i> 使用相同的报告设置继续提问
                    </small>
                </div>
            </div>
        </div>

      </div>

    </div>
</div>

<!-- 完整建议模态框 -->
<div class="modal fade" id="adviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI健康建议详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

// 保存上一次的咨询设置
let lastConsultationSettings = {
    reportMode: null,
    selectedReports: [],
    medicationMode: null,
    selectedMedications: [],
    conversationMode: null
};

// 获取CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 处理报告模式切换
function handleReportModeChange() {
    const noReportsMode = document.getElementById('noReportsMode');
    const selectReportsMode = document.getElementById('selectReportsMode');
    const reportListContainer = document.getElementById('reportListContainer');

    if (noReportsMode && noReportsMode.checked) {
        // 选择"不使用任何报告"时，隐藏报告列表
        if (reportListContainer) {
            reportListContainer.style.display = 'none';
        }
        // 清空所有报告选择
        const checkboxes = document.querySelectorAll('input[name="selected_reports"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        updateSelectedCount();
    } else {
        // 选择"选择特定报告"时，显示报告列表
        if (reportListContainer) {
            reportListContainer.style.display = 'block';
        }
    }
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('input[name="selected_reports"]:checked');
    const count = checkboxes.length;
    const selectedInfo = document.getElementById('selectedReportsInfo');
    const countSpan = document.getElementById('selectedCount');

    if (count > 0) {
        selectedInfo.style.display = 'block';
        countSpan.textContent = count;
    } else {
        selectedInfo.style.display = 'none';
    }
}

function selectAllReports() {
    const checkboxes = document.querySelectorAll('input[name="selected_reports"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateSelectedCount();
}

function selectRecentReports() {
    const checkboxes = document.querySelectorAll('input[name="selected_reports"]');

    // 先清空所有选择
    checkboxes.forEach(checkbox => checkbox.checked = false);

    // 选择前2个（最近的2份报告）
    for (let i = 0; i < Math.min(2, checkboxes.length); i++) {
        checkboxes[i].checked = true;
    }
    updateSelectedCount();
}

function selectAbnormalReports() {
    const checkboxes = document.querySelectorAll('input[name="selected_reports"]');

    // 先清空所有选择
    checkboxes.forEach(checkbox => checkbox.checked = false);

    // 选择有异常或需要注意的报告
    checkboxes.forEach(checkbox => {
        const reportDiv = checkbox.closest('.form-check');
        if (reportDiv.querySelector('.badge')) {
            checkbox.checked = true;
        }
    });
    updateSelectedCount();
}

// 处理药单模式切换
function handleMedicationModeChange() {
    const noMedicationsMode = document.getElementById('noMedicationsMode');
    const selectMedicationsMode = document.getElementById('selectMedicationsMode');
    const medicationListContainer = document.getElementById('medicationListContainer');

    if (noMedicationsMode && noMedicationsMode.checked) {
        // 选择"不使用药单"时，隐藏药单列表
        if (medicationListContainer) {
            medicationListContainer.style.display = 'none';
        }
        // 清空所有药单选择
        const checkboxes = document.querySelectorAll('input[name="selected_medications"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        updateSelectedMedicationsCount();
    } else {
        // 选择"选择药单"时，显示药单列表
        if (medicationListContainer) {
            medicationListContainer.style.display = 'block';
        }
    }
}

function updateSelectedMedicationsCount() {
    const checkboxes = document.querySelectorAll('input[name="selected_medications"]:checked');
    const count = checkboxes.length;
    const selectedInfo = document.getElementById('selectedMedicationsInfo');
    const countSpan = document.getElementById('selectedMedicationsCount');

    if (count > 0) {
        selectedInfo.style.display = 'block';
        countSpan.textContent = count;
    } else {
        selectedInfo.style.display = 'none';
    }
}

function selectAllMedications() {
    const checkboxes = document.querySelectorAll('input[name="selected_medications"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateSelectedMedicationsCount();
}

function clearMedications() {
    const checkboxes = document.querySelectorAll('input[name="selected_medications"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateSelectedMedicationsCount();
}

// 处理对话模式切换
function handleConversationModeChange() {
    const newConversationMode = document.getElementById('newConversationMode');
    const continueConversationMode = document.getElementById('continueConversationMode');
    const conversationListContainer = document.getElementById('conversationListContainer');

    if (continueConversationMode && continueConversationMode.checked) {
        // 选择"继续对话"时，显示对话列表
        if (conversationListContainer) {
            conversationListContainer.style.display = 'block';
            // 加载对话列表
            loadConversationList();
        }
    } else {
        // 选择"新对话"时，隐藏对话列表
        if (conversationListContainer) {
            conversationListContainer.style.display = 'none';
        }
    }
}

// 加载对话列表
async function loadConversationList() {
    const conversationList = document.getElementById('conversationList');

    // 如果页面已经加载了对话数据，就不需要重新加载
    if (conversationList.children.length > 0 &&
        !conversationList.querySelector('.bi-arrow-repeat')) {
        return;
    }

    try {
        const response = await fetch('{% url "medical_records:api_conversations" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayConversationList(result.conversations);
            } else {
                conversationList.innerHTML = '<div class="text-center text-muted">加载对话列表失败</div>';
            }
        } else {
            conversationList.innerHTML = '<div class="text-center text-muted">网络错误</div>';
        }
    } catch (error) {
        console.error('加载对话列表失败:', error);
        conversationList.innerHTML = '<div class="text-center text-muted">网络错误</div>';
    }
}

// 显示对话列表
function displayConversationList(conversations) {
    const conversationList = document.getElementById('conversationList');

    if (conversations.length === 0) {
        conversationList.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                <p class="mt-2">暂无对话记录</p>
                <small class="text-muted">开始一个新对话</small>
            </div>
        `;
        return;
    }

    let html = '';
    conversations.forEach((conversation, index) => {
        const latestMessage = conversation.latest_message;
        const messageCount = conversation.message_count;
        const isSelected = index === 0; // 默认选中第一个

        html += `
            <div class="conversation-item p-3 border rounded mb-2 ${isSelected ? 'border-primary bg-light' : 'border-secondary'}"
                 data-conversation-id="${conversation.id}"
                 style="cursor: pointer; transition: all 0.2s ease;"
                 onclick="selectConversation(${conversation.id}, '${conversation.title.replace(/'/g, "\\'")}', ${messageCount})">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${conversation.title}</div>
                        <div class="small text-muted mt-1">
                            ${messageCount} 条对话
                        </div>
                        ${latestMessage ? `
                            <div class="small text-truncate mt-1" style="max-width: 200px;">
                                最新: ${latestMessage.question.substring(0, 50)}${latestMessage.question.length > 50 ? '...' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="text-end">
                        <div class="small text-muted">${conversation.updated_at}</div>
                        ${isSelected ? '<span class="badge bg-primary">选中</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    });

    conversationList.innerHTML = html;
}

// 选择对话
function selectConversation(conversationId, title, messageCount) {
    // 移除所有选中状态
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('border-primary', 'bg-light');
        item.classList.add('border-secondary');

        // 移除选中徽章
        const badge = item.querySelector('.badge');
        if (badge) badge.remove();
    });

    // 添加选中状态
    const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    selectedItem.classList.remove('border-secondary');
    selectedItem.classList.add('border-primary', 'bg-light');

    // 添加选中徽章
    const textEnd = selectedItem.querySelector('.text-end');
    const existingBadge = textEnd.querySelector('.badge');
    if (!existingBadge) {
        textEnd.innerHTML += ' <span class="badge bg-primary">选中</span>';
    }

    // 隐藏当前对话历史显示
    document.getElementById('conversationHistory').style.display = 'none';

    // 可以在页面顶部显示选中的对话信息
    showSelectedConversationInfo(title, messageCount);
}

// 显示选中的对话信息
function showSelectedConversationInfo(title, messageCount) {
    // 可以在问题输入框上方显示选中的对话信息
    const textarea = document.querySelector('textarea[name="question"]');
    const container = textarea.parentElement;

    // 移除之前的信息（如果存在）
    const existingInfo = document.getElementById('selectedConversationInfo');
    if (existingInfo) {
        existingInfo.remove();
    }

    // 添加选中对话信息
    const infoDiv = document.createElement('div');
    infoDiv.id = 'selectedConversationInfo';
    infoDiv.className = 'alert alert-info py-2 mb-2';
    infoDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">当前对话：</small>
                <strong>${title}</strong>
                <small class="text-muted ms-2">(${messageCount} 条消息)</small>
            </div>
            <button type="button" class="btn-close btn-sm" onclick="clearSelectedConversation()"></button>
        </div>
    `;

    container.insertBefore(infoDiv, textarea);
}

// 清除选中的对话
function clearSelectedConversation() {
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('border-primary', 'bg-light');
        item.classList.add('border-secondary');

        const badge = item.querySelector('.badge');
        if (badge) badge.remove();
    });

    const infoDiv = document.getElementById('selectedConversationInfo');
    if (infoDiv) {
        infoDiv.remove();
    }
}

// 显示对话消息
function showConversationMessages(conversationId) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (!conversationItem) return;

    const originalContent = conversationItem.innerHTML;
    conversationItem.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="min-height: 100px;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <span class="ms-2">加载消息...</span>
        </div>
    `;

    fetch(`{% url 'medical_records:api_conversation_messages' 0 %}`.replace('0', conversationId), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessagesInModal(data.messages);
        } else {
            conversationItem.innerHTML = originalContent;
            alert('加载对话消息失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('加载对话消息失败:', error);
        conversationItem.innerHTML = originalContent;
        alert('加载对话消息失败：网络错误');
    });
}

// 在模态框中显示消息
function displayMessagesInModal(messages) {
    const modal = new bootstrap.Modal(document.getElementById('adviceModal'));
    const modalContent = document.getElementById('modalContent');

    let messagesHtml = '';
    messages.forEach((msg) => {
        // 每条消息包含一次完整的对话（用户问题和AI回答）
        // 使用 marked.parse() 解析Markdown，并添加 CSS 类来应用样式
        messagesHtml += `
            <div class="mb-3 p-3 rounded bg-light border">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="bi bi-person"></i> 您的问题</strong>
                    <span class="small text-muted">${msg.created_at}</span>
                </div>
                <div class="user-question">${msg.question}</div>
            </div>
            <hr class="my-2">
            <div class="mb-3 p-3 rounded bg-info bg-opacity-10 border border-info">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="bi bi-robot"></i> AI医生建议</strong>
                    <span class="small text-muted">${msg.created_at}</span>
                </div>
                <div class="ai-content-modal">${marked.parse(msg.answer)}</div>
            </div>
        `;
    });

    // 检查是否有任何消息包含prompt_sent
    const hasAnyPrompt = messages.some(msg => msg.prompt_sent && msg.prompt_sent.trim() !== '');

    let promptButtonHtml = '';
    if (hasAnyPrompt) {
        promptButtonHtml = `
            <button class="btn btn-outline-info btn-sm mb-3" onclick="toggleAllPrompts()">
                <i class="bi bi-code"></i> 查看发送给AI的内容
            </button>
            <div id="allPromptsSection" style="display: none;">
                ${messages.map((msg, index) => `
                    <div class="mb-3">
                        <strong><i class="bi bi-chat-dots"></i> 第 ${index + 1} 条消息发送给AI的内容：</strong>
                        <pre class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 200px; overflow-y: auto;">${msg.prompt_sent || '无'}</pre>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // 获取当前对话ID（从消息中获取）
    const conversationId = messages.length > 0 && messages[0].conversation_id ? messages[0].conversation_id : null;

    // 导出按钮HTML
    let exportButtonsHtml = '';
    if (conversationId) {
        exportButtonsHtml = `
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <a href="/health/conversations/${conversationId}/export/pdf/"
                       class="btn btn-outline-danger">
                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                    </a>
                    <a href="/health/conversations/${conversationId}/export/word/"
                       class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-word"></i> 导出Word
                    </a>
                </div>
            </div>
        `;
    }

    modalContent.innerHTML = `
        <div class="mb-3">
            <h5><i class="bi bi-chat-dots"></i> 对话历史</h5>
            <small class="text-muted">共 ${messages.length} 条消息</small>
        </div>
        ${exportButtonsHtml}
        ${promptButtonHtml}
        <div class="mb-3">
            ${messagesHtml}
        </div>
    `;

    modal.show();
}

// 切换显示所有Prompt
function toggleAllPrompts() {
    const promptSection = document.getElementById('allPromptsSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 删除对话
function deleteConversation(conversationId) {
    fetch(`{% url 'medical_records:api_delete_conversation' 0 %}`.replace('0', conversationId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除对话失败:', error);
        alert('删除失败：网络错误');
    });
}

// 刷新对话列表
function refreshConversations() {
    const conversationList = document.getElementById('conversationList');
    conversationList.innerHTML = `
        <div class="text-center text-muted">
            <i class="bi bi-arrow-repeat spin"></i> 刷新中...
        </div>
    `;
    loadConversationList();
}

// 监听报告选择变化和历史列表按钮事件
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_reports"]');

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // 初始化报告模式
    handleReportModeChange();

    // 初始化对话模式
    handleConversationModeChange();

    // 初始化时更新选择计数
    updateSelectedCount();

    // 事件委托：处理历史列表中的动态按钮点击
    document.addEventListener('click', function(e) {
        // 处理查看对话按钮
        const convBtn = e.target.closest('[data-show-conversation]');
        if (convBtn) {
            e.preventDefault();
            const conversationId = parseInt(convBtn.dataset.showConversation);
            showConversationMessages(conversationId);
            return;
        }

        // 处理查看完整回答按钮
        const adviceBtn = e.target.closest('[data-show-advice]');
        if (adviceBtn) {
            e.preventDefault();
            const adviceId = parseInt(adviceBtn.dataset.showAdvice);
            showFullAdvice(adviceId);
            return;
        }
    });
});

// 切换Prompt显示
function togglePrompt() {
    const promptSection = document.getElementById('promptSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 显示完整建议（历史记录）
function showFullAdvice(adviceId) {
    fetch(`{% url 'medical_records:api_advice_detail' 0 %}`.replace('0', adviceId), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = new bootstrap.Modal(document.getElementById('adviceModal'));
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <div class="mb-3">
                    <strong><i class="bi bi-question-circle"></i> 问题：</strong>
                    <p class="mt-2">${data.question}</p>
                </div>
                <div class="mb-3">
                    <strong><i class="bi bi-chat-dots"></i> AI医生建议：</strong>
                    <div class="mt-2 p-3 bg-light rounded ai-content-modal">${marked.parse(data.answer)}</div>
                </div>
                ${data.prompt ? `
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm" onclick="toggleModalPrompt()">
                        <i class="bi bi-code"></i> 查看发送给AI的内容
                    </button>
                    <div id="modalPromptSection" style="display: none;">
                        <strong><i class="bi bi-terminal"></i> 发送给AI医生的完整内容：</strong>
                        <pre class="mt-2 p-3 bg-dark text-light rounded" style="font-size: 0.9em; max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
                    </div>
                </div>
                ` : ''}
                <div class="text-muted small">
                    <i class="bi bi-clock"></i> 咨询时间：${data.created_at}
                </div>
            `;

            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('获取建议详情失败');
    });
}

// 切换模态框中的Prompt显示
function toggleModalPrompt() {
    const promptSection = document.getElementById('modalPromptSection');
    const button = event.target;

    if (promptSection.style.display === 'none') {
        promptSection.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> 隐藏发送给AI的内容';
    } else {
        promptSection.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> 查看发送给AI的内容';
    }
}

// 删除咨询记录
function deleteAdvice(adviceId) {
    fetch(`/health/api/advice/${adviceId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除失败:', error);
        alert('删除失败：网络错误');
    });
}

// 保存当前咨询设置
function saveConsultationSettings() {
    const reportMode = document.querySelector('input[name="report_mode"]:checked');
    const conversationMode = document.querySelector('input[name="conversation_mode"]:checked');
    const selectedReports = [];
    const selectedMedications = [];

    // 保存报告选择
    document.querySelectorAll('input[name="selected_reports"]:checked').forEach(checkbox => {
        selectedReports.push(checkbox.value);
    });

    // 保存药单选择
    document.querySelectorAll('input[name="selected_medications"]:checked').forEach(checkbox => {
        selectedMedications.push(checkbox.value);
    });

    const medicationMode = document.querySelector('input[name="medication_mode"]:checked');

    lastConsultationSettings = {
        reportMode: reportMode ? reportMode.value : 'select_reports',
        selectedReports: selectedReports,
        medicationMode: medicationMode ? medicationMode.value : 'no_medications',
        selectedMedications: selectedMedications,
        conversationMode: conversationMode ? conversationMode.value : 'new_conversation'
    };

    console.log('保存咨询设置:', lastConsultationSettings);
}

// 继续咨询
function continueConsultation() {
    console.log('继续咨询，恢复设置:', lastConsultationSettings);

    // 隐藏结果卡片
    document.getElementById('resultCard').style.display = 'none';

    // 滚动到页面顶部
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // 恢复报告模式
    if (lastConsultationSettings.reportMode === 'no_reports') {
        document.getElementById('noReportsMode').checked = true;
    } else {
        document.getElementById('selectReportsMode').checked = true;
    }

    // 触发报告模式变化处理
    handleReportModeChange();

    // 恢复报告选择
    if (lastConsultationSettings.reportMode === 'select_reports') {
        // 先清空所有选择
        document.querySelectorAll('input[name="selected_reports"]').forEach(checkbox => {
            checkbox.checked = false;
        });

        // 恢复之前的选择
        lastConsultationSettings.selectedReports.forEach(reportId => {
            const checkbox = document.querySelector(`input[name="selected_reports"][value="${reportId}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });

        // 更新选择计数
        updateSelectedCount();
    }

    // 恢复药单模式
    if (lastConsultationSettings.medicationMode === 'select_medications') {
        document.getElementById('selectMedicationsMode').checked = true;
    } else {
        document.getElementById('noMedicationsMode').checked = true;
    }

    // 触发药单模式变化处理
    handleMedicationModeChange();

    // 恢复药单选择
    if (lastConsultationSettings.medicationMode === 'select_medications') {
        // 先清空所有选择
        document.querySelectorAll('input[name="selected_medications"]').forEach(checkbox => {
            checkbox.checked = false;
        });

        // 恢复之前的选择
        if (lastConsultationSettings.selectedMedications) {
            lastConsultationSettings.selectedMedications.forEach(medicationId => {
                const checkbox = document.querySelector(`input[name="selected_medications"][value="${medicationId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }

        // 更新选择计数
        updateSelectedMedicationsCount();
    }

    // 聚焦到问题输入框
    const textarea = document.querySelector('textarea[name="question"]');
    textarea.focus();
    textarea.style.height = 'auto';
}

// 刷新咨询历史列表
function refreshAdviceHistory() {
    const historyContainer = document.querySelector('.advice-history') || document.querySelector('.card-body');
    if (!historyContainer) {
        return;
    }

    historyContainer.innerHTML = `
        <div class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">刷新中...</span>
            </div>
            <span class="ms-2">刷新中...</span>
        </div>
    `;

    fetch('{% url "medical_records:api_user_advices" %}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            historyContainer.innerHTML = data.html;
        } else {
            historyContainer.innerHTML = '<p class="text-muted text-center">刷新失败，请刷新页面重试</p>';
        }
    })
    .catch(error => {
        console.error('刷新咨询历史失败:', error);
        historyContainer.innerHTML = '<p class="text-muted text-center">网络错误，刷新失败</p>';
    });
}

// 表单提交处理 - 使用流式响应
document.getElementById('adviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const textarea = document.querySelector('textarea[name="question"]');
    const question = textarea.value.trim();

    if (!question) {
        alert('请输入您的健康问题');
        textarea.focus();
        return;
    }

    if (question.length < 5) {
        alert('请详细描述您的问题，至少5个字符');
        textarea.focus();
        return;
    }

    // 显示加载状态
    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>处理中...';

    // 收集表单数据
    const formData = new FormData(this);

    // 保存当前咨询设置
    saveConsultationSettings();

    // 添加对话相关信息
    const conversationMode = document.querySelector('input[name="conversation_mode"]:checked');
    if (conversationMode && conversationMode.value === 'continue_conversation') {
        const selectedConversation = document.querySelector('.conversation-item.border-primary');
        if (selectedConversation) {
            const conversationId = selectedConversation.getAttribute('data-conversation-id');
            formData.append('conversation_id', conversationId);
        } else {
            alert('请选择一个要继续的对话');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-send"></i> 获取建议';
            document.getElementById('loadingCard').style.display = 'none';
            return;
        }
    }

    // 收集选择的报告ID
    const selectedReportIds = [];
    document.querySelectorAll('input[name="selected_reports"]:checked').forEach(checkbox => {
        selectedReportIds.push(checkbox.value);
    });
    if (selectedReportIds.length > 0) {
        formData.append('selected_report_ids', JSON.stringify(selectedReportIds));
    }

    // Wake Lock API - 保持屏幕常亮
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock activated');
            }
        } catch (err) {
            console.log(`Wake Lock error: ${err.name}, ${err.message}`);
        }
    }

    // 请求Wake Lock
    await requestWakeLock();

    // Page Visibility API - 检测页面可见性
    const handleVisibilityChange = () => {
        if (document.hidden) {
            console.log('⚠️ 警告：请保持页面打开，切换后台可能导致AI分析失败');
        } else {
            console.log('✅ 页面已恢复，继续AI分析...');
            // 重新请求Wake Lock（因为切换后台会释放）
            requestWakeLock();
        }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    try {
        // 使用流式API
        const streamUrl = '{% url "medical_records:api_stream_ai_advice" %}';

        // 准备请求数据
        const requestData = {
            question: question,
            conversation_mode: formData.get('conversation_mode'),
            report_mode: formData.get('report_mode'),
            selected_report_ids: selectedReportIds
        };

        const conversationIdInput = formData.get('conversation_id');
        if (conversationIdInput) {
            requestData.conversation_id = conversationIdInput;
        }

        // 使用AbortController进行超时控制（10分钟）
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10分钟超时

        const response = await fetch(streamUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // 切换到流式显示状态
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('userQuestion').textContent = question;
        document.getElementById('aiAnswer').innerHTML = '<div class="text-muted"><i class="bi bi-three-dots"></i> AI医生正在思考...</div>';
        document.getElementById('responseTime').textContent = new Date().toLocaleString();
        document.getElementById('conversationHistory').style.display = 'none';

        // 滚动到结果区域
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });

        // 读取流式响应
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullAnswer = '';
        let isMarkdownMode = true;

        while (true) {
            const { done, value } = await reader.read();

            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.error) {
                            // 显示错误
                            document.getElementById('aiAnswer').innerHTML = `
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> AI医生服务暂时不可用</h5>
                                    <p><strong>错误信息：</strong>${data.error}</p>
                                </div>
                            `;
                            isMarkdownMode = false;
                        } else if (data.content) {
                            // 流式内容
                            fullAnswer += data.content;

                            // 显示累积内容（暂时不解析Markdown以提高性能）
                            document.getElementById('aiAnswer').textContent = fullAnswer;

                            // 自动滚动到底部
                            const aiAnswerDiv = document.getElementById('aiAnswer');
                            aiAnswerDiv.scrollTop = aiAnswerDiv.scrollHeight;
                        } else if (data.done) {
                            // 流式完成，将Markdown转换为HTML
                            const aiAnswerHtml = marked.parse(fullAnswer);
                            document.getElementById('aiAnswer').innerHTML = aiAnswerHtml;
                        } else if (data.saved) {
                            // 保存成功
                            console.log('已保存到数据库，advice_id:', data.advice_id, 'conversation_id:', data.conversation_id);

                            // 显示保存成功提示和刷新按钮
                            const aiAnswerDiv = document.getElementById('aiAnswer');
                            const refreshButton = document.createElement('div');
                            refreshButton.className = 'mt-3 text-center';
                            refreshButton.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> AI建议已保存
                                </div>
                                <button class="btn btn-primary" onclick="window.location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新页面查看历史记录
                                </button>
                            `;
                            aiAnswerDiv.appendChild(refreshButton);
                        } else if (data.save_error) {
                            console.error('保存失败:', data.save_error);
                        }
                    } catch (parseError) {
                        console.error('解析SSE数据失败:', parseError, line);
                    }
                }
            }
        }

        // 清空表单
        textarea.value = '';

    } catch (error) {
        console.error('Error:', error);

        // 显示网络错误
        document.getElementById('userQuestion').textContent = question;

        // 检查是否是超时错误
        if (error.name === 'AbortError') {
            document.getElementById('aiAnswer').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> 请求超时</h5>
                    <p><strong>错误信息：</strong>AI分析超时，请检查网络连接后重试</p>
                </div>
            `;
        } else {
            document.getElementById('aiAnswer').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> 网络或服务器错误</h5>
                    <p><strong>错误信息：</strong>${error.message}</p>
                    <p>请检查网络连接或稍后重试</p>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新页面
                        </button>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="document.getElementById('loadingCard').style.display='none'; document.getElementById('resultCard').style.display='none';">
                            <i class="bi bi-x"></i> 关闭
                        </button>
                    </div>
                </div>
            `;
        }
        document.getElementById('responseTime').textContent = new Date().toLocaleString();
        document.getElementById('conversationHistory').style.display = 'none';

        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultCard').style.display = 'block';
    } finally {
        // 清理资源
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        // 释放Wake Lock
        if (wakeLock !== null) {
            wakeLock.release()
                .then(() => {
                    wakeLock = null;
                    console.log('Wake Lock released');
                })
                .catch((err) => {
                    console.error(`Wake Lock release error: ${err.name}, ${err.message}`);
                });
        }

        // 恢复按钮状态
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-send"></i> 获取建议';
    }
});

// 自动调整文本框高度
const textarea = document.querySelector('textarea[name="question"]');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});
</script>

<style>
.ai-content h1,
.ai-content h2,
.ai-content h3,
.ai-content h4,
.ai-content h5,
.ai-content h6 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.ai-content h1 {
    font-size: 1.75rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
}

.ai-content h2 {
    font-size: 1.5rem;
    color: #34495e;
    border-bottom: 1px solid #bdc3c7;
    padding-bottom: 0.3rem;
}

.ai-content h3 {
    font-size: 1.25rem;
    color: #2c3e50;
}

.ai-content h4 {
    font-size: 1.1rem;
    color: #34495e;
}

.ai-content p {
    margin-bottom: 1rem;
    line-height: 1.6;
}

.ai-content strong {
    color: #e74c3c;
    font-weight: 600;
}

.ai-content em {
    color: #8e44ad;
    font-style: italic;
}

.ai-content ul,
.ai-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.ai-content li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.ai-content blockquote {
    border-left: 4px solid #3498db;
    padding-left: 1rem;
    margin: 1rem 0;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    font-style: italic;
    color: #6c757d;
}

.ai-content code {
    background-color: #f1f2f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #e83e8c;
}

.ai-content pre {
    background-color: #2d3748;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.ai-content pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
}

.ai-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.ai-content th,
.ai-content td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

.ai-content th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.ai-content hr {
    border: 0;
    height: 1px;
    background-color: #dee2e6;
    margin: 2rem 0;
}

/* 模态框中的样式 */
.ai-content-modal h1,
.ai-content-modal h2,
.ai-content-modal h3,
.ai-content-modal h4,
.ai-content-modal h5,
.ai-content-modal h6 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.ai-content-modal h1 {
    font-size: 1.5rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
}

.ai-content-modal h2 {
    font-size: 1.3rem;
    color: #34495e;
    border-bottom: 1px solid #bdc3c7;
    padding-bottom: 0.3rem;
}

.ai-content-modal strong {
    color: #e74c3c;
    font-weight: 600;
}

.ai-content-modal em {
    color: #8e44ad;
    font-style: italic;
}

.ai-content-modal code {
    background-color: #f1f2f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #e83e8c;
}

.ai-content-modal blockquote {
    border-left: 4px solid #3498db;
    padding-left: 1rem;
    margin: 1rem 0;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    font-style: italic;
    color: #6c757d;
}

/* 健康相关的特殊样式 */
.ai-content .health-tip {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin: 1rem 0;
}

.ai-content .health-warning {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin: 1rem 0;
}

.ai-content .health-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin: 1rem 0;
}

/* 报告选择区域样式 */
.report-selection-list .form-check {
    transition: background-color 0.2s ease;
}

.report-selection-list .form-check:hover {
    background-color: #f0f8ff !important;
}

.report-selection-list .form-check-input:checked ~ .form-check-label {
    font-weight: 500;
    color: #0d6efd;
}

.report-selection-list .form-check-input:checked + .form-check-label {
    background-color: #e7f3ff;
    border-radius: 0.25rem;
}

#selectedReportsInfo {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 报告选择区域滚动条样式 */
#reportSelectionArea::-webkit-scrollbar {
    width: 6px;
}

#reportSelectionArea::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#reportSelectionArea::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#reportSelectionArea::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

{% endblock %}