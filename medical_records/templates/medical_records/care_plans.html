{% extends 'base.html' %}

{% block title %}健康计划与目标{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header" style="background: var(--brutal-cyan); border: var(--border-thick); box-shadow: var(--shadow-hard); padding: 2rem; margin-bottom: 2rem;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1 fw-bold" style="font-size: 2.25rem; font-weight: 900; text-transform: uppercase; letter-spacing: -0.03em; margin: 0;">
                    <i class="bi bi-clipboard2-pulse"></i> 健康计划与目标
                </h1>
                <p class="mb-0" style="opacity: 0.9;">设定目标、行动计划，并用AI生成可执行建议</p>
            </div>
        </div>
    </div>

    <div class="card mb-4" style="border: var(--border-thick); box-shadow: var(--shadow-hard);">
        <div class="card-header" style="background: var(--brutal-yellow); border-bottom: var(--border-thick);">
            创建新计划
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_plan">
                <div class="row g-3">
                    <div class="col-md-4">{{ plan_form.title.label_tag }}{{ plan_form.title }}</div>
                    <div class="col-md-6">{{ plan_form.description.label_tag }}{{ plan_form.description }}</div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-check">
                            {{ plan_form.is_active }} {{ plan_form.is_active.label_tag }}
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle"></i> 创建计划
                </button>
            </form>
        </div>
    </div>

    {% if plans %}
        {% for plan in plans %}
            <div class="card mb-4" style="border: var(--border-thick); box-shadow: var(--shadow-hard-sm);">
                <div class="card-header" style="background: #000; color: #fff;">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ plan.title }}</strong>
                        <span class="badge bg-light text-dark">{% if plan.is_active %}进行中{% else %}已停用{% endif %}</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if plan.description %}
                        <p class="text-muted">{{ plan.description }}</p>
                    {% endif %}

                    <div class="mb-3">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create_goal">
                            <input type="hidden" name="plan_id" value="{{ plan.id }}">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <input class="form-control" name="title" placeholder="目标标题">
                                </div>
                                <div class="col-md-2">
                                    <input class="form-control" name="target_value" placeholder="目标值">
                                </div>
                                <div class="col-md-2">
                                    <input class="form-control" name="unit" placeholder="单位">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" name="due_date">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" name="status">
                                        <option value="active">进行中</option>
                                        <option value="paused">已暂停</option>
                                        <option value="completed">已完成</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-outline-dark mt-2">添加目标</button>
                        </form>
                    </div>

                    {% if plan.goals.all %}
                        {% for goal in plan.goals.all %}
                            <div class="border p-3 mb-3" style="border: var(--border-thick);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ goal.title }}</strong>
                                        {% if goal.target_value %}
                                            <span class="text-muted">(目标：{{ goal.target_value }}{{ goal.unit|default:'' }})</span>
                                        {% endif %}
                                        {% if goal.due_date %}
                                            <span class="text-muted">截止：{{ goal.due_date }}</span>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-secondary">{{ goal.get_status_display }}</span>
                                </div>
                                <div class="progress mt-2" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ goal.progress_percent }}%;"></div>
                                </div>
                                <div class="small text-muted mt-1">进度：{{ goal.progress_percent }}%</div>

                                <div class="mt-3">
                                    <form method="post" class="d-flex gap-2 flex-wrap">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="create_action">
                                        <input type="hidden" name="goal_id" value="{{ goal.id }}">
                                        <input class="form-control" name="title" placeholder="行动内容" style="max-width: 240px;">
                                        <input class="form-control" name="frequency" placeholder="频率" style="max-width: 160px;">
                                        <select class="form-control" name="status" style="max-width: 140px;">
                                            <option value="pending">待完成</option>
                                            <option value="done">已完成</option>
                                        </select>
                                        <button type="submit" class="btn btn-outline-primary">添加行动</button>
                                        <button type="button" class="btn btn-outline-dark" onclick="suggestActions({{ goal.id }}, this)">AI建议行动</button>
                                    </form>
                                </div>

                                {% if goal.actions.all %}
                                    <ul class="list-group mt-3">
                                        {% for action in goal.actions.all %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    {% if action.status == 'done' %}
                                                        <s>{{ action.title }}</s>
                                                    {% else %}
                                                        {{ action.title }}
                                                    {% endif %}
                                                    {% if action.frequency %}
                                                        <span class="text-muted">({{ action.frequency }})</span>
                                                    {% endif %}
                                                    {% if action.suggested_by_ai %}
                                                        <span class="badge bg-info text-dark">AI</span>
                                                    {% endif %}
                                                </div>
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="toggle_action">
                                                    <input type="hidden" name="action_id" value="{{ action.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">切换状态</button>
                                                </form>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="text-muted mt-2">暂无行动</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted">暂无目标</div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="text-muted">暂无健康计划</div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

async function suggestActions(goalId, btn) {
    const csrfToken = getCookie('csrftoken');
    btn.disabled = true;
    btn.textContent = '生成中...';

    try {
        const resp = await fetch(`/medical_records/api/care-goals/${goalId}/suggest-actions/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        const data = await resp.json();
        if (!data.success) {
            alert(data.error || '生成失败');
            return;
        }
        if (!data.suggestions || data.suggestions.length === 0) {
            alert('没有生成可用建议');
            return;
        }

        const confirmAdd = confirm(`生成了 ${data.suggestions.length} 条建议，是否全部添加？`);
        if (!confirmAdd) return;

        const addResp = await fetch(`/medical_records/api/care-goals/${goalId}/actions/bulk/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ actions: data.suggestions })
        });
        const addData = await addResp.json();
        if (!addData.success) {
            alert(addData.error || '添加失败');
            return;
        }
        window.location.reload();
    } catch (e) {
        alert('请求失败');
    } finally {
        btn.disabled = false;
        btn.textContent = 'AI建议行动';
    }
}
</script>
{% endblock %}
