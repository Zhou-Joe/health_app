{% extends 'base.html' %}

{% block title %}健康管理{% endblock %}

{% block extra_css %}
<style>
/* 健康管理页面样式 - 专业医疗+有机自然风格 */

.management-header {
    background: linear-gradient(135deg, var(--primary-soft) 0%, #e0f2fe 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.management-tabs {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
}

.management-tab {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    font-weight: 500;
    transition: var(--transition);
    padding: 0.625rem 1rem;
}

.management-tab:hover {
    background: var(--bg-soft);
    border-color: var(--primary-light);
    color: var(--primary);
}

.management-tab.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
}

.section-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

.section-card:hover {
    box-shadow: var(--shadow-md);
}

.section-card .card-header {
    background: var(--bg-soft);
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    padding: 1rem 1.25rem;
}

.medication-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: 1rem;
    transition: var(--transition);
}

.medication-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.medication-card .card-header {
    background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
    color: #be185d;
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    padding: 1rem 1.25rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.btn-neo {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    font-weight: 500;
    transition: var(--transition);
}

.btn-neo:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.modal-content {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
}

.modal-header {
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-soft);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.progress {
    background-color: var(--bg-muted);
    border-radius: var(--radius-full);
    height: 8px;
}

.progress-bar {
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
    border-radius: var(--radius-full);
}

.list-group-item {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
    background: var(--bg-card);
    transition: var(--transition);
}

.list-group-item:hover {
    background: var(--bg-soft);
}

.form-control, .form-select {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

@media (max-width: 768px) {
    .management-header {
        padding: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="management-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="mb-1 fw-bold" style="font-size: 1.75rem; color: var(--text-primary); margin: 0;">
                    <i class="bi bi-grid-1x2-fill" style="color: var(--primary);"></i> 健康管理
                </h1>
                <p class="mb-0" style="color: var(--text-secondary);">将日志、计划、药单统一在一个页面管理</p>
            </div>
            <a class="btn btn-primary" href="{% url 'medical_records:dashboard' %}">
                <i class="bi bi-house-door me-1"></i> 返回首页
            </a>
        </div>
    </div>

    <div class="management-tabs">
        <a class="btn management-tab {% if active_tab == 'medications' %}active{% else %}btn-light{% endif %}" href="{% url 'medical_records:health_management' %}?tab=medications">
            <i class="bi bi-capsule me-1"></i> 药单
        </a>
        <a class="btn management-tab {% if active_tab == 'health_log' %}active{% else %}btn-light{% endif %}" href="{% url 'medical_records:health_management' %}?tab=health_log">
            <i class="bi bi-activity me-1"></i> 日志
        </a>
    </div>


    {% if active_tab == 'health_log' %}
    <div class="row g-4">
        <!-- 左侧：日志 -->
        <div class="col-lg-6">
            <div class="card section-card mb-3">
                <div class="card-header" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                    <i class="bi bi-activity me-2"></i>添加症状
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="module" value="diary">
                        <input type="hidden" name="form_type" value="symptom">
                        <div class="row g-3">
                            <div class="col-md-4">{{ symptom_form.entry_date.label_tag }}{{ symptom_form.entry_date }}</div>
                            <div class="col-md-8">{{ symptom_form.symptom.label_tag }}{{ symptom_form.symptom }}</div>
                            <div class="col-md-4">{{ symptom_form.severity.label_tag }}{{ symptom_form.severity }}</div>
                            <div class="col-md-8">{{ symptom_form.notes.label_tag }}{{ symptom_form.notes }}</div>
                            <div class="col-md-6">{{ symptom_form.related_checkup.label_tag }}{{ symptom_form.related_checkup }}</div>
                            <div class="col-md-6">{{ symptom_form.related_medication.label_tag }}{{ symptom_form.related_medication }}</div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-plus-circle"></i> 保存症状
                        </button>
                    </form>
                </div>
            </div>

            <div class="card section-card">
                <div class="card-header" style="background: var(--bg-soft);">
                    <i class="bi bi-clock-history me-2"></i>最近症状
                </div>
                <div class="card-body">
                    {% if symptoms %}
                        <ul class="list-group">
                            {% for item in symptoms %}
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ item.entry_date }}</strong> - {{ item.symptom }}
                                    <div class="text-muted" style="font-size: 0.85rem;">严重程度：{{ item.get_severity_display }}</div>
                                    {% if item.notes %}
                                    <div class="text-muted" style="font-size: 0.85rem;">{{ item.notes }}</div>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-muted">暂无症状记录</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 右侧：计划 -->
        <div class="col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold">健康计划</h6>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createPlanModal">
                    <i class="bi bi-plus-circle me-1"></i> 创建计划
                </button>
            </div>

            {% if plans %}
                {% for plan in plans %}
                <div class="card section-card mb-3">
                    <div class="card-header" style="background: var(--bg-soft); cursor: pointer; padding: 0.75rem 1rem;" data-bs-toggle="collapse" data-bs-target="#planCollapse{{ plan.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="font-size: 0.95rem;">{{ plan.title }}</strong>
                                {% if plan.description %}
                                <small class="text-muted ms-2">{{ plan.description|truncatewords:5 }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <span class="badge me-2" style="background: {% if plan.is_active %}var(--success){% else %}var(--secondary){% endif %}; font-size: 0.75rem;">{% if plan.is_active %}进行中{% else %}已停用{% endif %}</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="planCollapse{{ plan.id }}">
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createGoalModal" onclick="setPlanId({{ plan.id }})">
                                    <i class="bi bi-plus-circle me-1"></i> 添加目标
                                </button>
                            </div>

                            {% if plan.goals.all %}
                                {% for goal in plan.goals.all %}
                                <div class="border p-2 mb-2" style="border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-soft);">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong style="font-size: 0.9rem;">{{ goal.title }}</strong>
                                                <span class="badge" style="background: var(--secondary); font-size: 0.75rem;">{{ goal.get_status_display }}</span>
                                            </div>
                                            {% if goal.target_value or goal.due_date %}
                                            <small class="text-muted">
                                                {% if goal.target_value %}目标：{{ goal.target_value }}{{ goal.unit|default:'' }}{% endif %}
                                                {% if goal.target_value and goal.due_date %} | {% endif %}
                                                {% if goal.due_date %}截止：{{ goal.due_date }}{% endif %}
                                            </small>
                                            {% endif %}
                                            <div class="progress mt-2" style="height: 5px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ goal.progress_percent }}%;"></div>
                                            </div>
                                            <small class="text-muted">进度：{{ goal.progress_percent }}%</small>
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#goalActions{{ goal.id }}">
                                            <i class="bi bi-list-ul me-1"></i> 行动 ({{ goal.actions.count }})
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm ms-1" data-bs-toggle="modal" data-bs-target="#createActionModal" onclick="setGoalId({{ goal.id }})">
                                            <i class="bi bi-plus-circle me-1"></i> 添加
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm ms-1" onclick="suggestActions({{ goal.id }}, this)">
                                            <i class="bi bi-magic me-1"></i> AI
                                        </button>
                                    </div>

                                    <div class="collapse mt-2" id="goalActions{{ goal.id }}">
                                        {% if goal.actions.all %}
                                        <ul class="list-group mb-0">
                                            {% for action_item in goal.actions.all %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                                <div class="flex-grow-1">
                                                    {% if action_item.status == 'done' %}
                                                        <span class="text-muted text-decoration-line-through">{{ action_item.title }}</span>
                                                    {% else %}
                                                        {{ action_item.title }}
                                                    {% endif %}
                                                    {% if action_item.frequency %}
                                                        <small class="text-muted">({{ action_item.frequency }})</small>
                                                    {% endif %}
                                                    {% if action_item.suggested_by_ai %}
                                                        <span class="badge bg-info" style="font-size: 0.7rem;">AI</span>
                                                    {% endif %}
                                                </div>
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="module" value="plans">
                                                    <input type="hidden" name="action" value="toggle_action">
                                                    <input type="hidden" name="action_id" value="{{ action_item.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-arrow-repeat"></i>
                                                    </button>
                                                </form>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        <div class="text-muted small">暂无行动</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-muted small">暂无目标</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-clipboard2-pulse" style="font-size: 2.5rem;"></i>
                <p class="mt-2 mb-0 small">暂无健康计划</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- health_log 标签页的模态框 -->
    <div class="modal fade" id="createPlanModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clipboard2-pulse me-2"></i>创建健康计划</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="module" value="plans">
                        <input type="hidden" name="action" value="create_plan">
                        <div class="mb-3">
                            <label for="planTitle" class="form-label">计划标题 *</label>
                            <input type="text" class="form-control" name="title" id="planTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="planDescription" class="form-label">计划描述</label>
                            <textarea class="form-control" name="description" id="planDescription" rows="3"></textarea>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="is_active" id="planIsActive" checked>
                            <label class="form-check-label" for="planIsActive">启用计划</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">创建计划</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createGoalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-bullseye me-2"></i>添加目标</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="module" value="plans">
                        <input type="hidden" name="action" value="create_goal">
                        <input type="hidden" name="plan_id" id="goalPlanId">
                        <div class="mb-3">
                            <label for="goalTitle" class="form-label">目标标题 *</label>
                            <input type="text" class="form-control" name="title" id="goalTitle" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="goalTargetValue" class="form-label">目标值</label>
                                <input type="text" class="form-control" name="target_value" id="goalTargetValue">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalUnit" class="form-label">单位</label>
                                <input type="text" class="form-control" name="unit" id="goalUnit">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="goalDueDate" class="form-label">截止日期</label>
                            <input type="date" class="form-control" name="due_date" id="goalDueDate">
                        </div>
                        <div class="mb-3">
                            <label for="goalStatus" class="form-label">状态</label>
                            <select class="form-control" name="status" id="goalStatus">
                                <option value="active">进行中</option>
                                <option value="paused">已暂停</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">添加目标</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-check2-circle me-2"></i>添加行动</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="module" value="plans">
                        <input type="hidden" name="action" value="create_action">
                        <input type="hidden" name="goal_id" id="actionGoalId">
                        <div class="mb-3">
                            <label for="actionTitle" class="form-label">行动内容 *</label>
                            <input type="text" class="form-control" name="title" id="actionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="actionFrequency" class="form-label">频率</label>
                            <input type="text" class="form-control" name="frequency" id="actionFrequency" placeholder="例如：每天、每周3次">
                        </div>
                        <div class="mb-3">
                            <label for="actionStatus" class="form-label">状态</label>
                            <select class="form-control" name="status" id="actionStatus">
                                <option value="pending">待完成</option>
                                <option value="done">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">添加行动</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% elif active_tab == 'medications' %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold" style="color: var(--text-primary);">我的药单</h5>
        <button class="btn btn-primary" onclick="showAddMedicationModal()">
            <i class="bi bi-plus-circle me-1"></i> 添加药单
        </button>
    </div>

    <div class="row">
        {% if medications %}
            {% for medication in medications %}
            <div class="col-lg-6 col-xl-4">
                <div class="card medication-card">
                    <div class="card-header">
                        <i class="bi bi-capsule me-2"></i>{{ medication.medicine_name }}
                    </div>
                    <div class="card-body">
                        <div class="mb-2"><strong>服药方式：</strong>{{ medication.dosage }}</div>
                        <div class="mb-2"><strong>周期：</strong>{{ medication.start_date|date:"Y-m-d" }} 至 {{ medication.end_date|date:"Y-m-d" }}</div>
                        <div class="mb-2"><strong>进度：</strong>{{ medication.days_taken }}/{{ medication.total_days }}（{{ medication.progress_percentage }}%）</div>
                        {% if medication.notes %}
                        <div class="mb-2 text-muted">备注：{{ medication.notes }}</div>
                        {% endif %}
                        <div class="d-flex gap-2 flex-wrap mt-3">
                            <button class="btn btn-success btn-sm" onclick="checkin({{ medication.id }})"><i class="bi bi-check2-circle"></i> 今日签到</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showBackdateModal({{ medication.id }}, '{{ medication.medicine_name|escapejs }}')"><i class="bi bi-calendar-plus"></i></button>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewRecords({{ medication.id }})"><i class="bi bi-list-ul"></i></button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteMedication({{ medication.id }})"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12"><div class="text-muted">暂无药单</div></div>
        {% endif %}
    </div>

    <div class="modal fade" id="addMedicationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>添加药单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMedicationForm">
                        <div class="mb-3"><label for="medicineName" class="form-label">药名 *</label><input type="text" class="form-control" id="medicineName" required></div>
                        <div class="mb-3"><label for="dosage" class="form-label">服药方式 *</label><input type="text" class="form-control" id="dosage" required></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="startDate" class="form-label">开始日期 *</label><input type="date" class="form-control" id="startDate" required></div>
                            <div class="col-md-6 mb-3"><label for="endDate" class="form-label">结束日期 *</label><input type="date" class="form-control" id="endDate" required></div>
                        </div>
                        <div class="mb-3"><label for="notes" class="form-label">备注</label><textarea class="form-control" id="notes" rows="3"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveMedication()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recordsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-list-ul me-2"></i>服药记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><div id="recordsList"></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="backdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-calendar-plus me-2"></i>补签服药</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">药物名称</label><input type="text" class="form-control" id="backdateMedicineName" readonly></div>
                    <div class="mb-3"><label for="backdateDate" class="form-label">补签日期 *</label><input type="date" class="form-control" id="backdateDate" required></div>
                    <div class="mb-3"><label for="backdateNotes" class="form-label">备注（可选）</label><textarea class="form-control" id="backdateNotes" rows="2"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitBackdate()">确认补签</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

{% if active_tab == 'health_log' %}
async function suggestActions(goalId, btn) {
    const csrfToken = getCookie('csrftoken');
    btn.disabled = true;
    btn.textContent = '生成中...';

    try {
        const suggestUrl = `{% url 'medical_records:api_care_goal_suggest_actions' 0 %}`.replace('0', goalId);
        const resp = await fetch(suggestUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await resp.json();
        if (!data.success) {
            alert(data.error || '生成失败');
            return;
        }
        if (!data.suggestions || data.suggestions.length === 0) {
            alert('没有生成可用建议');
            return;
        }

        const confirmAdd = confirm(`生成了 ${data.suggestions.length} 条建议，是否全部添加？`);
        if (!confirmAdd) return;

        const bulkUrl = `{% url 'medical_records:api_care_goal_add_actions' 0 %}`.replace('0', goalId);
        const addResp = await fetch(bulkUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ actions: data.suggestions })
        });

        const addData = await addResp.json();
        if (!addData.success) {
            alert(addData.error || '添加失败');
            return;
        }

        window.location.reload();
    } catch (e) {
        alert('请求失败');
    } finally {
        btn.disabled = false;
        btn.textContent = 'AI建议';
    }
}

function setPlanId(planId) {
    document.getElementById('goalPlanId').value = planId;
}

function setGoalId(goalId) {
    document.getElementById('actionGoalId').value = goalId;
}
{% endif %}

{% if active_tab == 'medications' %}
let addMedicationModal;
let recordsModal;
let backdateModal;
let currentBackdateMedicationId = null;

window.addEventListener('DOMContentLoaded', function() {
    addMedicationModal = new bootstrap.Modal(document.getElementById('addMedicationModal'));
    recordsModal = new bootstrap.Modal(document.getElementById('recordsModal'));
    backdateModal = new bootstrap.Modal(document.getElementById('backdateModal'));
});

function showAddMedicationModal() {
    addMedicationModal.show();
}

async function saveMedication() {
    const medicineName = document.getElementById('medicineName').value;
    const dosage = document.getElementById('dosage').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const notes = document.getElementById('notes').value;

    if (!medicineName || !dosage || !startDate || !endDate) {
        alert('请填写所有必填项');
        return;
    }

    try {
        const response = await fetch('{% url "medical_records:api_medications" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                medicine_name: medicineName,
                dosage: dosage,
                start_date: startDate,
                end_date: endDate,
                notes: notes
            })
        });

        const data = await response.json();
        if (data.success) {
            alert('药单添加成功');
            window.location.reload();
        } else {
            alert('添加失败：' + (data.error || '未知错误'));
        }
    } catch (error) {
        alert('添加失败：' + error);
    }
}

async function checkin(medicationId) {
    const today = new Date().toISOString().split('T')[0];

    try {
        const response = await fetch('{% url "medical_records:api_medication_checkin" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                medication_id: medicationId,
                record_date: today,
                frequency: 'daily'
            })
        });

        const data = await response.json();
        if (data.success) {
            alert('签到成功');
            window.location.reload();
        } else {
            alert('签到失败：' + (data.error || '未知错误'));
        }
    } catch (error) {
        alert('签到失败：' + error);
    }
}

async function viewRecords(medicationId) {
    try {
        const response = await fetch(`{% url "medical_records:api_medication_records" 0 %}`.replace('0', medicationId));
        const data = await response.json();

        if (data.success) {
            const recordsList = document.getElementById('recordsList');
            if (data.records.length > 0) {
                recordsList.innerHTML = data.records.map(record => `
                    <div style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${record.record_date}</strong>
                                <span class="badge ms-2" style="background: var(--info);">${record.frequency_display}</span>
                            </div>
                            <small class="text-muted">${record.taken_at}</small>
                        </div>
                        ${record.notes ? `<small class="text-muted mt-1 d-block">${record.notes}</small>` : ''}
                    </div>
                `).join('');
            } else {
                recordsList.innerHTML = '<p class="text-center text-muted">暂无服药记录</p>';
            }
            recordsModal.show();
        } else {
            alert('获取记录失败');
        }
    } catch (error) {
        alert('获取记录失败：' + error);
    }
}

function showBackdateModal(medicationId, medicineName) {
    currentBackdateMedicationId = medicationId;
    document.getElementById('backdateMedicineName').value = medicineName;
    backdateModal.show();
}

async function submitBackdate() {
    const date = document.getElementById('backdateDate').value;
    const notes = document.getElementById('backdateNotes').value;

    if (!date) {
        alert('请选择补签日期');
        return;
    }

    try {
        const response = await fetch('{% url "medical_records:api_medication_checkin" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                medication_id: currentBackdateMedicationId,
                record_date: date,
                frequency: 'daily',
                notes: notes
            })
        });

        const data = await response.json();
        if (data.success) {
            alert('补签成功');
            backdateModal.hide();
            window.location.reload();
        } else {
            alert('补签失败：' + (data.error || '未知错误'));
        }
    } catch (error) {
        alert('补签失败：' + error);
    }
}

async function deleteMedication(medicationId) {
    if (!confirm('确定要删除这个药单吗？')) return;

    try {
        const response = await fetch(`{% url "medical_records:api_medications" %}${medicationId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (response.ok) {
            alert('删除成功');
            window.location.reload();
        } else {
            alert('删除失败');
        }
    } catch (error) {
        alert('删除失败：' + error);
    }
}
{% endif %}
</script>
{% endblock %}
