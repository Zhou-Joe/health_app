{% extends 'base.html' %}

{% block title %}æ•°æ®æ•´åˆ - ä¸ªäººå¥åº·ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.checkup-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}
.checkup-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.checkup-card.selected {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}
.checkup-checkbox {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 20px;
    height: 20px;
}
.integration-progress {
    display: none;
}
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
}
.result-card {
    max-height: 400px;
    overflow-y: auto;
}
.indicator-changed {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}
.indicator-unchanged {
    background-color: #f8f9fa;
}
.diff-old {
    text-decoration: line-through;
    color: #dc3545;
}
.diff-new {
    color: #198754;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Adminç”¨æˆ·é€‰æ‹©å™¨ -->
    {% if is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-badge"></i> ç®¡ç†å‘˜æ§åˆ¶å°
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="userSelect" class="form-label fw-bold">é€‰æ‹©ç”¨æˆ·æŸ¥çœ‹æŠ¥å‘Š</label>
                            <select class="form-select" id="userSelect" onchange="changeUser()">
                                <option value="">æ‰€æœ‰ç”¨æˆ·</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>
                                    {{ user.username }}{% if user.first_name %} ({{ user.first_name }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                ä½œä¸ºç®¡ç†å‘˜ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å’Œå¯¼å‡ºæ‰€æœ‰ç”¨æˆ·çš„ä½“æ£€æŠ¥å‘Š
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- é‡è¦æç¤º -->
            <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>é‡è¦æç¤ºï¼š</strong> æ•°æ®æ•´åˆè¿‡ç¨‹ä¸­è¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œä¸è¦åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨æˆ–é”å±ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ•´åˆå¤±è´¥ã€‚
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="mb-0">
                        <i class="bi bi-layers text-primary"></i> æ™ºèƒ½æ•°æ®æ•´åˆ
                    </h1>
                    <p class="text-muted mb-0">é€‰æ‹©å¤šä»½ä½“æ£€æŠ¥å‘Šï¼ŒAIå°†è‡ªåŠ¨ç»Ÿä¸€æŒ‡æ ‡åç§°ã€å•ä½ã€å‚è€ƒèŒƒå›´ç­‰ä¿¡æ¯</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-danger" onclick="exportSelectedCheckupsPdf()">
                        <i class="bi bi-file-earmark-pdf"></i> å¯¼å‡ºé€‰ä¸­æŠ¥å‘Š
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportSelectedCheckupsWord()">
                        <i class="bi bi-file-earmark-word"></i> å¯¼å‡ºé€‰ä¸­æŠ¥å‘Š(Word)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-pills nav-fill">
                <li class="nav-item">
                    <a class="nav-link active" id="step1-tab" href="#">
                        <i class="bi bi-1-circle"></i> é€‰æ‹©æŠ¥å‘Š
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="step2-tab" href="#">
                        <i class="bi bi-2-circle"></i> AIåˆ†æ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="step3-tab" href="#">
                        <i class="bi bi-3-circle"></i> ç¡®è®¤æ›´æ–°
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æŠ¥å‘Š -->
    <div id="step1-content">
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="bi bi-file-earmark-text"></i> é€‰æ‹©è¦æ•´åˆçš„ä½“æ£€æŠ¥å‘Š
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="selectAllCheckups()">
                            <i class="bi bi-check-all"></i> å…¨é€‰
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                            <i class="bi bi-x"></i> æ¸…ç©º
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-2" id="exportButton1" onclick="exportSelectedCheckups()" disabled>
                            <i class="bi bi-download"></i> å¯¼å‡º
                        </button>
                    </div>
                </div>
                <small class="text-muted">å·²é€‰æ‹© <strong id="selectedCount">0</strong> ä»½æŠ¥å‘Š</small>
            </div>
        </div>

        <!-- æŠ¥å‘Šåˆ—è¡¨ -->
        <div class="row" id="checkupsList">
            {% if checkups %}
                {% for checkup in checkups %}
                <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                    <div class="card checkup-card position-relative" data-checkup-id="{{ checkup.id }}">
                        <input type="checkbox" class="form-check-input checkup-checkbox" value="{{ checkup.id }}">
                        <div class="card-body">
                            {% if is_admin %}
                            <p class="card-text small mb-1">
                                <span class="badge bg-secondary">
                                    <i class="bi bi-person"></i> {{ checkup.user.username }}
                                </span>
                            </p>
                            {% endif %}
                            {% if checkup.notes %}
                            <h6 class="card-title mb-1">
                                <i class="bi bi-card-text"></i> {{ checkup.notes|truncatewords:15 }}
                            </h6>
                            {% endif %}
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-calendar3"></i>
                                {{ checkup.checkup_date|date:"Yå¹´mæœˆdæ—¥" }}
                            </p>
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-hospital"></i> {{ checkup.hospital }}
                            </p>
                            <p class="card-text small mb-0">
                                <span class="badge bg-primary">{{ checkup.healthindicator_set.count }} ä¸ªæŒ‡æ ‡</span>
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> æš‚æ— ä½“æ£€æŠ¥å‘Šï¼Œè¯·å…ˆä¸Šä¼ æŠ¥å‘Š
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- ç”¨æˆ·æç¤ºè¯ï¼ˆå¯é€‰ï¼‰ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-chat-left-text"></i> è‡ªå®šä¹‰æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
                        </h6>
                    </div>
                    <div class="card-body">
                        <label for="userPrompt" class="form-label">è¡¥å……è¯´æ˜</label>
                        <textarea class="form-control" id="userPrompt" rows="3"
                                  placeholder="ä¾‹å¦‚ï¼šè¯·ç‰¹åˆ«å…³æ³¨è¡€å‹ã€è¡€ç³–æŒ‡æ ‡çš„å¼‚å¸¸å€¼åˆ¤æ–­ï¼›è¯·ç¡®ä¿æ‰€æœ‰æ—¥æœŸæ ¼å¼ç»Ÿä¸€..."></textarea>
                        <small class="form-text text-muted">
                            <i class="bi bi-info-circle"></i> å¯é€‰ã€‚åœ¨è¿™é‡Œæ·»åŠ æ‚¨å¸Œæœ› AI ç‰¹åˆ«å…³æ³¨çš„æ–¹é¢ï¼Œæˆ–é¢å¤–çš„æ•´åˆè¦æ±‚ã€‚ç•™ç©ºåˆ™ä»…ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„æ•´åˆè§„åˆ™ã€‚
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-primary btn-lg" id="startIntegrationBtn" onclick="startIntegration()" disabled>
                    <i class="bi bi-magic"></i> å¼€å§‹æ™ºèƒ½æ•´åˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šAIåˆ†æä¸­ -->
    <div id="step2-content" class="integration-progress">
        <div class="row">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3 text-white" role="status">
                                <span class="visually-hidden">å¤„ç†ä¸­...</span>
                            </div>
                            <h5 class="mb-0" id="progressTitle">AIæ­£åœ¨åˆ†ææ•°æ®...</h5>
                        </div>
                    </div>
                    <div class="card-body py-4">
                        <!-- è¿›åº¦ç™¾åˆ†æ¯” -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted fw-bold">å¤„ç†è¿›åº¦</small>
                                <small class="text-muted fw-bold" id="progressPercent">0%</small>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                     role="progressbar"
                                     id="progressBar"
                                     style="width: 0%">
                                    <span class="text-white fw-bold" id="progressBarText">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- LLMè¾“å‡ºåŒºåŸŸ -->
                        <div class="card bg-light mb-3" id="llmOutputCard" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-robot text-primary"></i> AIæ€è€ƒè¿‡ç¨‹
                                </h6>
                                <div id="llmOutput"
                                     style="max-height: 200px; overflow-y: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.9em; line-height: 1.6; padding: 15px; background: white; border: 1px solid #dee2e6; border-radius: 5px; color: #333;">
                                </div>
                            </div>
                        </div>

                        <!-- è¿›åº¦æ—¥å¿— -->
                        <div class="card bg-dark text-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title mb-0 small">
                                        <i class="bi bi-terminal-fill text-success"></i> å®æ—¶å¤„ç†æ—¥å¿—
                                    </h6>
                                    <span class="badge bg-success small" id="logStatus">è¿è¡Œä¸­</span>
                                </div>
                                <div id="progressLog"
                                     style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.4; background: #1e1e1e; padding: 10px; border-radius: 4px;">
                                    <div class="text-secondary">ç­‰å¾…å¼€å§‹...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤æ›´æ–° -->
    <div id="step3-content" class="integration-progress">
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>åˆ†æå®Œæˆï¼</strong>
                    AIå…±åˆ†æäº† <strong id="totalIndicators">0</strong> ä¸ªæŒ‡æ ‡ï¼Œ
                    å»ºè®®æ›´æ–° <strong id="changedIndicators">0</strong> ä¸ªï¼Œ
                    æ— å˜åŒ– <strong id="unchangedIndicators">0</strong> ä¸ª
                </div>
            </div>
        </div>

        <!-- å˜æ›´æ‘˜è¦ -->
        <div class="row mb-3">
            <div class="col-12">
                <h5>
                    <i class="bi bi-list-check"></i> å˜æ›´æ‘˜è¦
                </h5>
            </div>
        </div>

        <!-- å˜æ›´è¯¦æƒ… -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card result-card">
                    <div class="card-body">
                        <div id="changesList">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„å˜æ›´åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row">
            <div class="col-12">
                <button class="btn btn-success btn-lg me-2" onclick="applyChanges()">
                    <i class="bi bi-check-circle"></i> åº”ç”¨æ‰€æœ‰æ›´æ–°
                </button>
                <button class="btn btn-outline-danger btn-lg me-2" onclick="exportSelectedCheckups()">
                    <i class="bi bi-download"></i> å¯¼å‡ºæŠ¥å‘Š
                </button>
                <button class="btn btn-outline-secondary btn-lg" onclick="location.reload()">
                    <i class="bi bi-x-circle"></i> å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedCheckups = new Set();
let integrationResult = null;

// åˆ‡æ¢ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
function changeUser() {
    const userSelect = document.getElementById('userSelect');
    const userId = userSelect.value;
    const currentUrl = new URL(window.location.href);

    if (userId) {
        currentUrl.searchParams.set('user_id', userId);
    } else {
        currentUrl.searchParams.delete('user_id');
    }

    window.location.href = currentUrl.toString();
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    initCheckupSelection();
});

// åˆå§‹åŒ–æŠ¥å‘Šé€‰æ‹©åŠŸèƒ½
function initCheckupSelection() {
    const cards = document.querySelectorAll('.checkup-card');
    const checkboxes = document.querySelectorAll('.checkup-checkbox');

    cards.forEach(card => {
        card.addEventListener('click', function(e) {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¤é€‰æ¡†ï¼Œåˆ‡æ¢é€‰ä¸­çŠ¶æ€
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('.checkup-checkbox');
                checkbox.checked = !checkbox.checked;
                toggleCheckupSelection(this);
            }
        });
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleCheckupSelection(this.closest('.checkup-card'));
        });
    });
}

// åˆ‡æ¢æŠ¥å‘Šé€‰ä¸­çŠ¶æ€
function toggleCheckupSelection(card) {
    const checkbox = card.querySelector('.checkup-checkbox');
    const checkupId = checkbox.value;

    if (checkbox.checked) {
        card.classList.add('selected');
        selectedCheckups.add(checkupId);
    } else {
        card.classList.remove('selected');
        selectedCheckups.delete(checkupId);
    }

    updateSelectedCount();
}

// æ›´æ–°é€‰ä¸­è®¡æ•°
function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedCheckups.size;
    document.getElementById('startIntegrationBtn').disabled = selectedCheckups.size === 0;
    document.getElementById('exportButton1').disabled = selectedCheckups.size === 0;
}

// å…¨é€‰
function selectAllCheckups() {
    const checkboxes = document.querySelectorAll('.checkup-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        toggleCheckupSelection(checkbox.closest('.checkup-card'));
    });
}

// æ¸…ç©ºé€‰æ‹©
function clearSelection() {
    const checkboxes = document.querySelectorAll('.checkup-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        toggleCheckupSelection(checkbox.closest('.checkup-card'));
    });
}

// å¯¼å‡ºé€‰ä¸­çš„æŠ¥å‘Š
function exportSelectedCheckups() {
    if (selectedCheckups.size === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä»½æŠ¥å‘Š');
        return;
    }

    // åˆ›å»ºå¯¼å‡ºæ ¼å¼é€‰æ‹©æ¨¡æ€æ¡†
    const modalHtml = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-download"></i> é€‰æ‹©å¯¼å‡ºæ ¼å¼
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">è¯·é€‰æ‹©è¦å¯¼å‡ºçš„æ–‡ä»¶æ ¼å¼ï¼š</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'medical_records:export_checkups_pdf' %}?checkup_ids=${Array.from(selectedCheckups).join(',')}"
                               class="btn btn-outline-danger text-start">
                                <i class="bi bi-file-earmark-pdf"></i>
                                <strong>å¯¼å‡ºä¸ºPDF</strong>
                                <small class="d-block text-muted">é€‚åˆæ‰“å°å’Œå­˜æ¡£</small>
                            </a>
                            <a href="{% url 'medical_records:export_checkups_word' %}?checkup_ids=${Array.from(selectedCheckups).join(',')}"
                               class="btn btn-outline-primary text-start">
                                <i class="bi bi-file-earmark-word"></i>
                                <strong>å¯¼å‡ºä¸ºWord</strong>
                                <small class="d-block text-muted">å¯ç¼–è¾‘æ ¼å¼ï¼Œä¾¿äºä¿®æ”¹</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
    const oldModal = document.getElementById('exportModal');
    if (oldModal) {
        oldModal.remove();
    }

    // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

// å¯¼å‡ºé€‰ä¸­çš„æŠ¥å‘Šä¸ºPDF
function exportSelectedCheckupsPdf() {
    if (selectedCheckups.size === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä»½æŠ¥å‘Š');
        return;
    }

    if (!confirm(`ç¡®å®šè¦å¯¼å‡ºé€‰ä¸­çš„ ${selectedCheckups.size} ä»½æŠ¥å‘Šå—ï¼Ÿ`)) {
        return;
    }

    // ç›´æ¥è§¦å‘ä¸‹è½½
    const url = "{% url 'medical_records:export_checkups_pdf' %}?checkup_ids=" + Array.from(selectedCheckups).join(',');
    window.location.href = url;
}

// å¯¼å‡ºé€‰ä¸­çš„æŠ¥å‘Šä¸ºWord
function exportSelectedCheckupsWord() {
    if (selectedCheckups.size === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä»½æŠ¥å‘Š');
        return;
    }

    if (!confirm(`ç¡®å®šè¦å¯¼å‡ºé€‰ä¸­çš„ ${selectedCheckups.size} ä»½æŠ¥å‘Šå—ï¼Ÿ`)) {
        return;
    }

    // ç›´æ¥è§¦å‘ä¸‹è½½
    const url = "{% url 'medical_records:export_checkups_word' %}?checkup_ids=" + Array.from(selectedCheckups).join(',');
    window.location.href = url;
}

// å¼€å§‹æ•´åˆ
async function startIntegration() {
    if (selectedCheckups.size === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä»½ä½“æ£€æŠ¥å‘Š');
        return;
    }

    // è·å–ç”¨æˆ·æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
    const userPrompt = document.getElementById('userPrompt').value.trim();

    // åˆ‡æ¢åˆ°ç¬¬äºŒæ­¥
    document.getElementById('step1-content').style.display = 'none';
    document.getElementById('step2-content').style.display = 'block';
    updateStepIndicator(2);

    // æ¸…ç©ºæ—¥å¿—
    const progressLog = document.getElementById('progressLog');
    progressLog.innerHTML = '<div class="text-muted">å‡†å¤‡å¼€å§‹...</div>';

    // Wake Lock API - ä¿æŒå±å¹•å¸¸äº®
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock activated');
            }
        } catch (err) {
            console.log(`Wake Lock error: ${err.name}, ${err.message}`);
        }
    }

    // è¯·æ±‚Wake Lock
    await requestWakeLock();

    // Page Visibility API - æ£€æµ‹é¡µé¢å¯è§æ€§
    const handleVisibilityChange = () => {
        if (document.hidden) {
            addLogEntry('âš ï¸ è­¦å‘Šï¼šè¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œåˆ‡æ¢åå°å¯èƒ½å¯¼è‡´æ•´åˆå¤±è´¥', 'warning');
        } else {
            addLogEntry('âœ… é¡µé¢å·²æ¢å¤ï¼Œç»§ç»­æ•´åˆ...', 'info');
            // é‡æ–°è¯·æ±‚Wake Lockï¼ˆå› ä¸ºåˆ‡æ¢åå°ä¼šé‡Šæ”¾ï¼‰
            requestWakeLock();
        }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    try {
        // è°ƒç”¨æµå¼åç«¯API
        const checkupIds = Array.from(selectedCheckups);
        const requestData = {
            checkup_ids: checkupIds
        };

        // å¦‚æœç”¨æˆ·å¡«å†™äº†æç¤ºè¯ï¼Œæ·»åŠ åˆ°è¯·æ±‚æ•°æ®ä¸­
        if (userPrompt) {
            requestData.user_prompt = userPrompt;
        }

        // ä½¿ç”¨AbortControllerè¿›è¡Œè¶…æ—¶æ§åˆ¶ï¼ˆ10åˆ†é’Ÿï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶

        const response = await fetch('{% url "medical_records:api_stream_integrate" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // å®šä¹‰æ‰€æœ‰å˜é‡
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let resultData = null;
        let progress = 0;
        let buffer = ''; // ç”¨äºå¤„ç†è·¨chunkçš„ä¸å®Œæ•´JSON
        let llmOutputBuffer = ''; // LLMè¾“å‡ºç¼“å†²

        // è¿½åŠ LLM tokenåˆ°è¾“å‡ºåŒºåŸŸ
        function appendLLMToken(token) {
            const llmOutput = document.getElementById('llmOutput');
            if (!llmOutput) return;

            llmOutputBuffer += token;

            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦å¹¶æ˜¾ç¤º
            llmOutput.innerHTML = escapeHtml(llmOutputBuffer)
                .replace(/\n/g, '<br>')
                .replace(/\{/g, '<span style="color: #66d9ef;">{</span>')
                .replace(/\}/g, '<span style="color: #66d9ef;">}</span>')
                .replace(/"([^"]+)":/g, '<span style="color: #a6e22e;">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span style="color: #fd971f;">"$1"</span>');

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            llmOutput.scrollTop = llmOutput.scrollHeight;
        }

        // å¤„ç†SSEæ¶ˆæ¯çš„å‡½æ•°
        function processSSELine(line) {
            if (!line.trim()) return;

            if (line.startsWith('data: ')) {
                try {
                    const jsonStr = line.slice(6).trim();
                    if (!jsonStr) return;

                    const data = JSON.parse(jsonStr);

                    if (data.error) {
                        // æ˜¾ç¤ºé”™è¯¯
                        addLogEntry('âŒ é”™è¯¯: ' + data.error, 'error');
                        updateLogStatus('é”™è¯¯', 'danger');
                        alert('æ•´åˆå¤±è´¥ï¼š' + data.error);
                        location.reload();
                        return;
                    } else if (data.status === 'validating') {
                        addLogEntry('âœ“ ' + data.message, 'info');
                        updateProgress(10);
                    } else if (data.status === 'loading_data') {
                        addLogEntry('ğŸ“Š ' + data.message, 'info');
                        updateProgress(20);
                    } else if (data.status === 'grouping') {
                        addLogEntry('ğŸ“‹ ' + data.message, 'info');
                        updateProgress(30);
                    } else if (data.status === 'prompt_ready') {
                        addLogEntry('ğŸ’¾ ' + data.message, 'info');
                        updateProgress(40);
                    } else if (data.status === 'calling_llm') {
                        addLogEntry(data.message, 'warning');
                        document.getElementById('progressTitle').textContent = data.message;
                        updateProgress(50);
                    } else if (data.status === 'llm_thinking') {
                        addLogEntry('â³ ' + data.message, 'warning');
                        // æ˜¾ç¤ºLLMè¾“å‡ºåŒºåŸŸ
                        const llmCard = document.getElementById('llmOutputCard');
                        if (llmCard) llmCard.style.display = 'block';
                        updateProgress(60);
                    } else if (data.status === 'llm_token') {
                        // å®æ—¶æ˜¾ç¤ºLLMè¾“å‡ºçš„token
                        appendLLMToken(data.token);
                    } else if (data.status === 'llm_complete') {
                        addLogEntry('âœ“ ' + data.message, 'success');
                        updateProgress(70);
                    } else if (data.status === 'parsing') {
                        addLogEntry('ğŸ” ' + data.message, 'info');
                        updateProgress(80);
                    } else if (data.status === 'parsed') {
                        addLogEntry('âœ“ ' + data.message, 'success');
                        updateProgress(90);
                    } else if (data.status === 'done') {
                        // å®Œæˆæ¥æ”¶æ•°æ®
                        resultData = data;
                        addLogEntry('âœ… ' + data.message, 'success');
                        updateLogStatus('å®Œæˆ', 'success');
                        updateProgress(100);
                        // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        console.log('æ”¶åˆ°å®ŒæˆçŠ¶æ€ï¼Œæ•°æ®:', resultData);
                        console.log('å˜æ›´æ•°é‡:', resultData.changed_count);
                        console.log('æ‰€æœ‰æŒ‡æ ‡æ•°é‡:', resultData.all_indicators?.length);
                    }
                } catch (parseError) {
                    // åªåœ¨å¼€å‘æ¨¡å¼ä¸‹è¾“å‡ºè¯¦ç»†é”™è¯¯ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
                    console.warn('è·³è¿‡æ— æ³•è§£æçš„SSEæ¶ˆæ¯:', parseError.message);
                    // ä¸è¦è®©è§£æé”™è¯¯ä¸­æ–­æ•´ä¸ªæµç¨‹
                }
            }
        }

        // è¯»å–æµå¼å“åº”
        while (true) {
            const { done, value } = await reader.read();

            if (done) {
                // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®
                if (buffer.trim()) {
                    processSSELine(buffer);
                    buffer = '';
                }
                break;
            }

            const chunk = decoder.decode(value, { stream: true });
            buffer += chunk;

            // æŒ‰è¡Œåˆ†å‰²ï¼Œä½†ä¿ç•™æœªå®Œæˆçš„è¡Œåˆ°buffer
            const lines = buffer.split('\n');
            buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰

            for (const line of lines) {
                processSSELine(line);
            }
        }

        // ç¡®ä¿åœ¨æ•°æ®æ¥æ”¶å®Œæˆåå¤„ç†ç»“æœ
        console.log('æµå¼è¯»å–å®Œæˆï¼ŒresultData:', resultData);

        if (resultData) {
            console.log('å‡†å¤‡è°ƒç”¨ displayResults');

            // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
            setTimeout(() => {
                try {
                    integrationResult = resultData;
                    displayResults(resultData);
                } catch (displayError) {
                    console.error('displayResults æ‰§è¡Œå¤±è´¥:', displayError);
                    addLogEntry('âŒ æ˜¾ç¤ºç»“æœå¤±è´¥: ' + displayError.message, 'error');
                }
            }, 300);
        } else {
            console.error('æœªæ¥æ”¶åˆ°å®Œæˆæ•°æ®');
            addLogEntry('âŒ æœªæ¥æ”¶åˆ°å®Œæ•´çš„å“åº”æ•°æ®', 'error');
        }

    } catch (error) {
        console.error('æ•´åˆè¯·æ±‚å¤±è´¥:', error);

        // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
        if (error.name === 'AbortError') {
            addLogEntry('âŒ æ•´åˆè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
            alert('æ•´åˆè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
        } else {
            addLogEntry('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
        location.reload();
    } finally {
        // æ¸…ç†èµ„æº
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        // é‡Šæ”¾Wake Lock
        if (wakeLock !== null) {
            wakeLock.release()
                .then(() => {
                    wakeLock = null;
                    console.log('Wake Lock released');
                })
                .catch((err) => {
                    console.error(`Wake Lock release error: ${err.name}, ${err.message}`);
                });
        }
    }
}

// æ·»åŠ æ—¥å¿—æ¡ç›®
function addLogEntry(message, type = 'info') {
    const progressLog = document.getElementById('progressLog');
    const timestamp = new Date().toLocaleTimeString();

    // å®šä¹‰ä¸åŒç±»å‹çš„é¢œè‰²å’Œå›¾æ ‡
    const styles = {
        'info': {
            color: '#61dafb',  // äº®è“è‰²
            icon: 'â„¹ï¸',
            prefix: '[INFO]'
        },
        'success': {
            color: '#4ade80',  // äº®ç»¿è‰²
            icon: 'âœ…',
            prefix: '[SUCCESS]'
        },
        'warning': {
            color: '#fbbf24',  // äº®é»„è‰²
            icon: 'âš ï¸',
            prefix: '[WARNING]'
        },
        'error': {
            color: '#f87171',  // äº®çº¢è‰²
            icon: 'âŒ',
            prefix: '[ERROR]'
        }
    };

    const style = styles[type] || styles['info'];

    const entry = document.createElement('div');
    entry.style.cssText = `
        margin-bottom: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid ${style.color};
        border-radius: 3px;
        color: ${style.color};
        font-family: 'Courier New', monospace;
    `;
    entry.innerHTML = `
        <span style="opacity: 0.6; font-size: 0.85em;">${timestamp}</span>
        <span style="margin-left: 10px; font-weight: bold;">${style.prefix}</span>
        <span style="margin-left: 8px;">${message}</span>
    `;

    progressLog.appendChild(entry);
    progressLog.scrollTop = progressLog.scrollHeight;
}

// æ›´æ–°æ—¥å¿—çŠ¶æ€æ ‡ç­¾
function updateLogStatus(text, color) {
    const logStatus = document.getElementById('logStatus');
    if (logStatus) {
        logStatus.textContent = text;
        logStatus.className = `badge bg-${color}`;
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress(percent) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressBarText = document.getElementById('progressBarText');

    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);

    if (progressPercent) {
        progressPercent.textContent = percent + '%';
    }

    if (progressBarText) {
        progressBarText.textContent = percent + '%';
    }
}

// æ˜¾ç¤ºç»“æœ
function displayResults(result) {
    console.log('displayResults è¢«è°ƒç”¨ï¼Œå‚æ•°:', result);

    // åˆ‡æ¢åˆ°ç¬¬ä¸‰æ­¥
    document.getElementById('step2-content').style.display = 'none';
    document.getElementById('step3-content').style.display = 'block';
    updateStepIndicator(3);

    // æ›´æ–°ç»Ÿè®¡
    console.log('total_indicators:', result.total_indicators);
    console.log('changed_count:', result.changed_count);
    console.log('unchanged_count:', result.unchanged_count);

    document.getElementById('totalIndicators').textContent = result.total_indicators;
    document.getElementById('changedIndicators').textContent = result.changed_count || result.changes?.length || 0;
    document.getElementById('unchangedIndicators').textContent = result.unchanged_count || (result.total_indicators - (result.changed_count || result.changes?.length || 0));

    // æ˜¾ç¤ºå˜æ›´åˆ—è¡¨
    const changesList = document.getElementById('changesList');
    changesList.innerHTML = '';

    // ä½¿ç”¨ all_indicators å¦‚æœå­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨ changesï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    const indicatorsToDisplay = result.all_indicators || result.changes;

    console.log('å‡†å¤‡æ˜¾ç¤ºçš„æŒ‡æ ‡æ•°é‡:', indicatorsToDisplay?.length);

    if (!indicatorsToDisplay || indicatorsToDisplay.length === 0) {
        changesList.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-info-circle"></i> æ²¡æœ‰éœ€è¦æ›´æ–°çš„æŒ‡æ ‡</div>';
        return;
    }

    indicatorsToDisplay.forEach((change, index) => {
        const changeItem = createChangeItem(change, index);
        changesList.appendChild(changeItem);
    });

    console.log('æ˜¾ç¤ºå®Œæˆï¼Œå…±æ¸²æŸ“äº†', indicatorsToDisplay.length, 'ä¸ªæŒ‡æ ‡');
}

// åˆ›å»ºå˜æ›´é¡¹
function createChangeItem(change, index) {
    const div = document.createElement('div');
    // æ ¹æ®æ˜¯å¦æœ‰å˜æ›´è®¾ç½®ä¸åŒçš„æ ·å¼
    const isUnchanged = change.unchanged || Object.keys(change.changes || {}).length === 0;
    div.className = isUnchanged ? 'card mb-2 indicator-unchanged' : 'card mb-2 indicator-changed';

    // åˆ¤æ–­å“ªäº›å­—æ®µæœ‰å˜åŒ–
    const hasNameChange = change.changes && change.changes.indicator_name;
    const hasValueChange = change.changes && change.changes.value;
    const hasUnitChange = change.changes && change.changes.unit;
    const hasRefRangeChange = change.changes && change.changes.reference_range;
    const hasStatusChange = change.changes && change.changes.status;
    const hasTypeChange = change.changes && change.changes.indicator_type;
    const hasReason = change.reason && change.reason.trim().length > 0;

    div.innerHTML = `
        <div class="card-body">
            <h6 class="card-title">
                <span class="badge ${isUnchanged ? 'bg-secondary' : 'bg-warning text-dark'} me-2">${index + 1}</span>
                ${escapeHtml(change.original.indicator_name)}
                ${isUnchanged ? '<span class="badge bg-info ms-2">æ— å˜åŒ–</span>' : ''}
            </h6>
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted">æŒ‡æ ‡åç§°</small><br>
                    ${hasNameChange ? `
                        <span class="diff-old">${escapeHtml(change.original.indicator_name)}</span><br>
                        <span class="diff-new">â†’ ${escapeHtml(change.changes.indicator_name)}</span>
                    ` : `<span class="text-muted">${escapeHtml(change.original.indicator_name)} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">æ•°å€¼</small><br>
                    ${hasValueChange ? `
                        <span class="diff-old">${escapeHtml(change.original.value)}</span><br>
                        <span class="diff-new">â†’ ${escapeHtml(change.changes.value)}</span>
                    ` : `<span class="text-muted">${escapeHtml(change.original.value)} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">å•ä½</small><br>
                    ${hasUnitChange ? `
                        <span class="diff-old">${escapeHtml(change.original.unit || 'æ— ')}</span><br>
                        <span class="diff-new">â†’ ${escapeHtml(change.changes.unit)}</span>
                    ` : `<span class="text-muted">${escapeHtml(change.original.unit || 'æ— ')} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">å‚è€ƒèŒƒå›´</small><br>
                    ${hasRefRangeChange ? `
                        <span class="diff-old">${escapeHtml(change.original.reference_range || 'æ— ')}</span><br>
                        <span class="diff-new">â†’ ${escapeHtml(change.changes.reference_range)}</span>
                    ` : `<span class="text-muted">${escapeHtml(change.original.reference_range || 'æ— ')} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <small class="text-muted">çŠ¶æ€</small><br>
                    ${hasStatusChange ? `
                        <span class="diff-old">${getStatusBadge(change.original.status)}</span>
                        <span class="diff-new">â†’ ${getStatusBadge(change.changes.status)}</span>
                    ` : `<span class="text-muted">${getStatusBadge(change.original.status)} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
                <div class="col-md-6">
                    <small class="text-muted">åˆ†ç±»</small><br>
                    ${hasTypeChange ? `
                        <span class="diff-old">${getTypeName(change.original.indicator_type)}</span>
                        <span class="diff-new">â†’ ${getTypeName(change.changes.indicator_type)}</span>
                    ` : `<span class="text-muted">${getTypeName(change.original.indicator_type)} ${isUnchanged ? '(æ— å˜åŒ–)' : ''}</span>`}
                </div>
            </div>
            ${hasReason ? `
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-primary"><i class="bi bi-lightbulb"></i> ä¿®æ”¹ç†ç”±ï¼š</small><br>
                    <span class="text-muted">${escapeHtml(change.reason)}</span>
                </div>
            </div>
            ` : ''}
        </div>
    `;
    return div;
}

// åº”ç”¨æ›´æ”¹
async function applyChanges() {
    if (!integrationResult || !integrationResult.changes.length) {
        alert('æ²¡æœ‰éœ€è¦åº”ç”¨çš„æ›´æ”¹');
        return;
    }

    // åªå‘é€æœ‰å˜æ›´çš„æŒ‡æ ‡
    const changesToApply = integrationResult.changes;
    if (!confirm(`ç¡®å®šè¦åº”ç”¨ ${changesToApply.length} ä¸ªæ›´æ”¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
    }

    try {
        const response = await fetch('{% url "medical_records:api_apply_integration" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                changes: changesToApply
            })
        });

        const result = await response.json();

        if (result.success) {
            // æ˜¾ç¤ºæ›´æ–°è¯¦æƒ…
            showUpdateDetails(result);
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('æ›´æ–°è¯·æ±‚å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// æ˜¾ç¤ºæ›´æ–°è¯¦æƒ…
function showUpdateDetails(result) {
    // éšè—ç¬¬ä¸‰æ­¥å†…å®¹
    document.getElementById('step3-content').style.display = 'none';

    // åˆ›å»ºæ–°çš„è¯¦æƒ…å±•ç¤ºåŒºåŸŸ
    const detailsContainer = document.createElement('div');
    detailsContainer.id = 'updateDetailsContent';
    detailsContainer.innerHTML = `
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>æ›´æ–°å®Œæˆï¼</strong>
                    æˆåŠŸæ›´æ–° <strong>${result.updated_count}</strong> ä¸ªæŒ‡æ ‡
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <h5>
                    <i class="bi bi-list-check"></i> æ›´æ–°è¯¦æƒ…å¯¹æ¯”
                </h5>
                <p class="text-muted">ä»¥ä¸‹æ˜¯æ¯ä¸ªæŒ‡æ ‡æ›´æ–°å‰åçš„å¯¹æ¯”ï¼Œè¯·æ ¸å¯¹æ˜¯å¦æ­£ç¡®</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div id="updateDetailsList" style="max-height: 600px; overflow-y: auto;">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„æ›´æ–°è¯¦æƒ… -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-primary btn-lg" onclick="window.location.href='{% url "medical_records:dashboard" %}'">
                    <i class="bi bi-house"></i> è¿”å›é¦–é¡µ
                </button>
                <button class="btn btn-outline-secondary btn-lg" onclick="window.location.reload()">
                    <i class="bi bi-arrow-repeat"></i> ç»§ç»­æ•´åˆ
                </button>
            </div>
        </div>
    `;

    // æ’å…¥åˆ°é¡µé¢
    document.querySelector('#step1-content').parentNode.appendChild(detailsContainer);

    // ç”Ÿæˆæ›´æ–°è¯¦æƒ…åˆ—è¡¨
    const detailsList = document.getElementById('updateDetailsList');
    result.update_details.forEach((detail, index) => {
        const detailItem = createUpdateDetailItem(detail, index);
        detailsList.appendChild(detailItem);
    });
}

// åˆ›å»ºæ›´æ–°è¯¦æƒ…é¡¹
function createUpdateDetailItem(detail, index) {
    const div = document.createElement('div');
    div.className = 'card mb-3 border-success';

    const hasChanges = Object.keys(detail.changes || {}).length > 0;

    div.innerHTML = `
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <span class="badge bg-light text-dark me-2">${index + 1}</span>
                ${escapeHtml(detail.after.indicator_name)}
                <small class="ms-2">${detail.checkup_date} - ${escapeHtml(detail.hospital)}</small>
            </h6>
        </div>
        <div class="card-body">
            ${hasChanges ? renderFieldChanges(detail) : '<p class="text-muted mb-0">æ— å˜æ›´</p>'}
            ${detail.reason ? `<hr><p class="mb-0"><strong>AIè¯´æ˜ï¼š</strong>${escapeHtml(detail.reason)}</p>` : ''}
        </div>
    `;
    return div;
}

// æ¸²æŸ“å­—æ®µå˜æ›´
function renderFieldChanges(detail) {
    const fields = [
        { key: 'indicator_name', label: 'æŒ‡æ ‡åç§°' },
        { key: 'value', label: 'æ•°å€¼' },
        { key: 'unit', label: 'å•ä½' },
        { key: 'reference_range', label: 'å‚è€ƒèŒƒå›´' },
        { key: 'status', label: 'çŠ¶æ€' },
        { key: 'indicator_type', label: 'åˆ†ç±»' }
    ];

    let changesHtml = '<div class="row">';
    let hasAnyChange = false;

    fields.forEach(field => {
        const before = detail.before[field.key];
        const after = detail.after[field.key];

        if (before !== after) {
            hasAnyChange = true;
            changesHtml += `
                <div class="col-md-6 mb-2">
                    <small class="text-muted">${field.label}</small><br>
                    <span class="diff-old">${escapeHtml(String(before || 'æ— '))}</span><br>
                    <span class="diff-new">â†’ ${escapeHtml(String(after || 'æ— '))}</span>
                </div>
            `;
        }
    });

    changesHtml += '</div>';

    if (!hasAnyChange) {
        return '<p class="text-muted mb-0">æ— å˜æ›´</p>';
    }

    return changesHtml;
}

// æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
function updateStepIndicator(step) {
    const tabs = ['step1-tab', 'step2-tab', 'step3-tab'];
    tabs.forEach((tabId, index) => {
        const tab = document.getElementById(tabId);
        if (index + 1 === step) {
            tab.classList.add('active');
            tab.classList.remove('disabled');
        } else if (index + 1 < step) {
            tab.classList.remove('active');
            tab.classList.add('disabled');
        } else {
            tab.classList.remove('active', 'disabled');
        }
    });
}

// è·å–çŠ¶æ€å¾½ç« 
function getStatusBadge(status) {
    const badges = {
        'normal': '<span class="badge bg-success">æ­£å¸¸</span>',
        'abnormal': '<span class="badge bg-danger">å¼‚å¸¸</span>',
        'attention': '<span class="badge bg-warning text-dark">å…³æ³¨</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
}

// è·å–ç±»å‹åç§°
function getTypeName(type) {
    const types = {
        'physical_exam': 'ä½“æ ¼æ£€æŸ¥',
        'blood_routine': 'è¡€æ¶²å¸¸è§„',
        'biochemistry': 'ç”ŸåŒ–æ£€éªŒ',
        'liver_function': 'è‚åŠŸèƒ½',
        'kidney_function': 'è‚¾åŠŸèƒ½',
        'thyroid_function': 'ç”²çŠ¶è…ºåŠŸèƒ½',
        'tumor_markers': 'è‚¿ç˜¤æ ‡å¿—ç‰©',
        'urine_exam': 'å°¿æ¶²æ£€æŸ¥',
        'blood_rheology': 'è¡€æ¶²æµå˜å­¦',
        'eye_exam': 'çœ¼ç§‘æ£€æŸ¥',
        'ultrasound_exam': 'è¶…å£°æ£€æŸ¥',
        'imaging_exam': 'å½±åƒå­¦æ£€æŸ¥',
        'diagnosis': 'ç—…ç—‡è¯Šæ–­',
        'symptoms': 'ç—‡çŠ¶æè¿°',
        'other_exam': 'å…¶ä»–æ£€æŸ¥'
    };
    return types[type] || type || 'æœªçŸ¥';
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è·å–CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
