{% extends 'base.html' %}

{% block title %}健康数据仪表板 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.sidebar-card {
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
}
.status-badge {
    font-size: 0.75rem;
}
.chart-container {
    position: relative;
    height: 300px;
}
.indicator-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.indicator-trend {
    font-size: 0.875rem;
}
.indicator-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}
.indicator-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.indicator-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0 !important;
    padding: 12px 15px;
}
.indicator-card .card-header h6 {
    font-weight: 600;
    margin: 0;
}
.indicator-card .card-header small {
    opacity: 0.9;
}
.indicator-card .card-body {
    padding: 15px;
}
.indicator-table {
    margin-bottom: 0;
}
.indicator-table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 10px 12px;
    white-space: nowrap;
}
.indicator-table tbody td {
    padding: 10px 12px;
    vertical-align: middle;
    font-size: 0.9rem;
    border-bottom: 1px solid #f1f3f5;
}
.indicator-table tbody tr:last-child td {
    border-bottom: none;
}
.indicator-table tbody tr:hover {
    background-color: #f8f9fa;
}
.indicator-table .date-cell {
    color: #6c757d;
    font-weight: 500;
}
.indicator-table .value-cell {
    font-weight: 600;
    color: #212529;
}
.indicator-table .change-cell {
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="bi bi-heart-pulse text-primary"></i> 健康数据仪表板
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- 顶部信息栏 -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- 最近体检报告 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-file-text"></i> 我的体检报告
                            </h6>
                            {% if total_checkups > 0 %}
                            <span class="badge bg-primary">{{ total_checkups }} 份</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if all_checkups %}
                                {% for checkup in all_checkups|slice:":10" %}
                                <div class="d-flex justify-content-between align-items-center mb-3 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                                    <div>
                                        <div class="fw-bold">{{ checkup.checkup_date|date:"Y年m月d日" }}</div>
                                        <div class="text-muted small">{{ checkup.hospital }}</div>
                                    </div>
                                    <a href="{% url 'medical_records:checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                                {% endfor %}
                                {% if all_checkups|length > 10 %}
                                <div class="text-center mt-2">
                                    <span class="text-muted small d-block mb-2">还有 {{ all_checkups|length|add:"-10" }} 条记录未显示</span>
                                    <a href="{% url 'medical_records:all_checkups' %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-list me-1"></i>查看全部 ({{ all_checkups|length }} 份)
                                    </a>
                                </div>
                                {% endif %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-plus"></i> 上传新报告
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-3">暂无体检报告</p>
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm">
                                        上传第一份报告
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 异常指标提醒 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 异常指标提醒
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if abnormal_indicators %}
                                {% for indicator in abnormal_indicators %}
                                <div class="alert alert-danger alert-sm mb-2 py-2">
                                    <div class="fw-bold">{{ indicator.indicator_name }}</div>
                                    <div class="small">
                                        {{ indicator.value }} {{ indicator.unit }}
                                        <br>
                                        <span class="text-muted">{{ indicator.checkup.checkup_date|date:"Y-m-d" }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:ai_health_advice' %}" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="bi bi-robot"></i> 咨询AI医生
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <p class="text-muted small mb-0 mt-2">暂无异常指标</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="col-12">
            <!-- 健康趋势图表区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up"></i> 健康趋势分析 - 按指标分类
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- 图表切换标签 -->
                            <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                                <!-- 基础检查类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="physical-tab" data-bs-toggle="tab" data-bs-target="#physical" type="button" role="tab">
                                        <i class="bi bi-person"></i> 体格检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="blood-tab" data-bs-toggle="tab" data-bs-target="#blood" type="button" role="tab">
                                        <i class="bi bi-droplet"></i> 血液常规
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="biochemistry-tab" data-bs-toggle="tab" data-bs-target="#biochemistry" type="button" role="tab">
                                        <i class="bi bi-cpu"></i> 生化检验
                                    </button>
                                </li>

                                <!-- 器官功能类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="liver-tab" data-bs-toggle="tab" data-bs-target="#liver" type="button" role="tab">
                                        <i class="bi bi-liver"></i> 肝功能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="kidney-tab" data-bs-toggle="tab" data-bs-target="#kidney" type="button" role="tab">
                                        <i class="bi bi-gear"></i> 肾功能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="thyroid-tab" data-bs-toggle="tab" data-bs-target="#thyroid" type="button" role="tab">
                                        <i class="bi bi-lightning"></i> 甲状腺
                                    </button>
                                </li>

                                <!-- 其他检查类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tumor-tab" data-bs-toggle="tab" data-bs-target="#tumor" type="button" role="tab">
                                        <i class="bi bi-shield-exclamation"></i> 肿瘤标志
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="urine-tab" data-bs-toggle="tab" data-bs-target="#urine" type="button" role="tab">
                                        <i class="bi bi-moisture"></i> 尿液检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="rheology-tab" data-bs-toggle="tab" data-bs-target="#rheology" type="button" role="tab">
                                        <i class="bi bi-water"></i> 血液流变
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="eye-tab" data-bs-toggle="tab" data-bs-target="#eye" type="button" role="tab">
                                        <i class="bi bi-eye"></i> 眼科检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button" role="tab">
                                        <i class="bi bi-clipboard"></i> 其他检查
                                    </button>
                                </li>
                            </ul>

                            <!-- 标签内容 -->
                            <div class="tab-content" id="chartTabContent">
                                <!-- 体格检查标签页 -->
                                <div class="tab-pane fade show active" id="physical" role="tabpanel">
                                    <div class="row" id="physical-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 血液常规标签页 -->
                                <div class="tab-pane fade" id="blood" role="tabpanel">
                                    <div class="row" id="blood-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 生化检验标签页 -->
                                <div class="tab-pane fade" id="biochemistry" role="tabpanel">
                                    <div class="row" id="biochemistry-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肝功能标签页 -->
                                <div class="tab-pane fade" id="liver" role="tabpanel">
                                    <div class="row" id="liver-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肾功能标签页 -->
                                <div class="tab-pane fade" id="kidney" role="tabpanel">
                                    <div class="row" id="kidney-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 甲状腺功能标签页 -->
                                <div class="tab-pane fade" id="thyroid" role="tabpanel">
                                    <div class="row" id="thyroid-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肿瘤标志物标签页 -->
                                <div class="tab-pane fade" id="tumor" role="tabpanel">
                                    <div class="row" id="tumor-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 尿液检查标签页 -->
                                <div class="tab-pane fade" id="urine" role="tabpanel">
                                    <div class="row" id="urine-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 血液流变学标签页 -->
                                <div class="tab-pane fade" id="rheology" role="tabpanel">
                                    <div class="row" id="rheology-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 眼科检查标签页 -->
                                <div class="tab-pane fade" id="eye" role="tabpanel">
                                    <div class="row" id="eye-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 其他检查标签页 -->
                                <div class="tab-pane fade" id="other" role="tabpanel">
                                    <div class="row" id="other-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 图表数据
const chartData = {{ chart_data|safe }};
const rawData = chartData; // 保持向后兼容

// 从Django传递的动态指标分类映射
const dynamicIndicatorMapping = {{ indicator_type_mapping|safe }};
console.log('Dynamic indicator mapping from Django:', dynamicIndicatorMapping);

// 计算变化量
function calculateChange(values) {
    if (!values || values.length < 2) return null;
    const latest = values[0];
    const previous = values[1];
    const change = latest - previous;
    const percentChange = previous !== 0 ? ((change / previous) * 100).toFixed(1) : 'N/A';
    return { absolute: change.toFixed(2), percent: percentChange };
}

// 生成变化量显示HTML
function formatChange(changeData) {
    if (!changeData) return '<span class="text-muted">-</span>';
    const { absolute, percent } = changeData;
    const isPositive = parseFloat(absolute) > 0;
    const isNegative = parseFloat(absolute) < 0;
    let html = '';
    if (isPositive) {
        html = `<span class="text-danger">↑ ${Math.abs(absolute)}</span> <span class="text-muted small">(+${percent}%)</span>`;
    } else if (isNegative) {
        html = `<span class="text-success">↓ ${Math.abs(absolute)}</span> <span class="text-muted small">(${percent}%)</span>`;
    } else {
        html = `<span class="text-muted">-</span>`;
    }
    return html;
}

// 为单个指标创建表格
function createTableForIndicator(indicatorName, indicatorData, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const dates = indicatorData.dates || [];
    const values = indicatorData.values || [];
    const unit = indicatorData.units || '';

    if (dates.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无数据</div>';
        return;
    }

    const sortedData = dates.map((date, i) => ({
        date: date,
        value: values[i]
    })).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);

    let tableHtml = `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card indicator-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${indicatorName}</h6>
                    <small>${unit}</small>
                </div>
                <div class="card-body">
                    <table class="table indicator-table mb-0">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>数值</th>
                                <th>变化量</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    sortedData.forEach((item, idx) => {
        let changeHtml = '';
        if (idx < sortedData.length - 1) {
            const currentVal = parseFloat(item.value);
            const prevVal = parseFloat(sortedData[idx + 1].value);

            if (!isNaN(currentVal) && !isNaN(prevVal)) {
                const change = currentVal - prevVal;
                const changeClass = change > 0 ? 'text-success' : (change < 0 ? 'text-danger' : 'text-muted');
                const changeSymbol = change > 0 ? '↑' : (change < 0 ? '↓' : '-');
                changeHtml = `<span class="${changeClass} fw-bold">${changeSymbol} ${Math.abs(change).toFixed(2)}</span>`;
            } else {
                changeHtml = '-';
            }
        } else {
            changeHtml = '<span class="text-muted">-</span>';
        }

        tableHtml += `
            <tr>
                <td class="date-cell">${item.date}</td>
                <td class="value-cell">${item.value}</td>
                <td class="change-cell">${changeHtml}</td>
            </tr>
        `;
    });

    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = tableHtml;
}

// 体格检查表格
function createPhysicalTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('physical-individual-charts');
    if (!container) return;

    const physicalIndicators = ['收缩压', '舒张压', '心率', '身高', '体重', '体重指数', '腰围', '臀围', '呼吸频率'];

    let html = '';
    rawData.forEach(indicator => {
        if (physicalIndicators.some(pi => indicator.indicator_name.includes(pi))) {
            const tableId = `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            createTableForIndicator(indicator.indicator_name, indicator, tableId);
            html += `<div id="${tableId}"></div>`;
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无体格检查数据</div>';
    }
}

// 血液常规表格
function createBloodTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('blood-individual-charts');
    if (!container) return;

    const bloodIndicators = ['白细胞计数', '红细胞计数', '血红蛋白浓度', '血小板计数',
                           '中性粒细胞百分比', '淋巴细胞百分比', '单核细胞百分比'];

    let html = '';
    rawData.forEach(indicator => {
        if (bloodIndicators.some(bi => indicator.indicator_name.includes(bi))) {
            const tableId = `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            createTableForIndicator(indicator.indicator_name, indicator, tableId);
            html += `<div id="${tableId}"></div>`;
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无血液常规数据</div>';
    }
}

// 生化检验表格
function createBiochemistryTables() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('biochemistry-individual-charts');
    if (!container) return;

    const biochemistryIndicators = ['葡萄糖', '总胆固醇', '甘油三酯', '高密度脂蛋白胆固醇',
                                   '低密度脂蛋白胆固醇', '载脂蛋白A1', '载脂蛋白B', '尿酸',
                                   '肌酐', '尿素', '总胆红素', '直接胆红素', '间接胆红素'];

    let html = '';
    rawData.forEach(indicator => {
        if (biochemistryIndicators.some(bi => indicator.indicator_name.includes(bi))) {
            const tableId = `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            createTableForIndicator(indicator.indicator_name, indicator, tableId);
            html += `<div id="${tableId}"></div>`;
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无生化检验数据</div>';
    }
}

// 肝功能表格
function createLiverTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('liver-individual-charts');
    if (!container) return;

    const liverIndicators = ['丙氨酸氨基转移酶', '天门冬氨酸氨基转移酶', 'γ-谷氨酰转移酶'];

    let html = '';
    rawData.forEach(indicator => {
        if (liverIndicators.some(li => indicator.indicator_name.includes(li))) {
            const tableId = `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            createTableForIndicator(indicator.indicator_name, indicator, tableId);
            html += `<div id="${tableId}"></div>`;
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肝功能数据</div>';
    }
}

// 肾功能表格
function createKidneyTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('kidney-individual-charts');
    if (!container) return;

    const kidneyIndicators = rawData
        .filter(item => item.type === 'kidney_function')
        .map(item => item.indicator_name);

    let html = '';
    rawData.forEach(indicator => {
        if (kidneyIndicators.includes(indicator.indicator_name)) {
            const tableId = `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            createTableForIndicator(indicator.indicator_name, indicator, tableId);
            html += `<div id="${tableId}"></div>`;
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肾功能数据</div>';
    }
}

// 甲状腺功能表格
function createThyroidTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('thyroid-individual-charts');
    if (!container) return;

    // 动态获取所有甲状腺功能指标
    const thyroidIndicators = rawData
        .filter(item => item.type === 'thyroid_function')
        .map(item => item.indicator_name);

    let html = '';
    rawData.forEach(indicator => {
        if (indicator.type === 'thyroid_function' || thyroidIndicators.some(ti => indicator.indicator_name.includes(ti))) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无甲状腺功能数据</div>';
    }
}

// 肿瘤标志物表格
function createTumorTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('tumor-individual-charts');
    if (!container) return;

    const tumorIndicators = ['甲胎蛋白', '癌胚抗原', 'CA125', 'CA153', 'CA199', 'PSA', 'fPSA'];
    
    let html = '';
    rawData.forEach(indicator => {
        if (tumorIndicators.some(ti => indicator.indicator_name.includes(ti))) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肿瘤标志物数据</div>';
    }
}

// 尿液检查表格
function createUrineTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('urine-individual-charts');
    if (!container) return;

    const urineIndicators = ['尿比重', '尿pH值', '尿蛋白', '尿糖', '尿酮体', '尿潜血', '尿白细胞'];
    
    let html = '';
    rawData.forEach(indicator => {
        if (urineIndicators.some(ui => indicator.indicator_name.includes(ui))) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无尿液检查数据</div>';
    }
}

// 血液流变学表格
function createRheologyTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('rheology-individual-charts');
    if (!container) return;

    const rheologyIndicators = ['全血粘度低切', '全血粘度中切', '全血粘度高切', '血浆粘度', '红细胞压积'];
    
    let html = '';
    rawData.forEach(indicator => {
        if (rheologyIndicators.some(ri => indicator.indicator_name.includes(ri))) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无血液流变学数据</div>';
    }
}

// 眼科检查表格
function createEyeTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('eye-individual-charts');
    if (!container) return;

    const eyeIndicators = ['裸眼视力左', '裸眼视力右', '矫正视力左', '矫正视力右', '眼压左', '眼压右'];
    
    let html = '';
    rawData.forEach(indicator => {
        if (eyeIndicators.some(ei => indicator.indicator_name.includes(ei))) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无眼科检查数据</div>';
    }
}

// 其他检查表格
function createOtherTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('other-individual-charts');
    if (!container) return;

    const knownTypes = ['physical_exam', 'blood_routine', 'biochemistry', 'liver_function', 
                        'kidney_function', 'thyroid_function', 'tumor_markers', 'urine_exam', 
                        'blood_rheology', 'eye_exam'];
    
    let html = '';
    rawData.forEach(indicator => {
        if (!knownTypes.includes(indicator.type)) {
            createTableForIndicator(indicator.indicator_name, indicator, `table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            html += `<div id="table-${indicator.indicator_name.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }
    });
    
    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无其他检查数据</div>';
    }
}

// 初始化所有表格
function initializeAllTables() {
    createPhysicalTable();
    createBloodTable();
    createBiochemistryTables();
    createLiverTable();
    createKidneyTable();
    createThyroidTable();
    createTumorTable();
    createUrineTable();
    createRheologyTable();
    createEyeTable();
    createOtherTable();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing tables...');
    initializeAllTables();
});

// 切换标签时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    switch(targetId) {
        case '#physical': createPhysicalTable(); break;
        case '#blood': createBloodTable(); break;
        case '#biochemistry': createBiochemistryTables(); break;
        case '#liver': createLiverTable(); break;
        case '#kidney': createKidneyTable(); break;
        case '#thyroid': createThyroidTable(); break;
        case '#tumor': createTumorTable(); break;
        case '#urine': createUrineTable(); break;
        case '#rheology': createRheologyTable(); break;
        case '#eye': createEyeTable(); break;
        case '#other': createOtherTable(); break;
    }
});

// 页面加载完成后初始化表格
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing tables...');
    initializeAllTables();
});

// 标签切换时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    switch(targetId) {
        case '#physical': createPhysicalTable(); break;
        case '#blood': createBloodTable(); break;
        case '#biochemistry': createBiochemistryTables(); break;
        case '#liver': createLiverTable(); break;
        case '#kidney': createKidneyTable(); break;
        case '#thyroid': createThyroidTable(); break;
        case '#tumor': createTumorTable(); break;
        case '#urine': createUrineTable(); break;
        case '#rheology': createRheologyTable(); break;
        case '#eye': createEyeTable(); break;
        case '#other': createOtherTable(); break;
    }
});
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: true,
            position: 'top',
        },
        tooltip: {
            mode: 'index',
            intersect: false,
        }
    },
    scales: {
        x: {
            display: true,
            title: {
                display: true,
                text: '日期'
            }
        }
    }
};

// 获取指标颜色
function getIndicatorColor(indicatorName, alpha = 1) {
    const colors = {
        // 体格检查
        '心率': `rgba(255, 99, 132, ${alpha})`,
        '收缩压': `rgba(255, 99, 132, ${alpha})`,
        '舒张压': `rgba(54, 162, 235, ${alpha})`,
        '身高': `rgba(75, 192, 192, ${alpha})`,
        '体重': `rgba(153, 102, 255, ${alpha})`,
        '体重指数': `rgba(255, 159, 64, ${alpha})`,
        '腰围': `rgba(255, 99, 132, ${alpha})`,
        '臀围': `rgba(54, 162, 235, ${alpha})`,
        '腰围臀围比值': `rgba(75, 192, 192, ${alpha})`,
        '呼吸频率': `rgba(153, 102, 255, ${alpha})`,

        // 血液常规
        '红细胞计数': `rgba(255, 99, 132, ${alpha})`,
        '血红蛋白浓度': `rgba(54, 162, 235, ${alpha})`,
        '红细胞比容': `rgba(75, 192, 192, ${alpha})`,
        '平均红细胞容积': `rgba(153, 102, 255, ${alpha})`,
        '红细胞分布宽度': `rgba(255, 159, 64, ${alpha})`,
        '白细胞计数': `rgba(255, 99, 132, ${alpha})`,
        '中性粒细胞百分比': `rgba(54, 162, 235, ${alpha})`,
        '中性粒细胞绝对计数': `rgba(75, 192, 192, ${alpha})`,
        '淋巴细胞百分比': `rgba(153, 102, 255, ${alpha})`,
        '淋巴细胞绝对计数': `rgba(255, 159, 64, ${alpha})`,
        '单核细胞百分比': `rgba(255, 99, 132, ${alpha})`,
        '单核细胞绝对计数': `rgba(54, 162, 235, ${alpha})`,
        '血小板计数': `rgba(75, 192, 192, ${alpha})`,
        '血小板分布宽度': `rgba(153, 102, 255, ${alpha})`,
        '平均血小板容积': `rgba(255, 159, 64, ${alpha})`,
        '血小板压积': `rgba(255, 99, 132, ${alpha})`,

        // 生化检验
        '葡萄糖': `rgba(255, 99, 132, ${alpha})`,
        '总胆固醇': `rgba(54, 162, 235, ${alpha})`,
        '甘油三酯': `rgba(75, 192, 192, ${alpha})`,
        '高密度脂蛋白胆固醇': `rgba(153, 102, 255, ${alpha})`,
        '低密度脂蛋白胆固醇': `rgba(255, 159, 64, ${alpha})`,
        '载脂蛋白A1': `rgba(255, 99, 132, ${alpha})`,
        '载脂蛋白B': `rgba(54, 162, 235, ${alpha})`,
        '尿酸': `rgba(75, 192, 192, ${alpha})`,
        '肌酐': `rgba(153, 102, 255, ${alpha})`,
        '尿素': `rgba(255, 159, 64, ${alpha})`,
        '尿素氮': `rgba(255, 99, 132, ${alpha})`,
        '总胆红素': `rgba(54, 162, 235, ${alpha})`,
        '直接胆红素': `rgba(75, 192, 192, ${alpha})`,
        '间接胆红素': `rgba(153, 102, 255, ${alpha})`,
        '糖化血红蛋白': `rgba(255, 159, 64, ${alpha})`,

        // 肝功能
        '丙氨酸氨基转移酶': `rgba(255, 99, 132, ${alpha})`,
        '天门冬氨酸氨基转移酶': `rgba(54, 162, 235, ${alpha})`,
        'γ-谷氨酰转移酶': `rgba(75, 192, 192, ${alpha})`,

        // 甲状腺功能
        '促甲状腺激素': `rgba(255, 99, 132, ${alpha})`,
        '游离甲状腺素': `rgba(54, 162, 235, ${alpha})`,
        '三碘甲状腺原氨酸': `rgba(75, 192, 192, ${alpha})`,
        '游离三碘甲状腺原氨酸': `rgba(153, 102, 255, ${alpha})`,
        '甲状腺素': `rgba(255, 159, 64, ${alpha})`,

        // 肿瘤标志物
        '甲胎蛋白': `rgba(255, 99, 132, ${alpha})`,
        '癌胚抗原': `rgba(54, 162, 235, ${alpha})`,
        '前列腺特异性抗原': `rgba(75, 192, 192, ${alpha})`,
        '游离前列腺特异性抗原': `rgba(153, 102, 255, ${alpha})`,
        '糖类抗原19-9': `rgba(255, 159, 64, ${alpha})`,
        '细胞角蛋白19片段抗原': `rgba(255, 99, 132, ${alpha})`,

        // 眼科检查
        '右眼视力': `rgba(255, 99, 132, ${alpha})`,
        '左眼视力': `rgba(54, 162, 235, ${alpha})`,
        '右眼眼压值': `rgba(75, 192, 192, ${alpha})`,
        '左眼眼压值': `rgba(153, 102, 255, ${alpha})`,

        // 其他检查
        '平均血红蛋白含量': `rgba(255, 99, 132, ${alpha})`,
        '平均血红蛋白浓度': `rgba(54, 162, 235, ${alpha})`,
        '血沉': `rgba(75, 192, 192, ${alpha})`,
        '血沉方程K值': `rgba(153, 102, 255, ${alpha})`,
        '维生素C': `rgba(255, 159, 64, ${alpha})`,

        // 尿液检查
        '尿pH值': `rgba(255, 99, 132, ${alpha})`,
        '尿比重': `rgba(54, 162, 235, ${alpha})`,
        '尿蛋白': `rgba(75, 192, 192, ${alpha})`,
        '尿潜血': `rgba(153, 102, 255, ${alpha})`,
        '尿白细胞': `rgba(255, 159, 64, ${alpha})`,
        '尿糖': `rgba(255, 99, 132, ${alpha})`,
        '尿酮体': `rgba(54, 162, 235, ${alpha})`,
        '尿胆原': `rgba(75, 192, 192, ${alpha})`,
        '尿胆红素': `rgba(153, 102, 255, ${alpha})`,

        // 血液流变学
        '全血粘度(1/s)': `rgba(255, 99, 132, ${alpha})`,
        '全血粘度(30/s)': `rgba(54, 162, 235, ${alpha})`,
        '全血粘度(50/s)': `rgba(75, 192, 192, ${alpha})`,
        '全血粘度(200/s)': `rgba(153, 102, 255, ${alpha})`,
        '全血还原粘度(1/s)': `rgba(255, 159, 64, ${alpha})`,
        '全血还原粘度(30/s)': `rgba(255, 99, 132, ${alpha})`,
        '血浆粘度': `rgba(54, 162, 235, ${alpha})`,

        // 旧名称映射（保持兼容性）
        'BMI': `rgba(255, 159, 64, ${alpha})`,
        '血糖': `rgba(255, 159, 64, ${alpha})`
    };
    return colors[indicatorName] || `rgba(${Math.random()*255|0}, ${Math.random()*255|0}, ${Math.random()*255|0}, ${alpha})`;
}

// 体格检查图表
function createPhysicalChart() {
    const ctx = document.getElementById('physicalChart').getContext('2d');
    const rawData = chartData.raw_data || [];

    // 体格检查指标
    const physicalIndicators = ['收缩压', '舒张压', '心率', '身高', '体重', '体重指数', '腰围', '臀围', '呼吸频率'];
    const datasets = [];
    const allDates = new Set();

    // 为每个体格检查指标创建数据集
    physicalIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });
}

// 血液常规图表
function createBloodChart() {
    const ctx = document.getElementById('bloodChart').getContext('2d');
    const rawData = chartData.raw_data || [];

    // 血液常规指标
    const bloodIndicators = [
        '白细胞计数', '红细胞计数', '血红蛋白浓度', '血小板计数',
        '中性粒细胞百分比', '淋巴细胞百分比', '单核细胞百分比',
        '嗜酸性粒细胞百分比', '嗜碱性粒细胞百分比'
    ];
    const datasets = [];
    const allDates = new Set();

    bloodIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });
}

// 生化检验图表
function createBiochemistryCharts() {
    // 第一个生化图表：血糖和血脂
    const ctx1 = document.getElementById('biochemistryChart1').getContext('2d');
    const rawData = chartData.raw_data || [];

    const biochemistryIndicators1 = ['葡萄糖', '总胆固醇', '甘油三酯', '高密度脂蛋白胆固醇', '低密度脂蛋白胆固醇'];
    const datasets1 = [];
    const allDates1 = new Set();

    biochemistryIndicators1.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates1.add(date));

            datasets1.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels1 = Array.from(allDates1).sort();

    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: labels1,
            datasets: datasets1
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });

    // 第二个生化图表：肾功能和胆红素
    const ctx2 = document.getElementById('biochemistryChart2').getContext('2d');
    const biochemistryIndicators2 = ['肌酐', '尿素', '尿酸', '总胆红素', '直接胆红素', '间接胆红素'];
    const datasets2 = [];
    const allDates2 = new Set();

    biochemistryIndicators2.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates2.add(date));

            datasets2.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels2 = Array.from(allDates2).sort();

    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: labels2,
            datasets: datasets2
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });
}

// 肝功能图表
function createLiverChart() {
    const ctx = document.getElementById('liverChart').getContext('2d');
    const rawData = chartData.raw_data || [];

    const liverIndicators = ['丙氨酸氨基转移酶', '天门冬氨酸氨基转移酶', 'γ-谷氨酰转移酶'];
    const datasets = [];
    const allDates = new Set();

    liverIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值 (U/L)'
                    }
                }
            }
        }
    });
}

  // 肾功能图表
function createKidneyChart() {
    const ctx = document.getElementById('kidneyChart');
    if (!ctx) return;

    const rawData = chartData.raw_data || [];
    const datasets = [];
    const allDates = new Set();

    // 动态获取所有肾功能指标
    const kidneyIndicators = rawData
        .filter(item => item.type === 'kidney_function')
        .map(item => item.indicator_name);

    kidneyIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    if (datasets.length === 0) {
        ctx.parentElement.querySelector('.text-muted').style.display = 'block';
        return;
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });
}

  // 甲状腺功能图表
function createThyroidChart() {
    const ctx = document.getElementById('thyroidChart');
    if (!ctx) return;

    const rawData = chartData.raw_data || [];
    const datasets = [];
    const allDates = new Set();

    // 动态获取所有甲状腺功能指标
    const thyroidIndicators = rawData
        .filter(item => item.type === 'thyroid_function')
        .map(item => item.indicator_name);

    thyroidIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    if (datasets.length === 0) {
        ctx.parentElement.querySelector('.text-muted').style.display = 'block';
        return;
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '数值'
                    }
                }
            }
        }
    });
}

      // 通用动态图表创建函数
function createDynamicChart(canvasId, indicatorType, title, beginAtZero = false) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const rawData = chartData.raw_data || [];
    const datasets = [];
    const allDates = new Set();

    // 动态获取指定类型的所有指标
    const indicators = rawData
        .filter(item => item.type === indicatorType)
        .map(item => item.indicator_name);

    indicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));

            datasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    const labels = Array.from(allDates).sort();

    if (datasets.length === 0) {
        if (ctx.parentElement.querySelector('.text-muted')) {
            ctx.parentElement.querySelector('.text-muted').style.display = 'block';
        }
        return;
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: title || '数值'
                    },
                    beginAtZero: beginAtZero
                }
            }
        }
    });
}

// 创建独立指标表格的函数
function createIndividualCharts(containerId, indicatorType) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    const rawData = chartData.raw_data || [];

    const indicators = rawData
        .filter(item => item.type === indicatorType)
        .map(item => ({
            name: item.indicator_name,
            data: item,
            unit: item.units
        }));

    if (indicators.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4" style="width: 100%;">暂无数据</div>';
        return;
    }

    indicators.forEach((indicator, index) => {
        const tableId = `individual-table-${containerId}-${index}`;

        const dates = indicator.data.dates || [];
        const values = indicator.data.values || [];

        const sortedData = dates.map((date, i) => ({
            date: date,
            value: values[i]
        })).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);

        let tableHtml = `
            <div class="col-lg-6 col-xl-4 mb-3">
                <div class="card indicator-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${indicator.name}</h6>
                        <small>${indicator.unit || ''}</small>
                    </div>
                    <div class="card-body">
                        <table class="table indicator-table mb-0" id="${tableId}">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>数值</th>
                                    <th>变化量</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        sortedData.forEach((item, idx) => {
            let changeHtml = '';
            if (idx < sortedData.length - 1) {
                const currentVal = parseFloat(item.value);
                const prevVal = parseFloat(sortedData[idx + 1].value);

                if (!isNaN(currentVal) && !isNaN(prevVal)) {
                    const change = currentVal - prevVal;
                    const changeClass = change > 0 ? 'text-success' : (change < 0 ? 'text-danger' : 'text-muted');
                    const changeSymbol = change > 0 ? '↑' : (change < 0 ? '↓' : '-');
                    changeHtml = `<span class="${changeClass} fw-bold">${changeSymbol} ${Math.abs(change).toFixed(2)}</span>`;
                } else {
                    changeHtml = '-';
                }
            } else {
                changeHtml = '<span class="text-muted">-</span>';
            }

            tableHtml += `
                <tr>
                    <td class="date-cell">${item.date}</td>
                    <td class="value-cell">${item.value}</td>
                    <td class="change-cell">${changeHtml}</td>
                </tr>
            `;
        });

        tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', tableHtml);
    });
}

// 肿瘤标志物图表
function createTumorChart() {
    createDynamicChart('tumorChart', 'tumor_markers', '数值', true);
}

// 尿液检查图表
function createUrineChart() {
    createDynamicChart('urineChart', 'urine_exam', '数值');
}

      // 血液流变学图表
function createRheologyChart() {
    createDynamicChart('rheologyChart', 'blood_rheology', '数值');
}

// 眼科检查图表
function createEyeCharts() {
    const ctx1 = document.getElementById('eyeVisionChart');
    const ctx2 = document.getElementById('eyePressureChart');

    if (!ctx1 || !ctx2) return;

    const rawData = chartData.raw_data || [];

    const eyeIndicators = ['右眼视力', '左眼视力', '右眼眼压值', '左眼眼压值'];
    const allDates = new Set();

    // 收集所有日期
    eyeIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            indicatorData.dates.forEach(date => allDates.add(date));
        }
    });

    const labels = Array.from(allDates).sort();

    if (labels.length === 0) {
        ctx1.parentElement.querySelector('.text-muted').style.display = 'block';
        ctx2.parentElement.querySelector('.text-muted').style.display = 'block';
        return;
    }

    // 视力图表
    const visionIndicators = ['右眼视力', '左眼视力'];
    const visionDatasets = [];

    visionIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            visionDatasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    if (visionDatasets.length > 0) {
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: visionDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '日期'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '视力'
                        }
                    }
                }
            }
        });
    } else {
        ctx1.parentElement.querySelector('.text-muted').style.display = 'block';
    }

    // 眼压图表
    const pressureIndicators = ['右眼眼压值', '左眼眼压值'];
    const pressureDatasets = [];

    pressureIndicators.forEach(indicatorName => {
        const indicatorData = rawData.find(item => item.indicator_name === indicatorName);
        if (indicatorData && indicatorData.values.length > 0) {
            pressureDatasets.push({
                label: indicatorName,
                data: indicatorData.values,
                borderColor: getIndicatorColor(indicatorName),
                backgroundColor: getIndicatorColor(indicatorName, 0.1),
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        }
    });

    if (pressureDatasets.length > 0) {
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: pressureDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '日期'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '眼压值'
                        }
                    }
                }
            }
        });
    } else {
        ctx2.parentElement.querySelector('.text-muted').style.display = 'block';
    }
}

// 其他检查图表
function createOtherChart() {
    createDynamicChart('otherChart', 'other_exam', '数值');
}

// 综合概览图表
function createOverviewChart() {
    const ctx = document.getElementById('overviewChart').getContext('2d');

    // 合并所有数据到一个图表
    const allData = [];
    const labels = [];

    // 收集所有日期
    const dates = new Set();
    Object.values(chartData).forEach(data => {
        data.forEach(d => dates.add(d.date));
    });
    const sortedDates = Array.from(dates).sort();

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [
                {
                    label: '收缩压',
                    data: sortedDates.map(date => {
                        const item = (chartData.blood_pressure || []).find(d => d.date === date);
                        return item ? item.systolic : null;
                    }),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1,
                    hidden: true
                },
                {
                    label: '心率',
                    data: sortedDates.map(date => {
                        const item = (chartData.heart_rate || []).find(d => d.date === date);
                        return item ? item.value : null;
                    }),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: chartConfig
    });
}

// 指标分布饼图
function createDistributionChart() {
    const ctx = document.getElementById('distributionChart').getContext('2d');

    // 统计各类指标数量
    const distribution = {};
    Object.keys(chartData).forEach(key => {
        const count = chartData[key].length;
        if (count > 0) {
            const label = {
                'blood_pressure': '血压',
                'heart_rate': '心率',
                'weight': '体重',
                'blood_sugar': '血糖',
                'cholesterol': '胆固醇'
            }[key] || key;
            distribution[label] = count;
        }
    });

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(distribution),
            datasets: [{
                data: Object.values(distribution),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', function() {
    // 延迟初始化，确保DOM完全加载
    setTimeout(() => {
        createPhysicalChart();
        createBloodChart();
        createBiochemistryCharts();
        createLiverChart();
        createKidneyChart();
        createThyroidChart();
        createTumorChart();
        createUrineChart();
        createRheologyChart();
        createEyeCharts();
        createOtherChart();

        // 为默认激活的标签页生成独立指标图表
        createIndividualCharts('physical-individual-charts', 'physical_exam');
    }, 100);
});

// 标签切换时重新渲染图表
document.addEventListener('shown.bs.tab', function (e) {
    const targetTab = e.target.getAttribute('data-bs-target');

    // 使用从Django传递的动态指标分类映射
    console.log('Using Django dynamic mapping:', dynamicIndicatorMapping);
    console.log('Target tab:', targetTab);

    // 重新渲染当前可见的图表
    setTimeout(() => {
        const charts = Chart.instances;
        Object.values(charts).forEach(chart => {
            if (chart.canvas.closest('.tab-pane.active') ||
                chart.canvas.closest('.tab-pane') === null) {
                chart.resize();
            }
        });

        // 根据激活的标签页生成独立指标图表
        const tabId = targetTab.substring(1); // 移除#号
        const indicatorType = dynamicIndicatorMapping[tabId];
        if (indicatorType) {
            const containerId = tabId + '-individual-charts';
            createIndividualCharts(containerId, indicatorType);
            console.log(`Creating individual charts for ${indicatorType} in container ${containerId}`);
        } else {
            console.log(`No indicator type found for tab ${targetTab}`);
        }
    }, 100);
});
</script>
{% endblock %}