{% extends 'base.html' %}

{% block title %}健康数据仪表板 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
/* ═══════════════════════════════════════════════════════════
   NEO-BRUTALIST MEDICAL DASHBOARD - 新野兽派医疗仪表板
   ═══════════════════════════════════════════════════════════ */

:root {
    --brutal-yellow: #FFD60A;
    --brutal-cyan: #14b8a6;
    --brutal-pink: #FF5C8D;
    --brutal-blue: #4C8BF5;
    --brutal-green: #06FFA5;
    --brutal-red: #FF4757;
    --brutal-black: #000000;
    --brutal-white: #FFFFFF;
    --border-thick: 3px solid #000;
    --shadow-hard: 6px 6px 0px #000;
    --shadow-hard-sm: 4px 4px 0px #000;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #FAFAFA;
    font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif;
    color: #000;
    overflow-x: hidden;
}

/* 页面背景 - 棋盘格图案 */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    pointer-events: none;
    z-index: 0;
}

.container-fluid {
    position: relative;
    z-index: 1;
}

/* ═══════════════════════════════════════════════════════════
   超大标题 - 粗体，冲击力
   ═══════════════════════════════════════════════════════════ */

h1 {
    font-size: 3.5rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.03em;
    line-height: 0.9;
    margin-bottom: 0.5rem;
    position: relative;
    display: inline-block;
}

h1::before {
    content: '健康数据仪表板';
    position: absolute;
    left: 4px;
    top: 4px;
    z-index: -1;
    color: var(--brutal-yellow);
    opacity: 1;
}

h1 i {
    display: none;
}

/* 副标题 - 不对称布局 */
p {
    font-size: 1.125rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 0;
    padding-left: 1rem;
    border-left: 4px solid var(--brutal-cyan);
}

/* ═══════════════════════════════════════════════════════════
   野兽派卡片 - 粗边框 + 硬阴影
   ═══════════════════════════════════════════════════════════ */

.dashboard-card {
    background: var(--brutal-white);
    border: var(--border-thick);
    border-radius: 0;
    box-shadow: var(--shadow-hard);
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    margin-bottom: 1.5rem;
}

.dashboard-card:hover {
    transform: translate(-2px, -2px);
    box-shadow: 8px 8px 0px #000;
}

.dashboard-card .card-header {
    background: transparent;
    border-bottom: var(--border-thick);
    padding: 1.5rem;
    border-radius: 0;
}

.dashboard-card .card-header h6,
.dashboard-card .card-header h5 {
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 1rem;
    margin: 0;
}

.dashboard-card .card-body {
    padding: 1.5rem;
}

/* ═══════════════════════════════════════════════════════════
   野兽派按钮 - 粗体，硬阴影，hover时偏移
   ═══════════════════════════════════════════════════════════ */

.btn {
    border: var(--border-thick);
    border-radius: 0;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.875rem 1.5rem;
    box-shadow: var(--shadow-hard-sm);
    transition: all 0.1s ease;
    position: relative;
}

.btn:active {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0px #000;
}

.btn-primary {
    background: var(--brutal-cyan);
    color: #000;
    border-color: #000;
}

.btn-primary:hover {
    background: var(--brutal-green);
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

.btn-outline-primary {
    background: transparent;
    border-color: #000;
    color: #000;
}

.btn-outline-primary:hover {
    background: var(--brutal-yellow);
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

.btn-outline-danger {
    background: transparent;
    border-color: #000;
    color: #000;
}

.btn-outline-danger:hover {
    background: var(--brutal-pink);
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

.btn-outline-info {
    background: transparent;
    border-color: #000;
    color: #000;
}

.btn-outline-info:hover {
    background: var(--brutal-blue);
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

/* ═══════════════════════════════════════════════════════════
   野兽派徽章 - 纯色背景，粗边框
   ═══════════════════════════════════════════════════════════ */

.badge {
    padding: 0.5rem 0.875rem;
    border: 2px solid #000;
    border-radius: 0;
    font-weight: 800;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 2px 2px 0px #000;
}

.badge.bg-primary {
    background: var(--brutal-cyan);
    color: #000;
}

.badge.bg-success {
    background: var(--brutal-green);
    color: #000;
}

.badge.bg-danger {
    background: var(--brutal-red);
    color: #FFF;
}

.badge.bg-warning {
    background: var(--brutal-yellow);
    color: #000;
}

.badge.bg-info {
    background: var(--brutal-blue);
    color: #FFF;
}

.badge.bg-light {
    background: var(--brutal-white);
    color: #000;
}

/* ═══════════════════════════════════════════════════════════
   指标卡片 - 彩色顶部边框
   ═══════════════════════════════════════════════════════════ */

.indicator-card {
    background: var(--brutal-white);
    border: var(--border-thick);
    border-top: 6px solid var(--brutal-cyan);
    border-radius: 0;
    box-shadow: var(--shadow-hard-sm);
    transition: all 0.15s ease;
}

.indicator-card:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px #000;
}

.indicator-card .card-header {
    background: transparent;
    border-bottom: var(--border-thick);
    padding: 1rem;
    color: #000;
}

.indicator-card .card-header h6 {
    font-weight: 800;
    text-transform: uppercase;
    font-size: 0.875rem;
}

.indicator-card .card-body {
    padding: 1rem;
    background: #FFF;
}

/* ═══════════════════════════════════════════════════════════
   数据表格 - 粗边框，斑马纹
   ═══════════════════════════════════════════════════════════ */

.indicator-table {
    margin-bottom: 0;
    font-size: 0.875rem;
}

.indicator-table thead th {
    background: linear-gradient(135deg, #4C8BF5, #7C9FFF);
    color: #FFF;
    font-weight: 800;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.875rem;
    border: none;
    position: relative;
}

.indicator-table thead th::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brutal-cyan), var(--brutal-green), var(--brutal-yellow));
}

.indicator-table tbody td {
    padding: 0.875rem;
    border-bottom: 2px solid #000;
    color: #000;
}

.indicator-table tbody tr:nth-child(even) {
    background: #F5F5F5;
}

.indicator-table tbody tr:hover {
    background: var(--brutal-yellow);
}

/* ═══════════════════════════════════════════════════════════
   标签页 - 粗边框，硬阴影
   ═══════════════════════════════════════════════════════════ */

.nav-tabs {
    border-bottom: var(--border-thick);
    gap: 0;
}

.nav-tabs .nav-link {
    border: 2px solid #000;
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    background: #F5F5F5;
    color: #000;
    font-weight: 700;
    padding: 1rem 1.5rem;
    margin-right: 0.5rem;
    transition: all 0.15s ease;
}

.nav-tabs .nav-link:hover {
    background: var(--brutal-yellow);
    transform: translateY(-2px);
}

.nav-tabs .nav-link.active {
    background: var(--brutal-cyan);
    color: #000;
    border-color: #000;
    border-bottom: 2px solid #FFF;
    margin-bottom: -2px;
}

/* ═══════════════════════════════════════════════════════════
   进度条 - 纯色填充
   ═══════════════════════════════════════════════════════════ */

.progress {
    height: 12px;
    border: 2px solid #000;
    border-radius: 0;
    background: #F5F5F5;
}

.progress-bar {
    border-radius: 0;
    transition: width 0.3s ease;
}

/* ═══════════════════════════════════════════════════════════
   Alert - 纯色背景 + 粗边框
   ═══════════════════════════════════════════════════════════ */

.alert {
    border: var(--border-thick);
    border-radius: 0;
    padding: 1rem 1.25rem;
    font-weight: 600;
    box-shadow: var(--shadow-hard-sm);
}

.alert-danger {
    background: var(--brutal-red);
    color: #FFF;
    border-color: #000;
}

.alert-success {
    background: var(--brutal-green);
    color: #000;
    border-color: #000;
}

/* ═══════════════════════════════════════════════════════════
   卡片彩色边框
   ═══════════════════════════════════════════════════════════ */

.card.border-danger {
    border-left: 6px solid var(--brutal-red) !important;
}

.card.border-success {
    border-left: 6px solid var(--brutal-green) !important;
}

.card.border-warning {
    border-left: 6px solid var(--brutal-yellow) !important;
}

.card.border-info {
    border-left: 6px solid var(--brutal-blue) !important;
}

.card.border-danger .card-header {
    background: var(--brutal-red);
    color: #FFF;
    border-bottom-color: #000 !important;
}

.card.border-info .card-header {
    background: var(--brutal-blue);
    color: #FFF;
    border-bottom-color: #000 !important;
}

/* ═══════════════════════════════════════════════════════════
   文字颜色重置
   ═══════════════════════════════════════════════════════════ */

.text-muted {
    color: #666 !important;
    font-weight: 500;
}

.fw-bold {
    color: #000 !important;
    font-weight: 800 !important;
}

.border-bottom {
    border-color: #000 !important;
    border-width: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3">
                <div class="flex-grow-1">
                    <h1 class="mb-1 fw-bold" style="color: var(--text-primary);">
                        <i class="bi bi-heart-pulse-fill" style="color: var(--primary);"></i> 健康数据仪表板
                    </h1>
                    <p class="mb-0" style="color: var(--text-secondary);">全面掌控您的健康状况</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 顶部信息栏 -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- 最近体检报告 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-file-text"></i> 我的体检报告
                            </h6>
                            {% if total_checkups > 0 %}
                            <span class="badge bg-primary">{{ total_checkups }} 份</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if all_checkups %}
                                {% for checkup_data in all_checkups|slice:":10" %}
                                {% with checkup=checkup_data.checkup %}
                                <div class="d-flex justify-content-between align-items-start mb-3 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            {% if checkup.notes %}
                                            <div class="fw-bold me-2">{{ checkup.notes }}</div>
                                            {% else %}
                                            <div class="fw-bold me-2">{{ checkup.checkup_date|date:"Y年m月d日" }}</div>
                                            {% endif %}
                                            <span class="text-muted small">{{ checkup.hospital }}</span>
                                        </div>
                                        <div class="text-muted small mb-2">{{ checkup.checkup_date|date:"Y年m月d日" }}</div>

                                        <!-- 指标状态统计 -->
                                        {% if checkup_data.total_count > 0 %}
                                        <div class="d-flex gap-2">
                                            {% if checkup_data.normal_count > 0 %}
                                            <span class="badge bg-success status-badge">
                                                <i class="bi bi-check-circle"></i> 正常: {{ checkup_data.normal_count }}
                                            </span>
                                            {% endif %}
                                            {% if checkup_data.attention_count > 0 %}
                                            <span class="badge bg-warning text-dark status-badge">
                                                <i class="bi bi-exclamation-circle"></i> 关注: {{ checkup_data.attention_count }}
                                            </span>
                                            {% endif %}
                                            {% if checkup_data.abnormal_count > 0 %}
                                            <span class="badge bg-danger status-badge">
                                                <i class="bi bi-exclamation-triangle"></i> 异常: {{ checkup_data.abnormal_count }}
                                            </span>
                                            {% endif %}
                                            <span class="text-muted small">共 {{ checkup_data.total_count }} 项</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex gap-1">
                                        <a href="{% url 'medical_records:checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary" title="查看">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button onclick="deleteCheckup({{ checkup.id }})" class="btn btn-sm btn-outline-danger" title="删除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endwith %}
                                {% endfor %}
                                {% if all_checkups|length > 10 %}
                                <div class="text-center mt-2">
                                    <span class="text-muted small d-block mb-2">还有 {{ all_checkups|length|add:"-10" }} 条记录未显示</span>
                                    <a href="{% url 'medical_records:all_checkups' %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-list me-1"></i>查看全部 ({{ all_checkups|length }} 份)
                                    </a>
                                </div>
                                {% endif %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-plus"></i> 上传新报告
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-3">暂无体检报告</p>
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm">
                                        上传第一份报告
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 异常指标提醒 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 异常指标提醒
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if abnormal_indicators %}
                                {% for indicator in abnormal_indicators %}
                                <div class="alert alert-danger alert-sm mb-2 py-2">
                                    <div class="fw-bold">{{ indicator.indicator_name }}</div>
                                    <div class="small">
                                        {{ indicator.value }} {{ indicator.unit }}
                                        <br>
                                        <span class="text-muted">{{ indicator.checkup.checkup_date|date:"Y-m-d" }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:ai_health_advice' %}" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="bi bi-robot"></i> 咨询AI医生
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <p class="text-muted small mb-0 mt-2">暂无异常指标</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 用药提醒 -->
                {% if has_medication_reminders %}
                <div class="col-12 mb-3">
                    <div class="card dashboard-card border-info h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-capsule"></i> 用药提醒
                                <span class="badge bg-light text-info ms-2">{{ medication_reminders|length }} 种药</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for reminder in medication_reminders %}
                                <div class="col-md-6 mb-3">
                                    <div class="card {% if reminder.taken_today %}border-success{% else %}border-warning{% endif %}">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">
                                                        <i class="bi bi-pills"></i> {{ reminder.medication.medicine_name }}
                                                    </h6>
                                                    <div class="text-muted small">
                                                        {{ reminder.medication.dosage }}
                                                    </div>
                                                </div>
                                                {% if reminder.taken_today %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> 已服药
                                                </span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-clock"></i> 待服药
                                                </span>
                                                {% endif %}
                                            </div>

                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="small text-muted">
                                                    <i class="bi bi-calendar3"></i>
                                                    {{ reminder.medication.start_date|date:"m月d日" }} -
                                                    {{ reminder.medication.end_date|date:"m月d日" }}
                                                    <span class="ms-2">
                                                        剩余 {{ reminder.days_remaining }} 天
                                                    </span>
                                                </div>
                                                <div class="small" title="服药进度">
                                                    <div class="progress" style="height: 6px; width: 80px;">
                                                        <div class="progress-bar {% if reminder.progress_percentage >= 80 %}bg-success{% elif reminder.progress_percentage >= 50 %}bg-info{% else %}bg-warning{% endif %}"
                                                             style="width: {{ reminder.progress_percentage }}%"
                                                             role="progressbar"></div>
                                                    </div>
                                                    <span class="text-muted">{{ reminder.progress_percentage }}%</span>
                                                </div>
                                            </div>

                                            {% if not reminder.taken_today %}
                                            <div class="mt-2">
                                                <a href="{% url 'medical_records:medication_list' %}"
                                                   class="btn btn-sm btn-outline-primary w-100">
                                                    <i class="bi bi-check2-square"></i> 打卡服药
                                                </a>
                                            </div>
                                            {% endif %}

                                            {% if reminder.medication.notes %}
                                            <div class="mt-2 text-muted small">
                                                <i class="bi bi-sticky"></i> {{ reminder.medication.notes }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-3">
                                <a href="{% url 'medical_records:medication_list' %}" class="btn btn-outline-info btn-sm w-100">
                                    <i class="bi bi-list-ul"></i> 查看所有药单
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="col-12">
            <!-- 健康趋势图表区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> 健康趋势分析 - 按指标分类
                                </h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'medical_records:export_health_trends_pdf' %}"
                                       class="btn btn-outline-danger"
                                       title="导出为PDF">
                                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                                    </a>
                                    <a href="{% url 'medical_records:export_health_trends_word' %}"
                                       class="btn btn-outline-primary"
                                       title="导出为Word">
                                        <i class="bi bi-file-earmark-word"></i> 导出Word
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 图表切换标签 -->
                            <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                                <!-- 动态生成的标签按钮 -->
                            </ul>

                            <!-- 标签内容 -->
                            <div class="tab-content" id="chartTabContent">
                                <!-- 动态生成的标签内容 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 图表数据
const chartData = {{ chart_data|safe }} || {};
const rawData = chartData; // 保持向后兼容

// 从Django传递的动态指标分类列表
const indicatorTypeList = {{ indicator_type_list|safe }} || [];
console.log('Indicator type list from Django:', indicatorTypeList);

// 从Django传递的动态指标分类映射
const dynamicIndicatorMapping = {{ indicator_type_mapping|safe }} || {};
console.log('Dynamic indicator mapping from Django:', dynamicIndicatorMapping);

// 动态生成标签按钮和内容面板
function generateDynamicTabs() {
    const tabsContainer = document.getElementById('chartTabs');
    const contentContainer = document.getElementById('chartTabContent');

    if (!tabsContainer || !contentContainer) {
        console.error('Tabs container or content container not found');
        return;
    }

    // 清空现有内容
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    // 为每个指标类型创建标签按钮和内容面板
    indicatorTypeList.forEach((indicatorType, index) => {
        const type = indicatorType.type;
        const displayName = indicatorType.display_name;
        const isActive = index === 0 ? 'active' : '';
        const isShow = index === 0 ? 'show active' : '';

        // 创建标签按钮
        const tabButton = document.createElement('li');
        tabButton.className = 'nav-item';
        tabButton.role = 'presentation';
        tabButton.innerHTML = `
            <button class="nav-link ${isActive}"
                    id="${type}-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#${type}"
                    type="button"
                    role="tab">
                <i class="bi bi-bar-chart"></i> ${displayName}
            </button>
        `;
        tabsContainer.appendChild(tabButton);

        // 创建标签内容面板
        const tabPane = document.createElement('div');
        tabPane.className = `tab-pane fade ${isShow}`;
        tabPane.id = type;
        tabPane.role = 'tabpanel';
        tabPane.innerHTML = `
            <div class="row" id="${type}-individual-charts">
                <!-- 动态生成的表格将显示在这里 -->
            </div>
        `;
        contentContainer.appendChild(tabPane);
    });
}

// 页面加载时生成动态标签
generateDynamicTabs();

// 计算变化量
function calculateChange(values) {
    if (!values || values.length < 2) return null;
    const latest = values[0];
    const previous = values[1];
    const change = latest - previous;
    const percentChange = previous !== 0 ? ((change / previous) * 100).toFixed(1) : 'N/A';
    return { absolute: change.toFixed(2), percent: percentChange };
}

// 生成变化量显示HTML
function formatChange(changeData) {
    if (!changeData) return '<span class="text-muted">-</span>';
    const { absolute, percent } = changeData;
    const isPositive = parseFloat(absolute) > 0;
    const isNegative = parseFloat(absolute) < 0;
    let html = '';
    if (isPositive) {
        html = `<span class="text-danger">↑ ${Math.abs(absolute)}</span> <span class="text-muted small">(+${percent}%)</span>`;
    } else if (isNegative) {
        html = `<span class="text-success">↓ ${Math.abs(absolute)}</span> <span class="text-muted small">(${percent}%)</span>`;
    } else {
        html = `<span class="text-muted">-</span>`;
    }
    return html;
}

// 为单个指标创建表格
function createTableForIndicator(indicatorName, indicatorData) {
    const dates = indicatorData.dates || [];
    const values = indicatorData.values || [];  // 用于计算的数值
    const valuesDisplay = indicatorData.values_display || values;  // 用于显示的原始值
    const unit = indicatorData.units || '';

    if (dates.length === 0) {
        return '';
    }

    // 按日期降序排列所有数据（最新的在前）
    const sortedData = dates.map((date, i) => ({
        date: date,
        value: values[i],  // 计算用的数值
        valueDisplay: valuesDisplay[i]  // 显示用的原始值
    })).sort((a, b) => new Date(b.date) - new Date(a.date));

    let tableHtml = `
        <div class="col-lg-6 col-xl-4 mb-2">
            <div class="card indicator-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-truncate" title="${indicatorName}">${indicatorName}</h6>
                    <small class="text-nowrap ms-2">${unit}</small>
                </div>
                <div class="card-body p-2">
                    <table class="table indicator-table mb-0 table-sm">
                        <thead>
                            <tr>
                                <th class="ps-2" style="width: 35%">日期</th>
                                <th style="width: 35%">数值</th>
                                <th class="text-end pe-2" style="width: 30%">变化率</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    sortedData.forEach((item, idx) => {
        let changePercentHtml = '<span class="text-muted">-</span>';

        // 计算与上一次记录的变化率（当前行的下一项，因为数组是按日期降序排列的）
        if (idx < sortedData.length - 1) {
            const currentVal = item.value;  // 使用提取的数值
            const prevVal = sortedData[idx + 1].value;

            // 只有当两个值都是数字时才计算变化率
            if (currentVal !== null && prevVal !== null && !isNaN(currentVal) && !isNaN(prevVal) && prevVal !== 0) {
                const change = currentVal - prevVal;
                const percentChange = ((change / prevVal) * 100).toFixed(1);

                // 变化率的颜色和符号
                let changeClass, changeSymbol;
                if (change > 0) {
                    changeClass = 'text-danger';
                    changeSymbol = '↑';
                } else if (change < 0) {
                    changeClass = 'text-success';
                    changeSymbol = '↓';
                } else {
                    changeClass = 'text-muted';
                    changeSymbol = '-';
                }

                changePercentHtml = `<span class="${changeClass}">${changeSymbol} ${Math.abs(percentChange)}%</span>`;
            }
        }

        tableHtml += `
            <tr>
                <td class="ps-2 text-muted small">${item.date}</td>
                <td class="fw-bold small">${item.valueDisplay}</td>
                <td class="text-end pe-2 small">${changePercentHtml}</td>
            </tr>
        `;
    });

    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    return tableHtml;
}

// 通用的指标类型表格生成函数
function createIndicatorTypeTable(indicatorType) {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById(`${indicatorType}-individual-charts`);
    if (!container) return;

    // 过滤出该类型的所有指标
    const typeIndicators = rawData
        .filter(item => item.type === indicatorType)
        .map(item => item.indicator_name);

    let html = '';
    // 去重并生成表格
    const uniqueIndicatorNames = [...new Set(typeIndicators)];
    uniqueIndicatorNames.forEach(indicatorName => {
        const indicatorData = rawData.find(item =>
            item.indicator_name === indicatorName && item.type === indicatorType
        );
        if (indicatorData) {
            html += createTableForIndicator(indicatorName, indicatorData);
        }
    });

    if (!html) {
        // 从indicatorTypeList中找到对应的显示名称
        const typeInfo = indicatorTypeList.find(item => item.type === indicatorType);
        const displayName = typeInfo ? typeInfo.display_name : indicatorType;
        container.innerHTML = `<div class="col-12 text-center text-muted py-4">暂无${displayName}数据</div>`;
    } else {
        container.innerHTML = html;
    }
}

// 初始化所有表格
function initializeAllTables() {
    indicatorTypeList.forEach(indicatorType => {
        createIndicatorTypeTable(indicatorType.type);
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing tables...');
    initializeAllTables();
});

// 切换标签时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    if (targetId && targetId.startsWith('#')) {
        const indicatorType = targetId.substring(1); // 去掉#号
        createIndicatorTypeTable(indicatorType);
    }
});

// 删除体检报告
function deleteCheckup(checkupId) {
    if (!confirm('确定要删除这份体检报告吗？删除后将无法恢复。')) {
        return;
    }

    const deleteUrl = `/checkup/${checkupId}/delete/`;

    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除失败:', error);
        alert('删除失败，请稍后重试');
    });
}

// 获取CSRF Token的辅助函数
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
