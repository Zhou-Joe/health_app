{% extends 'base.html' %}

{% block title %}健康数据仪表板 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.sidebar-card {
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
}
.status-badge {
    font-size: 0.75rem;
}
.chart-container {
    position: relative;
    height: 300px;
}
.indicator-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.indicator-trend {
    font-size: 0.875rem;
}
.indicator-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}
.indicator-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.indicator-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0 !important;
    padding: 12px 15px;
}
.indicator-card .card-header h6 {
    font-weight: 600;
    margin: 0;
}
.indicator-card .card-header small {
    opacity: 0.9;
}
.indicator-card .card-body {
    padding: 15px;
}
.indicator-table {
    margin-bottom: 0;
}
.indicator-table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
    font-weight: 600;
    font-size: 0.75rem;
    white-space: nowrap;
}
.indicator-table tbody td {
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f5;
}
.indicator-table tbody tr:last-child td {
    border-bottom: none;
}
.indicator-table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="bi bi-heart-pulse text-primary"></i> 健康数据仪表板
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- 顶部信息栏 -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- 最近体检报告 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-file-text"></i> 我的体检报告
                            </h6>
                            {% if total_checkups > 0 %}
                            <span class="badge bg-primary">{{ total_checkups }} 份</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if all_checkups %}
                                {% for checkup in all_checkups|slice:":10" %}
                                <div class="d-flex justify-content-between align-items-center mb-3 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                                    <div>
                                        <div class="fw-bold">{{ checkup.checkup_date|date:"Y年m月d日" }}</div>
                                        <div class="text-muted small">{{ checkup.hospital }}</div>
                                    </div>
                                    <a href="{% url 'medical_records:checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                                {% endfor %}
                                {% if all_checkups|length > 10 %}
                                <div class="text-center mt-2">
                                    <span class="text-muted small d-block mb-2">还有 {{ all_checkups|length|add:"-10" }} 条记录未显示</span>
                                    <a href="{% url 'medical_records:all_checkups' %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-list me-1"></i>查看全部 ({{ all_checkups|length }} 份)
                                    </a>
                                </div>
                                {% endif %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-plus"></i> 上传新报告
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-3">暂无体检报告</p>
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm">
                                        上传第一份报告
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 异常指标提醒 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 异常指标提醒
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if abnormal_indicators %}
                                {% for indicator in abnormal_indicators %}
                                <div class="alert alert-danger alert-sm mb-2 py-2">
                                    <div class="fw-bold">{{ indicator.indicator_name }}</div>
                                    <div class="small">
                                        {{ indicator.value }} {{ indicator.unit }}
                                        <br>
                                        <span class="text-muted">{{ indicator.checkup.checkup_date|date:"Y-m-d" }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:ai_health_advice' %}" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="bi bi-robot"></i> 咨询AI医生
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <p class="text-muted small mb-0 mt-2">暂无异常指标</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="col-12">
            <!-- 健康趋势图表区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up"></i> 健康趋势分析 - 按指标分类
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- 图表切换标签 -->
                            <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                                <!-- 基础检查类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="physical-tab" data-bs-toggle="tab" data-bs-target="#physical" type="button" role="tab">
                                        <i class="bi bi-person"></i> 体格检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="blood-tab" data-bs-toggle="tab" data-bs-target="#blood" type="button" role="tab">
                                        <i class="bi bi-droplet"></i> 血液常规
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="biochemistry-tab" data-bs-toggle="tab" data-bs-target="#biochemistry" type="button" role="tab">
                                        <i class="bi bi-cpu"></i> 生化检验
                                    </button>
                                </li>

                                <!-- 器官功能类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="liver-tab" data-bs-toggle="tab" data-bs-target="#liver" type="button" role="tab">
                                        <i class="bi bi-liver"></i> 肝功能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="kidney-tab" data-bs-toggle="tab" data-bs-target="#kidney" type="button" role="tab">
                                        <i class="bi bi-gear"></i> 肾功能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="thyroid-tab" data-bs-toggle="tab" data-bs-target="#thyroid" type="button" role="tab">
                                        <i class="bi bi-lightning"></i> 甲状腺
                                    </button>
                                </li>

                                <!-- 其他检查类别 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tumor-tab" data-bs-toggle="tab" data-bs-target="#tumor" type="button" role="tab">
                                        <i class="bi bi-shield-exclamation"></i> 肿瘤标志
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="urine-tab" data-bs-toggle="tab" data-bs-target="#urine" type="button" role="tab">
                                        <i class="bi bi-moisture"></i> 尿液检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="rheology-tab" data-bs-toggle="tab" data-bs-target="#rheology" type="button" role="tab">
                                        <i class="bi bi-water"></i> 血液流变
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="eye-tab" data-bs-toggle="tab" data-bs-target="#eye" type="button" role="tab">
                                        <i class="bi bi-eye"></i> 眼科检查
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button" role="tab">
                                        <i class="bi bi-clipboard"></i> 其他检查
                                    </button>
                                </li>
                            </ul>

                            <!-- 标签内容 -->
                            <div class="tab-content" id="chartTabContent">
                                <!-- 体格检查标签页 -->
                                <div class="tab-pane fade show active" id="physical" role="tabpanel">
                                    <div class="row" id="physical-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 血液常规标签页 -->
                                <div class="tab-pane fade" id="blood" role="tabpanel">
                                    <div class="row" id="blood-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 生化检验标签页 -->
                                <div class="tab-pane fade" id="biochemistry" role="tabpanel">
                                    <div class="row" id="biochemistry-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肝功能标签页 -->
                                <div class="tab-pane fade" id="liver" role="tabpanel">
                                    <div class="row" id="liver-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肾功能标签页 -->
                                <div class="tab-pane fade" id="kidney" role="tabpanel">
                                    <div class="row" id="kidney-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 甲状腺功能标签页 -->
                                <div class="tab-pane fade" id="thyroid" role="tabpanel">
                                    <div class="row" id="thyroid-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 肿瘤标志物标签页 -->
                                <div class="tab-pane fade" id="tumor" role="tabpanel">
                                    <div class="row" id="tumor-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 尿液检查标签页 -->
                                <div class="tab-pane fade" id="urine" role="tabpanel">
                                    <div class="row" id="urine-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 血液流变学标签页 -->
                                <div class="tab-pane fade" id="rheology" role="tabpanel">
                                    <div class="row" id="rheology-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 眼科检查标签页 -->
                                <div class="tab-pane fade" id="eye" role="tabpanel">
                                    <div class="row" id="eye-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>

                                <!-- 其他检查标签页 -->
                                <div class="tab-pane fade" id="other" role="tabpanel">
                                    <div class="row" id="other-individual-charts">
                                        <!-- 动态生成的表格将显示在这里 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 图表数据
const chartData = {{ chart_data|safe }};
const rawData = chartData; // 保持向后兼容

// 从Django传递的动态指标分类映射
const dynamicIndicatorMapping = {{ indicator_type_mapping|safe }};
console.log('Dynamic indicator mapping from Django:', dynamicIndicatorMapping);

// 计算变化量
function calculateChange(values) {
    if (!values || values.length < 2) return null;
    const latest = values[0];
    const previous = values[1];
    const change = latest - previous;
    const percentChange = previous !== 0 ? ((change / previous) * 100).toFixed(1) : 'N/A';
    return { absolute: change.toFixed(2), percent: percentChange };
}

// 生成变化量显示HTML
function formatChange(changeData) {
    if (!changeData) return '<span class="text-muted">-</span>';
    const { absolute, percent } = changeData;
    const isPositive = parseFloat(absolute) > 0;
    const isNegative = parseFloat(absolute) < 0;
    let html = '';
    if (isPositive) {
        html = `<span class="text-danger">↑ ${Math.abs(absolute)}</span> <span class="text-muted small">(+${percent}%)</span>`;
    } else if (isNegative) {
        html = `<span class="text-success">↓ ${Math.abs(absolute)}</span> <span class="text-muted small">(${percent}%)</span>`;
    } else {
        html = `<span class="text-muted">-</span>`;
    }
    return html;
}

// 为单个指标创建表格
function createTableForIndicator(indicatorName, indicatorData) {
    const dates = indicatorData.dates || [];
    const values = indicatorData.values || [];  // 用于计算的数值
    const valuesDisplay = indicatorData.values_display || values;  // 用于显示的原始值
    const unit = indicatorData.units || '';

    if (dates.length === 0) {
        return '';
    }

    // 按日期降序排列所有数据（最新的在前）
    const sortedData = dates.map((date, i) => ({
        date: date,
        value: values[i],  // 计算用的数值
        valueDisplay: valuesDisplay[i]  // 显示用的原始值
    })).sort((a, b) => new Date(b.date) - new Date(a.date));

    let tableHtml = `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card indicator-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-truncate" title="${indicatorName}">${indicatorName}</h6>
                    <small class="text-nowrap ms-2">${unit}</small>
                </div>
                <div class="card-body p-2">
                    <table class="table indicator-table mb-0 table-sm">
                        <thead>
                            <tr>
                                <th class="ps-2" style="width: 35%">日期</th>
                                <th style="width: 35%">数值</th>
                                <th class="text-end pe-2" style="width: 30%">变化率</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    sortedData.forEach((item, idx) => {
        let changePercentHtml = '<span class="text-muted">-</span>';

        // 计算与上一次记录的变化率（当前行的下一项，因为数组是按日期降序排列的）
        if (idx < sortedData.length - 1) {
            const currentVal = item.value;  // 使用提取的数值
            const prevVal = sortedData[idx + 1].value;

            // 只有当两个值都是数字时才计算变化率
            if (currentVal !== null && prevVal !== null && !isNaN(currentVal) && !isNaN(prevVal) && prevVal !== 0) {
                const change = currentVal - prevVal;
                const percentChange = ((change / prevVal) * 100).toFixed(1);

                // 变化率的颜色和符号
                let changeClass, changeSymbol;
                if (change > 0) {
                    changeClass = 'text-danger';
                    changeSymbol = '↑';
                } else if (change < 0) {
                    changeClass = 'text-success';
                    changeSymbol = '↓';
                } else {
                    changeClass = 'text-muted';
                    changeSymbol = '-';
                }

                changePercentHtml = `<span class="${changeClass}">${changeSymbol} ${Math.abs(percentChange)}%</span>`;
            }
        }

        tableHtml += `
            <tr>
                <td class="ps-2 text-muted small">${item.date}</td>
                <td class="fw-bold small">${item.valueDisplay}</td>
                <td class="text-end pe-2 small">${changePercentHtml}</td>
            </tr>
        `;
    });

    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    return tableHtml;
}

// 体格检查表格
function createPhysicalTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('physical-individual-charts');
    if (!container) return;

    const physicalIndicators = ['收缩压', '舒张压', '心率', '身高', '体重', '体重指数', '腰围', '臀围', '呼吸频率'];

    let html = '';
    rawData.forEach(indicator => {
        if (physicalIndicators.some(pi => indicator.indicator_name.includes(pi))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无体格检查数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 血液常规表格
function createBloodTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('blood-individual-charts');
    if (!container) return;

    const bloodIndicators = ['白细胞计数', '红细胞计数', '血红蛋白浓度', '血小板计数',
                           '中性粒细胞百分比', '淋巴细胞百分比', '单核细胞百分比'];

    let html = '';
    rawData.forEach(indicator => {
        if (bloodIndicators.some(bi => indicator.indicator_name.includes(bi))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无血液常规数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 生化检验表格
function createBiochemistryTables() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('biochemistry-individual-charts');
    if (!container) return;

    const biochemistryIndicators = ['葡萄糖', '总胆固醇', '甘油三酯', '高密度脂蛋白胆固醇',
                                   '低密度脂蛋白胆固醇', '载脂蛋白A1', '载脂蛋白B', '尿酸',
                                   '肌酐', '尿素', '总胆红素', '直接胆红素', '间接胆红素'];

    let html = '';
    rawData.forEach(indicator => {
        if (biochemistryIndicators.some(bi => indicator.indicator_name.includes(bi))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无生化检验数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 肝功能表格
function createLiverTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('liver-individual-charts');
    if (!container) return;

    const liverIndicators = ['丙氨酸氨基转移酶', '天门冬氨酸氨基转移酶', 'γ-谷氨酰转移酶'];

    let html = '';
    rawData.forEach(indicator => {
        if (liverIndicators.some(li => indicator.indicator_name.includes(li))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肝功能数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 肾功能表格
function createKidneyTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('kidney-individual-charts');
    if (!container) return;

    const kidneyIndicators = rawData
        .filter(item => item.type === 'kidney_function')
        .map(item => item.indicator_name);

    let html = '';
    rawData.forEach(indicator => {
        if (kidneyIndicators.includes(indicator.indicator_name)) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肾功能数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 甲状腺功能表格
function createThyroidTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('thyroid-individual-charts');
    if (!container) return;

    const thyroidIndicators = rawData
        .filter(item => item.type === 'thyroid_function')
        .map(item => item.indicator_name);

    let html = '';
    rawData.forEach(indicator => {
        if (indicator.type === 'thyroid_function' || thyroidIndicators.some(ti => indicator.indicator_name.includes(ti))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无甲状腺功能数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 肿瘤标志物表格
function createTumorTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('tumor-individual-charts');
    if (!container) return;

    const tumorIndicators = ['甲胎蛋白', '癌胚抗原', 'CA125', 'CA153', 'CA199', 'PSA', 'fPSA'];

    let html = '';
    rawData.forEach(indicator => {
        if (tumorIndicators.some(ti => indicator.indicator_name.includes(ti))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无肿瘤标志物数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 尿液检查表格
function createUrineTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('urine-individual-charts');
    if (!container) return;

    const urineIndicators = ['尿比重', '尿pH值', '尿蛋白', '尿糖', '尿酮体', '尿潜血', '尿白细胞'];

    let html = '';
    rawData.forEach(indicator => {
        if (urineIndicators.some(ui => indicator.indicator_name.includes(ui))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无尿液检查数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 血液流变学表格
function createRheologyTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('rheology-individual-charts');
    if (!container) return;

    const rheologyIndicators = ['全血粘度低切', '全血粘度中切', '全血粘度高切', '血浆粘度', '红细胞压积'];

    let html = '';
    rawData.forEach(indicator => {
        if (rheologyIndicators.some(ri => indicator.indicator_name.includes(ri))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无血液流变学数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 眼科检查表格
function createEyeTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('eye-individual-charts');
    if (!container) return;

    const eyeIndicators = ['裸眼视力左', '裸眼视力右', '矫正视力左', '矫正视力右', '眼压左', '眼压右'];

    let html = '';
    rawData.forEach(indicator => {
        if (indicator.type === 'eye_exam' || eyeIndicators.some(ei => indicator.indicator_name.includes(ei))) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无眼科检查数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 其他检查表格
function createOtherTable() {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById('other-individual-charts');
    if (!container) return;

    const knownTypes = ['physical_exam', 'blood_routine', 'biochemistry', 'liver_function',
                        'kidney_function', 'thyroid_function', 'tumor_markers', 'urine_exam',
                        'blood_rheology', 'eye_exam'];

    let html = '';
    rawData.forEach(indicator => {
        if (!knownTypes.includes(indicator.type)) {
            html += createTableForIndicator(indicator.indicator_name, indicator);
        }
    });

    if (!html) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无其他检查数据</div>';
    } else {
        container.innerHTML = html;
    }
}

// 初始化所有表格
function initializeAllTables() {
    createPhysicalTable();
    createBloodTable();
    createBiochemistryTables();
    createLiverTable();
    createKidneyTable();
    createThyroidTable();
    createTumorTable();
    createUrineTable();
    createRheologyTable();
    createEyeTable();
    createOtherTable();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeAllTables();
});

// 切换标签时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    switch(targetId) {
        case '#physical': createPhysicalTable(); break;
        case '#blood': createBloodTable(); break;
        case '#biochemistry': createBiochemistryTables(); break;
        case '#liver': createLiverTable(); break;
        case '#kidney': createKidneyTable(); break;
        case '#thyroid': createThyroidTable(); break;
        case '#tumor': createTumorTable(); break;
        case '#urine': createUrineTable(); break;
        case '#rheology': createRheologyTable(); break;
        case '#eye': createEyeTable(); break;
        case '#other': createOtherTable(); break;
    }
});

// 页面加载完成后初始化表格
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing tables...');
    initializeAllTables();
});

// 标签切换时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    switch(targetId) {
        case '#physical': createPhysicalTable(); break;
        case '#blood': createBloodTable(); break;
        case '#biochemistry': createBiochemistryTables(); break;
        case '#liver': createLiverTable(); break;
        case '#kidney': createKidneyTable(); break;
        case '#thyroid': createThyroidTable(); break;
        case '#tumor': createTumorTable(); break;
        case '#urine': createUrineTable(); break;
        case '#rheology': createRheologyTable(); break;
        case '#eye': createEyeTable(); break;
        case '#other': createOtherTable(); break;
    }
});
</script>
{% endblock %}
