{% extends 'base.html' %}

{% block title %}健康数据仪表板 - 个人健康管理系统{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.sidebar-card {
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
}
.status-badge {
    font-size: 0.75rem;
}
.chart-container {
    position: relative;
    height: 300px;
}
.indicator-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.indicator-trend {
    font-size: 0.875rem;
}
.indicator-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}
.indicator-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.indicator-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0 !important;
    padding: 12px 15px;
}
.indicator-card .card-header h6 {
    font-weight: 600;
    margin: 0;
}
.indicator-card .card-header small {
    opacity: 0.9;
}
.indicator-card .card-body {
    padding: 15px;
}
.indicator-table {
    margin-bottom: 0;
}
.indicator-table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
    font-weight: 600;
    font-size: 0.75rem;
    white-space: nowrap;
}
.indicator-table tbody td {
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f5;
}
.indicator-table tbody tr:last-child td {
    border-bottom: none;
}
.indicator-table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="bi bi-heart-pulse text-primary"></i> 健康数据仪表板
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- 顶部信息栏 -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- 最近体检报告 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-file-text"></i> 我的体检报告
                            </h6>
                            {% if total_checkups > 0 %}
                            <span class="badge bg-primary">{{ total_checkups }} 份</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if all_checkups %}
                                {% for checkup in all_checkups|slice:":10" %}
                                <div class="d-flex justify-content-between align-items-center mb-3 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                                    <div>
                                        <div class="fw-bold">{{ checkup.checkup_date|date:"Y年m月d日" }}</div>
                                        <div class="text-muted small">{{ checkup.hospital }}</div>
                                    </div>
                                    <a href="{% url 'medical_records:checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                                {% endfor %}
                                {% if all_checkups|length > 10 %}
                                <div class="text-center mt-2">
                                    <span class="text-muted small d-block mb-2">还有 {{ all_checkups|length|add:"-10" }} 条记录未显示</span>
                                    <a href="{% url 'medical_records:all_checkups' %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-list me-1"></i>查看全部 ({{ all_checkups|length }} 份)
                                    </a>
                                </div>
                                {% endif %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-plus"></i> 上传新报告
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small mb-3">暂无体检报告</p>
                                    <a href="{% url 'medical_records:upload_report' %}" class="btn btn-primary btn-sm">
                                        上传第一份报告
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 异常指标提醒 -->
                <div class="col-lg-6 mb-3">
                    <div class="card dashboard-card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 异常指标提醒
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if abnormal_indicators %}
                                {% for indicator in abnormal_indicators %}
                                <div class="alert alert-danger alert-sm mb-2 py-2">
                                    <div class="fw-bold">{{ indicator.indicator_name }}</div>
                                    <div class="small">
                                        {{ indicator.value }} {{ indicator.unit }}
                                        <br>
                                        <span class="text-muted">{{ indicator.checkup.checkup_date|date:"Y-m-d" }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-3">
                                    <a href="{% url 'medical_records:ai_health_advice' %}" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="bi bi-robot"></i> 咨询AI医生
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <p class="text-muted small mb-0 mt-2">暂无异常指标</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="col-12">
            <!-- 健康趋势图表区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> 健康趋势分析 - 按指标分类
                                </h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'medical_records:export_health_trends_pdf' %}"
                                       class="btn btn-outline-danger"
                                       title="导出为PDF">
                                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                                    </a>
                                    <a href="{% url 'medical_records:export_health_trends_word' %}"
                                       class="btn btn-outline-primary"
                                       title="导出为Word">
                                        <i class="bi bi-file-earmark-word"></i> 导出Word
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 图表切换标签 -->
                            <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                                <!-- 动态生成的标签按钮 -->
                            </ul>

                            <!-- 标签内容 -->
                            <div class="tab-content" id="chartTabContent">
                                <!-- 动态生成的标签内容 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 图表数据
const chartData = {{ chart_data|safe }};
const rawData = chartData; // 保持向后兼容

// 从Django传递的动态指标分类列表
const indicatorTypeList = {{ indicator_type_list|safe }};
console.log('Indicator type list from Django:', indicatorTypeList);

// 从Django传递的动态指标分类映射
const dynamicIndicatorMapping = {{ indicator_type_mapping|safe }};
console.log('Dynamic indicator mapping from Django:', dynamicIndicatorMapping);

// 动态生成标签按钮和内容面板
function generateDynamicTabs() {
    const tabsContainer = document.getElementById('chartTabs');
    const contentContainer = document.getElementById('chartTabContent');

    if (!tabsContainer || !contentContainer) {
        console.error('Tabs container or content container not found');
        return;
    }

    // 清空现有内容
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    // 为每个指标类型创建标签按钮和内容面板
    indicatorTypeList.forEach((indicatorType, index) => {
        const type = indicatorType.type;
        const displayName = indicatorType.display_name;
        const isActive = index === 0 ? 'active' : '';
        const isShow = index === 0 ? 'show active' : '';

        // 创建标签按钮
        const tabButton = document.createElement('li');
        tabButton.className = 'nav-item';
        tabButton.role = 'presentation';
        tabButton.innerHTML = `
            <button class="nav-link ${isActive}"
                    id="${type}-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#${type}"
                    type="button"
                    role="tab">
                <i class="bi bi-bar-chart"></i> ${displayName}
            </button>
        `;
        tabsContainer.appendChild(tabButton);

        // 创建标签内容面板
        const tabPane = document.createElement('div');
        tabPane.className = `tab-pane fade ${isShow}`;
        tabPane.id = type;
        tabPane.role = 'tabpanel';
        tabPane.innerHTML = `
            <div class="row" id="${type}-individual-charts">
                <!-- 动态生成的表格将显示在这里 -->
            </div>
        `;
        contentContainer.appendChild(tabPane);
    });
}

// 页面加载时生成动态标签
generateDynamicTabs();

// 计算变化量
function calculateChange(values) {
    if (!values || values.length < 2) return null;
    const latest = values[0];
    const previous = values[1];
    const change = latest - previous;
    const percentChange = previous !== 0 ? ((change / previous) * 100).toFixed(1) : 'N/A';
    return { absolute: change.toFixed(2), percent: percentChange };
}

// 生成变化量显示HTML
function formatChange(changeData) {
    if (!changeData) return '<span class="text-muted">-</span>';
    const { absolute, percent } = changeData;
    const isPositive = parseFloat(absolute) > 0;
    const isNegative = parseFloat(absolute) < 0;
    let html = '';
    if (isPositive) {
        html = `<span class="text-danger">↑ ${Math.abs(absolute)}</span> <span class="text-muted small">(+${percent}%)</span>`;
    } else if (isNegative) {
        html = `<span class="text-success">↓ ${Math.abs(absolute)}</span> <span class="text-muted small">(${percent}%)</span>`;
    } else {
        html = `<span class="text-muted">-</span>`;
    }
    return html;
}

// 为单个指标创建表格
function createTableForIndicator(indicatorName, indicatorData) {
    const dates = indicatorData.dates || [];
    const values = indicatorData.values || [];  // 用于计算的数值
    const valuesDisplay = indicatorData.values_display || values;  // 用于显示的原始值
    const unit = indicatorData.units || '';

    if (dates.length === 0) {
        return '';
    }

    // 按日期降序排列所有数据（最新的在前）
    const sortedData = dates.map((date, i) => ({
        date: date,
        value: values[i],  // 计算用的数值
        valueDisplay: valuesDisplay[i]  // 显示用的原始值
    })).sort((a, b) => new Date(b.date) - new Date(a.date));

    let tableHtml = `
        <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card indicator-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-truncate" title="${indicatorName}">${indicatorName}</h6>
                    <small class="text-nowrap ms-2">${unit}</small>
                </div>
                <div class="card-body p-2">
                    <table class="table indicator-table mb-0 table-sm">
                        <thead>
                            <tr>
                                <th class="ps-2" style="width: 35%">日期</th>
                                <th style="width: 35%">数值</th>
                                <th class="text-end pe-2" style="width: 30%">变化率</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    sortedData.forEach((item, idx) => {
        let changePercentHtml = '<span class="text-muted">-</span>';

        // 计算与上一次记录的变化率（当前行的下一项，因为数组是按日期降序排列的）
        if (idx < sortedData.length - 1) {
            const currentVal = item.value;  // 使用提取的数值
            const prevVal = sortedData[idx + 1].value;

            // 只有当两个值都是数字时才计算变化率
            if (currentVal !== null && prevVal !== null && !isNaN(currentVal) && !isNaN(prevVal) && prevVal !== 0) {
                const change = currentVal - prevVal;
                const percentChange = ((change / prevVal) * 100).toFixed(1);

                // 变化率的颜色和符号
                let changeClass, changeSymbol;
                if (change > 0) {
                    changeClass = 'text-danger';
                    changeSymbol = '↑';
                } else if (change < 0) {
                    changeClass = 'text-success';
                    changeSymbol = '↓';
                } else {
                    changeClass = 'text-muted';
                    changeSymbol = '-';
                }

                changePercentHtml = `<span class="${changeClass}">${changeSymbol} ${Math.abs(percentChange)}%</span>`;
            }
        }

        tableHtml += `
            <tr>
                <td class="ps-2 text-muted small">${item.date}</td>
                <td class="fw-bold small">${item.valueDisplay}</td>
                <td class="text-end pe-2 small">${changePercentHtml}</td>
            </tr>
        `;
    });

    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    return tableHtml;
}

// 通用的指标类型表格生成函数
function createIndicatorTypeTable(indicatorType) {
    const rawData = chartData.raw_data || [];
    const container = document.getElementById(`${indicatorType}-individual-charts`);
    if (!container) return;

    // 过滤出该类型的所有指标
    const typeIndicators = rawData
        .filter(item => item.type === indicatorType)
        .map(item => item.indicator_name);

    let html = '';
    // 去重并生成表格
    const uniqueIndicatorNames = [...new Set(typeIndicators)];
    uniqueIndicatorNames.forEach(indicatorName => {
        const indicatorData = rawData.find(item =>
            item.indicator_name === indicatorName && item.type === indicatorType
        );
        if (indicatorData) {
            html += createTableForIndicator(indicatorName, indicatorData);
        }
    });

    if (!html) {
        // 从indicatorTypeList中找到对应的显示名称
        const typeInfo = indicatorTypeList.find(item => item.type === indicatorType);
        const displayName = typeInfo ? typeInfo.display_name : indicatorType;
        container.innerHTML = `<div class="col-12 text-center text-muted py-4">暂无${displayName}数据</div>`;
    } else {
        container.innerHTML = html;
    }
}

// 初始化所有表格
function initializeAllTables() {
    indicatorTypeList.forEach(indicatorType => {
        createIndicatorTypeTable(indicatorType.type);
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing tables...');
    initializeAllTables();
});

// 切换标签时刷新对应的表格
document.addEventListener('shown.bs.tab', function(e) {
    const targetId = e.target.getAttribute('data-bs-target');
    if (targetId && targetId.startsWith('#')) {
        const indicatorType = targetId.substring(1); // 去掉#号
        createIndicatorTypeTable(indicatorType);
    }
});
</script>
{% endblock %}
